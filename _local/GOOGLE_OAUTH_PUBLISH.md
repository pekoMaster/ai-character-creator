# Google OAuth 發布設定指南

## 🎯 問題：無法登入 Google

### 錯誤訊息
```
The fetch of the id assertion endpoint resulted in a network error: ERR_FAILED
Server did not send the correct CORS headers.
```

### 真正原因
您的 Google OAuth 應用程式在「測試中」狀態，而您的 Google 帳號不在測試使用者清單中。

---

## ✅ 解決方案

### 方案 A：添加測試使用者（推薦，快速）

#### 1. 前往 OAuth 同意畫面
https://console.cloud.google.com/apis/credentials/consent

#### 2. 確認狀態
在頁面頂部，您會看到：

```
┌─────────────────────────────────────────┐
│ OAuth 同意畫面                          │
├─────────────────────────────────────────┤
│ 發布狀態：Testing 🟡                    │
│          ↑                              │
│       這就是問題！                       │
└─────────────────────────────────────────┘
```

#### 3. 添加測試使用者
往下滾動到「測試使用者」區域：

```
┌─────────────────────────────────────────┐
│ 測試使用者                              │
├─────────────────────────────────────────┤
│ 在發布狀態為「測試中」時，只有此處       │
│ 列出的使用者可以存取應用程式。           │
│                                         │
│ [+ ADD USERS] ← 點這裡                  │
│                                         │
│ 已新增的測試使用者：                     │
│ (目前可能是空的)                         │
└─────────────────────────────────────────┘
```

#### 4. 輸入您的 Email
```
┌─────────────────────────────────────────┐
│ 新增測試使用者                          │
├─────────────────────────────────────────┤
│ 輸入測試使用者的電子郵件地址             │
│                                         │
│ ┌─────────────────────────────────┐    │
│ │ your.email@gmail.com            │    │
│ │ friend@gmail.com                │    │
│ └─────────────────────────────────┘    │
│                                         │
│ 最多可新增 100 位測試使用者              │
│                                         │
│ [取消]  [新增] ← 點這裡                 │
└─────────────────────────────────────────┘
```

⚠️ **重要**：輸入您要用來登入的 Google Email

#### 5. 儲存
點擊頁面底部的「SAVE AND CONTINUE」或「儲存」

#### 6. 測試
- 訪問：https://pekomaster.github.io/ai-character-creator/platform.html
- 點擊「登入 Google」
- ✅ 應該能成功登入了！

---

### 方案 B：發布應用程式（任何人可用）

#### 何時使用
- 您想要分享給其他人使用
- 不想每次都手動添加測試使用者

#### 步驟

##### 1. 前往 OAuth 同意畫面
https://console.cloud.google.com/apis/credentials/consent

##### 2. 檢查應用程式類型
在頁面頂部查看「User Type」：

```
User Type: External 🌐
          ↑
    可供任何 Google 帳號使用
```

或

```
User Type: Internal 🏢
          ↑
    只能供組織內部使用（需要 Google Workspace）
```

##### 3. 點擊「PUBLISH APP」
在頁面頂部，狀態顯示「Testing」旁邊應該有一個按鈕：

```
┌──────────────────────────────────┐
│ 發布狀態：Testing 🟡              │
│                                  │
│ [PUBLISH APP] ← 點這裡           │
└──────────────────────────────────┘
```

##### 4. 確認發布
會出現確認對話框：

**情況 A：不需要驗證（您使用的是基本範圍）**
```
┌─────────────────────────────────────────┐
│ 發布應用程式？                          │
├─────────────────────────────────────────┤
│ 您的應用程式將可供所有 Google 使用者     │
│ 使用。                                  │
│                                         │
│ [取消]  [確認] ← 點這裡                 │
└─────────────────────────────────────────┘
```
✅ 點擊確認，立即生效！

**情況 B：需要驗證（您使用了敏感範圍）**
```
┌─────────────────────────────────────────┐
│ 需要驗證                                │
├─────────────────────────────────────────┤
│ 您的應用程式使用敏感或受限範圍，         │
│ 必須通過 Google 驗證才能發布。           │
│                                         │
│ 準備驗證需要：                          │
│ • 隱私政策 URL                          │
│ • 服務條款 URL                          │
│ • 應用程式首頁 URL                      │
│ • 應用程式標誌                          │
│                                         │
│ [取消]  [開始驗證]                      │
└─────────────────────────────────────────┘
```
⚠️ 驗證可能需要數週，不推薦個人專案使用

##### 5. 檢查您的 OAuth 範圍
回到「OAuth 同意畫面」，查看「範圍」區段：

如果只有這些，就可以直接發布：
```
✅ openid
✅ email
✅ profile
```

如果有這些，就需要驗證：
```
⚠️ https://www.googleapis.com/auth/drive
⚠️ https://www.googleapis.com/auth/gmail.send
⚠️ 其他敏感範圍
```

---

## 🔍 確認您目前的狀態

### 檢查清單

前往：https://console.cloud.google.com/apis/credentials/consent

1. **發布狀態**：
   - [ ] Testing（測試中）← 需要添加測試使用者
   - [ ] In production（已發布）← 任何人都能用

2. **User Type**：
   - [ ] External（外部）
   - [ ] Internal（內部）

3. **測試使用者**（如果是 Testing 狀態）：
   - [ ] 已添加您的 Email
   - [ ] 尚未添加

4. **OAuth 範圍**：
   - [ ] 只有基本範圍（openid, email, profile）
   - [ ] 有敏感範圍（Drive, Gmail 等）

---

## 💡 建議

### 如果是個人專案或小團隊
→ **保持 Testing 狀態 + 添加測試使用者**
- 優點：簡單快速
- 缺點：最多 100 個使用者

### 如果要公開分享
→ **發布應用程式（如果只用基本範圍）**
- 優點：任何人都能用
- 缺點：如果用敏感範圍，需要通過驗證

---

## 🧪 測試步驟

設定完成後：

1. **清除瀏覽器快取**（重要！）
   - Chrome: Ctrl + Shift + Delete
   - 選擇「Cookie 和其他網站資料」
   - 點擊「清除資料」

2. **訪問您的網站**
   https://pekomaster.github.io/ai-character-creator/platform.html

3. **打開開發者工具**（F12）
   - 切換到 Console 標籤

4. **點擊「登入 Google」**

5. **檢查結果**：
   - ✅ 成功：顯示頭像和名稱
   - ❌ 失敗：查看 Console 錯誤訊息

---

## ❌ 常見錯誤與解決

### 錯誤 1: "Access blocked: This app's request is invalid"
**原因**：授權來源設定錯誤
**解決**：檢查 OAuth 客戶端 ID 的「已授權的 JavaScript 來源」

### 錯誤 2: "This app is blocked"
**原因**：您的帳號不在測試使用者清單中
**解決**：添加您的 Email 到測試使用者

### 錯誤 3: "redirect_uri_mismatch"
**原因**：重新導向 URI 設定錯誤
**解決**：通常不需要設定，我們使用 Google Identity Services

### 錯誤 4: "origin_mismatch"
**原因**：授權來源不匹配
**解決**：確認已添加 `https://pekomaster.github.io`

---

## 📞 需要幫助？

如果還是無法登入，請提供：
1. 發布狀態（Testing / In production）
2. 是否已添加測試使用者
3. Console 的錯誤訊息截圖
4. 使用的 Google 帳號（不需要密碼！）
