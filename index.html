<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI è§’è‰²å¡å‰µä½œå·¥å…·</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- å¤–éƒ¨è³‡æº CDN -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

  <style>
    /* ===== CSS è®Šæ•¸å®šç¾© ===== */
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #a5b4fc;
      --secondary: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1e1b4b;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    /* ===== å…¨åŸŸæ¨£å¼ ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--gray-800);
      line-height: 1.6;
    }

    /* ===== ä¸»å®¹å™¨ ===== */
    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ===== é é¦– ===== */
    .header {
      text-align: center;
      padding: 30px 20px;
      color: white;
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    /* ===== æ§åˆ¶åˆ— ===== */
    .controls-bar {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .control-group label {
      font-weight: 500;
      color: var(--gray-700);
      white-space: nowrap;
    }

    /* ===== æ¨¡å¼åˆ‡æ›é–‹é—œ ===== */
    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: var(--gray-300);
      border-radius: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: var(--shadow);
    }

    .toggle-switch.active::after {
      transform: translateX(28px);
    }

    .mode-label {
      font-weight: 600;
      color: var(--primary);
      min-width: 60px;
    }

    /* ===== å¹³å°é¸æ“‡æŒ‰éˆ• ===== */
    .platform-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .platform-btn {
      padding: 10px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .platform-btn:hover {
      border-color: var(--primary-light);
      background: var(--gray-50);
    }

    .platform-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .platform-btn .icon {
      font-size: 1.1rem;
    }

    /* ===== ä¸»è¦å…§å®¹å€ ===== */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    /* ===== è¡¨å–®å€åŸŸ ===== */
    .form-panel {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .form-section {
      border-bottom: 1px solid var(--gray-200);
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .section-header {
      background: var(--gray-50);
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: background 0.2s;
    }

    .section-header:hover {
      background: var(--gray-100);
    }

    .section-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-header .icon {
      font-size: 1.2rem;
    }

    .section-toggle {
      font-size: 1.2rem;
      color: var(--gray-400);
      transition: transform 0.3s;
    }

    .section-header.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-content {
      padding: 20px;
      display: grid;
      gap: 16px;
    }

    .section-content.collapsed {
      display: none;
    }

    /* ===== è¡¨å–®æ¬„ä½ ===== */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-field.full-width {
      grid-column: 1 / -1;
    }

    .form-field label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-600);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-field label .required {
      color: var(--danger);
    }

    .form-field label .hint {
      font-weight: 400;
      color: var(--gray-400);
      font-size: 0.8rem;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 10px 14px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: white;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-field textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-field textarea.large {
      min-height: 150px;
    }

    /* ===== å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½æ¨™è¨˜ ===== */
    .full-mode-only {
      display: none;
    }

    .full-mode .full-mode-only {
      display: flex;
    }

    /* ===== é è¦½å€åŸŸ ===== */
    .preview-panel {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 200px);
      position: sticky;
      top: 20px;
    }

    .preview-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .preview-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preview-tabs {
      display: flex;
      gap: 4px;
    }

    .preview-tab {
      padding: 8px 16px;
      border: none;
      background: var(--gray-100);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .preview-tab:hover {
      background: var(--gray-200);
    }

    .preview-tab.active {
      background: var(--primary);
      color: white;
    }

    .preview-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* ===== è§’è‰²å¡é è¦½æ¨£å¼ ===== */
    .character-preview {
      display: none;
    }

    .character-preview.active {
      display: block;
    }

    .preview-card {
      background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius);
      padding: 24px;
    }

    .preview-card-header {
      text-align: center;
      padding-bottom: 20px;
      border-bottom: 2px dashed var(--gray-200);
      margin-bottom: 20px;
    }

    .preview-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .preview-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 4px;
    }

    .preview-aliases {
      color: var(--gray-500);
      font-style: italic;
    }

    .preview-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      margin-top: 12px;
    }

    .preview-tag {
      padding: 4px 10px;
      background: var(--primary-light);
      color: var(--primary-dark);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .preview-section {
      margin-bottom: 20px;
    }

    .preview-section:last-child {
      margin-bottom: 0;
    }

    .preview-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preview-section-content {
      color: var(--gray-700);
      font-size: 0.95rem;
      line-height: 1.7;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .preview-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .preview-item-label {
      font-size: 0.75rem;
      color: var(--gray-500);
      text-transform: uppercase;
    }

    .preview-item-value {
      font-weight: 500;
      color: var(--gray-700);
    }

    .preview-first-message {
      background: var(--gray-100);
      border-left: 4px solid var(--primary);
      padding: 16px;
      border-radius: 0 8px 8px 0;
      font-style: italic;
      color: var(--gray-600);
    }

    /* ===== ç¨‹å¼ç¢¼é è¦½ ===== */
    .code-preview {
      display: none;
      height: 100%;
    }

    .code-preview.active {
      display: block;
    }

    .code-preview pre {
      background: var(--gray-900);
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.85rem;
      line-height: 1.6;
      max-height: 500px;
      overflow-y: auto;
    }

    /* ===== åŒ¯å‡ºæŒ‰éˆ•å€ ===== */
    .export-buttons {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .export-btn {
      flex: 1;
      min-width: 100px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .export-btn.json {
      background: var(--warning);
      color: white;
    }

    .export-btn.yaml {
      background: var(--success);
      color: white;
    }

    .export-btn.markdown {
      background: var(--primary);
      color: white;
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* ===== æç¤ºè¨Šæ¯ ===== */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: var(--gray-800);
      color: white;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    /* ===== éŸ¿æ‡‰å¼èª¿æ•´ ===== */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .control-group {
        flex-direction: column;
        align-items: flex-start;
      }

      .platform-buttons {
        width: 100%;
        justify-content: center;
      }

      .preview-panel {
        position: relative;
        max-height: none;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .preview-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ===== è¨­å®šèˆ‡ç™»å…¥æŒ‰éˆ• ===== */
    .settings-login-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .icon-btn {
      padding: 10px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn:hover {
      border-color: var(--primary);
      background: var(--gray-50);
    }

    .icon-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .icon-btn.primary:hover {
      background: var(--primary-dark);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: var(--gray-50);
      border-radius: 8px;
      border: 2px solid var(--gray-200);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--primary);
    }

    .user-name {
      font-weight: 500;
      color: var(--gray-700);
    }

    /* ===== Modal å½ˆçª— ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--gray-200);
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-400);
      transition: color 0.2s;
      padding: 5px;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--gray-700);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .setting-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .setting-item label {
      font-weight: 600;
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .setting-item input {
      padding: 10px 14px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: 'Courier New', monospace;
    }

    .setting-item input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .setting-item .hint {
      font-size: 0.85rem;
      color: var(--gray-500);
      line-height: 1.5;
    }

    .setting-item .hint a {
      color: var(--primary);
      text-decoration: none;
    }

    .setting-item .hint a:hover {
      text-decoration: underline;
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid var(--gray-200);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn.primary {
      background: var(--primary);
      color: white;
    }

    .btn.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn.secondary {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .btn.secondary:hover {
      background: var(--gray-300);
    }

    /* ===== éª°å­æŒ‰éˆ• ===== */
    .dice-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .dice-btn:hover {
      background: var(--primary);
      transform: rotate(360deg);
    }

    /* ===== å¿«é€Ÿæ¨™ç±¤ ===== */
    .quick-tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      padding: 10px;
      background: var(--gray-50);
      border-radius: 8px;
      border: 1px dashed var(--gray-300);
    }

    .quick-tag {
      padding: 4px 10px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 16px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--gray-700);
      user-select: none;
    }

    .quick-tag:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* ===== PNG åŒ¯å‡ºæŒ‰éˆ•æ¨£å¼ ===== */
    .export-btn.png-card {
      background: var(--secondary);
      color: white;
    }

    .export-btn.png-yaml {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* ===== YAML åœ–ç‰‡å¡ç‰‡æ¨£å¼ ===== */
    #yamlImageContainer {
      position: fixed;
      top: -9999px;
      left: -9999px;
    }

    .yaml-code-card {
      width: 1000px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border-radius: 12px;
      overflow: hidden;
    }

    .yaml-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 30px;
      color: white;
    }

    .yaml-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .yaml-title .icon {
      font-size: 1.8rem;
    }

    .yaml-title .platform {
      font-size: 0.9rem;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: auto;
    }

    .yaml-meta {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .yaml-body {
      padding: 30px;
      background: #1e1e1e;
    }

    .yaml-content {
      color: #d4d4d4;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }

    .yaml-footer {
      padding: 15px 30px;
      background: #252525;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
      border-top: 1px solid #333;
    }

    /* åŒ¯å‡ºæ¨¡å¼ï¼šéš±è—ä¸éœ€è¦çš„å…ƒç´  */
    .preview-card.export-mode {
      /* ä¿æŒç¾æœ‰æ¨£å¼ */
    }

    /* ===== å‹•ç•« ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-section {
      animation: fadeIn 0.3s ease-out;
    }

    /* ===== å‹•æ…‹æ¬„ä½ç³»çµ± ===== */
    .dynamic-fields-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .dynamic-field-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      animation: fadeIn 0.3s ease-out;
    }

    .dynamic-field-row .form-field {
      flex: 1;
      margin: 0;
    }

    .dynamic-field-row .form-field input,
    .dynamic-field-row .form-field textarea {
      width: 100%;
    }

    .dynamic-field-row .field-controls {
      display: flex;
      gap: 5px;
      padding-top: 8px;
    }

    .dynamic-field-row .dice-btn,
    .dynamic-field-row .remove-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .dynamic-field-row .remove-btn {
      background: var(--danger);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dynamic-field-row .remove-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .dynamic-field-row .remove-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .add-field-btn {
      align-self: flex-start;
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .add-field-btn:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .dynamic-field-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .dynamic-field-header label {
      flex: 1;
      margin: 0;
    }

    /* ===== é›²ç«¯ç®¡ç† ===== */
    .cloud-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .cloud-actions .btn {
      flex: 1;
    }

    .cloud-list h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--gray-700);
    }

    #cloudCharacterList {
      max-height: 400px;
      overflow-y: auto;
    }

    .cloud-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .cloud-item:hover {
      border-color: var(--primary);
      background: var(--gray-50);
    }

    .cloud-item-info {
      flex: 1;
    }

    .cloud-item-name {
      font-weight: 500;
      color: var(--gray-800);
      margin-bottom: 5px;
    }

    .cloud-item-meta {
      font-size: 0.85rem;
      color: var(--gray-500);
    }

    .cloud-item-actions {
      display: flex;
      gap: 8px;
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .loading, .empty-state, .error-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-500);
    }

    .error-state {
      color: var(--danger);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é é¦– -->
    <header class="header">
      <h1>ğŸ­ AI è§’è‰²å¡å‰µä½œå·¥å…·</h1>
      <p>å‰µå»ºå°ˆæ¥­çš„ AI äº’å‹•è§’è‰²å¡ï¼Œæ”¯æ´å¤šå¹³å°æ ¼å¼è¼¸å‡º</p>
    </header>

    <!-- æ§åˆ¶åˆ— -->
    <div class="controls-bar">
      <div class="control-group mode-toggle">
        <label>æ¨¡å¼ï¼š</label>
        <div class="toggle-switch" id="modeToggle" onclick="toggleMode()"></div>
        <span class="mode-label" id="modeLabel">ç²¾ç°¡ç‰ˆ</span>
      </div>

      <div class="control-group">
        <label>ç›®æ¨™å¹³å°ï¼š</label>
        <div class="platform-buttons">
          <button class="platform-btn active" data-platform="gemini" onclick="selectPlatform('gemini')">
            <span class="icon">ğŸŒŸ</span> Gemini 3.0
          </button>
          <button class="platform-btn" data-platform="sillytavern" onclick="selectPlatform('sillytavern')">
            <span class="icon">ğŸº</span> SillyTavern
          </button>
          <button class="platform-btn" data-platform="risuai" onclick="selectPlatform('risuai')">
            <span class="icon">ğŸ¿ï¸</span> RisuAI
          </button>
          <button class="platform-btn" data-platform="characterai" onclick="selectPlatform('characterai')">
            <span class="icon">ğŸ’¬</span> Character.AI
          </button>
        </div>
      </div>

      <div class="settings-login-group">
        <!-- AI ç”ŸæˆæŒ‰éˆ• -->
        <button class="icon-btn primary" onclick="App.ai.generateCharacter()" title="AI ä¸€éµå‰µè§’">
          âœ¨ AI ç”Ÿæˆ
        </button>

        <!-- åŒ¯å…¥æŒ‰éˆ• -->
        <button class="icon-btn" onclick="document.getElementById('importFile').click()" title="åŒ¯å…¥æª”æ¡ˆ">
          ğŸ“¥ åŒ¯å…¥
        </button>
        <input type="file" id="importFile" accept=".json,.yaml,.yml,.md,.png,.jpg,.jpeg,.webp" style="display: none;" onchange="handleFileImport(event)">

        <!-- ç”¨æˆ¶è³‡è¨Šå€ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰-->
        <div class="user-info" id="userInfo" style="display: none;">
          <img class="user-avatar" id="userAvatar" src="" alt="User">
          <span class="user-name" id="userName"></span>
          <button class="icon-btn" onclick="App.auth.logout()" title="ç™»å‡º">ğŸšª</button>
        </div>

        <!-- ç™»å…¥æŒ‰éˆ•ï¼ˆæœªç™»å…¥æ™‚é¡¯ç¤ºï¼‰- å·²åœç”¨ -->
        <button class="icon-btn primary" id="loginBtn" onclick="App.auth.login()" title="Google ç™»å…¥" style="display: none;">
          ğŸ” ç™»å…¥
        </button>

        <!-- é›²ç«¯è§’è‰²å¡æŒ‰éˆ•ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰- å·²åœç”¨ -->
        <button class="icon-btn" id="cloudBtn" onclick="App.ui.openCloudManager()" title="é›²ç«¯è§’è‰²å¡" style="display: none;">
          â˜ï¸ é›²ç«¯
        </button>

        <!-- è¨­å®šæŒ‰éˆ• -->
        <button class="btn secondary" onclick="App.ui.openSettings()" style="padding: 8px 16px;">
          ğŸ¤– è¨­å®š AI API
        </button>
      </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content">
      <!-- è¡¨å–®å€åŸŸ -->
      <div class="form-panel" id="formPanel">
        
        <!-- åŸºæœ¬è³‡è¨Š -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“‹</span> åŸºæœ¬è³‡è¨Š</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>è§’è‰²é ­åƒç¶²å€ <span class="hint">(åœ–ç‰‡ URL)</span></label>
              <input type="url" id="avatarUrl" placeholder="https://example.com/avatar.jpg" oninput="updatePreview()">
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>
                  è§’è‰²åç¨± <span class="required">*</span>
                  <button class="dice-btn" onclick="App.ui.rollDice('name')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="name" placeholder="ä¾‹ï¼šè‰¾è‰è¥¿äº" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>åˆ¥å/æš±ç¨± <span class="hint">(é€—è™Ÿåˆ†éš”)</span></label>
                <input type="text" id="aliases" placeholder="ä¾‹ï¼šå°è‰¾, å†°éœœå¥³ç‹" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>
                  å¹´é½¡
                  <button class="dice-btn" onclick="App.ui.rollDice('age')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="age" placeholder="ä¾‹ï¼š23 æ­²" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>æ€§åˆ¥</label>
                <select id="gender" onchange="updatePreview()">
                  <option value="">-- é¸æ“‡ --</option>
                  <option value="å¥³æ€§">å¥³æ€§</option>
                  <option value="ç”·æ€§">ç”·æ€§</option>
                  <option value="éäºŒå…ƒ">éäºŒå…ƒ</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>
                  ç¨®æ—/ç‰©ç¨®
                  <button class="dice-btn" onclick="App.ui.rollDice('species')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="species" placeholder="ä¾‹ï¼šåŠç²¾éˆ" oninput="updatePreview()">
                <div class="quick-tags-container" id="speciesTags"></div>
              </div>
              <div class="form-field">
                <label>
                  è·æ¥­/èº«ä»½
                  <button class="dice-btn" onclick="App.ui.rollDice('occupation')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="occupation" placeholder="ä¾‹ï¼šçš‡å®¶åœ–æ›¸é¤¨ç®¡ç†å“¡" oninput="updatePreview()">
                <div class="quick-tags-container" id="occupationTags"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- å¤–è§€æè¿° -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ‘¤</span> å¤–è§€æè¿°</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>
                æ•´é«”å¤–è§€æ¦‚è¿°
                <button class="dice-btn" onclick="App.ui.rollDice('appearance')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
              </label>
              <textarea id="appearance" placeholder="ç°¡çŸ­æè¿°è§’è‰²çš„æ•´é«”å¤–è§€ç‰¹å¾µ..." oninput="updatePreview()"></textarea>
              <div class="quick-tags-container" id="appearanceTags"></div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>èº«é«˜</label>
                <input type="text" id="height" placeholder="ä¾‹ï¼š165cm" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>é«”å‹</label>
                <input type="text" id="bodyType" placeholder="ä¾‹ï¼šçº–ç´°" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  é«®è‰²
                  <button class="dice-btn" onclick="App.ui.rollDice('hair')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="hairColor" placeholder="ä¾‹ï¼šéŠ€ç™½è‰²" oninput="updatePreview()">
                <div class="quick-tags-container" id="hairTags"></div>
              </div>
              <div class="form-field">
                <label>é«®å‹</label>
                <input type="text" id="hairStyle" placeholder="ä¾‹ï¼šé•·é«®ï¼ŒåŠè…°" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  çœ¼ç›é¡è‰²
                  <button class="dice-btn" onclick="App.ui.rollDice('eyes')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="eyes" placeholder="ä¾‹ï¼šå†°è—è‰²ç³å­”" oninput="updatePreview()">
                <div class="quick-tags-container" id="eyesTags"></div>
              </div>
              <div class="form-field">
                <label>
                  æœè£é¢¨æ ¼
                  <button class="dice-btn" onclick="App.ui.rollDice('clothing')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="clothing" placeholder="ä¾‹ï¼šåå¥½æ·±è‰²é•·è¢" oninput="updatePreview()">
                <div class="quick-tags-container" id="clothingTags"></div>
              </div>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>ç‰¹æ®Šæ¨™è¨˜ <span class="hint">(ç–¤ç—•ã€åˆºé’ã€é…ä»¶ç­‰)</span></label>
              <input type="text" id="features" placeholder="ä¾‹ï¼šå·¦çœ¼ä¸‹æ–¹æœ‰æœˆç‰™å½¢èƒè¨˜" oninput="updatePreview()">
            </div>
          </div>
        </div>

        <!-- æ€§æ ¼ç‰¹è³ª -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ’­</span> æ€§æ ¼ç‰¹è³ª</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>
                æ€§æ ¼æ‘˜è¦
                <button class="dice-btn" onclick="App.ui.rollDice('personality')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
              </label>
              <textarea id="personality" placeholder="æè¿°è§’è‰²çš„æ ¸å¿ƒæ€§æ ¼ç‰¹å¾µ..." oninput="updatePreview()"></textarea>
              <div class="quick-tags-container" id="personalityTags"></div>
            </div>
            <div class="form-field full-width">
              <label>ç‰¹è³ªæ¨™ç±¤ <span class="hint">(é€—è™Ÿåˆ†éš”)</span></label>
              <input type="text" id="traits" placeholder="ä¾‹ï¼šå…§å‘, å–„è‰¯, å›ºåŸ·, å¥½å¥‡å¿ƒå¼·" oninput="updatePreview()">
              <div class="quick-tags-container" id="traitsTags"></div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>å„ªé»</label>
                <input type="text" id="strengths" placeholder="ä¾‹ï¼šè°æ˜, æœ‰è€å¿ƒ, å¿ èª " oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>ç¼ºé»/å¼±é»</label>
                <input type="text" id="weaknesses" placeholder="ä¾‹ï¼šéåº¦è¬¹æ…, ä¸å–„äº¤éš›" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>å–œå¥½</label>
                <input type="text" id="likes" placeholder="ä¾‹ï¼šé–±è®€, ä¸‹é›¨å¤©, èŒ¶" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>å­æƒ¡</label>
                <input type="text" id="dislikes" placeholder="ä¾‹ï¼šå™ªéŸ³, è¬Šè¨€, äººç¾¤" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>ææ‡¼</label>
                <input type="text" id="fears" placeholder="ä¾‹ï¼šå¤±å»è¨˜æ†¶, èƒŒå›" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>ç›®æ¨™/å‹•æ©Ÿ</label>
                <input type="text" id="goals" placeholder="ä¾‹ï¼šå°‹æ‰¾å¤±è½çš„å¤ç±" oninput="updatePreview()">
              </div>
            </div>
          </div>
        </div>

        <!-- èƒŒæ™¯æ•…äº‹ -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“–</span> èƒŒæ™¯æ•…äº‹</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <label>å‡ºç”Ÿåœ°</label>
              <input type="text" id="birthplace" placeholder="ä¾‹ï¼šåŒ—æ–¹é›ªåœ‹çš„å°æ‘èŠ" oninput="updatePreview()">
            </div>
            <div class="form-field full-width full-mode-only">
              <label>
                èƒŒæ™¯æ•…äº‹
                <button class="dice-btn" onclick="App.ui.rollDice('backstory')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
              </label>
              <textarea id="backstory" class="large" placeholder="æè¿°è§’è‰²çš„éå»ç¶“æ­·ã€æˆé•·èƒŒæ™¯..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>é‡è¦äº‹ä»¶</label>
              <textarea id="keyEvents" placeholder="å½¢å¡‘è§’è‰²çš„é—œéµç¶“æ­·..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>äººéš›é—œä¿‚ <span class="hint">(åç¨±èˆ‡é—œä¿‚æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="relationshipsContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('relationships')">
                â• æ–°å¢äººéš›é—œä¿‚
              </button>
            </div>
          </div>
        </div>

        <!-- æˆ°é¬¥èˆ‡ç”Ÿæ´»æŠ€èƒ½ -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">âš”ï¸</span> æˆ°é¬¥èˆ‡ç”Ÿæ´»æŠ€èƒ½</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>æˆ°é¬¥æŠ€èƒ½ <span class="hint">(æŠ€èƒ½åç¨±èˆ‡ç­‰ç´š/æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="combatSkillsContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('combatSkills')">
                â• æ–°å¢æˆ°é¬¥æŠ€èƒ½
              </button>
            </div>
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>ç”Ÿæ´»æŠ€èƒ½ <span class="hint">(æŠ€èƒ½åç¨±èˆ‡ç­‰ç´š/æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="lifeSkillsContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('lifeSkills')">
                â• æ–°å¢ç”Ÿæ´»æŠ€èƒ½
              </button>
            </div>
          </div>
        </div>

        <!-- è‡ªè¨‚å±¬æ€§ -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“Š</span> è‡ªè¨‚å±¬æ€§</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>è‡ªè¨‚å±¬æ€§ <span class="hint">(å±¬æ€§åç¨±èˆ‡å€¼/ç­‰ç´š/æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="customAttributesContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('customAttributes')">
                â• æ–°å¢è‡ªè¨‚å±¬æ€§
              </button>
            </div>
          </div>
        </div>

        <!-- å°è©±é¢¨æ ¼ -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ—£ï¸</span> å°è©±é¢¨æ ¼</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>èªªè©±æ–¹å¼ <span class="hint">(æƒ…å¢ƒèˆ‡å°è©±ç¯„ä¾‹)</span></label>
              </div>
              <div class="dynamic-fields-container" id="speechStyleContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('speechStyle')">
                â• æ–°å¢èªªè©±æ–¹å¼
              </button>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>å£é ­ç¦ª <span class="hint">(é€—è™Ÿåˆ†éš”)</span></label>
                <input type="text" id="catchphrases" placeholder="ä¾‹ï¼šæœ‰è¶£å‘¢..., è®“æˆ‘æƒ³æƒ³" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>èªè¨€ç¿’æ…£</label>
                <input type="text" id="verbalTics" placeholder="ä¾‹ï¼šå¥å°¾å¸¸åŠ ã€Œå‘¢ã€" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>æƒ…ç·’è¡¨é”æ–¹å¼</label>
              <textarea id="emotionalExpression" placeholder="é–‹å¿ƒ/ç”Ÿæ°£/å®³ç¾æ™‚çš„åæ‡‰..." oninput="updatePreview()"></textarea>
            </div>
          </div>
        </div>

        <!-- AI æ ¸å¿ƒè¨­å®š -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ¤–</span> AI æ ¸å¿ƒè¨­å®š</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>è§’è‰²æè¿° <span class="hint">(çµ¦ AI çš„å®Œæ•´æè¿°)</span></label>
              <textarea id="description" class="large" placeholder="é€™æ˜¯çµ¦ AI é–±è®€çš„å®Œæ•´è§’è‰²æè¿°ï¼Œå¯æ•´åˆä¸Šè¿°æ‰€æœ‰è³‡è¨Š..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>ç³»çµ±æç¤º <span class="hint">(System Prompt)</span></label>
              <textarea id="systemPrompt" class="large" placeholder="çµ¦ AI çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šä½ æ˜¯{{char}}ï¼Œè«‹ä»¥ç¬¬ä¸€äººç¨±å›æ‡‰..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width">
              <label>ç¬¬ä¸€å‰‡è¨Šæ¯ <span class="hint">(å°è©±é–‹å§‹æ™‚è§’è‰²èªªçš„è©±)</span></label>
              <textarea id="firstMessage" class="large" placeholder="*å¥¹æŠ¬èµ·é ­ï¼Œå¾æ›¸æœ¬ä¸­æœ›å‘ä½ * ã€Œå•Šï¼Œæœ‰å®¢äººå—ï¼Ÿæ­¡è¿ä¾†åˆ°åœ–æ›¸é¤¨ã€‚ã€" oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>ç¯„ä¾‹å°è©±</label>
              <textarea id="exampleDialogues" class="large" placeholder="å±•ç¤ºè§’è‰²å¦‚ä½•å›æ‡‰çš„ç¯„ä¾‹å°è©±..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>åˆæ¬¡ç›¸é‡åœ°é» <span class="hint">(ç•™ç©ºç‚º AI åŠ‡æƒ…è‡ªç”±ç™¼æ®)</span></label>
              <textarea id="scenario" placeholder="ä¾‹ï¼šåœ¨ç†±é¬§çš„è™›æ“¬ç›´æ’­é–“ã€åœ¨å¯§éœçš„åœ–æ›¸é¤¨..." oninput="updatePreview()"></textarea>
            </div>
          </div>
        </div>

        <!-- å…ƒè³‡æ–™ -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“</span> å…ƒè³‡æ–™</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>æ¨™ç±¤ <span class="hint">(é€—è™Ÿåˆ†éš”ï¼Œç”¨æ–¼åˆ†é¡)</span></label>
              <input type="text" id="tags" placeholder="ä¾‹ï¼šå¥‡å¹», åœ–æ›¸é¤¨å“¡, ç¥ç§˜, æº«æŸ”" oninput="updatePreview()">
            </div>
            <div class="form-field full-width full-mode-only">
              <label>ä¸–ç•Œè§€</label>
              <textarea id="worldLore" placeholder="è§’è‰²æ‰€è™•çš„ä¸–ç•Œè¨­å®š..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>å‰µä½œè€…</label>
                <input type="text" id="creator" placeholder="æ‚¨çš„åå­—" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>ç‰ˆæœ¬</label>
                <input type="text" id="version" placeholder="1.0" value="1.0" oninput="updatePreview()">
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- é è¦½å€åŸŸ -->
      <div class="preview-panel">
        <div class="preview-header">
          <h3>ğŸ‘ï¸ é è¦½</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div class="preview-tabs">
              <button class="preview-tab active" onclick="switchPreviewTab('card')">è§’è‰²å¡</button>
              <button class="preview-tab" onclick="switchPreviewTab('json')">JSON</button>
              <button class="preview-tab" onclick="switchPreviewTab('yaml')">YAML</button>
              <button class="preview-tab" onclick="switchPreviewTab('markdown')">Markdown</button>
            </div>
            <button class="icon-btn" id="copyPreviewBtn" onclick="copyPreviewContent()" title="è¤‡è£½å…§å®¹" style="display: none;">
              ğŸ“‹
            </button>
          </div>
        </div>

        <div class="preview-content">
          <!-- è§’è‰²å¡è¦–è¦ºé è¦½ -->
          <div class="character-preview active" id="previewCard">
            <div class="preview-card">
              <div class="preview-card-header">
                <div class="preview-avatar" id="previewAvatar">ğŸ­</div>
                <div class="preview-name" id="previewName">æœªå‘½åè§’è‰²</div>
                <div class="preview-aliases" id="previewAliases"></div>
                <div class="preview-tags" id="previewTags"></div>
              </div>

              <div class="preview-section" id="previewBasicInfo">
                <div class="preview-section-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
                <div class="preview-grid" id="previewBasicGrid"></div>
              </div>

              <div class="preview-section" id="previewAppearanceSection" style="display: none;">
                <div class="preview-section-title">ğŸ‘¤ å¤–è§€</div>
                <div class="preview-section-content" id="previewAppearance"></div>
              </div>

              <div class="preview-section" id="previewPersonalitySection" style="display: none;">
                <div class="preview-section-title">ğŸ’­ æ€§æ ¼</div>
                <div class="preview-section-content" id="previewPersonality"></div>
              </div>

              <div class="preview-section" id="previewBackstorySection" style="display: none;">
                <div class="preview-section-title">ğŸ“– èƒŒæ™¯</div>
                <div class="preview-section-content" id="previewBackstory"></div>
              </div>

              <div class="preview-section" id="previewFirstMessageSection" style="display: none;">
                <div class="preview-section-title">ğŸ’¬ ç¬¬ä¸€å‰‡è¨Šæ¯</div>
                <div class="preview-first-message" id="previewFirstMessage"></div>
              </div>
            </div>
          </div>

          <!-- JSON é è¦½ -->
          <div class="code-preview" id="previewJSON">
            <pre id="jsonCode"></pre>
          </div>

          <!-- YAML é è¦½ -->
          <div class="code-preview" id="previewYAML">
            <pre id="yamlCode"></pre>
          </div>

          <!-- Markdown é è¦½ -->
          <div class="code-preview" id="previewMarkdown">
            <pre id="markdownCode"></pre>
          </div>
        </div>

        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
        <div class="export-buttons">
          <button class="export-btn json" onclick="exportFile('json')">
            <span>ğŸ“¦</span> åŒ¯å‡º JSON
          </button>
          <button class="export-btn yaml" onclick="exportFile('yaml')">
            <span>ğŸ“„</span> åŒ¯å‡º YAML
          </button>
          <button class="export-btn markdown" onclick="exportFile('markdown')">
            <span>ğŸ“</span> åŒ¯å‡º Markdown
          </button>
          <button class="export-btn png-card" onclick="exportCharacterCardImage()">
            <span>ğŸ–¼ï¸</span> åŒ¯å‡ºè§’è‰²å¡åœ–ç‰‡
          </button>
          <button class="export-btn png-yaml" onclick="exportYAMLImage()">
            <span>ğŸ¨</span> åŒ¯å‡º YAML åœ–ç‰‡
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æç¤ºè¨Šæ¯ -->
  <div class="toast" id="toast"></div>

  <!-- è¨­å®šå½ˆçª— -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âš™ï¸ è¨­å®š</h2>
        <button class="modal-close" onclick="App.ui.closeSettings()">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="setting-item">
          <label>ğŸ¤– Gemini API Key</label>
          <input type="text" id="geminiApiKey" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key">
          <div class="hint">
            ç”¨æ–¼ AI ä¸€éµå‰µè§’åŠŸèƒ½ã€‚è«‹å…ˆé»æ“Šä¸‹æ–¹é€£çµç”³è«‹æ‚¨çš„ API Keyï¼Œç„¶å¾Œåœ¨æ­¤è™•è²¼ä¸Šå³å¯é–‹å§‹ä½¿ç”¨ AI è‡ªå‹•ç”Ÿæˆè§’è‰²è³‡æ–™åŠŸèƒ½ï¼
            <br><br>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-weight: bold; color: #1a73e8;">ğŸ‘‰ å‰å¾€ Google AI Studio ç”³è«‹ API Key</a>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="App.ui.closeSettings()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="App.settings.save()">å„²å­˜è¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- é›²ç«¯è§’è‰²å¡ Modal -->
  <div class="modal" id="cloudModal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>â˜ï¸ é›²ç«¯è§’è‰²å¡</h2>
        <button class="modal-close" onclick="App.ui.closeCloudManager()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="cloud-actions">
          <button class="btn primary" onclick="App.ui.saveToCloud()">
            ğŸ’¾ å„²å­˜ç›®å‰è§’è‰²åˆ°é›²ç«¯
          </button>
          <button class="btn secondary" onclick="App.ui.loadCloudCharacters()">
            ğŸ”„ é‡æ–°è¼‰å…¥
          </button>
        </div>
        <div class="cloud-list">
          <h3>æˆ‘çš„è§’è‰²å¡</h3>
          <div id="cloudCharacterList">
            <!-- è§’è‰²å¡åˆ—è¡¨å°‡ç”± JavaScript ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- YAML åœ–ç‰‡æ¸²æŸ“å®¹å™¨ï¼ˆéš±è—ï¼‰-->
  <div id="yamlImageContainer">
    <div class="yaml-code-card">
      <div class="yaml-header">
        <div class="yaml-title">
          <span class="icon">ğŸ“„</span>
          <span class="name">è§’è‰²åç¨±</span>
          <span class="platform">Gemini 3.0</span>
        </div>
        <div class="yaml-meta">ç”Ÿæˆæ™‚é–“ï¼š2025-11-28 12:34:56</div>
      </div>
      <div class="yaml-body">
        <pre><code class="yaml-content"></code></pre>
      </div>
      <div class="yaml-footer">
        ğŸ¤– Generated by AI è§’è‰²å¡å‰µä½œå·¥å…·
      </div>
    </div>
  </div>

  <script>
    // ===== éŒ¯èª¤è™•ç† =====
    window.addEventListener('error', function(e) {
      console.error('å…¨åŸŸéŒ¯èª¤:', e.message, e.filename, e.lineno, e.colno);
      return false;
    });

    // ===== ä¸»æ‡‰ç”¨ç¨‹å¼ç‰©ä»¶ =====
    const App = {
      // ç‹€æ…‹ç®¡ç†
      state: {
        isFullMode: false,
        currentPlatform: 'gemini',
        currentPreviewTab: 'card',
        user: null,
        accessToken: null
      },

      // ç¯„ä¾‹è³‡æ–™åº«ï¼ˆç”¨æ–¼éª°å­å¿«é€Ÿç”Ÿæˆï¼‰- Hololive æˆå“¡
      exampleData: {
        name: ['ç™½ä¸Šå¹é›ª', 'æ¹Šé˜¿åº«å©­', 'å¤§ç©ºæ˜´', 'Gawr Gura', 'å¯¶é˜ç‘ªç³', 'å…”ç”°ä½©å…‹æ‹‰', 'æ˜Ÿè¡—å½—æ˜Ÿ', 'ç´«å’²è©©éŸ³', 'ç™½éŠ€è«¾è‰¾çˆ¾', 'ä¸çŸ¥ç«èŠ™è•¾é›…'],
        age: ['ä¸æ˜', '5æ­²ï¼ˆè‡ªç¨±ï¼‰', 'æ°¸é çš„17æ­²', '9000+æ­²', '17æ­²ï¼ˆè‡ªç¨±ï¼‰', '111æ­²', '18æ­²', 'ä¸è©³', '19æ­²', 'åŠç²¾éˆå¹´é½¡'],
        species: ['ç™½é«®ç‹å¨˜', 'æµ·ä¹‹å¥³åƒ•', 'äººé¡', 'äºç‰¹è˜­ææ–¯é¯Šé­š', 'æµ·è³Šèˆ¹é•·', 'å…”å¨˜', 'å½—æ˜Ÿ', 'é­”å¥³', 'éŠ€é«®é¨å£«', 'åŠç²¾éˆ'],
        occupation: ['VTuber', 'å¥³åƒ•', 'é‹å‹•ç³» VTuber', 'é¯Šé­šå¶åƒ', 'æµ·è³Šèˆ¹é•·', 'æˆ°çˆ­ç½ªçŠ¯ï¼ˆè‡ªç¨±ï¼‰', 'æ­Œå§¬', 'é­”æ³•å°‘å¥³', 'é¨å£«åœ˜é•·', 'ç²¾éˆå¼“æ‰‹'],
        personality: ['å®³ç¾ä½†å–œæ„›äº¤æµï¼Œæ“æœ‰ç”œç¾è²éŸ³ï¼Œå–„æ–¼è§’è‰²æ‰®æ¼”', 'åŠªåŠ›ä½†å†’å¤±ï¼Œæœ‰æ™‚æœƒçŠ¯è¿·ç³Šçš„éŒ¯èª¤ï¼Œå……æ»¿æ´»åŠ›', 'è‡ªç”±å¥”æ”¾ï¼Œæœæ°£è“¬å‹ƒï¼Œå…·æœ‰å¼·çƒˆè—äººé­‚', 'è°æ˜æ©Ÿæ™ºä½†ç¬¨æ‹™å¯æ„›ï¼Œå–œæ­¡å”±æ­Œå’Œç©éŠæˆ²', 'è‡ªä¿¡é–‹æœ—ï¼Œæ“…é•·èªªé»ƒæ®µå­ï¼Œç†±æ„›å¨›æ¨‚è§€çœ¾', 'å–œæ­¡æƒ¡ä½œåŠ‡ï¼Œç¬‘è²ç¨ç‰¹ï¼Œå……æ»¿å…”å­èˆ¬çš„æ´»åŠ›', 'èªçœŸåŠªåŠ›ï¼Œæ­Œè²å‹•äººï¼Œå°éŸ³æ¨‚å……æ»¿ç†±æƒ…', 'ä»»æ€§å‚²å¬Œï¼Œé­”å¥³é¢¨æ ¼ï¼Œå–œæ­¡è¢«å¯µæ„›', 'æº«æŸ”é«”è²¼ï¼Œè²éŸ³æ²»ç™’ï¼Œæœ‰å¼·çƒˆçš„æ­£ç¾©æ„Ÿ', 'æˆç†Ÿç©©é‡ï¼Œè²éŸ³ç£æ€§ï¼Œæ“…é•·ç…§é¡§ä»–äºº'],
        appearance: ['éŠ€ç™½è‰²é•·é«®ï¼Œç‹è€³ç‹å°¾ï¼Œå†°è—è‰²çœ¼çœ¸', 'ç´«è‰²é›™é¦¬å°¾é…æ°´è—è‰²æŒ‘æŸ“ï¼Œæµ·è»å¥³åƒ•æœ', 'æ´»åŠ›çŸ­é«®ï¼Œé‹å‹•æœè£ï¼Œå……æ»¿æœæ°£', 'ç°è—è‰²é•·é«®ï¼Œé¯Šé­šå°¾å·´ï¼Œè—è‰²çœ¼ç›', 'ç´…è‰²é›™é¦¬å°¾ï¼Œæµ·è³Šè£æ‰®ï¼Œçœ¼ç½©é…é£¾', 'è—è‰²å…”è€³ï¼Œç´…æ©™è‰²é›™é¦¬å°¾ï¼Œæ´»æ½‘æ‰“æ‰®', 'æ˜Ÿç©ºè—çŸ­é«®ï¼Œæ˜Ÿæ˜Ÿé«®é£¾ï¼Œå¶åƒæœè£', 'ç´«è‰²é›™å°¾ï¼Œé­”å¥³å¸½ï¼Œå“¥å¾·è˜¿è‰é¢¨', 'éŠ€è‰²é•·é«®ï¼Œé¨å£«ç›”ç”²ï¼Œå„ªé›…æ°£è³ª', 'æ·±è¤è‰²é•·é«®ï¼Œç²¾éˆè€³æœµï¼Œå¼“ç®­æ‰‹è£æ‰®'],
        backstory: ['ä½œç‚º GAMERS çš„ä¸€å“¡åœ¨è™›æ“¬ä¸–ç•Œæ´»èºï¼Œä»¥å¤šæ‰å¤šè—èå', 'å¾ç•°ä¸–ç•Œä¾†åˆ°äººé–“ç•¶å¥³åƒ•ï¼ŒåŠªåŠ›é©æ‡‰äººé¡ä¸–ç•Œ', 'æ™®é€šé«˜ä¸­ç”Ÿæ„å¤–æˆç‚º VTuberï¼Œç”¨æ´»åŠ›æ„ŸæŸ“æ‰€æœ‰äºº', 'ä¾†è‡ªäºç‰¹è˜­ææ–¯çš„é¯Šé­šï¼Œå¤±è½åœ¨äººé¡ä¸–ç•Œä¸­', 'æ›¾æ˜¯æµ·ä¸Šéœ¸ä¸»ï¼Œç¾åœ¨æ”¹è¡Œç•¶ VTuber å¨›æ¨‚å¤§çœ¾', 'å¾ç•°ä¸–ç•Œä¾†çš„å…”å­ï¼Œå–œæ­¡åœ¨éŠæˆ²ä¸–ç•Œä¸­æƒ¡ä½œåŠ‡', 'å¾å½—æ˜Ÿé™è‡¨åœ°çƒï¼Œç”¨æ­Œè²å‚³é”ä¾†è‡ªæ˜Ÿç©ºçš„è¨Šæ¯', 'é­”ç•Œçš„é­”å¥³ï¼Œä¾†åˆ°äººé–“å°‹æ‰¾æœ‰è¶£çš„äº‹ç‰©', 'é¨å£«åœ˜çš„åœ˜é•·ï¼Œç‚ºäº†å®ˆè­·é‡è¦çš„äººè€Œæˆ°é¬¥', 'æ£®æ—çš„ç²¾éˆï¼Œç‚ºäº†å°‹æ‰¾å¤±è½çš„è¨˜æ†¶è€Œæ—…è¡Œ'],
        speechStyle: ['è²éŸ³ç”œç¾å¤šè®Šï¼Œå®³ç¾æ™‚æœƒå«ç³Šä¸æ¸…', 'èªªè©±å¸¶è‘—å¥³åƒ•è…”ï¼Œå¸¸ç”¨ã€Œã¯ã„ã€å›æ‡‰', 'å¥å°¾å¸¸åŠ ã€Œã£ã™ã€ï¼Œå……æ»¿æ´»åŠ›çš„èªæ°£', 'å¯æ„›çš„ã€Œaã€è²ï¼Œèªªè©±ç°¡çŸ­æœ‰è¶£', 'è±ªçˆ½çš„ç¬‘è²ï¼Œä¸æ™‚é–‹é»ƒè…”', 'ç¨ç‰¹çš„ã€Œãºã“ã€ç¬‘è²ï¼Œèªèª¿æ´»æ½‘', 'èªçœŸå°ˆæ¥­ï¼Œå”±æ­Œæ™‚å……æ»¿æ„Ÿæƒ…', 'å‚²å¬Œèªæ°£ï¼Œæ’’å¬Œæ™‚è²éŸ³è®Šè»Ÿ', 'æº«æŸ”æœ‰ç¦®ï¼Œèªªè©±å¸¶è‘—é¨å£«é¢¨ç¯„', 'æˆç†Ÿç©©é‡ï¼Œè²éŸ³ä½æ²‰æ²»ç™’'],
        combatSkills: ['ç‹ç«é­”æ³•, è²éŸ³é­”æ³•, è®Šèº«è¡“', 'æ°´é­”æ³•, å¥³åƒ•æˆ°é¬¥è¡“, æ¸…æ½”æŠ€èƒ½', 'é‹å‹•æŠ€å·§, é«”åŠ›å¼·åŒ–, åœ˜éšŠæ¿€å‹µ', 'é¯Šé­šè¡æ“Š, æ°´ä¸‹æˆ°é¬¥, éŸ³æ³¢æ”»æ“Š', 'åŠè¡“, ç«ç¹©æ§, èˆ¹èˆ¶æ“ç¸±', 'èƒ¡è˜¿è””åŠæ³•, é™·é˜±è¨­ç½®, é€ƒè·‘è¡“', 'æ­Œå”±é­”æ³•, æ˜Ÿå…‰æ”»æ“Š, é­…åŠ›å…‰ç’°', 'é­”æ³•è© å”±, è—¥æ°´èª¿é…, è©›å’’è¡“', 'è–é¨å£«åŠè¡“, ç›¾ç‰Œé˜²ç¦¦, æ²»ç™’è¡“', 'ç²¾éˆå¼“è¡“, è‡ªç„¶é­”æ³•, è¿½è¹¤è¡“'],
        lifeSkills: ['éŠæˆ²å¯¦æ³, æ­Œå”±, è§’è‰²æ‰®æ¼”', 'æ¸…æ½”æ‰“æƒ, æ–™ç†, æœä¾', 'é‹å‹•æ•™å­¸, æ¨¡ä»¿, ç¶œè—è¡¨æ¼”', 'éŠæˆ², å”±æ­Œ, è³£èŒ', 'èªªæ•…äº‹, èˆªæµ·çŸ¥è­˜, å¯¶è—é‘‘å®š', 'éŠæˆ²ç­–åŠƒ, æç¬‘, å…”å…”è·³', 'ä½œæ›², æ¼”å”±, å¶åƒæ´»å‹•', 'å åœ, é­”æ³•ç ”ç©¶, æ’’å¬Œ', 'æ–™ç†, ç…§é¡§ä»–äºº, é¨å£«ç¦®å„€', 'æ£®æ—ç”Ÿå­˜, è—¥è‰å­¸, ç²¾éˆæ­Œå”±'],
        customAttributes: ['é­…åŠ›: S\næ­Œå”±: A+\néŠæˆ²: A\nç‹ç‹¸åº¦: MAX', 'å†’å¤±åº¦: A+\nåŠªåŠ›å€¼: S\nå¯æ„›åº¦: MAX', 'æ´»åŠ›: S\nè—äººé­‚: S+\né‹å‹•ç¥ç¶“: A', 'å¯æ„›åº¦: SSS\næ­Œå”±: S\nè¿·ç³Šåº¦: A+', 'å¤§äººåº¦: S\nè‰²æ°£: A+\nèˆ¹é•·åŠ›: MAX', 'æƒ¡ä½œåŠ‡: S\nç¬‘è²: ç¨ç‰¹\næˆ°çˆ­ç½ª: ???', 'æ­Œå”±: SSS\nä½œæ›²: A+\nå¶åƒåŠ›: S', 'é­”åŠ›: A\nå‚²å¬Œåº¦: S\nå¯æ„›åº¦: A+', 'å®ˆè­·åŠ›: S\næ²»ç™’: A+\né¨å£«é“: MAX', 'æˆç†Ÿåº¦: S\nè²éŸ³é­…åŠ›: A+\nç²¾éˆåŠ›: A']
      },

      // å¿«é€Ÿæ¨™ç±¤è¨­å®š - Hololive é¢¨æ ¼
      quickTags: {
        personality: ['æ´»æ½‘', 'å®³ç¾', 'å‚²å¬Œ', 'å¤©ç„¶å‘†', 'å†’å¤±', 'èªçœŸ', 'æç¬‘', 'æº«æŸ”', 'æ¯’èˆŒ', 'å…ƒæ°£', 'æˆç†Ÿ', 'å¯æ„›', 'å¸¥æ°£', 'ç¥ç§˜'],
        traits: ['åŠªåŠ›', 'è¿·ç³Š', 'è°æ˜', 'å¥½å¥‡', 'ç†±æƒ…', 'å†·éœ', 'ä»»æ€§', 'é«”è²¼', 'ææ€ª', 'æ­£ç¶“', 'å¿ èª ', 'è‡ªä¿¡'],
        species: ['äººé¡', 'ç‹å¨˜', 'è²“å¨˜', 'çŠ¬å¨˜', 'å…”å¨˜', 'ç²¾éˆ', 'åŠç²¾éˆ', 'å¤©ä½¿', 'æƒ¡é­”', 'é­”å¥³', 'é¯Šé­š', 'é¾æ—'],
        occupation: ['VTuber', 'å¶åƒ', 'æ­Œå§¬', 'éŠæˆ²å¯¦æ³ä¸»', 'è—äºº', 'å¥³åƒ•', 'é¨å£«', 'é­”æ³•ä½¿', 'æµ·è³Š', 'å¿è€…', 'åµæ¢', 'æ–™ç†äºº'],
        appearance: ['å¯æ„›', 'å¸¥æ°£', 'å„ªé›…', 'æ´»æ½‘', 'æˆç†Ÿ', 'æ¸…ç´”', 'æ€§æ„Ÿ', 'å…ƒæ°£', 'ç¥ç§˜', 'æº«æŸ”'],
        hair: ['éŠ€ç™½', 'è—è‰²', 'ç´«è‰²', 'ç²‰ç´…', 'é‡‘è‰²', 'ç´…è‰²', 'é»‘è‰²', 'é›™è‰²', 'é•·é«®', 'çŸ­é«®', 'é›™é¦¬å°¾', 'å…¬ä¸»åˆ‡'],
        eyes: ['è—è‰²', 'ç´«è‰²', 'ç´…è‰²', 'é‡‘è‰²', 'ç¶ è‰²', 'ç²‰ç´…', 'ç•°è‰²ç³', 'æ˜Ÿæ˜Ÿçœ¼'],
        clothing: ['å¶åƒæœ', 'å¥³åƒ•è£', 'å’Œæœ', 'åˆ¶æœ', 'é€£å¸½è¡«', 'ç¦®æœ', 'é‹å‹•æœ', 'é¨å£«ç”²', 'å·«å¥³æœ', 'æ³³è£'],
        combatSkills: ['æ­Œå”±é­”æ³•', 'èˆè¹ˆæˆ°æŠ€', 'è²éŸ³æ”»æ“Š', 'é­…åŠ›å…‰ç’°', 'éŠæˆ²æŠ€å·§', 'åŠè¡“', 'é­”æ³•', 'å¿è¡“', 'å°„æ“Š', 'æ²»ç™’è¡“'],
        lifeSkills: ['å”±æ­Œ', 'è·³èˆ', 'éŠæˆ²', 'ç¹ªç•«', 'æ–™ç†', 'æ¼”å¥', 'é…éŸ³', 'æ¨¡ä»¿', 'æç¬‘', 'ä¸»æŒ']
      },

      // è¨­å®šç®¡ç†
      settings: {
        // å›ºå®šçš„ Google Drive ä¸»è³‡æ–™å¤¾ IDï¼ˆå¾Œå°è¨­å®šï¼Œç”¨æˆ¶ä¸å¯è¦‹ï¼‰
        GOOGLE_DRIVE_FOLDER_ID: '1s6pPlJic8s1Iv3cMtPJxbn4bsbgdR4aj',

        load() {
          const geminiApiKey = localStorage.getItem('geminiApiKey') || '';

          document.getElementById('geminiApiKey').value = geminiApiKey;

          return { geminiApiKey };
        },

        save() {
          const geminiApiKey = document.getElementById('geminiApiKey').value.trim();

          localStorage.setItem('geminiApiKey', geminiApiKey);

          showToast('è¨­å®šå·²å„²å­˜ï¼', 'success');
          App.ui.closeSettings();
        },

        get() {
          return {
            geminiApiKey: localStorage.getItem('geminiApiKey') || '',
            googleDriveFolderId: this.GOOGLE_DRIVE_FOLDER_ID
          };
        }
      },

      // Google OAuth èªè­‰
      auth: {
        client: null,
        // å›ºå®šçš„ Google OAuth Client ID
        GOOGLE_CLIENT_ID: '692507778051-t4mpeu79rbfcel1ds2hoi0n0qhg32224.apps.googleusercontent.com',

        init() {
          // åˆå§‹åŒ– Google Identity Services
          google.accounts.id.initialize({
            client_id: this.GOOGLE_CLIENT_ID,
            callback: this.handleCredentialResponse.bind(this),
          });

          // åˆå§‹åŒ– OAuth å®¢æˆ¶ç«¯ï¼ˆç”¨æ–¼å–å¾— access tokenï¼‰
          this.client = google.accounts.oauth2.initTokenClient({
            client_id: this.GOOGLE_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
            callback: this.handleTokenResponse.bind(this),
          });
        },

        login() {
          if (!this.client) {
            this.init();
          }

          this.client.requestAccessToken();
        },

        handleTokenResponse(response) {
          if (response.error) {
            showToast('ç™»å…¥å¤±æ•—ï¼š' + response.error, 'error');
            return;
          }

          App.state.accessToken = response.access_token;

          // å–å¾—ç”¨æˆ¶è³‡è¨Š
          fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: { Authorization: `Bearer ${response.access_token}` }
          })
          .then(res => res.json())
          .then(async userInfo => {
            App.state.user = userInfo;
            this.updateUI();
            showToast('ç™»å…¥æˆåŠŸï¼æ­¡è¿ ' + userInfo.name, 'success');

            // åˆå§‹åŒ– Google Drive ç”¨æˆ¶è³‡æ–™å¤¾
            try {
              await App.drive.initUserFolder();
              showToast('é›²ç«¯è³‡æ–™å¤¾å·²æº–å‚™å°±ç·’', 'success');
            } catch (error) {
              console.error('åˆå§‹åŒ– Drive è³‡æ–™å¤¾å¤±æ•—:', error);
              showToast('é›²ç«¯è³‡æ–™å¤¾åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š', 'warning');
            }
          });
        },

        handleCredentialResponse(response) {
          // JWT callbackï¼ˆå‚™ç”¨ï¼‰
          console.log('Credential response:', response);
        },

        logout() {
          App.state.user = null;
          App.state.accessToken = null;
          this.updateUI();
          showToast('å·²ç™»å‡º', 'info');
        },

        updateUI() {
          const userInfo = document.getElementById('userInfo');
          const loginBtn = document.getElementById('loginBtn');
          const cloudBtn = document.getElementById('cloudBtn');

          if (App.state.user) {
            document.getElementById('userAvatar').src = App.state.user.picture;
            document.getElementById('userName').textContent = App.state.user.name;
            userInfo.style.display = 'flex';
            loginBtn.style.display = 'none';
            if (cloudBtn) cloudBtn.style.display = 'flex';
          } else {
            userInfo.style.display = 'none';
            loginBtn.style.display = 'flex';
            if (cloudBtn) cloudBtn.style.display = 'none';
          }
        }
      },

      // è¡¨å–®é©—è­‰
      validator: {
        // é©—è­‰å¿…å¡«æ¬„ä½
        validateRequired(data) {
          const errors = [];

          // è§’è‰²åç¨±ç‚ºå¿…å¡«
          if (!data.name || data.name.trim() === '') {
            errors.push({
              field: 'name',
              message: 'è«‹å¡«å¯«è§’è‰²åç¨±'
            });
          }

          return errors;
        },

        // é©—è­‰å­—æ•¸é™åˆ¶ï¼ˆCharacter.AIï¼‰
        validateCharacterAI(data) {
          const warnings = [];

          if (App.state.currentPlatform === 'characterai') {
            const description = data.description || '';
            const maxLength = 3200;

            if (description.length > maxLength) {
              warnings.push({
                field: 'description',
                message: `Character.AI æè¿°è¶…éå»ºè­°é•·åº¦ (${description.length}/${maxLength} å­—å…ƒ)`
              });
            }
          }

          return warnings;
        },

        // è¦–è¦ºæ¨™ç¤ºéŒ¯èª¤æ¬„ä½
        highlightErrors(errors) {
          // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤æ¨™ç¤º
          document.querySelectorAll('.form-field input, .form-field textarea').forEach(el => {
            el.style.borderColor = '';
          });

          // æ¨™ç¤ºéŒ¯èª¤æ¬„ä½
          errors.forEach(error => {
            const field = document.getElementById(error.field);
            if (field) {
              field.style.borderColor = 'var(--danger)';
              field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        },

        // ç¶œåˆé©—è­‰
        validate(data) {
          const errors = this.validateRequired(data);
          const warnings = this.validateCharacterAI(data);

          if (errors.length > 0) {
            this.highlightErrors(errors);
            showToast(errors[0].message, 'error');
            return false;
          }

          if (warnings.length > 0) {
            warnings.forEach(warning => {
              showToast(warning.message, 'warning');
            });
          }

          return true;
        }
      },

      // UI æ§åˆ¶
      ui: {
        openSettings() {
          App.settings.load();
          document.getElementById('settingsModal').classList.add('show');
        },

        closeSettings() {
          document.getElementById('settingsModal').classList.remove('show');
        },

        async openCloudManager() {
          if (!App.state.user) {
            showToast('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ', 'warning');
            return;
          }

          document.getElementById('cloudModal').classList.add('show');
          await this.loadCloudCharacters();
        },

        closeCloudManager() {
          document.getElementById('cloudModal').classList.remove('show');
        },

        async loadCloudCharacters() {
          const list = document.getElementById('cloudCharacterList');
          list.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

          try {
            const files = await App.drive.listCharacters();

            if (files.length === 0) {
              list.innerHTML = '<div class="empty-state">å°šç„¡é›²ç«¯è§’è‰²å¡</div>';
              return;
            }

            list.innerHTML = files.map(file => `
              <div class="cloud-item">
                <div class="cloud-item-info">
                  <div class="cloud-item-name">${file.name.replace('.json', '')}</div>
                  <div class="cloud-item-meta">
                    ${new Date(file.modifiedTime).toLocaleString('zh-TW')}
                  </div>
                </div>
                <div class="cloud-item-actions">
                  <button class="btn small" onclick="App.ui.loadCloudCharacter('${file.id}', '${file.name}')">è¼‰å…¥</button>
                  <button class="btn small secondary" onclick="App.ui.deleteCloudCharacter('${file.id}')">åˆªé™¤</button>
                </div>
              </div>
            `).join('');
          } catch (error) {
            console.error('è¼‰å…¥é›²ç«¯è§’è‰²å¡å¤±æ•—:', error);
            list.innerHTML = '<div class="error-state">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            showToast('è¼‰å…¥é›²ç«¯è§’è‰²å¡å¤±æ•—', 'error');
          }
        },

        async loadCloudCharacter(fileId, fileName) {
          try {
            showToast('è¼‰å…¥ä¸­...', 'info');
            const content = await App.drive.downloadFile(fileId);
            const data = JSON.parse(content);

            // æ ¹æ“šæ ¼å¼è§£æè³‡æ–™
            let characterData;
            if (data.character_info) {
              // Gemini æ ¼å¼
              characterData = parseGeminiFormat(data);
            } else if (data.spec === 'chara_card_v2') {
              // SillyTavern æ ¼å¼
              characterData = parseSillyTavernFormat(data);
            } else if (data.type === 'risuai') {
              // RisuAI æ ¼å¼
              characterData = parseRisuAIFormat(data);
            } else {
              // ç°¡æ˜“æ ¼å¼
              characterData = data;
            }

            // å¡«å…¥è¡¨å–®
            fillFormData(characterData);

            this.closeCloudManager();
            showToast(`å·²è¼‰å…¥è§’è‰²å¡ï¼š${fileName.replace('.json', '')}`, 'success');
          } catch (error) {
            console.error('è¼‰å…¥è§’è‰²å¡å¤±æ•—:', error);
            showToast('è¼‰å…¥è§’è‰²å¡å¤±æ•—', 'error');
          }
        },

        async deleteCloudCharacter(fileId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å¡å—ï¼Ÿ')) {
            return;
          }

          try {
            await fetch(
              `https://www.googleapis.com/drive/v3/files/${fileId}`,
              {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            showToast('åˆªé™¤æˆåŠŸ', 'success');
            await this.loadCloudCharacters();
          } catch (error) {
            console.error('åˆªé™¤å¤±æ•—:', error);
            showToast('åˆªé™¤å¤±æ•—', 'error');
          }
        },

        async saveToCloud() {
          if (!App.state.user) {
            showToast('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ', 'warning');
            return;
          }

          const data = collectFormData();
          if (!App.validator.validate(data)) {
            return;
          }

          try {
            showToast('ä¸Šå‚³ä¸­...', 'info');

            const fileName = `${data.name || 'æœªå‘½åè§’è‰²'}_${Date.now()}.json`;
            const jsonContent = convertToJSON(data, App.state.currentPlatform);

            await App.drive.uploadFile(fileName, jsonContent, 'application/json');

            showToast('å„²å­˜åˆ°é›²ç«¯æˆåŠŸï¼', 'success');
          } catch (error) {
            console.error('å„²å­˜åˆ°é›²ç«¯å¤±æ•—:', error);
            showToast('å„²å­˜åˆ°é›²ç«¯å¤±æ•—ï¼š' + error.message, 'error');
          }
        },

        // éª°å­å¿«é€Ÿç”Ÿæˆ
        rollDice(fieldName) {
          const examples = App.exampleData[fieldName];
          if (!examples || examples.length === 0) {
            showToast('è©²æ¬„ä½æ²’æœ‰ç¯„ä¾‹è³‡æ–™', 'error');
            return;
          }

          const randomExample = examples[Math.floor(Math.random() * examples.length)];
          const field = document.getElementById(fieldName);
          if (field) {
            field.value = randomExample;
            updatePreview();
            showToast('å·²å¡«å…¥ç¯„ä¾‹ï¼', 'success');
          }
        },

        // å¿«é€Ÿæ¨™ç±¤æ’å…¥
        insertTag(fieldName, tag) {
          const field = document.getElementById(fieldName);
          if (!field) return;

          const currentValue = field.value.trim();
          if (currentValue === '') {
            field.value = tag;
          } else {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“åŒ…å«æ­¤æ¨™ç±¤
            const values = currentValue.split(',').map(v => v.trim());
            if (!values.includes(tag)) {
              field.value = currentValue + ', ' + tag;
            }
          }
          updatePreview();
        },

        // æ¸²æŸ“å¿«é€Ÿæ¨™ç±¤
        renderQuickTags(fieldName, containerId) {
          const tags = App.quickTags[fieldName];
          const container = document.getElementById(containerId);
          if (!container || !tags) return;

          container.innerHTML = tags.map(tag =>
            `<span class="quick-tag" onclick="App.ui.insertTag('${fieldName}', '${tag}')">${tag}</span>`
          ).join('');
        }
      },

      // å‹•æ…‹æ¬„ä½ç®¡ç†
      dynamicFields: {
        // æ¬„ä½é…ç½®
        config: {
          relationships: {
            fields: [
              { name: 'name', label: 'åç¨±/ç¨±å‘¼', placeholder: 'ä¾‹ï¼šç™½ä¸Šå¹é›ª', type: 'text', hasExample: true },
              { name: 'description', label: 'é—œä¿‚æè¿°', placeholder: 'ä¾‹ï¼šGAMERS çš„åŒæœŸå¤¥ä¼´', type: 'text', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              name: ['ç™½ä¸Šå¹é›ª', 'æ¹Šé˜¿åº«å©­', 'å¤§ç©ºæ˜´', 'Gawr Gura', 'å¯¶é˜ç‘ªç³', 'æ˜Ÿè¡—å½—æ˜Ÿ'],
              description: ['GAMERS çš„åŒæœŸå¤¥ä¼´ï¼Œç¶“å¸¸ä¸€èµ·ç›´æ’­', 'åŒæœŸç”Ÿï¼Œäº’ç›¸ç«¶çˆ­åˆäº’ç›¸æ‰¶æŒ', 'å‰è¼©ï¼Œç¶“å¸¸çµ¦äºˆå»ºè­°å’Œé¼“å‹µ', 'å¾Œè¼©ï¼Œéå¸¸å°Šæ•¬çš„å°è±¡', 'å¥½æœ‹å‹ï¼Œç¶“å¸¸ä¸€èµ·åˆä½œä¼åŠƒ', 'æ­Œå”±å¤¥ä¼´ï¼Œäº’ç›¸åˆ‡ç£‹æ­Œè—']
            }
          },
          combatSkills: {
            fields: [
              { name: 'skill', label: 'æŠ€èƒ½åç¨±', placeholder: 'ä¾‹ï¼šæ­Œå”±é­”æ³•', type: 'text', hasExample: true },
              { name: 'level', label: 'ç­‰ç´š/æè¿°', placeholder: 'ä¾‹ï¼šSç´šã€å°ˆç²¾ã€å¯é­…æƒ‘è½çœ¾', type: 'text', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              skill: ['æ­Œå”±é­”æ³•', 'èˆè¹ˆæˆ°æŠ€', 'è²éŸ³æ”»æ“Š', 'é­…åŠ›å…‰ç’°', 'éŠæˆ²æŠ€å·§', 'ç‹ç«é­”æ³•', 'æ°´é­”æ³•', 'æ˜Ÿå…‰æ”»æ“Š'],
              level: ['Sç´š', 'A+', 'å°ˆç²¾', 'å¤§å¸«ç´š', 'ç†Ÿç·´', 'MAX', 'å¯é­…æƒ‘è½çœ¾', 'ç¯„åœæ”»æ“Š']
            }
          },
          lifeSkills: {
            fields: [
              { name: 'skill', label: 'æŠ€èƒ½åç¨±', placeholder: 'ä¾‹ï¼šéŠæˆ²å¯¦æ³', type: 'text', hasExample: true },
              { name: 'level', label: 'ç­‰ç´š/æè¿°', placeholder: 'ä¾‹ï¼šå°ˆæ¥­ç´šã€æ“…é•·ææ€–éŠæˆ²', type: 'text', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              skill: ['éŠæˆ²å¯¦æ³', 'å”±æ­Œ', 'è·³èˆ', 'ç¹ªç•«', 'æ–™ç†', 'é…éŸ³', 'æ¨¡ä»¿', 'ä¸»æŒ', 'æç¬‘', 'æ¼”å¥'],
              level: ['å°ˆæ¥­ç´š', 'Sç´š', 'å¤©è³¦ç•°ç¨Ÿ', 'æ“…é•·ææ€–éŠæˆ²', 'å¯æ„›æ“”ç•¶', 'æ°£æ°›æ“”ç•¶', 'ç†Ÿç·´', 'å°ˆç²¾', 'å¤§å¸«', 'ç¨æ¨¹ä¸€æ ¼']
            }
          },
          customAttributes: {
            fields: [
              { name: 'attribute', label: 'å±¬æ€§åç¨±', placeholder: 'ä¾‹ï¼šé­…åŠ›å€¼', type: 'text', hasExample: true },
              { name: 'value', label: 'å€¼/ç­‰ç´š/æè¿°', placeholder: 'ä¾‹ï¼šSSS', type: 'text', hasExample: true }
            ],
            defaultCount: 3,
            examples: {
              attribute: ['é­…åŠ›å€¼', 'æ­Œå”±åŠ›', 'éŠæˆ²æŠ€è¡“', 'å¯æ„›åº¦', 'è—äººé­‚', 'å†’å¤±åº¦', 'æç¬‘åŠ›', 'å¶åƒåŠ›', 'è²éŸ³é­…åŠ›', 'ç²‰çµ²äººæ°£'],
              value: ['SSS', 'S+', 'A++', 'MAX', '97/100', 'âˆ', 'ç ´è¡¨', 'æ»¿é»', 'å‚³èªªç´š', '10è¬è¨‚é–±']
            }
          },
          speechStyle: {
            fields: [
              { name: 'situation', label: 'æƒ…å¢ƒ', placeholder: 'ä¾‹ï¼šé–‹å¿ƒæ™‚', type: 'text', hasExample: true },
              { name: 'dialogue', label: 'å°è©±ç¯„ä¾‹', placeholder: 'ä¾‹ï¼šã€Œã“ã‚“ã“ãƒ¼ã‚“ï¼ã€', type: 'textarea', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              situation: ['é–‹å¿ƒæ™‚', 'ç”Ÿæ°£æ™‚', 'å®³ç¾æ™‚', 'é©šè¨æ™‚', 'éŠæˆ²å¤±æ•—æ™‚', 'å”±æ­Œæ™‚', 'æ‰“æ‹›å‘¼æ™‚', 'é“åˆ¥æ™‚'],
              dialogue: [
                'ã€Œã“ã‚“ã“ãƒ¼ã‚“ï¼å¤§å®¶å¥½ï¼ã€',
                'ã€Œã‚‚ã†ï¼é€™æ¨£ä¸è¡Œå•¦ï¼ã€',
                'ã€Œèª’...é‚£å€‹...è¬ã€è¬è¬...ã€',
                'ã€Œãˆã‡ã‡ã‡ï¼ï¼ŸçœŸçš„å‡çš„ï¼ã€',
                'ã€Œå•Šå•Šå•Šä¸è¦ï¼æˆ‘ä¸æƒ³æ­»ï¼ã€',
                'ã€Œâ™ªï½è®“æˆ‘å€‘ä¸€èµ·å”±æ­Œå§ï½â™ªã€',
                'ã€Œå“ˆå›‰å“ˆå›‰ï½æ˜¯æˆ‘å•¦ï¼ã€',
                'ã€Œé‚£éº¼ï¼Œä¸‹æ¬¡è¦‹å›‰ï¼ãƒã‚¤ãƒã‚¤ï½ã€'
              ]
            }
          }
        },

        // åˆå§‹åŒ–æ‰€æœ‰å‹•æ…‹æ¬„ä½
        init() {
          Object.keys(this.config).forEach(fieldType => {
            const cfg = this.config[fieldType];
            const container = document.getElementById(`${fieldType}Container`);
            if (!container) return;

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // æ·»åŠ é è¨­æ•¸é‡çš„æ¬„ä½
            for (let i = 0; i < cfg.defaultCount; i++) {
              this.add(fieldType, true);
            }
          });
        },

        // æ·»åŠ ä¸€è¡Œæ¬„ä½
        add(fieldType, skipUpdate = false) {
          const cfg = this.config[fieldType];
          if (!cfg) {
            console.error('æœªçŸ¥çš„æ¬„ä½é¡å‹:', fieldType);
            return;
          }

          const container = document.getElementById(`${fieldType}Container`);
          if (!container) {
            console.error('æ‰¾ä¸åˆ°å®¹å™¨:', `${fieldType}Container`);
            return;
          }

          const index = container.children.length;
          const row = document.createElement('div');
          row.className = 'dynamic-field-row';
          row.dataset.index = index;

          // ç”Ÿæˆæ¬„ä½ HTML
          let fieldsHTML = '';
          cfg.fields.forEach((field, fieldIndex) => {
            const fieldId = `${fieldType}_${index}_${field.name}`;
            const inputType = field.type === 'textarea' ? 'textarea' : 'input';
            const inputHTML = inputType === 'textarea'
              ? `<textarea id="${fieldId}" placeholder="${field.placeholder}" oninput="updatePreview()" rows="2"></textarea>`
              : `<input type="${field.type || 'text'}" id="${fieldId}" placeholder="${field.placeholder}" oninput="updatePreview()">`;

            fieldsHTML += `
              <div class="form-field">
                <label>${field.label}</label>
                ${inputHTML}
              </div>
            `;
          });

          // æ·»åŠ æ§åˆ¶æŒ‰éˆ•
          let controlsHTML = '<div class="field-controls">';

          // éª°å­æŒ‰éˆ•ï¼ˆæ¯å€‹æ¬„ä½ä¸€å€‹ï¼‰
          cfg.fields.forEach((field, fieldIndex) => {
            if (field.hasExample) {
              controlsHTML += `
                <button type="button" class="dice-btn"
                  onclick="App.dynamicFields.rollDice('${fieldType}', ${index}, '${field.name}')"
                  title="éš¨æ©Ÿç”Ÿæˆ${field.label}">ğŸ²</button>
              `;
            }
          });

          // åˆªé™¤æŒ‰éˆ•
          const isFirst = index === 0;
          controlsHTML += `
            <button type="button" class="remove-btn"
              onclick="App.dynamicFields.remove('${fieldType}', ${index})"
              ${isFirst ? 'disabled' : ''}
              title="åˆªé™¤é€™ä¸€è¡Œ">ğŸ—‘ï¸</button>
          `;
          controlsHTML += '</div>';

          row.innerHTML = fieldsHTML + controlsHTML;
          container.appendChild(row);

          if (!skipUpdate) {
            updatePreview();
          }
        },

        // åˆªé™¤ä¸€è¡Œæ¬„ä½
        remove(fieldType, index) {
          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return;

          const rows = container.querySelectorAll('.dynamic-field-row');
          if (rows.length <= 1) {
            showToast('è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ¬„ä½', 'warning');
            return;
          }

          if (rows[index]) {
            rows[index].remove();

            // é‡æ–°ç´¢å¼•
            this.reindex(fieldType);
            updatePreview();
          }
        },

        // é‡æ–°ç´¢å¼•æ¬„ä½
        reindex(fieldType) {
          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return;

          const rows = container.querySelectorAll('.dynamic-field-row');
          rows.forEach((row, newIndex) => {
            row.dataset.index = newIndex;

            // æ›´æ–°æ‰€æœ‰ input/textarea çš„ id
            const inputs = row.querySelectorAll('input, textarea');
            inputs.forEach(input => {
              const oldId = input.id;
              const parts = oldId.split('_');
              parts[1] = newIndex; // æ›´æ–°ç´¢å¼•
              input.id = parts.join('_');
            });

            // æ›´æ–°æŒ‰éˆ•çš„ onclick
            const diceButtons = row.querySelectorAll('.dice-btn');
            diceButtons.forEach((btn, btnIndex) => {
              const cfg = this.config[fieldType];
              const field = cfg.fields[btnIndex];
              btn.setAttribute('onclick', `App.dynamicFields.rollDice('${fieldType}', ${newIndex}, '${field.name}')`);
            });

            const removeBtn = row.querySelector('.remove-btn');
            if (removeBtn) {
              removeBtn.setAttribute('onclick', `App.dynamicFields.remove('${fieldType}', ${newIndex})`);
              removeBtn.disabled = (newIndex === 0);
            }
          });
        },

        // éª°å­åŠŸèƒ½ï¼ˆé‡å°ç‰¹å®šæ¬„ä½ï¼‰
        rollDice(fieldType, index, part) {
          const cfg = this.config[fieldType];
          if (!cfg || !cfg.examples || !cfg.examples[part]) {
            showToast('è©²æ¬„ä½æ²’æœ‰ç¯„ä¾‹è³‡æ–™', 'error');
            return;
          }

          const examples = cfg.examples[part];
          const randomExample = examples[Math.floor(Math.random() * examples.length)];
          const fieldId = `${fieldType}_${index}_${part}`;
          const field = document.getElementById(fieldId);

          if (field) {
            field.value = randomExample;
            updatePreview();
            showToast('å·²å¡«å…¥ç¯„ä¾‹ï¼', 'success');
          }
        },

        // æ”¶é›†å‹•æ…‹æ¬„ä½è³‡æ–™
        collect(fieldType) {
          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return [];

          const cfg = this.config[fieldType];
          const rows = container.querySelectorAll('.dynamic-field-row');
          const result = [];

          rows.forEach((row, index) => {
            const item = {};
            cfg.fields.forEach(field => {
              const input = document.getElementById(`${fieldType}_${index}_${field.name}`);
              if (input) {
                item[field.name] = input.value;
              }
            });

            // åªæ·»åŠ éç©ºçš„é …ç›®
            const hasValue = Object.values(item).some(v => v && v.trim() !== '');
            if (hasValue) {
              result.push(item);
            }
          });

          return result;
        },

        // å¡«å……å‹•æ…‹æ¬„ä½è³‡æ–™
        fill(fieldType, data) {
          if (!Array.isArray(data) || data.length === 0) return;

          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return;

          // æ¸…ç©ºç¾æœ‰æ¬„ä½
          container.innerHTML = '';

          // ç‚ºæ¯å€‹è³‡æ–™é …æ·»åŠ æ¬„ä½
          data.forEach((item, index) => {
            this.add(fieldType, true);

            // å¡«å……è³‡æ–™
            const cfg = this.config[fieldType];
            cfg.fields.forEach(field => {
              const input = document.getElementById(`${fieldType}_${index}_${field.name}`);
              if (input && item[field.name] !== undefined) {
                input.value = item[field.name];
              }
            });
          });

          updatePreview();
        }
      },

      // Google Drive æ•´åˆ
      drive: {
        userFolderId: null, // ç”¨æˆ¶å°ˆå±¬è³‡æ–™å¤¾ ID

        /**
         * åˆå§‹åŒ–ç”¨æˆ¶è³‡æ–™å¤¾
         * åœ¨ä¸»è³‡æ–™å¤¾ä¸‹å‰µå»ºä»¥ç”¨æˆ¶ email å‘½åçš„å­è³‡æ–™å¤¾
         */
        async initUserFolder() {
          if (!App.state.accessToken) {
            throw new Error('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ');
          }

          const settings = App.settings.get();
          if (!settings.googleDriveFolderId) {
            throw new Error('è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å¯« Google Drive ä¸»è³‡æ–™å¤¾ ID');
          }

          const userEmail = App.state.user.email;
          const folderName = userEmail.replace('@', '_at_'); // é¿å…ç‰¹æ®Šå­—å…ƒ

          try {
            // æœå°‹æ˜¯å¦å·²å­˜åœ¨ç”¨æˆ¶è³‡æ–™å¤¾
            const searchResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files?` +
              `q=name='${folderName}' and '${settings.googleDriveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false&` +
              `fields=files(id,name)`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            if (!searchResponse.ok) {
              throw new Error('æœå°‹è³‡æ–™å¤¾å¤±æ•—');
            }

            const searchData = await searchResponse.json();

            if (searchData.files && searchData.files.length > 0) {
              // è³‡æ–™å¤¾å·²å­˜åœ¨
              this.userFolderId = searchData.files[0].id;
              console.log('æ‰¾åˆ°ç¾æœ‰ç”¨æˆ¶è³‡æ–™å¤¾:', this.userFolderId);
            } else {
              // å‰µå»ºæ–°è³‡æ–™å¤¾
              const createResponse = await fetch(
                'https://www.googleapis.com/drive/v3/files',
                {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${App.state.accessToken}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    name: folderName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [settings.googleDriveFolderId]
                  })
                }
              );

              if (!createResponse.ok) {
                throw new Error('å‰µå»ºè³‡æ–™å¤¾å¤±æ•—');
              }

              const createData = await createResponse.json();
              this.userFolderId = createData.id;
              console.log('å‰µå»ºæ–°ç”¨æˆ¶è³‡æ–™å¤¾:', this.userFolderId);
            }

            return this.userFolderId;
          } catch (error) {
            console.error('åˆå§‹åŒ–ç”¨æˆ¶è³‡æ–™å¤¾å¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * ä¸Šå‚³æª”æ¡ˆåˆ°ç”¨æˆ¶è³‡æ–™å¤¾
         */
        async uploadFile(fileName, content, mimeType = 'application/json') {
          if (!this.userFolderId) {
            await this.initUserFolder();
          }

          try {
            // ä½¿ç”¨ multipart upload
            const metadata = {
              name: fileName,
              parents: [this.userFolderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: mimeType }));

            const response = await fetch(
              'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                },
                body: form
              }
            );

            if (!response.ok) {
              throw new Error('ä¸Šå‚³æª”æ¡ˆå¤±æ•—');
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error('ä¸Šå‚³æª”æ¡ˆå¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * åˆ—å‡ºç”¨æˆ¶è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰è§’è‰²å¡
         */
        async listCharacters() {
          if (!this.userFolderId) {
            await this.initUserFolder();
          }

          try {
            const response = await fetch(
              `https://www.googleapis.com/drive/v3/files?` +
              `q='${this.userFolderId}' in parents and trashed=false and (mimeType='application/json' or name contains '.json')&` +
              `fields=files(id,name,createdTime,modifiedTime,size)&` +
              `orderBy=modifiedTime desc`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            if (!response.ok) {
              throw new Error('åˆ—å‡ºæª”æ¡ˆå¤±æ•—');
            }

            const data = await response.json();
            return data.files || [];
          } catch (error) {
            console.error('åˆ—å‡ºæª”æ¡ˆå¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * ä¸‹è¼‰æª”æ¡ˆå…§å®¹
         */
        async downloadFile(fileId) {
          try {
            const response = await fetch(
              `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            if (!response.ok) {
              throw new Error('ä¸‹è¼‰æª”æ¡ˆå¤±æ•—');
            }

            const content = await response.text();
            return content;
          } catch (error) {
            console.error('ä¸‹è¼‰æª”æ¡ˆå¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * ä¸Šå‚³åœ–ç‰‡ä¸¦å–å¾—å…¬é–‹åˆ†äº«é€£çµ
         */
        async uploadImage(file) {
          if (!this.userFolderId) {
            await this.initUserFolder();
          }

          try {
            // å‰µå»º images å­è³‡æ–™å¤¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let imagesFolderId = await this.getOrCreateImagesFolder();

            // ä¸Šå‚³åœ–ç‰‡
            const metadata = {
              name: `${Date.now()}_${file.name}`,
              parents: [imagesFolderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const uploadResponse = await fetch(
              'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                },
                body: form
              }
            );

            if (!uploadResponse.ok) {
              throw new Error('ä¸Šå‚³åœ–ç‰‡å¤±æ•—');
            }

            const uploadData = await uploadResponse.json();

            // è¨­å®šæª”æ¡ˆç‚ºå…¬é–‹
            await fetch(
              `https://www.googleapis.com/drive/v3/files/${uploadData.id}/permissions`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  role: 'reader',
                  type: 'anyone'
                })
              }
            );

            // å–å¾—å…¬é–‹é€£çµ
            const fileResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files/${uploadData.id}?fields=webContentLink,webViewLink`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            const fileData = await fileResponse.json();

            // è¿”å›ç›´æ¥é€£çµï¼ˆç”¨æ–¼é¡¯ç¤ºåœ–ç‰‡ï¼‰
            const directLink = `https://drive.google.com/uc?export=view&id=${uploadData.id}`;

            return {
              id: uploadData.id,
              name: uploadData.name,
              directLink: directLink,
              webViewLink: fileData.webViewLink
            };
          } catch (error) {
            console.error('ä¸Šå‚³åœ–ç‰‡å¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * å–å¾—æˆ–å‰µå»º images å­è³‡æ–™å¤¾
         */
        async getOrCreateImagesFolder() {
          try {
            // æœå°‹ images è³‡æ–™å¤¾
            const searchResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files?` +
              `q=name='images' and '${this.userFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false&` +
              `fields=files(id)`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            const searchData = await searchResponse.json();

            if (searchData.files && searchData.files.length > 0) {
              return searchData.files[0].id;
            }

            // å‰µå»º images è³‡æ–™å¤¾
            const createResponse = await fetch(
              'https://www.googleapis.com/drive/v3/files',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  name: 'images',
                  mimeType: 'application/vnd.google-apps.folder',
                  parents: [this.userFolderId]
                })
              }
            );

            const createData = await createResponse.json();
            return createData.id;
          } catch (error) {
            console.error('å–å¾—æˆ–å‰µå»º images è³‡æ–™å¤¾å¤±æ•—:', error);
            throw error;
          }
        }
      },

      // AI ç”Ÿæˆæ¨¡çµ„
      ai: {
        /**
         * AI ä¸€éµå‰µè§’ - ä½¿ç”¨ Gemini API ç”Ÿæˆè§’è‰²
         */
        async generateCharacter() {
          const settings = App.settings.get();
          if (!settings.geminiApiKey) {
            showToast('è«‹å…ˆåœ¨è¨­å®šä¸­é…ç½® Gemini API Keyï¼', 'warning');
            App.ui.openSettings();
            return;
          }

          // æç¤ºç”¨æˆ¶è¼¸å…¥è§’è‰²æ¦‚å¿µ
          const prompt = window.prompt(
            'âœ¨ AI ä¸€éµå‰µè§’\n\n' +
            'è«‹è¼¸å…¥æ‚¨æƒ³å‰µå»ºçš„è§’è‰²æ¦‚å¿µï¼ŒAI å°‡ç‚ºæ‚¨ç”Ÿæˆå®Œæ•´çš„è§’è‰²è³‡æ–™ï¼\n\n' +
            'ç¯„ä¾‹ï¼š\n' +
            'â€¢ ä¸€å€‹æ´»æ½‘å¯æ„›çš„ç‹è€³ VTuberï¼Œå–œæ­¡éŠæˆ²å¯¦æ³\n' +
            'â€¢ å†·éœæˆç†Ÿçš„ç²¾éˆå¼“æ‰‹ï¼Œæ“…é•·æ²»ç™’é­”æ³•\n' +
            'â€¢ æç¬‘æ“”ç•¶çš„æµ·è³Šèˆ¹é•·ï¼Œå€‹æ€§è±ªçˆ½\n\n' +
            'è«‹è¼¸å…¥æ‚¨çš„å‰µæ„ï¼š'
          );

          if (!prompt || prompt.trim() === '') {
            return;
          }

          showToast('AI ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...', 'info');

          try {
            const characterData = await this.callGeminiAPI(settings.geminiApiKey, prompt);

            // å°‡ç”Ÿæˆçš„è³‡æ–™å¡«å…¥è¡¨å–®
            fillFormData(characterData);
            updatePreview();

            showToast('âœ¨ AI å‰µè§’å®Œæˆï¼è«‹æª¢æŸ¥ä¸¦èª¿æ•´è³‡æ–™', 'success');
          } catch (error) {
            console.error('AI ç”Ÿæˆå¤±æ•—:', error);
            showToast('AI ç”Ÿæˆå¤±æ•—ï¼š' + error.message, 'error');
          }
        },

        /**
         * å‘¼å« Gemini API ç”Ÿæˆè§’è‰²è³‡æ–™
         */
        async callGeminiAPI(apiKey, userPrompt) {
          const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è§’è‰²è¨­è¨ˆåŠ©æ‰‹ã€‚æ ¹æ“šç”¨æˆ¶æä¾›çš„è§’è‰²æ¦‚å¿µï¼Œè«‹ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡è³‡æ–™ã€‚

è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆæ‰€æœ‰æ¬„ä½éƒ½ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥å1, åˆ¥å2",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥ï¼ˆå¥³æ€§/ç”·æ€§/éäºŒå…ƒ/å…¶ä»–ï¼‰",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½",
  "appearance": "æ•´é«”å¤–è§€æè¿°ï¼ˆ2-3å¥è©±ï¼‰",
  "height": "èº«é«˜",
  "bodyType": "é«”å‹",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›é¡è‰²",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "ç‰¹æ®Šæ¨™è¨˜",
  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆ2-3å¥è©±ï¼‰",
  "traits": "ç‰¹è³ªæ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹ï¼ˆ3-5å¥è©±ï¼‰",
  "keyEvents": "é—œéµäº‹ä»¶",
  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯ï¼ˆè§’è‰²çš„è‡ªæˆ‘ä»‹ç´¹å°è©±ï¼‰",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»ï¼ˆ1-2å¥è©±æè¿°å ´æ™¯ï¼‰",
  "description": "çµ¦ AI çš„å®Œæ•´è§’è‰²æè¿°ï¼ˆæ•´åˆæ‰€æœ‰è³‡è¨Šï¼Œ5-8å¥è©±ï¼‰",
  "systemPrompt": "ç³»çµ±æç¤ºè©ï¼ˆæŒ‡å° AI å¦‚ä½•æ‰®æ¼”é€™å€‹è§’è‰²ï¼‰"
}

ç”¨æˆ¶çš„è§’è‰²æ¦‚å¿µï¼š${userPrompt}

é‡è¦è¦å‰‡ï¼š
1. åªå›å‚³ç´” JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ã€è¨»é‡‹æˆ– markdown æ ¼å¼ï¼ˆå¦‚ \`\`\`jsonï¼‰
2. æ‰€æœ‰å­—æ®µçš„å€¼éƒ½å¿…é ˆæ˜¯å­—ç¬¦ä¸²é¡å‹ï¼Œç”¨é›™å¼•è™ŸåŒ…è£¹
3. ç¢ºä¿æ‰€æœ‰å¼•è™Ÿã€é€—è™Ÿã€å¤§æ‹¬è™Ÿæ­£ç¢ºåŒ¹é…
4. ä¸è¦åœ¨æœ€å¾Œä¸€å€‹å­—æ®µå¾ŒåŠ é€—è™Ÿ
5. JSON å¿…é ˆèƒ½è¢« JSON.parse() ç›´æ¥è§£æï¼Œä¸èƒ½æœ‰ä»»ä½•èªæ³•éŒ¯èª¤

ç¯„ä¾‹æ ¼å¼ï¼š
{
  "name": "è§’è‰²åç¨±",
  "catchphrases": "å£é ­ç¦ª1, å£é ­ç¦ª2, å£é ­ç¦ª3"
}`;

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-goog-api-key': apiKey
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: systemPrompt
                  }]
                }],
                generationConfig: {
                  temperature: 0.9,
                  topK: 40,
                  topP: 0.95,
                  maxOutputTokens: 8192,
                }
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Gemini API');
          }

          const data = await response.json();

          // æª¢æŸ¥å›æ‡‰çµæ§‹
          if (!data.candidates || !data.candidates[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error(data.error?.message || 'API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          const generatedText = data.candidates[0].content.parts[0].text;

          // å˜—è©¦è§£æ JSONï¼ˆç§»é™¤å¯èƒ½çš„ markdown ä»£ç¢¼å¡Šï¼‰
          let jsonText = generatedText.trim();
          if (jsonText.startsWith('```json')) {
            jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
          } else if (jsonText.startsWith('```')) {
            jsonText = jsonText.replace(/```\n?/g, '');
          }

          // ä¿®å¾©å¸¸è¦‹çš„ JSON æ ¼å¼éŒ¯èª¤
          jsonText = jsonText
            .replace(/,\s*}/g, '}')  // ç§»é™¤ç‰©ä»¶çµå°¾çš„å¤šé¤˜é€—è™Ÿ
            .replace(/,\s*]/g, ']')  // ç§»é™¤é™£åˆ—çµå°¾çš„å¤šé¤˜é€—è™Ÿ
            .trim();

          try {
            const characterData = JSON.parse(jsonText);
            return characterData;
          } catch (e) {
            console.error('JSON è§£æå¤±æ•—:', e);
            console.log('åŸå§‹å›æ‡‰:', generatedText);
            console.log('æ¸…ç†å¾Œçš„ JSON:', jsonText);
            throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦');
          }
        }
      }
    };

    // ===== èˆŠçš„å…¨åŸŸç‹€æ…‹ï¼ˆå‘å¾Œç›¸å®¹ï¼‰=====
    let isFullMode = false;
    let currentPlatform = 'gemini';
    let currentPreviewTab = 'card';

    // ===== æ¨¡å¼åˆ‡æ› =====
    function toggleMode() {
      isFullMode = !isFullMode;
      const toggle = document.getElementById('modeToggle');
      const label = document.getElementById('modeLabel');
      const formPanel = document.getElementById('formPanel');

      if (isFullMode) {
        toggle.classList.add('active');
        label.textContent = 'å®Œæ•´ç‰ˆ';
        formPanel.classList.add('full-mode');
      } else {
        toggle.classList.remove('active');
        label.textContent = 'ç²¾ç°¡ç‰ˆ';
        formPanel.classList.remove('full-mode');
      }

      updatePreview();
    }

    // ===== å¹³å°é¸æ“‡ =====
    function selectPlatform(platform) {
      currentPlatform = platform;
      App.state.currentPlatform = platform; // åŒæ­¥åˆ° App ç‹€æ…‹
      document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-platform="${platform}"]`).classList.add('active');
      updatePreview();
    }

    // ===== å€å¡Šæ”¶åˆ =====
    function toggleSection(header) {
      header.classList.toggle('collapsed');
      header.nextElementSibling.classList.toggle('collapsed');
    }

    // ===== é è¦½åˆ†é åˆ‡æ› =====
    function switchPreviewTab(tab) {
      currentPreviewTab = tab;
      App.state.currentPreviewTab = tab; // åŒæ­¥åˆ° App ç‹€æ…‹

      document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.preview-tab:nth-child(${['card', 'json', 'yaml', 'markdown'].indexOf(tab) + 1})`).classList.add('active');

      document.querySelectorAll('.character-preview, .code-preview').forEach(p => p.classList.remove('active'));

      // é¡¯ç¤º/éš±è—è¤‡è£½æŒ‰éˆ•
      const copyBtn = document.getElementById('copyPreviewBtn');
      if (tab === 'card') {
        document.getElementById('previewCard').classList.add('active');
        copyBtn.style.display = 'none'; // è§’è‰²å¡é è¦½ä¸é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
      } else if (tab === 'json') {
        document.getElementById('previewJSON').classList.add('active');
        copyBtn.style.display = 'flex';
      } else if (tab === 'yaml') {
        document.getElementById('previewYAML').classList.add('active');
        copyBtn.style.display = 'flex';
      } else if (tab === 'markdown') {
        document.getElementById('previewMarkdown').classList.add('active');
        copyBtn.style.display = 'flex';
      }

      updatePreview();
    }

    // ===== æ”¶é›†è¡¨å–®è³‡æ–™ =====
    function collectFormData() {
      return {
        avatarUrl: document.getElementById('avatarUrl').value,
        name: document.getElementById('name').value,
        aliases: document.getElementById('aliases').value,
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        species: document.getElementById('species').value,
        occupation: document.getElementById('occupation').value,
        appearance: document.getElementById('appearance').value,
        height: document.getElementById('height').value,
        bodyType: document.getElementById('bodyType').value,
        hairColor: document.getElementById('hairColor').value,
        hairStyle: document.getElementById('hairStyle').value,
        eyes: document.getElementById('eyes').value,
        clothing: document.getElementById('clothing').value,
        features: document.getElementById('features').value,
        personality: document.getElementById('personality').value,
        traits: document.getElementById('traits').value,
        strengths: document.getElementById('strengths').value,
        weaknesses: document.getElementById('weaknesses').value,
        likes: document.getElementById('likes').value,
        dislikes: document.getElementById('dislikes').value,
        fears: document.getElementById('fears').value,
        goals: document.getElementById('goals').value,
        birthplace: document.getElementById('birthplace').value,
        backstory: document.getElementById('backstory').value,
        keyEvents: document.getElementById('keyEvents').value,
        // å‹•æ…‹æ¬„ä½
        relationships: App.dynamicFields.collect('relationships'),
        combatSkills: App.dynamicFields.collect('combatSkills'),
        lifeSkills: App.dynamicFields.collect('lifeSkills'),
        customAttributes: App.dynamicFields.collect('customAttributes'),
        speechStyle: App.dynamicFields.collect('speechStyle'),
        // å…¶ä»–æ¬„ä½
        catchphrases: document.getElementById('catchphrases').value,
        verbalTics: document.getElementById('verbalTics').value,
        emotionalExpression: document.getElementById('emotionalExpression').value,
        description: document.getElementById('description').value,
        systemPrompt: document.getElementById('systemPrompt').value,
        firstMessage: document.getElementById('firstMessage').value,
        exampleDialogues: document.getElementById('exampleDialogues').value,
        scenario: document.getElementById('scenario').value,
        tags: document.getElementById('tags').value,
        worldLore: document.getElementById('worldLore').value,
        creator: document.getElementById('creator').value,
        version: document.getElementById('version').value
      };
    }

    // ===== æ›´æ–°é è¦½ =====
    function updatePreview() {
      const data = collectFormData();

      // æ›´æ–°è§’è‰²å¡é è¦½
      updateCardPreview(data);

      // æ›´æ–°ç¨‹å¼ç¢¼é è¦½
      updateCodePreviews(data);
    }

    // ===== æ›´æ–°è§’è‰²å¡è¦–è¦ºé è¦½ =====
    function updateCardPreview(data) {
      // åç¨±èˆ‡åˆ¥å
      document.getElementById('previewName').textContent = data.name || 'æœªå‘½åè§’è‰²';
      document.getElementById('previewAliases').textContent = data.aliases ? `åˆç¨±ï¼š${data.aliases}` : '';

      // é ­åƒåœ–ç‰‡æˆ–æ–‡å­—
      const avatarEl = document.getElementById('previewAvatar');
      if (data.avatarUrl && data.avatarUrl.trim() !== '') {
        // ä½¿ç”¨åœ–ç‰‡
        avatarEl.innerHTML = `<img src="${data.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.parentElement.textContent='${data.name ? data.name.charAt(0) : 'ğŸ­'}'">`;
      } else {
        // ä½¿ç”¨æ–‡å­—ï¼ˆå–åå­—ç¬¬ä¸€å€‹å­—ï¼‰
        const avatarChar = data.name ? data.name.charAt(0) : 'ğŸ­';
        avatarEl.textContent = avatarChar;
      }

      // æ¨™ç±¤
      const tagsContainer = document.getElementById('previewTags');
      tagsContainer.innerHTML = '';
      if (data.tags) {
        data.tags.split(',').forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'preview-tag';
          tagEl.textContent = tag.trim();
          tagsContainer.appendChild(tagEl);
        });
      }

      // åŸºæœ¬è³‡è¨Šæ ¼
      const basicGrid = document.getElementById('previewBasicGrid');
      basicGrid.innerHTML = '';
      const basicFields = [
        { label: 'å¹´é½¡', value: data.age },
        { label: 'æ€§åˆ¥', value: data.gender },
        { label: 'ç¨®æ—', value: data.species },
        { label: 'è·æ¥­', value: data.occupation }
      ];
      basicFields.forEach(field => {
        if (field.value) {
          basicGrid.innerHTML += `
            <div class="preview-item">
              <span class="preview-item-label">${field.label}</span>
              <span class="preview-item-value">${field.value}</span>
            </div>
          `;
        }
      });

      // å¤–è§€
      const appearanceSection = document.getElementById('previewAppearanceSection');
      const appearanceContent = document.getElementById('previewAppearance');
      if (data.appearance) {
        appearanceSection.style.display = 'block';
        appearanceContent.textContent = data.appearance;
      } else {
        appearanceSection.style.display = 'none';
      }

      // æ€§æ ¼
      const personalitySection = document.getElementById('previewPersonalitySection');
      const personalityContent = document.getElementById('previewPersonality');
      if (data.personality || data.traits) {
        personalitySection.style.display = 'block';
        let content = data.personality || '';
        if (data.traits) {
          content += (content ? '\n\n' : '') + 'ç‰¹è³ªï¼š' + data.traits;
        }
        personalityContent.textContent = content;
      } else {
        personalitySection.style.display = 'none';
      }

      // èƒŒæ™¯
      const backstorySection = document.getElementById('previewBackstorySection');
      const backstoryContent = document.getElementById('previewBackstory');
      if (data.backstory) {
        backstorySection.style.display = 'block';
        backstoryContent.textContent = data.backstory;
      } else {
        backstorySection.style.display = 'none';
      }

      // ç¬¬ä¸€å‰‡è¨Šæ¯
      const firstMessageSection = document.getElementById('previewFirstMessageSection');
      const firstMessageContent = document.getElementById('previewFirstMessage');
      if (data.firstMessage) {
        firstMessageSection.style.display = 'block';
        firstMessageContent.textContent = data.firstMessage;
      } else {
        firstMessageSection.style.display = 'none';
      }
    }

    // ===== æ›´æ–°ç¨‹å¼ç¢¼é è¦½ =====
    function updateCodePreviews(data) {
      // JSON
      const jsonOutput = convertToJSON(data, currentPlatform);
      document.getElementById('jsonCode').textContent = jsonOutput;

      // YAML
      const yamlOutput = convertToYAML(data, currentPlatform);
      document.getElementById('yamlCode').textContent = yamlOutput;

      // Markdown
      const mdOutput = convertToMarkdown(data, currentPlatform);
      document.getElementById('markdownCode').textContent = mdOutput;
    }

    // ===== æ ¼å¼è½‰æ›å‡½æ•¸ï¼ˆå‰ç«¯ç‰ˆæœ¬ï¼‰ =====
    
    function convertToJSON(data, platform) {
      let output;
      switch(platform) {
        case 'sillytavern':
          output = convertToSillyTavernFormat(data);
          break;
        case 'risuai':
          output = convertToRisuAIFormat(data);
          break;
        case 'characterai':
          output = convertToCharacterAIFormat(data);
          break;
        case 'gemini':
        default:
          output = convertToGeminiFormat(data);
          break;
      }
      return JSON.stringify(output, null, 2);
    }

    function convertToYAML(data, platform) {
      let output;
      switch(platform) {
        case 'sillytavern':
          output = convertToSillyTavernFormat(data);
          break;
        case 'risuai':
          output = convertToRisuAIFormat(data);
          break;
        case 'characterai':
          output = convertToCharacterAIFormat(data);
          break;
        case 'gemini':
        default:
          output = convertToGeminiFormat(data);
          break;
      }
      return objectToYAML(output, 0);
    }

    /**
     * ç²å–å¹³å°é¡¯ç¤ºåç¨±
     */
    function getPlatformName(platform) {
      const platformNames = {
        'gemini': 'Gemini 3.0',
        'sillytavern': 'SillyTavern',
        'risuai': 'RisuAI',
        'characterai': 'Character.AI'
      };
      return platformNames[platform] || platform;
    }

    function convertToMarkdown(data, platform) {
      const platformNames = {
        'gemini': 'Gemini 3.0',
        'sillytavern': 'SillyTavern',
        'risuai': 'RisuAI',
        'characterai': 'Character.AI'
      };

      let md = `# ${data.name || 'æœªå‘½åè§’è‰²'}\n\n`;
      md += `> å¹³å°ï¼š${platformNames[platform]} | ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n\n`;
      
      // åŸºæœ¬è³‡è¨Š
      md += `## ğŸ“‹ åŸºæœ¬è³‡è¨Š\n\n`;
      md += `| é …ç›® | å…§å®¹ |\n|------|------|\n`;
      if (data.name) md += `| åç¨± | ${data.name} |\n`;
      if (data.aliases) md += `| åˆ¥å | ${data.aliases} |\n`;
      if (data.age) md += `| å¹´é½¡ | ${data.age} |\n`;
      if (data.gender) md += `| æ€§åˆ¥ | ${data.gender} |\n`;
      if (data.species) md += `| ç¨®æ— | ${data.species} |\n`;
      if (data.occupation) md += `| è·æ¥­ | ${data.occupation} |\n`;
      md += `\n`;
      
      // å¤–è§€æè¿°
      if (data.appearance || data.height || data.bodyType || data.hairColor || data.hairStyle || data.eyes || data.clothing || data.features) {
        md += `## ğŸ‘¤ å¤–è§€æè¿°\n\n`;
        if (data.appearance) md += `${data.appearance}\n\n`;
        if (data.height) md += `**èº«é«˜**ï¼š${data.height}\n\n`;
        if (data.bodyType) md += `**é«”å‹**ï¼š${data.bodyType}\n\n`;
        if (data.hairColor) md += `**é«®è‰²**ï¼š${data.hairColor}\n\n`;
        if (data.hairStyle) md += `**é«®å‹**ï¼š${data.hairStyle}\n\n`;
        if (data.eyes) md += `**çœ¼ç›**ï¼š${data.eyes}\n\n`;
        if (data.clothing) md += `**æœè£é¢¨æ ¼**ï¼š${data.clothing}\n\n`;
        if (data.features) md += `**ç‰¹æ®Šæ¨™è¨˜**ï¼š${data.features}\n\n`;
      }
      
      // æ€§æ ¼
      if (data.personality || data.traits || data.strengths || data.weaknesses || data.likes || data.dislikes || data.fears || data.goals) {
        md += `## ğŸ’­ æ€§æ ¼ç‰¹è³ª\n\n`;
        if (data.personality) md += `${data.personality}\n\n`;
        if (data.traits) md += `**ç‰¹è³ªæ¨™ç±¤**ï¼š${data.traits}\n\n`;
        if (data.strengths) md += `**å„ªé»**ï¼š${data.strengths}\n\n`;
        if (data.weaknesses) md += `**ç¼ºé»**ï¼š${data.weaknesses}\n\n`;
        if (data.likes) md += `**å–œå¥½**ï¼š${data.likes}\n\n`;
        if (data.dislikes) md += `**å­æƒ¡**ï¼š${data.dislikes}\n\n`;
        if (data.fears) md += `**ææ‡¼**ï¼š${data.fears}\n\n`;
        if (data.goals) md += `**ç›®æ¨™**ï¼š${data.goals}\n\n`;
      }
      
      // æŠ€èƒ½ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰
      if (Array.isArray(data.combatSkills) && data.combatSkills.length > 0 ||
          Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0) {
        md += `## âš”ï¸ æŠ€èƒ½\n\n`;
        if (Array.isArray(data.combatSkills) && data.combatSkills.length > 0) {
          md += `**æˆ°é¬¥æŠ€èƒ½**ï¼š\n\n`;
          data.combatSkills.forEach(item => {
            if (item.skill) {
              md += `- ${item.skill}${item.level ? ` (${item.level})` : ''}\n`;
            }
          });
          md += '\n';
        }
        if (Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0) {
          md += `**ç”Ÿæ´»æŠ€èƒ½**ï¼š\n\n`;
          data.lifeSkills.forEach(item => {
            if (item.skill) {
              md += `- ${item.skill}${item.level ? ` (${item.level})` : ''}\n`;
            }
          });
          md += '\n';
        }
      }

      // è‡ªè¨‚å±¬æ€§ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰
      if (Array.isArray(data.customAttributes) && data.customAttributes.length > 0) {
        md += `## ğŸ“Š è‡ªè¨‚å±¬æ€§\n\n`;
        md += `| å±¬æ€§ | å€¼ |\n|------|------|\n`;
        data.customAttributes.forEach(item => {
          if (item.attribute && item.value) {
            md += `| ${item.attribute} | ${item.value} |\n`;
          }
        });
        md += '\n';
      }

      // èƒŒæ™¯æ•…äº‹
      if (data.backstory || data.birthplace || data.keyEvents ||
          (Array.isArray(data.relationships) && data.relationships.length > 0)) {
        md += `## ğŸ“– èƒŒæ™¯æ•…äº‹\n\n`;
        if (data.birthplace) md += `**å‡ºç”Ÿåœ°**ï¼š${data.birthplace}\n\n`;
        if (data.backstory) md += `${data.backstory}\n\n`;
        if (data.keyEvents) md += `**é‡è¦äº‹ä»¶**ï¼š${data.keyEvents}\n\n`;

        // äººéš›é—œä¿‚ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰
        if (Array.isArray(data.relationships) && data.relationships.length > 0) {
          md += `**äººéš›é—œä¿‚**ï¼š\n\n`;
          data.relationships.forEach(item => {
            if (item.name && item.description) {
              md += `- **${item.name}**ï¼š${item.description}\n`;
            }
          });
          md += '\n';
        }
      }

      // å°è©±é¢¨æ ¼
      if ((Array.isArray(data.speechStyle) && data.speechStyle.length > 0) ||
          data.catchphrases || data.verbalTics || data.emotionalExpression) {
        md += `## ğŸ—£ï¸ å°è©±é¢¨æ ¼\n\n`;

        // èªªè©±æ–¹å¼ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰
        if (Array.isArray(data.speechStyle) && data.speechStyle.length > 0) {
          md += `**èªªè©±æ–¹å¼ç¯„ä¾‹**ï¼š\n\n`;
          data.speechStyle.forEach(item => {
            if (item.situation && item.dialogue) {
              md += `- **${item.situation}**ï¼š${item.dialogue}\n`;
            }
          });
          md += '\n';
        }

        if (data.catchphrases) md += `**å£é ­ç¦ª**ï¼š${data.catchphrases}\n\n`;
        if (data.verbalTics) md += `**èªè¨€ç¿’æ…£**ï¼š${data.verbalTics}\n\n`;
        if (data.emotionalExpression) md += `**æƒ…ç·’è¡¨é”**ï¼š${data.emotionalExpression}\n\n`;
      }
      
      // AI æ ¸å¿ƒè¨­å®š
      md += `## ğŸ¤– AI æ ¸å¿ƒè¨­å®š\n\n`;
      if (data.description) md += `### è§’è‰²æè¿°\n\n${data.description}\n\n`;
      if (data.systemPrompt) md += `### ç³»çµ±æç¤º\n\n${data.systemPrompt}\n\n`;
      if (data.firstMessage) md += `### ç¬¬ä¸€å‰‡è¨Šæ¯\n\n${data.firstMessage}\n\n`;
      if (data.exampleDialogues) md += `### ç¯„ä¾‹å°è©±\n\n${data.exampleDialogues}\n\n`;
      if (data.scenario) md += `### åˆæ¬¡ç›¸é‡åœ°é»\n\n${data.scenario}\n\n`;
      
      // å…ƒè³‡æ–™
      if (data.tags || data.worldLore || data.creator || data.version) {
        md += `## ğŸ“ å…ƒè³‡æ–™\n\n`;
        if (data.tags) md += `**æ¨™ç±¤**ï¼š${data.tags}\n\n`;
        if (data.worldLore) md += `**ä¸–ç•Œè§€**ï¼š${data.worldLore}\n\n`;
        if (data.creator) md += `**å‰µä½œè€…**ï¼š${data.creator}\n\n`;
        if (data.version) md += `**ç‰ˆæœ¬**ï¼š${data.version}\n\n`;
      }
      
      md += `---\n*ç”± AI è§’è‰²å¡å‰µä½œå·¥å…·ç”Ÿæˆ*\n`;
      
      return md;
    }

    // å¹³å°ç‰¹å®šæ ¼å¼
    function convertToSillyTavernFormat(data) {
      return {
        spec: "chara_card_v2",
        spec_version: "2.0",
        data: {
          name: data.name || "",
          description: buildCharacterDescription(data),
          personality: data.personality || "",
          scenario: data.scenario || "",
          first_mes: data.firstMessage || "",
          mes_example: data.exampleDialogues || "",
          creator_notes: data.creatorNotes || "",
          system_prompt: data.systemPrompt || "",
          post_history_instructions: "",
          alternate_greetings: [],
          tags: data.tags ? data.tags.split(',').map(t => t.trim()) : [],
          creator: data.creator || "",
          character_version: data.version || "1.0",
          extensions: {
            world: data.worldLore || "",
            depth_prompt: { prompt: "", depth: 4 }
          }
        }
      };
    }

    function convertToRisuAIFormat(data) {
      return {
        type: "risuai",
        ver: 1,
        data: {
          name: data.name || "",
          firstMessage: data.firstMessage || "",
          description: buildCharacterDescription(data),
          personality: data.personality || "",
          scenario: data.scenario || "",
          exampleMessage: data.exampleDialogues || "",
          creatorNotes: data.creatorNotes || "",
          systemPrompt: data.systemPrompt || "",
          tags: data.tags ? data.tags.split(',').map(t => t.trim()) : [],
          creator: data.creator || "",
          characterVersion: data.version || "1.0",
          lorebook: {
            name: data.worldLore ? "World Lore" : "",
            entries: data.worldLore ? [{
              keys: [data.name || "character"],
              content: data.worldLore,
              enabled: true
            }] : []
          }
        }
      };
    }

    function convertToCharacterAIFormat(data) {
      let definition = "";
      if (data.name) definition += `{{char}} is named ${data.name}. `;
      if (data.age) definition += `{{char}} is ${data.age} years old. `;
      if (data.gender) definition += `{{char}}'s gender is ${data.gender}. `;
      if (data.species && data.species !== 'äººé¡') definition += `{{char}} is a ${data.species}. `;
      if (data.occupation) definition += `{{char}} works as ${data.occupation}. `;
      if (data.appearance) definition += `${data.appearance} `;
      if (data.personality) definition += `${data.personality} `;
      if (data.speechStyle) definition += `{{char}} speaks in a ${data.speechStyle} manner. `;
      if (data.backstory) definition += `${data.backstory} `;

      return {
        name: data.name || "",
        title: data.aliases || "",
        description: data.description || definition.trim(),
        greeting: data.firstMessage || "",
        definition: definition.trim(),
        visibility: "private",
        copyable: true,
        categories: data.tags ? data.tags.split(',').map(t => t.trim()) : []
      };
    }

    function convertToGeminiFormat(data) {
      // è½‰æ›å‹•æ…‹æ¬„ä½æ ¼å¼
      const formatSkills = (skillsArray) => {
        if (!Array.isArray(skillsArray)) return [];
        return skillsArray.map(item =>
          item.level ? `${item.skill} (${item.level})` : item.skill
        ).filter(s => s);
      };

      const formatAttributes = (attrsArray) => {
        if (!Array.isArray(attrsArray)) return {};
        const result = {};
        attrsArray.forEach(item => {
          if (item.attribute && item.value) {
            result[item.attribute] = item.value;
          }
        });
        return result;
      };

      const formatRelationships = (relsArray) => {
        if (!Array.isArray(relsArray)) return [];
        return relsArray.map(item => ({
          name: item.name || "",
          relationship: item.description || ""
        })).filter(r => r.name || r.relationship);
      };

      const formatSpeechStyles = (stylesArray) => {
        if (!Array.isArray(stylesArray)) return [];
        return stylesArray.map(item => ({
          situation: item.situation || "",
          dialogue: item.dialogue || ""
        })).filter(s => s.situation || s.dialogue);
      };

      return {
        character_info: {
          name: data.name || "",
          aliases: data.aliases ? data.aliases.split(',').map(a => a.trim()) : [],
          age: data.age || "",
          gender: data.gender || "",
          species: data.species || "",
          occupation: data.occupation || "",
          avatar_url: data.avatarUrl || ""
        },
        appearance: {
          general: data.appearance || "",
          height: data.height || "",
          body_type: data.bodyType || "",
          hair_color: data.hairColor || "",
          hair_style: data.hairStyle || "",
          eyes: data.eyes || "",
          clothing: data.clothing || "",
          distinguishing_features: data.features || ""
        },
        personality: {
          summary: data.personality || "",
          traits: data.traits ? data.traits.split(',').map(t => t.trim()) : [],
          strengths: data.strengths ? data.strengths.split(',').map(s => s.trim()) : [],
          weaknesses: data.weaknesses ? data.weaknesses.split(',').map(w => w.trim()) : [],
          likes: data.likes ? data.likes.split(',').map(l => l.trim()) : [],
          dislikes: data.dislikes ? data.dislikes.split(',').map(d => d.trim()) : [],
          fears: data.fears ? data.fears.split(',').map(f => f.trim()) : [],
          goals: data.goals ? data.goals.split(',').map(g => g.trim()) : []
        },
        skills: {
          combat_skills: formatSkills(data.combatSkills),
          life_skills: formatSkills(data.lifeSkills)
        },
        attributes: formatAttributes(data.customAttributes),
        background: {
          birthplace: data.birthplace || "",
          backstory: data.backstory || "",
          key_events: data.keyEvents || "",
          relationships: formatRelationships(data.relationships)
        },
        speech_patterns: {
          examples: formatSpeechStyles(data.speechStyle),
          catchphrases: data.catchphrases ? data.catchphrases.split(',').map(c => c.trim()) : [],
          verbal_tics: data.verbalTics || "",
          emotional_expression: data.emotionalExpression || ""
        },
        ai_instructions: {
          system_prompt: data.systemPrompt || "",
          character_description: data.description || "",
          first_message: data.firstMessage || "",
          example_dialogues: data.exampleDialogues || "",
          scenario: data.scenario || ""
        },
        metadata: {
          tags: data.tags ? data.tags.split(',').map(t => t.trim()) : [],
          world_lore: data.worldLore || "",
          creator: data.creator || "",
          version: data.version || "1.0",
          created_at: new Date().toISOString()
        }
      };
    }

    function buildCharacterDescription(data) {
      let desc = "";

      if (data.name) desc += `Name: ${data.name}\n`;
      if (data.aliases) desc += `Also known as: ${data.aliases}\n`;
      if (data.age) desc += `Age: ${data.age}\n`;
      if (data.gender) desc += `Gender: ${data.gender}\n`;
      if (data.species) desc += `Species: ${data.species}\n`;
      if (data.occupation) desc += `Occupation: ${data.occupation}\n`;
      if (data.avatarUrl) desc += `Avatar: ${data.avatarUrl}\n`;
      desc += "\n";

      if (data.appearance || data.height || data.bodyType || data.hairColor || data.hairStyle || data.eyes || data.clothing || data.features) {
        desc += "ã€Appearanceã€‘\n";
        if (data.appearance) desc += `${data.appearance}\n`;
        if (data.height) desc += `Height: ${data.height}\n`;
        if (data.bodyType) desc += `Build: ${data.bodyType}\n`;
        if (data.hairColor) desc += `Hair Color: ${data.hairColor}\n`;
        if (data.hairStyle) desc += `Hair Style: ${data.hairStyle}\n`;
        if (data.eyes) desc += `Eyes: ${data.eyes}\n`;
        if (data.clothing) desc += `Clothing: ${data.clothing}\n`;
        if (data.features) desc += `Distinguishing features: ${data.features}\n`;
        desc += "\n";
      }

      if (data.personality || data.traits) {
        desc += "ã€Personalityã€‘\n";
        if (data.personality) desc += `${data.personality}\n`;
        if (data.traits) desc += `Traits: ${data.traits}\n`;
        if (data.strengths) desc += `Strengths: ${data.strengths}\n`;
        if (data.weaknesses) desc += `Weaknesses: ${data.weaknesses}\n`;
        if (data.likes) desc += `Likes: ${data.likes}\n`;
        if (data.dislikes) desc += `Dislikes: ${data.dislikes}\n`;
        if (data.fears) desc += `Fears: ${data.fears}\n`;
        if (data.goals) desc += `Goals: ${data.goals}\n`;
        desc += "\n";
      }

      // è™•ç†å‹•æ…‹æŠ€èƒ½æ¬„ä½
      if (Array.isArray(data.combatSkills) && data.combatSkills.length > 0 ||
          Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0) {
        desc += "ã€Skillsã€‘\n";
        if (Array.isArray(data.combatSkills) && data.combatSkills.length > 0) {
          const skills = data.combatSkills.map(item =>
            item.level ? `${item.skill} (${item.level})` : item.skill
          ).join(', ');
          desc += `Combat Skills: ${skills}\n`;
        }
        if (Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0) {
          const skills = data.lifeSkills.map(item =>
            item.level ? `${item.skill} (${item.level})` : item.skill
          ).join(', ');
          desc += `Life Skills: ${skills}\n`;
        }
        desc += "\n";
      }

      // è™•ç†å‹•æ…‹å±¬æ€§æ¬„ä½
      if (Array.isArray(data.customAttributes) && data.customAttributes.length > 0) {
        desc += "ã€Attributesã€‘\n";
        data.customAttributes.forEach(item => {
          if (item.attribute && item.value) {
            desc += `${item.attribute}: ${item.value}\n`;
          }
        });
        desc += "\n";
      }

      if (data.backstory || data.birthplace) {
        desc += "ã€Backgroundã€‘\n";
        if (data.birthplace) desc += `Birthplace: ${data.birthplace}\n`;
        if (data.backstory) desc += `${data.backstory}\n`;
        if (data.keyEvents) desc += `Key events: ${data.keyEvents}\n`;

        // è™•ç†å‹•æ…‹äººéš›é—œä¿‚æ¬„ä½
        if (Array.isArray(data.relationships) && data.relationships.length > 0) {
          desc += "Relationships:\n";
          data.relationships.forEach(item => {
            if (item.name && item.description) {
              desc += `  - ${item.name}: ${item.description}\n`;
            }
          });
        }
        desc += "\n";
      }

      // è™•ç†å‹•æ…‹èªªè©±æ–¹å¼æ¬„ä½
      if (Array.isArray(data.speechStyle) && data.speechStyle.length > 0 ||
          data.catchphrases || data.verbalTics) {
        desc += "ã€Speech Styleã€‘\n";
        if (Array.isArray(data.speechStyle) && data.speechStyle.length > 0) {
          data.speechStyle.forEach(item => {
            if (item.situation && item.dialogue) {
              desc += `When ${item.situation}: ${item.dialogue}\n`;
            }
          });
        }
        if (data.catchphrases) desc += `Catchphrases: ${data.catchphrases}\n`;
        if (data.verbalTics) desc += `Verbal habits: ${data.verbalTics}\n`;
        if (data.emotionalExpression) desc += `Emotional expression: ${data.emotionalExpression}\n`;
        desc += "\n";
      }

      if (data.description) {
        desc += "ã€Additional Descriptionã€‘\n";
        desc += `${data.description}\n`;
      }

      return desc.trim();
    }

    function objectToYAML(obj, indent) {
      let yaml = "";
      const spaces = "  ".repeat(indent);
      
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          const value = obj[key];
          
          if (value === null || value === undefined || value === "") {
            yaml += `${spaces}${key}: ~\n`;
          } else if (typeof value === "object" && !Array.isArray(value)) {
            yaml += `${spaces}${key}:\n`;
            yaml += objectToYAML(value, indent + 1);
          } else if (Array.isArray(value)) {
            if (value.length === 0) {
              yaml += `${spaces}${key}: []\n`;
            } else if (typeof value[0] === "object") {
              yaml += `${spaces}${key}:\n`;
              value.forEach(item => {
                yaml += `${spaces}  -\n`;
                yaml += objectToYAML(item, indent + 2);
              });
            } else {
              yaml += `${spaces}${key}:\n`;
              value.forEach(item => {
                yaml += `${spaces}  - "${String(item).replace(/"/g, '\\"')}"\n`;
              });
            }
          } else if (typeof value === "string" && (value.includes("\n") || value.length > 80)) {
            yaml += `${spaces}${key}: |\n`;
            value.split("\n").forEach(line => {
              yaml += `${spaces}  ${line}\n`;
            });
          } else if (typeof value === "string") {
            yaml += `${spaces}${key}: "${value.replace(/"/g, '\\"')}"\n`;
          } else {
            yaml += `${spaces}${key}: ${value}\n`;
          }
        }
      }
      
      return yaml;
    }

    // ===== æª”æ¡ˆåŒ¯å‡º =====
    function exportFile(format) {
      const data = collectFormData();

      // é©—è­‰è¡¨å–®
      if (!App.validator.validate(data)) {
        return;
      }

      const name = data.name || 'character';
      let content, mimeType, extension;

      switch(format) {
        case 'json':
          content = convertToJSON(data, currentPlatform);
          mimeType = 'application/json';
          extension = 'json';
          break;
        case 'yaml':
          content = convertToYAML(data, currentPlatform);
          mimeType = 'text/yaml';
          extension = 'yaml';
          break;
        case 'markdown':
          content = convertToMarkdown(data, currentPlatform);
          mimeType = 'text/markdown';
          extension = 'md';
          break;
      }

      const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}_${currentPlatform}.${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(`å·²åŒ¯å‡º ${format.toUpperCase()} æª”æ¡ˆï¼`, 'success');
    }

    // ===== PNG åœ–ç‰‡åŒ¯å‡º =====

    /**
     * åŒ¯å‡º YAML ç¨‹å¼ç¢¼åœ–ç‰‡
     */
    async function exportYAMLImage() {
      const data = collectFormData();

      // é©—è­‰è¡¨å–®
      if (!App.validator.validate(data)) {
        return;
      }

      showToast('æ­£åœ¨ç”Ÿæˆ YAML åœ–ç‰‡ï¼Œè«‹ç¨å€™...', 'info');

      try {
        // 1. ç”Ÿæˆ YAML å…§å®¹
        const yamlContent = convertToYAML(data, currentPlatform);

        // 2. å¡«å…¥è³‡æ–™åˆ°éš±è—å®¹å™¨
        const container = document.getElementById('yamlImageContainer');
        const card = container.querySelector('.yaml-code-card');

        container.querySelector('.name').textContent = data.name || 'æœªå‘½åè§’è‰²';
        container.querySelector('.platform').textContent = getPlatformName(currentPlatform);
        container.querySelector('.yaml-meta').textContent =
          `ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;
        container.querySelector('.yaml-content').textContent = yamlContent;

        // 3. æš«æ™‚é¡¯ç¤ºå®¹å™¨ï¼ˆç§»åˆ°å¯è¦‹å€åŸŸï¼‰
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.zIndex = '-1';

        // 4. ç­‰å¾…å­—é«”å’Œæ¨£å¼è¼‰å…¥
        await new Promise(resolve => setTimeout(resolve, 100));

        // 5. ä½¿ç”¨ html2canvas æˆªåœ–
        const canvas = await html2canvas(card, {
          backgroundColor: '#1e1e1e',
          scale: 2, // é«˜è§£æåº¦
          logging: false,
          windowWidth: card.scrollWidth,
          windowHeight: card.scrollHeight
        });

        // 6. è½‰æ›ç‚º PNG ä¸¦ä¸‹è¼‰
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${data.name || 'character'}_yaml_${currentPlatform}.png`;
          a.click();
          URL.revokeObjectURL(url);

          showToast('YAML åœ–ç‰‡å·²åŒ¯å‡ºï¼', 'success');
        }, 'image/png');

        // 7. éš±è—å®¹å™¨
        container.style.position = 'fixed';
        container.style.top = '-9999px';
        container.style.left = '-9999px';

      } catch (error) {
        console.error('YAML åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼š', error);
        showToast('åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    /**
     * åŒ¯å‡ºè§’è‰²å¡è¦–è¦ºé è¦½åœ–ç‰‡
     */
    async function exportCharacterCardImage() {
      const data = collectFormData();

      // é©—è­‰è¡¨å–®
      if (!App.validator.validate(data)) {
        return;
      }

      showToast('æ­£åœ¨ç”Ÿæˆè§’è‰²å¡åœ–ç‰‡ï¼Œè«‹ç¨å€™...', 'info');

      try {
        // 1. ç²å–è§’è‰²å¡é è¦½å€åŸŸ
        const cardElement = document.querySelector('#previewCard .preview-card');

        if (!cardElement) {
          showToast('æ‰¾ä¸åˆ°è§’è‰²å¡é è¦½å€åŸŸ', 'error');
          return;
        }

        // 2. æ·»åŠ åŒ¯å‡ºæ¨¡å¼ classï¼ˆå¦‚éœ€éš±è—æŸäº›å…ƒç´ ï¼‰
        cardElement.classList.add('export-mode');

        // 3. ç­‰å¾…æ¸²æŸ“å®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 100));

        // 4. ä½¿ç”¨ html2canvas æˆªåœ–
        const canvas = await html2canvas(cardElement, {
          backgroundColor: '#ffffff',
          scale: 2, // 2å€è§£æåº¦ï¼ˆé«˜æ¸…ï¼‰
          logging: false,
          useCORS: true, // å…è¨±è·¨åŸŸåœ–ç‰‡ï¼ˆé ­åƒï¼‰
          allowTaint: true,
          windowWidth: cardElement.scrollWidth,
          windowHeight: cardElement.scrollHeight,
          onclone: (clonedDoc) => {
            // ä¿®å¾©æ¼¸è®Šè‰²å•é¡Œï¼šå°‡æ¼¸è®Šæ›¿æ›ç‚ºç´”è‰²
            const clonedCard = clonedDoc.querySelector('#previewCard .preview-card');
            if (clonedCard) {
              clonedCard.style.background = '#f9fafb';
            }
            const avatar = clonedDoc.querySelector('.preview-card-avatar');
            if (avatar) {
              avatar.style.background = '#667eea';
            }
          }
        });

        // 5. è½‰æ›ç‚º PNG ä¸¦ä¸‹è¼‰
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${data.name || 'character'}_card.png`;
          a.click();
          URL.revokeObjectURL(url);

          showToast('è§’è‰²å¡åœ–ç‰‡å·²åŒ¯å‡ºï¼', 'success');
        }, 'image/png');

        // 6. ç§»é™¤åŒ¯å‡ºæ¨¡å¼
        cardElement.classList.remove('export-mode');

      } catch (error) {
        console.error('è§’è‰²å¡åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼š', error);
        showToast('åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    // ===== æª”æ¡ˆåŒ¯å…¥ =====

    /**
     * è™•ç†æª”æ¡ˆåŒ¯å…¥
     */
    async function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const extension = file.name.split('.').pop().toLowerCase();
      const imageExtensions = ['png', 'jpg', 'jpeg', 'webp'];

      // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡æª”æ¡ˆ
      if (imageExtensions.includes(extension)) {
        // æª¢æŸ¥æ˜¯å¦æœ‰ API Key
        const settings = App.settings.get();
        if (!settings.geminiApiKey) {
          showToast('åœ–ç‰‡åŒ¯å…¥éœ€è¦è¨­å®š Gemini API Keyï¼', 'warning');
          App.ui.openSettings();
          event.target.value = '';
          return;
        }

        // ä½¿ç”¨ AI è®€å–åœ–ç‰‡
        await importFromImage(file);
        event.target.value = '';
        return;
      }

      // è™•ç†æ–‡å­—æª”æ¡ˆï¼ˆJSON, YAML, MDï¼‰
      showToast('æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');

      try {
        const text = await file.text();
        let data = null;

        // æ ¹æ“šæª”æ¡ˆé¡å‹è§£æ
        if (extension === 'json') {
          data = await importFromJSON(text);
        } else if (extension === 'yaml' || extension === 'yml') {
          data = await importFromYAML(text);
        } else if (extension === 'md') {
          data = await importFromMarkdown(text);
        } else {
          showToast('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼', 'error');
          return;
        }

        if (data) {
          fillFormData(data);
          showToast('åŒ¯å…¥æˆåŠŸï¼', 'success');
        }

      } catch (error) {
        console.error('åŒ¯å…¥å¤±æ•—ï¼š', error);
        showToast('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼ŒåŒ¯å…¥å¤±æ•—', 'error');
      }

      // æ¸…é™¤æª”æ¡ˆé¸æ“‡
      event.target.value = '';
    }

    /**
     * å¾ JSON åŒ¯å…¥
     */
    async function importFromJSON(text) {
      const json = JSON.parse(text);

      // åˆ¤æ–·æ ¼å¼ä¸¦è½‰æ›ç‚ºçµ±ä¸€æ ¼å¼
      if (json.character_info) {
        // Gemini æ ¼å¼
        return parseGeminiFormat(json);
      } else if (json.spec === 'chara_card_v2') {
        // SillyTavern æ ¼å¼
        return parseSillyTavernFormat(json);
      } else if (json.type === 'risuai') {
        // RisuAI æ ¼å¼
        return parseRisuAIFormat(json);
      } else if (json.name && json.definition) {
        // Character.AI æ ¼å¼
        return parseCharacterAIFormat(json);
      } else {
        // å˜—è©¦ç›´æ¥ä½¿ç”¨
        return json;
      }
    }

    /**
     * å¾ YAML åŒ¯å…¥
     */
    async function importFromYAML(text) {
      // ä½¿ç”¨ js-yaml è§£æ
      const yaml = jsyaml.load(text);
      return await importFromJSON(JSON.stringify(yaml));
    }

    /**
     * å¾ Markdown åŒ¯å…¥ï¼ˆåŸºç¤è§£æï¼‰
     */
    async function importFromMarkdown(text) {
      // åŸºç¤çš„ Markdown è§£æ
      const data = {};

      // æå–æ¨™é¡Œä½œç‚ºåç¨±
      const nameMatch = text.match(/^#\s+(.+)$/m);
      if (nameMatch) data.name = nameMatch[1];

      // æå–åŸºæœ¬è³‡è¨Šè¡¨æ ¼
      const tableMatch = text.match(/\|.*åç¨±.*\|.*(.+).*\|/);
      // ç°¡åŒ–ç‰ˆï¼šåªæå–åç¨±ï¼Œå…¶ä»–æ¬„ä½å¯ä»¥è£œå……

      showToast('Markdown åŒ¯å…¥åƒ…æ”¯æ´åŸºç¤è§£æï¼Œå»ºè­°ä½¿ç”¨ JSON æˆ– YAML', 'warning');
      return data;
    }

    /**
     * å¾åœ–ç‰‡åŒ¯å…¥ï¼ˆä½¿ç”¨ Gemini Vision APIï¼‰
     */
    async function importFromImage(file) {
      showToast('æ­£åœ¨ä½¿ç”¨ AI è®€å–åœ–ç‰‡...', 'info');

      try {
        // 1. å°‡åœ–ç‰‡è½‰æ›ç‚º Base64
        const base64Image = await fileToBase64(file);
        const base64Data = base64Image.split(',')[1]; // ç§»é™¤ data:image/...;base64, å‰ç¶´

        // 2. ç²å– API Key
        const settings = App.settings.get();
        const apiKey = settings.geminiApiKey;

        // 3. æº–å‚™ AI æç¤ºè©
        const prompt = `è«‹åˆ†æé€™å¼µè§’è‰²å¡åœ–ç‰‡ï¼Œæå–æ‰€æœ‰è§’è‰²è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼å›å‚³ã€‚

è«‹æå–ä»¥ä¸‹æ¬„ä½ï¼ˆå¦‚æœåœ–ç‰‡ä¸­æœ‰çš„è©±ï¼‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥åï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½",
  "appearance": "å¤–è§€æè¿°",
  "height": "èº«é«˜",
  "bodyType": "é«”å‹",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›ç‰¹å¾µ",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "é¡¯è‘—ç‰¹å¾µ",
  "personality": "æ€§æ ¼æè¿°",
  "traits": "ç‰¹è³ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹",
  "keyEvents": "é—œéµäº‹ä»¶",
  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»",
  "description": "è§’è‰²æè¿°",
  "systemPrompt": "ç³»çµ±æç¤ºè©"
}

é‡è¦è¦å‰‡ï¼š
1. åªå›å‚³ç´” JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ– markdown æ ¼å¼
2. æ‰€æœ‰å­—æ®µçš„å€¼éƒ½å¿…é ˆæ˜¯å­—ç¬¦ä¸²é¡å‹
3. å¦‚æœåœ–ç‰‡ä¸­æ²’æœ‰æŸå€‹æ¬„ä½ï¼Œè«‹å¿½ç•¥è©²æ¬„ä½ï¼ˆä¸è¦å›å‚³ç©ºå­—ç¬¦ä¸²ï¼‰
4. JSON å¿…é ˆèƒ½è¢« JSON.parse() ç›´æ¥è§£æ`;

        // 4. èª¿ç”¨ Gemini Vision API
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey
            },
            body: JSON.stringify({
              contents: [{
                parts: [
                  { text: prompt },
                  {
                    inline_data: {
                      mime_type: file.type,
                      data: base64Data
                    }
                  }
                ]
              }],
              generationConfig: {
                temperature: 0.4,
                topK: 32,
                topP: 1,
                maxOutputTokens: 8192,
              }
            })
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Gemini API');
        }

        const data = await response.json();

        // æª¢æŸ¥å›æ‡‰çµæ§‹
        if (!data.candidates || !data.candidates[0]) {
          console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
          throw new Error(data.error?.message || 'API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
        }

        const generatedText = data.candidates[0].content.parts[0].text;

        // 5. è§£æ JSON
        let jsonText = generatedText.trim();
        if (jsonText.startsWith('```json')) {
          jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
        } else if (jsonText.startsWith('```')) {
          jsonText = jsonText.replace(/```\n?/g, '');
        }

        // ä¿®å¾©å¸¸è¦‹çš„ JSON æ ¼å¼éŒ¯èª¤
        jsonText = jsonText
          .replace(/,\s*}/g, '}')
          .replace(/,\s*]/g, ']')
          .trim();

        try {
          const characterData = JSON.parse(jsonText);
          fillFormData(characterData);
          showToast('åœ–ç‰‡åŒ¯å…¥æˆåŠŸï¼', 'success');
        } catch (e) {
          console.error('JSON è§£æå¤±æ•—:', e);
          console.log('åŸå§‹å›æ‡‰:', generatedText);
          console.log('æ¸…ç†å¾Œçš„ JSON:', jsonText);
          throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦');
        }

      } catch (error) {
        console.error('åœ–ç‰‡åŒ¯å…¥å¤±æ•—ï¼š', error);
        showToast(`åœ–ç‰‡åŒ¯å…¥å¤±æ•—: ${error.message}`, 'error');
      }
    }

    /**
     * å°‡æª”æ¡ˆè½‰æ›ç‚º Base64
     */
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /**
     * è§£æ Gemini æ ¼å¼
     */
    function parseGeminiFormat(json) {
      return {
        avatarUrl: json.character_info?.avatar_url || '',
        name: json.character_info?.name || '',
        aliases: json.character_info?.aliases?.join(', ') || '',
        age: json.character_info?.age || '',
        gender: json.character_info?.gender || '',
        species: json.character_info?.species || '',
        occupation: json.character_info?.occupation || '',
        appearance: json.appearance?.general || '',
        height: json.appearance?.height || '',
        bodyType: json.appearance?.body_type || '',
        hairColor: json.appearance?.hair_color || json.appearance?.hair || '',
        hairStyle: json.appearance?.hair_style || '',
        eyes: json.appearance?.eyes || '',
        clothing: json.appearance?.clothing || '',
        features: json.appearance?.distinguishing_features || '',
        personality: json.personality?.summary || '',
        traits: json.personality?.traits?.join(', ') || '',
        strengths: json.personality?.strengths?.join(', ') || '',
        weaknesses: json.personality?.weaknesses?.join(', ') || '',
        likes: json.personality?.likes?.join(', ') || '',
        dislikes: json.personality?.dislikes?.join(', ') || '',
        fears: json.personality?.fears?.join(', ') || '',
        goals: json.personality?.goals?.join(', ') || '',
        combatSkills: json.skills?.combat_skills?.join(', ') || '',
        lifeSkills: json.skills?.life_skills?.join(', ') || '',
        customAttributes: json.attributes || '',
        birthplace: json.background?.birthplace || '',
        backstory: json.background?.backstory || '',
        keyEvents: json.background?.key_events || '',
        relationships: json.background?.relationships || '',
        speechStyle: json.speech_patterns?.style || '',
        catchphrases: json.speech_patterns?.catchphrases?.join(', ') || '',
        verbalTics: json.speech_patterns?.verbal_tics || '',
        emotionalExpression: json.speech_patterns?.emotional_expression || '',
        description: json.ai_instructions?.character_description || '',
        systemPrompt: json.ai_instructions?.system_prompt || '',
        firstMessage: json.ai_instructions?.first_message || '',
        exampleDialogues: json.ai_instructions?.example_dialogues || '',
        scenario: json.ai_instructions?.scenario || '',
        tags: json.metadata?.tags?.join(', ') || '',
        worldLore: json.metadata?.world_lore || '',
        creator: json.metadata?.creator || '',
        version: json.metadata?.version || '1.0'
      };
    }

    /**
     * è§£æ SillyTavern æ ¼å¼
     */
    function parseSillyTavernFormat(json) {
      const data = json.data;
      return {
        name: data.name || '',
        personality: data.personality || '',
        scenario: data.scenario || '',
        firstMessage: data.first_mes || '',
        exampleDialogues: data.mes_example || '',
        systemPrompt: data.system_prompt || '',
        tags: data.tags?.join(', ') || '',
        creator: data.creator || '',
        version: data.character_version || '1.0',
        worldLore: data.extensions?.world || ''
      };
    }

    /**
     * è§£æ RisuAI æ ¼å¼
     */
    function parseRisuAIFormat(json) {
      const data = json.data;
      return {
        name: data.name || '',
        firstMessage: data.firstMessage || '',
        personality: data.personality || '',
        scenario: data.scenario || '',
        exampleDialogues: data.exampleMessage || '',
        systemPrompt: data.systemPrompt || '',
        tags: data.tags?.join(', ') || '',
        creator: data.creator || '',
        version: data.characterVersion || '1.0'
      };
    }

    /**
     * è§£æ Character.AI æ ¼å¼
     */
    function parseCharacterAIFormat(json) {
      return {
        name: json.name || '',
        aliases: json.title || '',
        description: json.description || '',
        firstMessage: json.greeting || '',
        tags: json.categories?.join(', ') || ''
      };
    }

    /**
     * å¡«å…¥è¡¨å–®è³‡æ–™
     */
    function fillFormData(data) {
      // ç‰¹æ®Šè™•ç†å‹•æ…‹æ¬„ä½
      const dynamicFieldTypes = ['relationships', 'combatSkills', 'lifeSkills', 'customAttributes', 'speechStyle'];

      for (const key in data) {
        // å¦‚æœæ˜¯å‹•æ…‹æ¬„ä½ï¼Œä½¿ç”¨ App.dynamicFields.fill
        if (dynamicFieldTypes.includes(key) && Array.isArray(data[key])) {
          App.dynamicFields.fill(key, data[key]);
        } else {
          // ä¸€èˆ¬æ¬„ä½ç›´æ¥å¡«å……
          const field = document.getElementById(key);
          if (field && data[key]) {
            field.value = data[key];
          }
        }
      }
      updatePreview();
    }

    // ===== è¤‡è£½åŠŸèƒ½ =====

    /**
     * è¤‡è£½é è¦½å…§å®¹åˆ°å‰ªè²¼ç°¿
     */
    async function copyPreviewContent() {
      const currentTab = App.state.currentPreviewTab;
      let content = '';

      switch (currentTab) {
        case 'json':
          content = document.getElementById('jsonCode').textContent;
          break;
        case 'yaml':
          content = document.getElementById('yamlCode').textContent;
          break;
        case 'markdown':
          content = document.getElementById('markdownCode').textContent;
          break;
        default:
          showToast('è§’è‰²å¡é è¦½ç„¡æ³•è¤‡è£½ï¼Œè«‹ä½¿ç”¨å…¶ä»–æ ¼å¼', 'warning');
          return;
      }

      try {
        await navigator.clipboard.writeText(content);
        showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
      } catch (error) {
        console.error('è¤‡è£½å¤±æ•—ï¼š', error);
        showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½', 'error');
      }
    }

    // ===== æç¤ºè¨Šæ¯ =====
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ– Google OAuth
      if (typeof google !== 'undefined') {
        App.auth.init();
      } else {
        // Google API å°šæœªè¼‰å…¥ï¼Œå»¶é²åˆå§‹åŒ–
        window.addEventListener('load', () => {
          setTimeout(() => App.auth.init(), 500);
        });
      }

      // è¼‰å…¥è¨­å®š
      App.settings.get();

      // åˆå§‹åŒ–å‹•æ…‹æ¬„ä½
      App.dynamicFields.init();

      // æ¸²æŸ“æ‰€æœ‰å¿«é€Ÿæ¨™ç±¤
      App.ui.renderQuickTags('species', 'speciesTags');
      App.ui.renderQuickTags('occupation', 'occupationTags');
      App.ui.renderQuickTags('appearance', 'appearanceTags');
      App.ui.renderQuickTags('hair', 'hairTags');
      App.ui.renderQuickTags('eyes', 'eyesTags');
      App.ui.renderQuickTags('clothing', 'clothingTags');
      App.ui.renderQuickTags('personality', 'personalityTags');
      App.ui.renderQuickTags('traits', 'traitsTags');

      // æ›´æ–°é è¦½
      updatePreview();
    });
  </script>
</body>
</html>