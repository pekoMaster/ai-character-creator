<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIäº’å‹•èŠå¤©è§’è‰²å¡å·¥å…·</title>
  <!-- Version: 2025-01-29-fix-json-truncation -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- å¤–éƒ¨è³‡æº CDN -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

  <!-- é…ç½®æ–‡ä»¶ -->
  <script src="config.js"></script>

  <style>
    /* ===== CSS è®Šæ•¸å®šç¾© ===== */
    :root {
      /* ğŸ¨ ä¸»é¡Œè‰²å½©ï¼ˆæŸ”å’Œä¸­æ€§ï¼‰ */
      --primary: #5B7BFF;
      --primary-dark: #4A6AEE;
      --primary-light: #8FA9FF;
      --primary-glow: rgba(91, 123, 255, 0.3);

      --secondary: #FF6B9D;
      --secondary-dark: #EE5A8C;
      --secondary-light: #FF9BBF;

      --accent: #9D7BFF;
      --success: #06D6A0;
      --warning: #FFB800;
      --danger: #FF6B6B;
      --info: #4FC3F7;

      /* ğŸŒˆ æ¼¸è®Šè‰²å½© */
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --gradient-soft: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --gradient-sunset: linear-gradient(135deg, #ff6b9d 0%, #ffa06b 100%);
      --gradient-ocean: linear-gradient(135deg, #4fc3f7 0%, #5b7bff 100%);
      --gradient-forest: linear-gradient(135deg, #06d6a0 0%, #54d8c7 100%);

      /* ğŸŒ‘ æ·ºè‰²æ¨¡å¼é¡è‰² */
      --bg-primary: #F8F9FA;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F1F3F5;

      --text-primary: #1A1A1A;
      --text-secondary: #4A5568;
      --text-tertiary: #718096;
      --text-inverse: #FFFFFF;

      --border-color: #E2E8F0;
      --border-light: #F1F3F5;
      --border-dark: #CBD5E1;

      /* ğŸ¯ ä¸­æ€§è‰²ç³»ï¼ˆå„ªåŒ–ç°éšï¼‰ */
      --gray-50: #FAFBFC;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;

      /* ğŸ“ åœ“è§’ç³»çµ±ï¼ˆç¾ä»£åŒ–å¤§åœ“è§’ï¼‰ */
      --radius-xs: 6px;
      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 20px;
      --radius-xl: 24px;
      --radius-2xl: 32px;
      --radius-full: 9999px;
      --radius: var(--radius-md);

      /* ğŸ’« é™°å½±ç³»çµ±ï¼ˆå¤šå±¤æ¬¡æŸ”å’Œé™°å½±ï¼‰ */
      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-sm:
        0 1px 3px 0 rgba(0, 0, 0, 0.1),
        0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-md:
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-lg:
        0 20px 25px -5px rgba(0, 0, 0, 0.1),
        0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --shadow-xl:
        0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --shadow-2xl:
        0 30px 60px -15px rgba(0, 0, 0, 0.3);
      --shadow-colored:
        0 10px 30px -5px var(--primary-glow);
      --shadow-glow:
        0 0 20px rgba(91, 123, 255, 0.3),
        0 0 40px rgba(91, 123, 255, 0.1);

      /* ğŸ”® ç»ç’ƒæ“¬æ…‹æ•ˆæœ */
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-blur: blur(12px);

      /* âš¡ å‹•ç•«æ™‚é–“ */
      --transition-fast: 150ms;
      --transition-base: 250ms;
      --transition-slow: 350ms;
      --transition-slower: 500ms;

      /* ğŸ“ é–“è·ç³»çµ±ï¼ˆ8px gridï¼‰ */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      --spacing-3xl: 64px;

      /* ğŸ­ Z-index å±¤ç´š */
      --z-dropdown: 1000;
      --z-sticky: 1020;
      --z-fixed: 1030;
      --z-modal-backdrop: 1040;
      --z-modal: 1050;
      --z-popover: 1060;
      --z-tooltip: 1070;
    }

    /* ğŸŒ™ æ·±è‰²æ¨¡å¼ */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg-primary: #0F1419;
        --bg-secondary: #1A1F2E;
        --bg-tertiary: #252C3C;

        --text-primary: #E4E6EB;
        --text-secondary: #B4B8C5;
        --text-tertiary: #8B92A6;
        --text-inverse: #FFFFFF;

        --border-color: #2D3748;
        --border-light: #252C3C;
        --border-dark: #3F4758;

        --glass-bg: rgba(26, 31, 46, 0.7);
        --glass-border: rgba(255, 255, 255, 0.1);

        --shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.3),
          0 2px 4px -2px rgba(0, 0, 0, 0.3);
        --shadow-md:
          0 10px 15px -3px rgba(0, 0, 0, 0.3),
          0 4px 6px -4px rgba(0, 0, 0, 0.3);
        --shadow-lg:
          0 20px 25px -5px rgba(0, 0, 0, 0.4),
          0 8px 10px -6px rgba(0, 0, 0, 0.4);
      }
    }

    /* ğŸ¨ æ‰‹å‹•æ·±è‰²æ¨¡å¼åˆ‡æ› */
    [data-theme="dark"] {
      --bg-primary: #0F1419;
      --bg-secondary: #1A1F2E;
      --bg-tertiary: #252C3C;

      --text-primary: #E4E6EB;
      --text-secondary: #B4B8C5;
      --text-tertiary: #8B92A6;
      --text-inverse: #FFFFFF;

      --border-color: #2D3748;
      --border-light: #252C3C;
      --border-dark: #3F4758;

      --glass-bg: rgba(26, 31, 46, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);

      --shadow:
        0 4px 6px -1px rgba(0, 0, 0, 0.3),
        0 2px 4px -2px rgba(0, 0, 0, 0.3);
      --shadow-md:
        0 10px 15px -3px rgba(0, 0, 0, 0.3),
        0 4px 6px -4px rgba(0, 0, 0, 0.3);
      --shadow-lg:
        0 20px 25px -5px rgba(0, 0, 0, 0.4),
        0 8px 10px -6px rgba(0, 0, 0, 0.4);
    }

    /* ===== å…¨åŸŸæ¨£å¼ ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    *,
    *::before,
    *::after {
      box-sizing: inherit;
    }

    html {
      box-sizing: border-box;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.6;
      position: relative;
      overflow-x: hidden;
      transition: background-color var(--transition-base) ease;
    }

    /* ğŸ¨ ç¾ä»£åŒ–èƒŒæ™¯è£é£¾ */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background:
        radial-gradient(circle at 20% 50%, rgba(91, 123, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 107, 157, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(157, 123, 255, 0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      animation: backgroundShift 30s ease-in-out infinite;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(2%, 2%) rotate(1deg); }
      50% { transform: translate(-1%, 3%) rotate(-1deg); }
      75% { transform: translate(3%, -2%) rotate(0.5deg); }
    }

    /* ===== ä¸»å®¹å™¨ ===== */
    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: var(--spacing-lg);
      position: relative;
      z-index: 1;
    }

    /* ===== é é¦– ===== */
    .header {
      text-align: center;
      padding: var(--spacing-3xl) var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      position: relative;
    }

    .header h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 800;
      margin-bottom: var(--spacing-md);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
      animation: fadeInDown var(--transition-slower) ease-out;
      line-height: 1.2;
    }

    .header p {
      font-size: clamp(1rem, 2.5vw, 1.2rem);
      color: var(--text-secondary);
      font-weight: 500;
      animation: fadeInUp var(--transition-slower) ease-out 0.1s backwards;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ===== æ§åˆ¶åˆ— ===== */
    .controls-bar {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-lg);
      align-items: center;
      justify-content: space-between;
      animation: fadeInUp var(--transition-slower) ease-out 0.2s backwards;
      transition: all var(--transition-base) ease;
    }

    .controls-bar:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-2px);
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .control-group label {
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
    }

    /* ===== æ¨¡å¼åˆ‡æ›é–‹é—œ ===== */
    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: var(--gray-300);
      border-radius: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: var(--primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: var(--shadow);
    }

    .toggle-switch.active::after {
      transform: translateX(28px);
    }

    .mode-label {
      font-weight: 600;
      color: var(--primary);
      min-width: 60px;
    }

    /* ===== å¹³å°é¸æ“‡æŒ‰éˆ• ===== */
    .platform-buttons {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .platform-btn {
      padding: 12px 20px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all var(--transition-base) cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      position: relative;
      overflow: hidden;
    }

    .platform-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: var(--primary-glow);
      transform: translate(-50%, -50%);
      transition: width var(--transition-slow) ease, height var(--transition-slow) ease;
    }

    .platform-btn:hover {
      border-color: var(--primary-light);
      background: var(--bg-tertiary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .platform-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .platform-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: var(--text-inverse);
      box-shadow: var(--shadow-colored);
      transform: translateY(-2px);
    }

    .platform-btn.active:hover {
      background: var(--primary-dark);
    }

    .platform-btn .icon {
      font-size: 1.2rem;
      transition: transform var(--transition-base) ease;
      position: relative;
      z-index: 1;
    }

    .platform-btn:hover .icon {
      transform: scale(1.1) rotate(5deg);
    }

    /* ===== ä¸»è¦å…§å®¹å€ ===== */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    /* ===== è¡¨å–®å€åŸŸ ===== */
    .form-panel {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      animation: fadeInUp var(--transition-slower) ease-out 0.3s backwards;
      transition: all var(--transition-base) ease;
    }

    .form-panel:hover {
      box-shadow: var(--shadow-2xl);
    }

    .form-section {
      border-bottom: 1px solid var(--border-color);
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .section-header {
      background: var(--bg-tertiary);
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: background 0.2s;
    }

    .section-header:hover {
      background: var(--gray-100);
    }

    .section-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-header .icon {
      font-size: 1.2rem;
    }

    .section-toggle {
      font-size: 1.2rem;
      color: var(--gray-400);
      transition: transform 0.3s;
    }

    .section-header.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    /* AI å€å¡Šè£œå……æŒ‰éˆ• */
    .ai-fill-btn {
      padding: 4px 12px;
      font-size: 0.85rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text-inverse);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-right: 8px;
    }

    .ai-fill-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .ai-fill-btn:active {
      transform: translateY(0);
    }

    .ai-fill-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
    }

    .section-content {
      padding: 20px;
      display: grid;
      gap: 16px;
    }

    .section-content.collapsed {
      display: none;
    }

    /* ===== è¡¨å–®æ¬„ä½ ===== */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-field.full-width {
      grid-column: 1 / -1;
    }

    .form-field label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-field label .required {
      color: var(--danger);
    }

    .form-field label .hint {
      font-weight: 400;
      color: var(--gray-400);
      font-size: 0.8rem;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      font-family: inherit;
      transition: all var(--transition-base) cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .form-field input:hover,
    .form-field select:hover,
    .form-field textarea:hover {
      border-color: var(--border-dark);
      box-shadow: var(--shadow-sm);
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-glow), var(--shadow-md);
      transform: translateY(-1px);
    }

    .form-field textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-field textarea.large {
      min-height: 150px;
    }

    /* ===== å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½æ¨™è¨˜ ===== */
    .full-mode-only {
      display: none;
    }

    .full-mode .full-mode-only {
      display: flex;
    }

    /* ç°¡æ½”ç‰ˆå°ˆç”¨ï¼ˆå®Œæ•´ç‰ˆéš±è—ï¼‰ */
    .simple-mode-only {
      display: flex;
    }

    .full-mode .simple-mode-only {
      display: none;
    }

    /* ===== é è¦½å€åŸŸ ===== */
    .preview-panel {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 200px);
      position: sticky;
      top: var(--spacing-lg);
      animation: fadeInUp var(--transition-slower) ease-out 0.4s backwards;
      transition: all var(--transition-base) ease;
      overflow: hidden;
    }

    .preview-panel:hover {
      box-shadow: var(--shadow-2xl);
    }

    .preview-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .preview-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preview-tabs {
      display: flex;
      gap: 4px;
    }

    .preview-tab {
      padding: 8px 16px;
      border: none;
      background: var(--gray-100);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .preview-tab:hover {
      background: var(--gray-200);
    }

    .preview-tab.active {
      background: var(--primary);
      color: var(--text-inverse);
    }

    .preview-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      min-width: 0; /* é˜²æ­¢å…§å®¹æ’é–‹å®¹å™¨ */
    }

    /* ===== è§’è‰²å¡é è¦½æ¨£å¼ ===== */
    .character-preview {
      display: none;
    }

    .character-preview.active {
      display: block;
    }

    .preview-card {
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .preview-card-header {
      text-align: center;
      padding-bottom: var(--spacing-lg);
      border-bottom: 2px dashed var(--border-color);
      margin-bottom: var(--spacing-lg);
    }

    .preview-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: var(--text-inverse);
      box-shadow: var(--shadow-lg);
    }

    .preview-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 4px;
    }

    .preview-aliases {
      color: var(--text-tertiary);
      font-style: italic;
    }

    .preview-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      margin-top: 12px;
    }

    .preview-tag {
      padding: 4px 10px;
      background: var(--primary-light);
      color: var(--primary-dark);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .preview-section {
      margin-bottom: 20px;
    }

    .preview-section:last-child {
      margin-bottom: 0;
    }

    .preview-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preview-section-content {
      color: var(--text-primary);
      font-size: 0.95rem;
      line-height: 1.7;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .preview-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .preview-item-label {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
    }

    .preview-item-value {
      font-weight: 500;
      color: var(--text-primary);
    }

    .preview-first-message {
      background: var(--gray-100);
      border-left: 4px solid var(--primary);
      padding: 16px;
      border-radius: 0 8px 8px 0;
      font-style: italic;
      color: var(--text-secondary);
    }

    /* ===== ç¨‹å¼ç¢¼é è¦½ ===== */
    .code-preview {
      display: none;
      height: 100%;
    }

    .code-preview.active {
      display: block;
    }

    .code-preview pre {
      background: var(--gray-900);
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      white-space: pre-wrap; /* è‡ªå‹•æ›è¡Œ */
      word-wrap: break-word; /* é•·å–®è©è‡ªå‹•æ–·è¡Œ */
      max-width: 100%; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
      font-size: 0.85rem;
      line-height: 1.6;
      max-height: 500px;
      overflow-y: auto;
    }

    /* ===== åŒ¯å‡ºæŒ‰éˆ•å€ ===== */
    .export-buttons-container {
      padding: 16px 20px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .export-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .export-btn {
      flex: 1;
      min-width: 100px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .export-btn.json {
      background: var(--warning);
      color: white;
    }

    .export-btn.yaml {
      background: var(--success);
      color: white;
    }

    .export-btn.markdown {
      background: var(--primary);
      color: white;
    }

    .export-btn.txt {
      background: #4B5563;
      color: white;
    }

    .export-btn.json-compact {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .export-btn.png-markdown {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* ===== æç¤ºè¨Šæ¯ ===== */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: #2D3748;
      color: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(20px);
      transition: all var(--transition-base);
      z-index: var(--z-tooltip);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    /* ===== éŸ¿æ‡‰å¼èª¿æ•´ ===== */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .control-group {
        flex-direction: column;
        align-items: flex-start;
      }

      .platform-buttons {
        width: 100%;
        justify-content: center;
      }

      .preview-panel {
        position: relative;
        max-height: none;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .preview-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ===== è¨­å®šèˆ‡ç™»å…¥æŒ‰éˆ• ===== */
    .settings-login-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .icon-btn {
      padding: 10px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 1.2rem;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn:hover {
      border-color: var(--primary);
      background: var(--bg-tertiary);
      box-shadow: var(--shadow-sm);
    }

    .icon-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .icon-btn.primary:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-colored);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 2px solid var(--border-color);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--primary);
    }

    .user-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    /* ===== Modal å½ˆçª— ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: var(--spacing-xl);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-2xl);
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--border-color);
    }

    .modal-header h2 {
      font-size: 1.5rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-400);
      transition: color 0.2s;
      padding: 5px;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .setting-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .setting-item label {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .setting-item input {
      padding: 10px 14px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: 'Courier New', monospace;
    }

    .setting-item input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .setting-item .hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .setting-item .hint a {
      color: var(--primary);
      text-decoration: none;
    }

    .setting-item .hint a:hover {
      text-decoration: underline;
    }

    .setting-item select {
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .setting-item select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-glow), var(--shadow-md);
    }

    .api-key-item {
      transition: all 0.3s ease;
    }

    .modal-footer {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid var(--gray-200);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all var(--transition-base);
      color: white;
    }

    .btn.primary {
      background: var(--primary);
      color: white;
    }

    .btn.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-colored);
    }

    .btn.secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn.secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }

    /* ===== éª°å­æŒ‰éˆ• ===== */
    .dice-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
      margin-left: 8px;
    }

    .dice-btn:hover {
      background: var(--primary);
      transform: rotate(360deg);
    }

    /* ===== å¿«é€Ÿæ¨™ç±¤ ===== */
    .quick-tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px dashed var(--gray-300);
    }

    .quick-tag {
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all var(--transition-base);
      color: var(--text-primary);
      user-select: none;
    }

    .quick-tag:hover {
      background: var(--primary);
      color: var(--text-inverse);
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* ===== PNG åŒ¯å‡ºæŒ‰éˆ•æ¨£å¼ ===== */
    .export-btn.png-card {
      background: var(--secondary);
      color: white;
    }

    .export-btn.png-yaml {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* ===== YAML åœ–ç‰‡å¡ç‰‡æ¨£å¼ ===== */
    #yamlImageContainer {
      position: fixed;
      top: -9999px;
      left: -9999px;
    }

    .yaml-code-card {
      width: 1000px;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border-radius: 12px;
      overflow: hidden;
    }

    .yaml-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 30px;
      color: var(--text-inverse);
    }

    .yaml-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .yaml-title .icon {
      font-size: 1.8rem;
    }

    .yaml-title .platform {
      font-size: 0.9rem;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: auto;
    }

    .yaml-meta {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .yaml-body {
      padding: 30px;
      background: #1e1e1e;
    }

    .yaml-content {
      color: #d4d4d4;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }

    .yaml-footer {
      padding: 15px 30px;
      background: #252525;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
      border-top: 1px solid #333;
    }

    /* Markdown åœ–ç‰‡åŒ¯å‡ºå®¹å™¨ */
    #markdownImageContainer {
      position: fixed;
      top: -9999px;
      left: -9999px;
    }

    .markdown-code-card {
      width: 1000px;
      background: #ffffff;
      color: #1a202c;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .markdown-header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      padding: 20px 30px;
      color: var(--text-inverse);
    }

    .markdown-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .markdown-title .name {
      font-size: 28px;
      font-weight: bold;
      margin: 0;
    }

    .markdown-title .platform {
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    .markdown-meta {
      font-size: 13px;
      opacity: 0.9;
    }

    .markdown-body {
      padding: 30px;
      background: #ffffff;
    }

    .markdown-content {
      color: #2d3748;
      font-size: 14px;
      line-height: 1.8;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* åŒ¯å‡ºæ¨¡å¼ï¼šéš±è—ä¸éœ€è¦çš„å…ƒç´  */
    .preview-card.export-mode {
      /* ä¿æŒç¾æœ‰æ¨£å¼ */
    }

    /* ===== å‹•ç•« ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-section {
      animation: fadeIn 0.3s ease-out;
    }

    /* ===== å‹•æ…‹æ¬„ä½ç³»çµ± ===== */
    .dynamic-fields-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .dynamic-field-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      animation: fadeIn 0.3s ease-out;
    }

    .dynamic-field-row .form-field {
      flex: 1;
      margin: 0;
    }

    .dynamic-field-row .form-field input,
    .dynamic-field-row .form-field textarea {
      width: 100%;
    }

    .dynamic-field-row .field-controls {
      display: flex;
      gap: 5px;
      padding-top: 8px;
    }

    .dynamic-field-row .dice-btn,
    .dynamic-field-row .remove-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .dynamic-field-row .remove-btn {
      background: var(--danger);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dynamic-field-row .remove-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .dynamic-field-row .remove-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .add-field-btn {
      align-self: flex-start;
      background: var(--success);
      color: var(--text-inverse);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .add-field-btn:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .dynamic-field-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .dynamic-field-header label {
      flex: 1;
      margin: 0;
    }

    /* ===== é›²ç«¯ç®¡ç† ===== */
    .cloud-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .cloud-actions .btn {
      flex: 1;
    }

    .cloud-list h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--text-primary);
    }

    #cloudCharacterList {
      max-height: 400px;
      overflow-y: auto;
    }

    .cloud-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .cloud-item:hover {
      border-color: var(--primary);
      background: var(--bg-tertiary);
    }

    .cloud-item-info {
      flex: 1;
    }

    .cloud-item-name {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 5px;
    }

    .cloud-item-meta {
      font-size: 0.85rem;
      color: var(--text-tertiary);
    }

    .cloud-item-actions {
      display: flex;
      gap: 8px;
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    .loading, .empty-state, .error-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-tertiary);
    }

    .error-state {
      color: var(--danger);
    }

    /* ========== ğŸ¨ ç¾ä»£åŒ–æ–°å¢åŠŸèƒ½ ========== */

    /* ğŸ’« éª¨æ¶å±åŠ è¼‰å‹•ç•« */
    .skeleton {
      background: linear-gradient(
        90deg,
        var(--gray-200) 0%,
        var(--gray-100) 50%,
        var(--gray-200) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: var(--radius-md);
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .skeleton-text {
      height: 16px;
      margin-bottom: var(--spacing-sm);
      border-radius: var(--radius-sm);
    }

    .skeleton-title {
      height: 24px;
      width: 60%;
      margin-bottom: var(--spacing-md);
      border-radius: var(--radius-md);
    }

    .skeleton-avatar {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-full);
    }

    /* ğŸŒ“ æ·±è‰²æ¨¡å¼åˆ‡æ›å™¨ */
    .theme-toggle {
      position: fixed;
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      width: 56px;
      height: 56px;
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-xl);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all var(--transition-base) ease;
      z-index: var(--z-fixed);
      animation: float 3s ease-in-out infinite;
    }

    .theme-toggle:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: var(--shadow-glow);
    }

    .theme-toggle:active {
      transform: translateY(-2px) scale(0.98);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    /* âœ¨ æ”¹é€²çš„ Toast é€šçŸ¥ */
    .toast {
      position: fixed;
      bottom: var(--spacing-xl);
      right: var(--spacing-xl);
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      opacity: 0;
      transform: translateY(20px) scale(0.95);
      transition: all var(--transition-base) cubic-bezier(0.4, 0, 0.2, 1);
      z-index: var(--z-tooltip);
      max-width: 400px;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      animation: toastSlideIn var(--transition-base) ease-out;
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .toast.success {
      border-left: 4px solid var(--success);
      background: var(--glass-bg);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
      background: var(--glass-bg);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
      background: var(--glass-bg);
    }

    .toast.info {
      border-left: 4px solid var(--info);
      background: var(--glass-bg);
    }

    /* ğŸ¯ æ”¹é€²çš„åŒ¯å‡ºæŒ‰éˆ• */
    .export-btn {
      flex: 1;
      min-width: 100px;
      padding: 14px 24px;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all var(--transition-base) cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      position: relative;
      overflow: hidden;
      color: white !important;
    }

    .export-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      transition: left var(--transition-slow) ease;
    }

    .export-btn:hover::before {
      left: 100%;
    }

    .export-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: var(--shadow-lg);
    }

    .export-btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* ğŸ¨ AI è£œå……æŒ‰éˆ•å¢å¼· */
    .ai-fill-btn {
      padding: 6px 14px;
      font-size: 0.875rem;
      background: var(--gradient-primary);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base) cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-right: var(--spacing-sm);
      font-weight: 600;
      box-shadow: var(--shadow-colored);
      position: relative;
      overflow: hidden;
    }

    .ai-fill-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width var(--transition-slow) ease, height var(--transition-slow) ease;
    }

    .ai-fill-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .ai-fill-btn:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: var(--shadow-glow);
    }

    .ai-fill-btn:active {
      transform: translateY(0) scale(0.98);
    }

    .ai-fill-btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª” æŒ‰éˆ• - ç´…è‰²ç³» */
    .ai-import-btn {
      padding: 6px 14px;
      font-size: 0.875rem;
      background: linear-gradient(135deg, #e63946 0%, #a4161a 100%);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.02em;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      margin-right: var(--spacing-sm);
    }

    .ai-import-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, #f44e5c 0%, #b71c23 100%);
    }

    .ai-import-btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .ai-import-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .ai-import-btn:active::before {
      width: 300px;
      height: 300px;
    }

    .ai-import-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ğŸ¨ è®“AIç”Ÿæˆ æŒ‰éˆ• - ç´«è—è‰²ç³» */
    .ai-generate-btn {
      padding: 6px 14px;
      font-size: 0.875rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.02em;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      margin-left: var(--spacing-xs);
    }

    .ai-generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, #7b93f7 0%, #8a5cb8 100%);
    }

    .ai-generate-btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .ai-generate-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .ai-generate-btn:active::before {
      width: 300px;
      height: 300px;
    }

    .ai-generate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ğŸ’¬ ç¢ºèªå°è©±æ¡† */
    .confirm-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease-out;
    }

    .confirm-dialog-box {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow-2xl);
      animation: slideUp 0.3s ease-out;
    }

    .confirm-dialog-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .confirm-dialog-message {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .confirm-dialog-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .confirm-option-btn {
      padding: 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      background: var(--bg-secondary);
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    .confirm-option-btn:hover {
      border-color: var(--primary-color);
      background: var(--bg-tertiary);
      transform: translateX(4px);
    }

    .option-label {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .option-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .confirm-cancel-btn {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .confirm-cancel-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ğŸ² éª°å­æŒ‰éˆ•å¢å¼· */
    .dice-btn {
      transition: all var(--transition-base) cubic-bezier(0.4, 0, 0.2, 1);
    }

    .dice-btn:hover {
      transform: rotate(360deg) scale(1.2);
    }

    .dice-btn:active {
      transform: rotate(360deg) scale(0.9);
    }

    /* ğŸ”„ æ—‹è½‰åŠ è¼‰å‹•ç•« */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ğŸ’ 3D å¡ç‰‡æ•ˆæœ */
    .card-3d {
      transition: transform var(--transition-base) cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
    }

    .card-3d:hover {
      transform: perspective(1000px) rotateX(2deg) rotateY(-2deg) translateY(-4px);
    }

    /* ğŸŒŠ æ³¢ç´‹æ•ˆæœ */
    .ripple {
      position: relative;
      overflow: hidden;
    }

    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      transition: width var(--transition-slow) ease, height var(--transition-slow) ease;
    }

    .ripple:active::after {
      width: 300px;
      height: 300px;
    }

    /* âœ¨ ç™¼å…‰æ•ˆæœ */
    .glow {
      position: relative;
    }

    .glow::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: var(--gradient-primary);
      border-radius: inherit;
      opacity: 0;
      filter: blur(10px);
      transition: opacity var(--transition-base) ease;
      z-index: -1;
    }

    .glow:hover::before {
      opacity: 0.6;
    }

    /* ğŸ“± æ”¹é€²çš„éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1024px) {
      .app-container {
        padding: var(--spacing-md);
      }

      .header h1 {
        font-size: 2rem;
      }

      .controls-bar {
        padding: var(--spacing-md);
      }
    }

    @media (max-width: 768px) {
      .theme-toggle {
        bottom: var(--spacing-md);
        right: var(--spacing-md);
        width: 48px;
        height: 48px;
        font-size: 1.25rem;
      }

      .toast {
        bottom: var(--spacing-md);
        right: var(--spacing-md);
        left: var(--spacing-md);
        max-width: none;
      }

      .header {
        padding: var(--spacing-xl) var(--spacing-md);
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .platform-btn {
        justify-content: center;
      }
    }

    /* ğŸ¯ æ»¾å‹•æ¢ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: var(--radius-sm);
      transition: background var(--transition-base) ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    /* ğŸ­ é¸å–æ–‡å­—ç¾åŒ– */
    ::selection {
      background: var(--primary-glow);
      color: var(--primary-dark);
    }

    ::-moz-selection {
      background: var(--primary-glow);
      color: var(--primary-dark);
    }

    /* âš¡ å„ªåŒ–éæ¸¡æ€§èƒ½ */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é é¦– -->
    <header class="header">
      <h1>ğŸ­ AIäº’å‹•èŠå¤©è§’è‰²å¡å·¥å…·</h1>
      <p>å‰µå»ºå°ˆæ¥­çš„ AI äº’å‹•è§’è‰²å¡ï¼Œæ”¯æ´å¤šå¹³å°æ ¼å¼è¼¸å‡º</p>
    </header>

    <!-- æ§åˆ¶åˆ— -->
    <div class="controls-bar">
      <div class="control-group mode-toggle">
        <label>æ¨¡å¼ï¼š</label>
        <div class="toggle-switch" id="modeToggle" onclick="toggleMode()"></div>
        <span class="mode-label" id="modeLabel">ç²¾ç°¡ç‰ˆ</span>
      </div>

      <div class="control-group">
        <label>ç›®æ¨™å¹³å°ï¼š</label>
        <div class="platform-buttons">
          <button class="platform-btn active" data-platform="gemini" onclick="selectPlatform('gemini')">
            <span class="icon">ğŸŒŸ</span> Gemini 3.0
          </button>
          <button class="platform-btn" data-platform="sillytavern" onclick="selectPlatform('sillytavern')">
            <span class="icon">ğŸº</span> SillyTavern
          </button>
          <button class="platform-btn" data-platform="risuai" onclick="selectPlatform('risuai')">
            <span class="icon">ğŸ¿ï¸</span> RisuAI
          </button>
          <button class="platform-btn" data-platform="characterai" onclick="selectPlatform('characterai')">
            <span class="icon">ğŸ’¬</span> Character.AI
          </button>
        </div>
      </div>

      <div class="settings-login-group">
        <!-- AI ç”ŸæˆæŒ‰éˆ• -->
        <button class="icon-btn primary" onclick="App.ai.generateCharacter()" title="AI ä¸€éµå‰µè§’">
          âœ¨ AI ç”Ÿæˆ
        </button>

        <!-- åŒ¯å…¥æŒ‰éˆ• -->
        <button class="icon-btn" onclick="App.ui.openImport()" title="åŒ¯å…¥æª”æ¡ˆ">
          ğŸ“¥ åŒ¯å…¥
        </button>

        <!-- ç”¨æˆ¶è³‡è¨Šå€ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰-->
        <div class="user-info" id="userInfo" style="display: none;">
          <img class="user-avatar" id="userAvatar" src="" alt="User">
          <span class="user-name" id="userName"></span>
          <button class="icon-btn" onclick="App.auth.logout()" title="ç™»å‡º">ğŸšª</button>
        </div>

        <!-- ç™»å…¥æŒ‰éˆ•ï¼ˆæœªç™»å…¥æ™‚é¡¯ç¤ºï¼‰- å·²åœç”¨ -->
        <button class="icon-btn primary" id="loginBtn" onclick="App.auth.login()" title="Google ç™»å…¥" style="display: none;">
          ğŸ” ç™»å…¥
        </button>

        <!-- é›²ç«¯è§’è‰²å¡æŒ‰éˆ•ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰- å·²åœç”¨ -->
        <button class="icon-btn" id="cloudBtn" onclick="App.ui.openCloudManager()" title="é›²ç«¯è§’è‰²å¡" style="display: none;">
          â˜ï¸ é›²ç«¯
        </button>

        <!-- è¨­å®šæŒ‰éˆ• -->
        <button class="btn secondary" onclick="App.ui.openSettings()" style="padding: 8px 16px;">
          ğŸ¤– è¨­å®š AI API
        </button>
      </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-content">
      <!-- è¡¨å–®å€åŸŸ -->
      <div class="form-panel" id="formPanel">
        
        <!-- åŸºæœ¬è³‡è¨Š -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“‹</span> åŸºæœ¬è³‡è¨Š</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('basicInfo')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-basicInfo"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>è§’è‰²é ­åƒç¶²å€ <span class="hint">(åœ–ç‰‡ URL)</span></label>
              <input type="url" id="avatarUrl" placeholder="https://example.com/avatar.jpg" oninput="updatePreview()">
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>
                  è§’è‰²åç¨± <span class="required">*</span>
                  <button class="dice-btn" onclick="App.ui.rollDice('name')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="name" placeholder="ä¾‹ï¼šè‰¾è‰è¥¿äº" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>åˆ¥å/æš±ç¨± <span class="hint">(é€—è™Ÿåˆ†éš”)</span></label>
                <input type="text" id="aliases" placeholder="ä¾‹ï¼šå°è‰¾, å†°éœœå¥³ç‹" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>
                  å¹´é½¡
                  <button class="dice-btn" onclick="App.ui.rollDice('age')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="age" placeholder="ä¾‹ï¼š23 æ­²" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>æ€§åˆ¥</label>
                <select id="gender" onchange="updatePreview()">
                  <option value="">-- é¸æ“‡ --</option>
                  <option value="å¥³æ€§">å¥³æ€§</option>
                  <option value="ç”·æ€§">ç”·æ€§</option>
                  <option value="éäºŒå…ƒ">éäºŒå…ƒ</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-field">
                <label>
                  ç¨®æ—/ç‰©ç¨®
                  <button class="dice-btn" onclick="App.ui.rollDice('species')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="species" placeholder="ä¾‹ï¼šåŠç²¾éˆ" oninput="updatePreview()">
                <div class="quick-tags-container" id="speciesTags"></div>
              </div>
              <div class="form-field">
                <label>
                  è·æ¥­/èº«ä»½
                  <button class="dice-btn" onclick="App.ui.rollDice('occupation')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="occupation" placeholder="ä¾‹ï¼šçš‡å®¶åœ–æ›¸é¤¨ç®¡ç†å“¡" oninput="updatePreview()">
                <div class="quick-tags-container" id="occupationTags"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- å¤–è§€æè¿° -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ‘¤</span> å¤–è§€æè¿°</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('appearance')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-appearance"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>
                æ•´é«”å¤–è§€æ¦‚è¿°
                <button class="dice-btn" onclick="App.ui.rollDice('appearance')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
              </label>
              <textarea id="appearance" placeholder="ç°¡çŸ­æè¿°è§’è‰²çš„æ•´é«”å¤–è§€ç‰¹å¾µ..." oninput="updatePreview()"></textarea>
              <div class="quick-tags-container" id="appearanceTags"></div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>èº«é«˜</label>
                <input type="text" id="height" placeholder="ä¾‹ï¼š165cm" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>é«”å‹</label>
                <input type="text" id="bodyType" placeholder="ä¾‹ï¼šçº–ç´°" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  é«®è‰²
                  <button class="dice-btn" onclick="App.ui.rollDice('hairColor')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="hairColor" placeholder="ä¾‹ï¼šéŠ€ç™½è‰²" oninput="updatePreview()">
                <div class="quick-tags-container" id="hairColorTags"></div>
              </div>
              <div class="form-field">
                <label>
                  é«®å‹
                  <button class="dice-btn" onclick="App.ui.rollDice('hairStyle')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="hairStyle" placeholder="ä¾‹ï¼šé•·é«®ï¼ŒåŠè…°" oninput="updatePreview()">
                <div class="quick-tags-container" id="hairStyleTags"></div>
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  çœ¼ç›é¡è‰²
                  <button class="dice-btn" onclick="App.ui.rollDice('eyes')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="eyes" placeholder="ä¾‹ï¼šå†°è—è‰²ç³å­”" oninput="updatePreview()">
                <div class="quick-tags-container" id="eyesTags"></div>
              </div>
              <div class="form-field">
                <label>
                  æœè£é¢¨æ ¼
                  <button class="dice-btn" onclick="App.ui.rollDice('clothing')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
                </label>
                <input type="text" id="clothing" placeholder="ä¾‹ï¼šåå¥½æ·±è‰²é•·è¢" oninput="updatePreview()">
                <div class="quick-tags-container" id="clothingTags"></div>
              </div>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>ç‰¹æ®Šæ¨™è¨˜ <span class="hint">(ç–¤ç—•ã€åˆºé’ã€é…ä»¶ç­‰)</span></label>
              <input type="text" id="features" placeholder="ä¾‹ï¼šå·¦çœ¼ä¸‹æ–¹æœ‰æœˆç‰™å½¢èƒè¨˜" oninput="updatePreview()">
            </div>
          </div>
        </div>

        <!-- æ€§æ ¼ç‰¹è³ª -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ’­</span> æ€§æ ¼ç‰¹è³ª</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('personality')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-personality"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>
                æ€§æ ¼æ‘˜è¦
                <button class="dice-btn" onclick="App.ui.rollDice('personality')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
              </label>
              <textarea id="personality" placeholder="æè¿°è§’è‰²çš„æ ¸å¿ƒæ€§æ ¼ç‰¹å¾µ..." oninput="updatePreview()"></textarea>
              <div class="quick-tags-container" id="personalityTags"></div>
            </div>
            <div class="form-field full-width">
              <label>
                ç‰¹è³ªæ¨™ç±¤ <span class="hint">(é€—è™Ÿåˆ†éš”)</span>
                <button class="dice-btn" onclick="App.ui.rollDice('traits')" type="button" title="éš¨æ©Ÿç”Ÿæˆç¯„ä¾‹">ğŸ²</button>
              </label>
              <input type="text" id="traits" placeholder="ä¾‹ï¼šå…§å‘, å–„è‰¯, å›ºåŸ·, å¥½å¥‡å¿ƒå¼·" oninput="updatePreview()">
              <div class="quick-tags-container" id="traitsTags"></div>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>
                é‡å°æ„Ÿæƒ… <span class="hint">(é€—è™Ÿåˆ†éš”)</span>
                <button class="dice-btn" onclick="App.ui.rollDice('emotionalAttitude')" type="button">ğŸ²</button>
              </label>
              <input type="text" id="emotionalAttitude" placeholder="ä¾‹ï¼šä½”æœ‰æ…¾, æ§åˆ¶æ¬², å°‹æ‰¾å®¶äºº, é‡è¦–å‹æƒ…, ç¨å æ¬²" oninput="updatePreview()">
              <div class="quick-tags-container" id="emotionalAttitudeTags"></div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  å„ªé»
                  <button class="dice-btn" onclick="App.ui.rollDice('strengths')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="strengths" placeholder="ä¾‹ï¼šè°æ˜, æœ‰è€å¿ƒ, å¿ èª " oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>
                  ç¼ºé»/å¼±é»
                  <button class="dice-btn" onclick="App.ui.rollDice('weaknesses')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="weaknesses" placeholder="ä¾‹ï¼šéåº¦è¬¹æ…, ä¸å–„äº¤éš›" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  å–œå¥½
                  <button class="dice-btn" onclick="App.ui.rollDice('likes')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="likes" placeholder="ä¾‹ï¼šé–±è®€, ä¸‹é›¨å¤©, èŒ¶" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>
                  å­æƒ¡
                  <button class="dice-btn" onclick="App.ui.rollDice('dislikes')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="dislikes" placeholder="ä¾‹ï¼šå™ªéŸ³, è¬Šè¨€, äººç¾¤" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  ææ‡¼
                  <button class="dice-btn" onclick="App.ui.rollDice('fears')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="fears" placeholder="ä¾‹ï¼šå¤±å»è¨˜æ†¶, èƒŒå›" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>
                  ç›®æ¨™/å‹•æ©Ÿ
                  <button class="dice-btn" onclick="App.ui.rollDice('goals')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="goals" placeholder="ä¾‹ï¼šå°‹æ‰¾å¤±è½çš„å¤ç±" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>
                  é‡‘éŒ¢è§€
                  <button class="dice-btn" onclick="App.ui.rollDice('moneyAttitude')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="moneyAttitude" placeholder="ä¾‹ï¼šç¯€å„‰, å¥¢ä¾ˆ, çœå°éŒ¢èŠ±å¤§éŒ¢" oninput="updatePreview()">
                <div class="quick-tags-container" id="moneyAttitudeTags"></div>
              </div>
              <div class="form-field">
                <label>
                  é“å¾·
                  <button class="dice-btn" onclick="App.ui.rollDice('morality')" type="button">ğŸ²</button>
                </label>
                <input type="text" id="morality" placeholder="ä¾‹ï¼šå–„è‰¯æ­£ç¾©, ä¸­ç«‹, æ··æ²Œé‚ªæƒ¡" oninput="updatePreview()">
                <div class="quick-tags-container" id="moralityTags"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- èƒŒæ™¯æ•…äº‹ -->
        <div class="form-section">
          <div class="section-header full-mode-only" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“–</span> èƒŒæ™¯æ•…äº‹</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('background')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-background"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <label>
                å‡ºç”Ÿåœ° <span class="hint">(è§’è‰²å‡ºç”Ÿçš„åœ°é»)</span>
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('birthplace')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <input type="text" id="birthplace" placeholder="ä¾‹ï¼šåŒ—æ–¹é›ªåœ‹çš„å°æ‘èŠ" oninput="updatePreview()">
            </div>
            <div class="form-field full-width full-mode-only">
              <label>
                èƒŒæ™¯æ•…äº‹ <span class="hint">(è§’è‰²çš„éå»ç¶“æ­·)</span>
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('backstory')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <textarea id="backstory" class="large" placeholder="æè¿°è§’è‰²çš„éå»ç¶“æ­·ã€æˆé•·èƒŒæ™¯..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>
                é‡è¦äº‹ä»¶ <span class="hint">(å½¢å¡‘è§’è‰²çš„é—œéµç¶“æ­·)</span>
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('keyEvents')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <textarea id="keyEvents" placeholder="å½¢å¡‘è§’è‰²çš„é—œéµç¶“æ­·..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>äººéš›é—œä¿‚ <span class="hint">(åç¨±èˆ‡é—œä¿‚æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="relationshipsContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('relationships')">
                â• æ–°å¢äººéš›é—œä¿‚
              </button>
            </div>
          </div>
        </div>

        <!-- æˆ°é¬¥èˆ‡ç”Ÿæ´»æŠ€èƒ½ -->
        <div class="form-section">
          <div class="section-header full-mode-only" onclick="toggleSection(this)">
            <h3><span class="icon">âš”ï¸</span> æˆ°é¬¥èˆ‡ç”Ÿæ´»æŠ€èƒ½</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('skills')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-skills"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>æˆ°é¬¥æŠ€èƒ½ <span class="hint">(æŠ€èƒ½åç¨±èˆ‡ç­‰ç´š/æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="combatSkillsContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('combatSkills')">
                â• æ–°å¢æˆ°é¬¥æŠ€èƒ½
              </button>
            </div>
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>ç”Ÿæ´»æŠ€èƒ½ <span class="hint">(æŠ€èƒ½åç¨±èˆ‡ç­‰ç´š/æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="lifeSkillsContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('lifeSkills')">
                â• æ–°å¢ç”Ÿæ´»æŠ€èƒ½
              </button>
            </div>
          </div>
        </div>

        <!-- è‡ªè¨‚å±¬æ€§ -->
        <div class="form-section">
          <div class="section-header full-mode-only" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“Š</span> è‡ªè¨‚å±¬æ€§</h3>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>è‡ªè¨‚å±¬æ€§ <span class="hint">(å±¬æ€§åç¨±èˆ‡å€¼/ç­‰ç´š/æè¿°)</span></label>
              </div>
              <div class="dynamic-fields-container" id="customAttributesContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('customAttributes')">
                â• æ–°å¢è‡ªè¨‚å±¬æ€§
              </button>
            </div>
          </div>
        </div>

        <!-- å°è©±é¢¨æ ¼ -->
        <div class="form-section">
          <div class="section-header full-mode-only" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ—£ï¸</span> å°è©±é¢¨æ ¼</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('speech')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-speech"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <button class="ai-generate-btn"
                    onclick="event.stopPropagation(); App.ai.generateSpeechFields()"
                    type="button"
                    title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆå£é ­ç¦ªã€èªè¨€ç¿’æ…£ã€æƒ…ç·’è¡¨é”">
              ğŸ¨ è®“AIç”Ÿæˆ
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width full-mode-only">
              <div class="dynamic-field-header">
                <label>èªªè©±æ–¹å¼ <span class="hint">(æƒ…å¢ƒèˆ‡å°è©±ç¯„ä¾‹)</span></label>
              </div>
              <div class="dynamic-fields-container" id="speechStyleContainer">
                <!-- å‹•æ…‹æ¬„ä½å°‡ç”± JavaScript ç”Ÿæˆ -->
              </div>
              <button type="button" class="add-field-btn" onclick="App.dynamicFields.add('speechStyle')">
                â• æ–°å¢èªªè©±æ–¹å¼
              </button>
            </div>
            <div class="form-row full-mode-only">
              <div class="form-field">
                <label>å£é ­ç¦ª <span class="hint">(é€—è™Ÿåˆ†éš”)</span></label>
                <input type="text" id="catchphrases" placeholder="ä¾‹ï¼šæœ‰è¶£å‘¢..., è®“æˆ‘æƒ³æƒ³" oninput="updatePreview()">
              </div>
              <div class="form-field">
                <label>èªè¨€ç¿’æ…£</label>
                <input type="text" id="verbalTics" placeholder="ä¾‹ï¼šå¥å°¾å¸¸åŠ ã€Œå‘¢ã€" oninput="updatePreview()">
              </div>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>æƒ…ç·’è¡¨é”æ–¹å¼</label>
              <textarea id="emotionalExpression" placeholder="é–‹å¿ƒ/ç”Ÿæ°£/å®³ç¾æ™‚çš„åæ‡‰..." oninput="updatePreview()"></textarea>
            </div>
          </div>
        </div>

        <!-- AI æ ¸å¿ƒè¨­å®š -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ¤–</span> AI æ ¸å¿ƒè¨­å®š</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('aiSettings')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-aiInstructions"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>
                è§’è‰²æè¿° <span class="hint">(çµ¦ AI çš„å®Œæ•´æè¿°ï¼ŒCharacter.AI å¿…å¡«)</span>
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('description')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <textarea id="description" class="large" placeholder="é€™æ˜¯çµ¦ AI é–±è®€çš„å®Œæ•´è§’è‰²æè¿°ï¼Œå¯æ•´åˆä¸Šè¿°æ‰€æœ‰è³‡è¨Š..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>
                ç³»çµ±æç¤º <span class="hint">(System Prompt)</span>
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('systemPrompt')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <textarea id="systemPrompt" class="large" placeholder="çµ¦ AI çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼šä½ æ˜¯{{char}}ï¼Œè«‹ä»¥ç¬¬ä¸€äººç¨±å›æ‡‰..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width">
              <label>
                ç¬¬ä¸€å‰‡è¨Šæ¯ <span class="hint">(å°è©±é–‹å§‹æ™‚è§’è‰²èªªçš„è©±ï¼ŒCharacter.AI å¿…å¡«)</span>
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('firstMessage')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <textarea id="firstMessage" class="large" placeholder="*å¥¹æŠ¬èµ·é ­ï¼Œå¾æ›¸æœ¬ä¸­æœ›å‘ä½ * ã€Œå•Šï¼Œæœ‰å®¢äººå—ï¼Ÿæ­¡è¿ä¾†åˆ°åœ–æ›¸é¤¨ã€‚ã€" oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width simple-mode-only">
              <label>ç¯„ä¾‹å°è©±</label>
              <textarea id="exampleDialogues" class="large" placeholder="å±•ç¤ºè§’è‰²å¦‚ä½•å›æ‡‰çš„ç¯„ä¾‹å°è©±..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-width full-mode-only">
              <label>
                åˆæ¬¡ç›¸é‡åœ°é» <span class="hint">(ç•™ç©ºç‚º AI åŠ‡æƒ…è‡ªç”±ç™¼æ®)</span>
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('scenario')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <textarea id="scenario" placeholder="ä¾‹ï¼šåœ¨ç†±é¬§çš„è™›æ“¬ç›´æ’­é–“ã€åœ¨å¯§éœçš„åœ–æ›¸é¤¨..." oninput="updatePreview()"></textarea>
            </div>
          </div>
        </div>

        <!-- å…ƒè³‡æ–™ -->
        <div class="form-section">
          <div class="section-header" onclick="toggleSection(this)">
            <h3><span class="icon">ğŸ“</span> å…ƒè³‡æ–™</h3>
            <button class="ai-import-btn"
                    onclick="event.stopPropagation(); App.import.fillSectionWithAI('metadata')"
                    title="å¾åŒ¯å…¥æª”æ¡ˆä¸­è®€å–è³‡æ–™å¡«å……æ­¤å€å¡Š"
                    id="aiImportBtn-metadata"
                    style="display: none;">
              ğŸ“¥ è®“AIè®€å–åŒ¯å…¥æª”
            </button>
            <span class="section-toggle">â–¼</span>
          </div>
          <div class="section-content">
            <div class="form-field full-width">
              <label>æ¨™ç±¤ <span class="hint">(é€—è™Ÿåˆ†éš”ï¼Œç”¨æ–¼åˆ†é¡)</span></label>
              <input type="text" id="tags" placeholder="ä¾‹ï¼šå¥‡å¹», åœ–æ›¸é¤¨å“¡, ç¥ç§˜, æº«æŸ”" oninput="updatePreview()">
            </div>
            <div class="form-field full-width">
              <label>å‰µä½œè€…</label>
              <input type="text" id="creator" placeholder="æ‚¨çš„åå­—" oninput="updatePreview()">
            </div>
            <div class="form-field full-width full-mode-only">
              <label>
                ä¸–ç•Œè§€
                <button class="ai-generate-btn"
                        onclick="App.ai.generateField('worldLore')"
                        type="button"
                        title="ä½¿ç”¨AIæ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆ">
                  ğŸ¨ è®“AIç”Ÿæˆ
                </button>
              </label>
              <textarea id="worldLore" placeholder="è§’è‰²æ‰€è™•çš„ä¸–ç•Œè¨­å®š..." oninput="updatePreview()"></textarea>
            </div>
            <div class="form-field full-mode-only">
              <label>ç‰ˆæœ¬</label>
              <input type="text" id="version" placeholder="1.0" value="1.0" oninput="updatePreview()">
            </div>
          </div>
        </div>

      </div>

      <!-- é è¦½å€åŸŸ -->
      <div class="preview-panel">
        <div class="preview-header">
          <h3>ğŸ‘ï¸ é è¦½</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div class="preview-tabs">
              <button class="preview-tab active" onclick="switchPreviewTab('card')">è§’è‰²å¡</button>
              <button class="preview-tab" onclick="switchPreviewTab('json')">JSON</button>
              <button class="preview-tab" onclick="switchPreviewTab('yaml')">YAML</button>
              <button class="preview-tab" onclick="switchPreviewTab('markdown')">Markdown</button>
              <button class="preview-tab" onclick="switchPreviewTab('txt')">TXT</button>
            </div>
            <button class="icon-btn" id="copyPreviewBtn" onclick="copyPreviewContent()" title="è¤‡è£½å…§å®¹" style="display: none;">
              ğŸ“‹
            </button>
          </div>
        </div>

        <div class="preview-content">
          <!-- è§’è‰²å¡è¦–è¦ºé è¦½ -->
          <div class="character-preview active" id="previewCard">
            <div class="preview-card">
              <div class="preview-card-header">
                <div class="preview-avatar" id="previewAvatar">ğŸ­</div>
                <div class="preview-name" id="previewName">æœªå‘½åè§’è‰²</div>
                <div class="preview-aliases" id="previewAliases"></div>
                <div class="preview-tags" id="previewTags"></div>
              </div>

              <div class="preview-section" id="previewBasicInfo">
                <div class="preview-section-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
                <div class="preview-grid" id="previewBasicGrid"></div>
              </div>

              <div class="preview-section" id="previewAppearanceSection" style="display: none;">
                <div class="preview-section-title">ğŸ‘¤ å¤–è§€</div>
                <div class="preview-section-content" id="previewAppearance"></div>
              </div>

              <div class="preview-section" id="previewPersonalitySection" style="display: none;">
                <div class="preview-section-title">ğŸ’­ æ€§æ ¼</div>
                <div class="preview-section-content" id="previewPersonality"></div>
              </div>

              <div class="preview-section" id="previewBackstorySection" style="display: none;">
                <div class="preview-section-title">ğŸ“– èƒŒæ™¯</div>
                <div class="preview-section-content" id="previewBackstory"></div>
              </div>

              <div class="preview-section" id="previewRelationshipsSection" style="display: none;">
                <div class="preview-section-title">ğŸ‘¥ äººéš›é—œä¿‚</div>
                <div class="preview-section-content" id="previewRelationships"></div>
              </div>

              <div class="preview-section" id="previewFirstMessageSection" style="display: none;">
                <div class="preview-section-title">ğŸ’¬ ç¬¬ä¸€å‰‡è¨Šæ¯</div>
                <div class="preview-first-message" id="previewFirstMessage"></div>
              </div>
            </div>
          </div>

          <!-- JSON é è¦½ -->
          <div class="code-preview" id="previewJSON">
            <pre id="jsonCode"></pre>
          </div>

          <!-- YAML é è¦½ -->
          <div class="code-preview" id="previewYAML">
            <pre id="yamlCode"></pre>
          </div>

          <!-- Markdown é è¦½ -->
          <div class="code-preview" id="previewMarkdown">
            <pre id="markdownCode"></pre>
          </div>

          <!-- TXT é è¦½ -->
          <div class="code-preview" id="previewTXT">
            <pre id="txtCode"></pre>
          </div>
        </div>

        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
        <div class="export-buttons-container">
          <!-- ç¬¬ä¸€è¡Œï¼šæ–‡å­—æ ¼å¼ -->
          <div class="export-buttons">
            <button class="export-btn txt" onclick="exportTextFile()">
              <span>ğŸ“„</span> åŒ¯å‡º TXT
            </button>
            <button class="export-btn json" onclick="exportFile('json')">
              <span>ğŸ“¦</span> åŒ¯å‡º JSON
            </button>
            <button class="export-btn yaml" onclick="exportFile('yaml')">
              <span>ğŸ“‹</span> åŒ¯å‡º YAML
            </button>
            <button class="export-btn markdown" onclick="exportFile('markdown')">
              <span>ğŸ“</span> åŒ¯å‡º Markdown
            </button>
          </div>

          <!-- ç¬¬äºŒè¡Œï¼šç‰¹æ®Šæ ¼å¼ -->
          <div class="export-buttons">
            <button class="export-btn png-card" onclick="exportCharacterCardImage()">
              <span>ğŸ–¼ï¸</span> åŒ¯å‡ºè§’è‰²å¡åœ–ç‰‡
            </button>
            <button class="export-btn json-compact" onclick="exportCompactJSON()">
              <span>ğŸ“¦</span> åŒ¯å‡ºç¸®è¡Œ JSON
            </button>
            <button class="export-btn png-yaml" onclick="exportYAMLImage()">
              <span>ğŸ¨</span> åŒ¯å‡º YAML åœ–ç‰‡
            </button>
            <button class="export-btn png-markdown" onclick="exportMarkdownImage()">
              <span>ğŸ–¼ï¸</span> åŒ¯å‡º Markdown åœ–ç‰‡
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æç¤ºè¨Šæ¯ -->
  <div class="toast" id="toast"></div>

  <!-- è¨­å®šå½ˆçª— -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âš™ï¸ è¨­å®š</h2>
        <button class="modal-close" onclick="App.ui.closeSettings()">âœ•</button>
      </div>
      <div class="modal-body">
        <!-- AI æä¾›å•†é¸æ“‡å™¨ -->
        <div class="setting-item">
          <label>ğŸ¤– AI æä¾›å•†</label>
          <select id="aiProvider" onchange="App.settings.updateProviderUI(); App.updateUIButtonsVisibility();">
            <option value="gemini">Google Gemini</option>
            <option value="openai">OpenAI GPT</option>
            <option value="claude">Anthropic Claude</option>
            <option value="deepseek">DeepSeek</option>
          </select>
          <div class="hint" style="color: white;">é¸æ“‡æ‚¨æƒ³ä½¿ç”¨çš„ AI æœå‹™</div>
        </div>

        <!-- Gemini API Key -->
        <div class="setting-item api-key-item" data-provider="gemini">
          <label>ğŸŒŸ Gemini API Key</label>
          <input type="text" id="geminiApiKey" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key">
          <div class="hint" style="color: white;">
            ç”¨æ–¼ AI ä¸€éµå‰µè§’åŠŸèƒ½ã€‚
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-weight: bold; color: #1a73e8;">ğŸ‘‰ å‰å¾€ Google AI Studio ç”³è«‹</a>
          </div>
        </div>

        <!-- OpenAI API Key -->
        <div class="setting-item api-key-item" data-provider="openai" style="display: none;">
          <label>ğŸ”¥ OpenAI API Key</label>
          <input type="text" id="openaiApiKey" placeholder="è«‹è¼¸å…¥æ‚¨çš„ OpenAI API Key">
          <div class="hint">
            <a href="https://platform.openai.com/api-keys" target="_blank" style="font-weight: bold; color: #1a73e8;">ğŸ‘‰ å‰å¾€ OpenAI Platform ç”³è«‹</a>
          </div>
        </div>

        <!-- Claude API Key -->
        <div class="setting-item api-key-item" data-provider="claude" style="display: none;">
          <label>ğŸ’¡ Claude API Key</label>
          <input type="text" id="claudeApiKey" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Claude API Key">
          <div class="hint">
            <a href="https://console.anthropic.com/settings/keys" target="_blank" style="font-weight: bold; color: #1a73e8;">ğŸ‘‰ å‰å¾€ Anthropic Console ç”³è«‹</a>
          </div>
        </div>

        <!-- DeepSeek API Key -->
        <div class="setting-item api-key-item" data-provider="deepseek" style="display: none;">
          <label>ğŸ” DeepSeek API Key</label>
          <input type="text" id="deepseekApiKey" placeholder="è«‹è¼¸å…¥æ‚¨çš„ DeepSeek API Key">
          <div class="hint">
            <a href="https://platform.deepseek.com/api_keys" target="_blank" style="font-weight: bold; color: #1a73e8;">ğŸ‘‰ å‰å¾€ DeepSeek Platform ç”³è«‹</a>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="App.ui.closeSettings()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="App.settings.save()">å„²å­˜è¨­å®š</button>
      </div>
    </div>
  </div>

  <!-- åŒ¯å…¥è§’è‰²å¡å½ˆçª— -->
  <div class="modal" id="importModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>ğŸ“¥ åŒ¯å…¥è§’è‰²å¡</h2>
        <button class="modal-close" onclick="App.ui.closeImport()">âœ•</button>
      </div>
      <div class="modal-body">
        <!-- æª”æ¡ˆé¸æ“‡å€ -->
        <div class="setting-item">
          <label>ğŸ“„ é¸æ“‡æª”æ¡ˆ</label>
          <input type="file" id="importFileInput" accept=".json,.yaml,.yml,.txt" style="display: block; width: 100%; padding: 10px; border: 2px dashed var(--border-color); border-radius: 8px; cursor: pointer;">
          <div class="hint" style="margin-top: 8px; color: white;">
            â€»åƒ…æ¥å—ç¬¦åˆæœ¬ç¶²ç«™æ‰€å»ºç«‹ä¹‹è§’è‰²å¡æ ¼å¼
          </div>
        </div>

        <!-- AI åˆ¤è®€é¸é … -->
        <div class="setting-item" style="margin-top: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="useAIImport" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
            <span style="font-weight: bold;">ğŸ¤– ä½¿ç”¨ AI åˆ¤è®€</span>
          </label>
          <div class="hint" style="margin-top: 8px; color: white;">
            â€»å¯å¥—å…¥ä»»ä½•æ ¼å¼çš„æ–‡å­—æª”æ¡ˆæä¾›åˆ¤è®€çµ¦é€™å€‹AIåˆ¤è®€çš„é¸é …
          </div>
        </div>

        <!-- é è¦½å€ï¼ˆé¡¯ç¤ºæª”æ¡ˆè³‡è¨Šï¼‰-->
        <div id="importPreview" style="margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; display: none;">
          <div style="font-weight: bold; margin-bottom: 8px; color: var(--text-primary);">ğŸ“‹ æª”æ¡ˆè³‡è¨Š</div>
          <div id="importFileInfo" style="color: var(--text-secondary); font-size: 14px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" onclick="App.ui.closeImport()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="App.import.execute()">é–‹å§‹åŒ¯å…¥</button>
      </div>
    </div>
  </div>

  <!-- é›²ç«¯è§’è‰²å¡ Modal -->
  <div class="modal" id="cloudModal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>â˜ï¸ é›²ç«¯è§’è‰²å¡</h2>
        <button class="modal-close" onclick="App.ui.closeCloudManager()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="cloud-actions">
          <button class="btn primary" onclick="App.ui.saveToCloud()">
            ğŸ’¾ å„²å­˜ç›®å‰è§’è‰²åˆ°é›²ç«¯
          </button>
          <button class="btn secondary" onclick="App.ui.loadCloudCharacters()">
            ğŸ”„ é‡æ–°è¼‰å…¥
          </button>
        </div>
        <div class="cloud-list">
          <h3>æˆ‘çš„è§’è‰²å¡</h3>
          <div id="cloudCharacterList">
            <!-- è§’è‰²å¡åˆ—è¡¨å°‡ç”± JavaScript ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- YAML åœ–ç‰‡æ¸²æŸ“å®¹å™¨ï¼ˆéš±è—ï¼‰-->
  <div id="yamlImageContainer">
    <div class="yaml-code-card">
      <div class="yaml-header">
        <div class="yaml-title">
          <span class="icon">ğŸ“„</span>
          <span class="name">è§’è‰²åç¨±</span>
          <span class="platform">Gemini 3.0</span>
        </div>
        <div class="yaml-meta">ç”Ÿæˆæ™‚é–“ï¼š2025-11-28 12:34:56</div>
      </div>
      <div class="yaml-body">
        <pre><code class="yaml-content"></code></pre>
      </div>
      <div class="yaml-footer">
        ğŸ¤– Generated by AIäº’å‹•èŠå¤©è§’è‰²å¡å·¥å…·
      </div>
    </div>
  </div>

  <!-- Markdown åœ–ç‰‡åŒ¯å‡ºå®¹å™¨ -->
  <div id="markdownImageContainer">
    <div class="markdown-code-card">
      <div class="markdown-header">
        <div class="markdown-title">
          <h2 class="name">è§’è‰²åç¨±</h2>
          <div class="platform">å¹³å°</div>
        </div>
        <div class="markdown-meta">ç”Ÿæˆæ™‚é–“</div>
      </div>
      <div class="markdown-body">
        <div class="markdown-content"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== éŒ¯èª¤è™•ç† =====
    window.addEventListener('error', function(e) {
      console.error('å…¨åŸŸéŒ¯èª¤:', e.message, e.filename, e.lineno, e.colno);
      return false;
    });

    // ===== ä¸»æ‡‰ç”¨ç¨‹å¼ç‰©ä»¶ =====
    const App = {
      // ç‹€æ…‹ç®¡ç†
      state: {
        isFullMode: false,
        currentPlatform: 'gemini',
        currentPreviewTab: 'card',
        user: null,
        accessToken: null
      },

      // ç¯„ä¾‹è³‡æ–™åº«ï¼ˆç”¨æ–¼éª°å­å¿«é€Ÿç”Ÿæˆï¼‰- Hololive æˆå“¡
      exampleData: {
        name: ['ç™½ä¸Šå¹é›ª', 'æ¹Šé˜¿åº«å©­', 'å¤§ç©ºæ˜´', 'Gawr Gura', 'å¯¶é˜ç‘ªç³', 'å…”ç”°ä½©å…‹æ‹‰', 'æ˜Ÿè¡—å½—æ˜Ÿ', 'ç´«å’²è©©éŸ³', 'ç™½éŠ€è«¾è‰¾çˆ¾', 'ä¸çŸ¥ç«èŠ™è•¾é›…'],
        age: ['ä¸æ˜', '5æ­²ï¼ˆè‡ªç¨±ï¼‰', 'æ°¸é çš„17æ­²', '9000+æ­²', '17æ­²ï¼ˆè‡ªç¨±ï¼‰', '111æ­²', '18æ­²', 'ä¸è©³', '19æ­²', 'åŠç²¾éˆå¹´é½¡'],
        species: ['ç™½é«®ç‹å¨˜', 'æµ·ä¹‹å¥³åƒ•', 'äººé¡', 'äºç‰¹è˜­ææ–¯é¯Šé­š', 'æµ·è³Šèˆ¹é•·', 'å…”å¨˜', 'å½—æ˜Ÿ', 'é­”å¥³', 'éŠ€é«®é¨å£«', 'åŠç²¾éˆ'],
        occupation: ['VTuber', 'å¥³åƒ•', 'é‹å‹•ç³» VTuber', 'é¯Šé­šå¶åƒ', 'æµ·è³Šèˆ¹é•·', 'æˆ°çˆ­ç½ªçŠ¯ï¼ˆè‡ªç¨±ï¼‰', 'æ­Œå§¬', 'é­”æ³•å°‘å¥³', 'é¨å£«åœ˜é•·', 'ç²¾éˆå¼“æ‰‹'],
        personality: ['å®³ç¾ä½†å–œæ„›äº¤æµï¼Œæ“æœ‰ç”œç¾è²éŸ³ï¼Œå–„æ–¼è§’è‰²æ‰®æ¼”', 'åŠªåŠ›ä½†å†’å¤±ï¼Œæœ‰æ™‚æœƒçŠ¯è¿·ç³Šçš„éŒ¯èª¤ï¼Œå……æ»¿æ´»åŠ›', 'è‡ªç”±å¥”æ”¾ï¼Œæœæ°£è“¬å‹ƒï¼Œå…·æœ‰å¼·çƒˆè—äººé­‚', 'è°æ˜æ©Ÿæ™ºä½†ç¬¨æ‹™å¯æ„›ï¼Œå–œæ­¡å”±æ­Œå’Œç©éŠæˆ²', 'è‡ªä¿¡é–‹æœ—ï¼Œæ“…é•·èªªé»ƒæ®µå­ï¼Œç†±æ„›å¨›æ¨‚è§€çœ¾', 'å–œæ­¡æƒ¡ä½œåŠ‡ï¼Œç¬‘è²ç¨ç‰¹ï¼Œå……æ»¿å…”å­èˆ¬çš„æ´»åŠ›', 'èªçœŸåŠªåŠ›ï¼Œæ­Œè²å‹•äººï¼Œå°éŸ³æ¨‚å……æ»¿ç†±æƒ…', 'ä»»æ€§å‚²å¬Œï¼Œé­”å¥³é¢¨æ ¼ï¼Œå–œæ­¡è¢«å¯µæ„›', 'æº«æŸ”é«”è²¼ï¼Œè²éŸ³æ²»ç™’ï¼Œæœ‰å¼·çƒˆçš„æ­£ç¾©æ„Ÿ', 'æˆç†Ÿç©©é‡ï¼Œè²éŸ³ç£æ€§ï¼Œæ“…é•·ç…§é¡§ä»–äºº'],
        appearance: ['éŠ€ç™½è‰²é•·é«®ï¼Œç‹è€³ç‹å°¾ï¼Œå†°è—è‰²çœ¼çœ¸', 'ç´«è‰²é›™é¦¬å°¾é…æ°´è—è‰²æŒ‘æŸ“ï¼Œæµ·è»å¥³åƒ•æœ', 'æ´»åŠ›çŸ­é«®ï¼Œé‹å‹•æœè£ï¼Œå……æ»¿æœæ°£', 'ç°è—è‰²é•·é«®ï¼Œé¯Šé­šå°¾å·´ï¼Œè—è‰²çœ¼ç›', 'ç´…è‰²é›™é¦¬å°¾ï¼Œæµ·è³Šè£æ‰®ï¼Œçœ¼ç½©é…é£¾', 'è—è‰²å…”è€³ï¼Œç´…æ©™è‰²é›™é¦¬å°¾ï¼Œæ´»æ½‘æ‰“æ‰®', 'æ˜Ÿç©ºè—çŸ­é«®ï¼Œæ˜Ÿæ˜Ÿé«®é£¾ï¼Œå¶åƒæœè£', 'ç´«è‰²é›™å°¾ï¼Œé­”å¥³å¸½ï¼Œå“¥å¾·è˜¿è‰é¢¨', 'éŠ€è‰²é•·é«®ï¼Œé¨å£«ç›”ç”²ï¼Œå„ªé›…æ°£è³ª', 'æ·±è¤è‰²é•·é«®ï¼Œç²¾éˆè€³æœµï¼Œå¼“ç®­æ‰‹è£æ‰®'],
        hair: ['éŠ€ç™½è‰²é•·é«®', 'ç´«è‰²é›™é¦¬å°¾é…æ°´è—è‰²æŒ‘æŸ“', 'æ´»åŠ›çŸ­é«®', 'ç°è—è‰²é•·é«®', 'ç´…è‰²é›™é¦¬å°¾', 'ç´…æ©™è‰²é›™é¦¬å°¾', 'æ˜Ÿç©ºè—çŸ­é«®', 'ç´«è‰²é›™å°¾', 'éŠ€è‰²é•·é«®', 'æ·±è¤è‰²é•·é«®'],
        hairColor: ['éŠ€ç™½è‰²', 'ç´«è‰²', 'è—è‰²', 'ç°è—è‰²', 'ç´…è‰²', 'ç´…æ©™è‰²', 'æ˜Ÿç©ºè—', 'ç´«è‰²', 'éŠ€è‰²', 'æ·±è¤è‰²'],
        hairStyle: ['é•·é«®', 'é›™é¦¬å°¾', 'çŸ­é«®', 'é•·é«®', 'é›™é¦¬å°¾', 'é›™é¦¬å°¾', 'çŸ­é«®', 'é›™å°¾', 'é•·é«®', 'é•·é«®'],
        eyes: ['å†°è—è‰²çœ¼çœ¸', 'æ°´è—è‰²å¤§çœ¼', 'æ£•è‰²æ´»åŠ›çœ¼ç¥', 'æ·±è—è‰²é¯Šé­šçœ¼', 'ç´…å¯¶çŸ³èˆ¬çš„çœ¼ç›', 'è—è‰²å…”ç³', 'æ˜Ÿå…‰èˆ¬çš„çœ¼ç›', 'ç´«ç¾…è˜­è‰²çœ¼çœ¸', 'é‡‘è‰²é¨å£«çœ¼', 'ç¿ ç¶ è‰²ç²¾éˆçœ¼'],
        clothing: ['ç™½è‰²ç‹ç‹¸è£æ‰®', 'æµ·è»å¥³åƒ•æœ', 'é‹å‹•æœè£', 'è—ç™½é¯Šé­šä¸»é¡Œæœè£', 'æµ·è³Šèˆ¹é•·æœ', 'å…”å…”å¶åƒè£', 'æ˜Ÿç©ºå¶åƒæœ', 'å“¥å¾·è˜¿è‰é­”å¥³è£', 'éŠ€ç™½è‰²é¨å£«ç›”ç”²', 'æ£®æ—ç²¾éˆå¼“ç®­æ‰‹æœ'],
        backstory: ['ä½œç‚º GAMERS çš„ä¸€å“¡åœ¨è™›æ“¬ä¸–ç•Œæ´»èºï¼Œä»¥å¤šæ‰å¤šè—èå', 'å¾ç•°ä¸–ç•Œä¾†åˆ°äººé–“ç•¶å¥³åƒ•ï¼ŒåŠªåŠ›é©æ‡‰äººé¡ä¸–ç•Œ', 'æ™®é€šé«˜ä¸­ç”Ÿæ„å¤–æˆç‚º VTuberï¼Œç”¨æ´»åŠ›æ„ŸæŸ“æ‰€æœ‰äºº', 'ä¾†è‡ªäºç‰¹è˜­ææ–¯çš„é¯Šé­šï¼Œå¤±è½åœ¨äººé¡ä¸–ç•Œä¸­', 'æ›¾æ˜¯æµ·ä¸Šéœ¸ä¸»ï¼Œç¾åœ¨æ”¹è¡Œç•¶ VTuber å¨›æ¨‚å¤§çœ¾', 'å¾ç•°ä¸–ç•Œä¾†çš„å…”å­ï¼Œå–œæ­¡åœ¨éŠæˆ²ä¸–ç•Œä¸­æƒ¡ä½œåŠ‡', 'å¾å½—æ˜Ÿé™è‡¨åœ°çƒï¼Œç”¨æ­Œè²å‚³é”ä¾†è‡ªæ˜Ÿç©ºçš„è¨Šæ¯', 'é­”ç•Œçš„é­”å¥³ï¼Œä¾†åˆ°äººé–“å°‹æ‰¾æœ‰è¶£çš„äº‹ç‰©', 'é¨å£«åœ˜çš„åœ˜é•·ï¼Œç‚ºäº†å®ˆè­·é‡è¦çš„äººè€Œæˆ°é¬¥', 'æ£®æ—çš„ç²¾éˆï¼Œç‚ºäº†å°‹æ‰¾å¤±è½çš„è¨˜æ†¶è€Œæ—…è¡Œ'],
        speechStyle: ['è²éŸ³ç”œç¾å¤šè®Šï¼Œå®³ç¾æ™‚æœƒå«ç³Šä¸æ¸…', 'èªªè©±å¸¶è‘—å¥³åƒ•è…”ï¼Œå¸¸ç”¨ã€Œã¯ã„ã€å›æ‡‰', 'å¥å°¾å¸¸åŠ ã€Œã£ã™ã€ï¼Œå……æ»¿æ´»åŠ›çš„èªæ°£', 'å¯æ„›çš„ã€Œaã€è²ï¼Œèªªè©±ç°¡çŸ­æœ‰è¶£', 'è±ªçˆ½çš„ç¬‘è²ï¼Œä¸æ™‚é–‹é»ƒè…”', 'ç¨ç‰¹çš„ã€Œãºã“ã€ç¬‘è²ï¼Œèªèª¿æ´»æ½‘', 'èªçœŸå°ˆæ¥­ï¼Œå”±æ­Œæ™‚å……æ»¿æ„Ÿæƒ…', 'å‚²å¬Œèªæ°£ï¼Œæ’’å¬Œæ™‚è²éŸ³è®Šè»Ÿ', 'æº«æŸ”æœ‰ç¦®ï¼Œèªªè©±å¸¶è‘—é¨å£«é¢¨ç¯„', 'æˆç†Ÿç©©é‡ï¼Œè²éŸ³ä½æ²‰æ²»ç™’'],
        combatSkills: ['ç‹ç«é­”æ³•, è²éŸ³é­”æ³•, è®Šèº«è¡“', 'æ°´é­”æ³•, å¥³åƒ•æˆ°é¬¥è¡“, æ¸…æ½”æŠ€èƒ½', 'é‹å‹•æŠ€å·§, é«”åŠ›å¼·åŒ–, åœ˜éšŠæ¿€å‹µ', 'é¯Šé­šè¡æ“Š, æ°´ä¸‹æˆ°é¬¥, éŸ³æ³¢æ”»æ“Š', 'åŠè¡“, ç«ç¹©æ§, èˆ¹èˆ¶æ“ç¸±', 'èƒ¡è˜¿è””åŠæ³•, é™·é˜±è¨­ç½®, é€ƒè·‘è¡“', 'æ­Œå”±é­”æ³•, æ˜Ÿå…‰æ”»æ“Š, é­…åŠ›å…‰ç’°', 'é­”æ³•è© å”±, è—¥æ°´èª¿é…, è©›å’’è¡“', 'è–é¨å£«åŠè¡“, ç›¾ç‰Œé˜²ç¦¦, æ²»ç™’è¡“', 'ç²¾éˆå¼“è¡“, è‡ªç„¶é­”æ³•, è¿½è¹¤è¡“'],
        lifeSkills: ['éŠæˆ²å¯¦æ³, æ­Œå”±, è§’è‰²æ‰®æ¼”', 'æ¸…æ½”æ‰“æƒ, æ–™ç†, æœä¾', 'é‹å‹•æ•™å­¸, æ¨¡ä»¿, ç¶œè—è¡¨æ¼”', 'éŠæˆ², å”±æ­Œ, è³£èŒ', 'èªªæ•…äº‹, èˆªæµ·çŸ¥è­˜, å¯¶è—é‘‘å®š', 'éŠæˆ²ç­–åŠƒ, æç¬‘, å…”å…”è·³', 'ä½œæ›², æ¼”å”±, å¶åƒæ´»å‹•', 'å åœ, é­”æ³•ç ”ç©¶, æ’’å¬Œ', 'æ–™ç†, ç…§é¡§ä»–äºº, é¨å£«ç¦®å„€', 'æ£®æ—ç”Ÿå­˜, è—¥è‰å­¸, ç²¾éˆæ­Œå”±'],
        customAttributes: ['é­…åŠ›: S\næ­Œå”±: A+\néŠæˆ²: A\nç‹ç‹¸åº¦: MAX', 'å†’å¤±åº¦: A+\nåŠªåŠ›å€¼: S\nå¯æ„›åº¦: MAX', 'æ´»åŠ›: S\nè—äººé­‚: S+\né‹å‹•ç¥ç¶“: A', 'å¯æ„›åº¦: SSS\næ­Œå”±: S\nè¿·ç³Šåº¦: A+', 'å¤§äººåº¦: S\nè‰²æ°£: A+\nèˆ¹é•·åŠ›: MAX', 'æƒ¡ä½œåŠ‡: S\nç¬‘è²: ç¨ç‰¹\næˆ°çˆ­ç½ª: ???', 'æ­Œå”±: SSS\nä½œæ›²: A+\nå¶åƒåŠ›: S', 'é­”åŠ›: A\nå‚²å¬Œåº¦: S\nå¯æ„›åº¦: A+', 'å®ˆè­·åŠ›: S\næ²»ç™’: A+\né¨å£«é“: MAX', 'æˆç†Ÿåº¦: S\nè²éŸ³é­…åŠ›: A+\nç²¾éˆåŠ›: A'],
        traits: ['å–„è‰¯, å®³ç¾, å¤šæ‰å¤šè—', 'åŠªåŠ›, å†’å¤±, å¯æ„›', 'æ´»åŠ›, è‡ªç”±, è—äººé­‚', 'è°æ˜, ç¬¨æ‹™, æ„›å”±æ­Œ', 'è‡ªä¿¡, é–‹æœ—, å¤§è†½', 'æƒ¡ä½œåŠ‡, æ´»æ½‘, ç¨ç‰¹', 'èªçœŸ, åŠªåŠ›, æœ‰æ‰è¯', 'å‚²å¬Œ, ä»»æ€§, å¯æ„›', 'æº«æŸ”, æ­£ç¾©, æ²»ç™’', 'æˆç†Ÿ, ç©©é‡, é«”è²¼'],
        strengths: ['å¤šæ‰å¤šè—ï¼Œè²éŸ³ç”œç¾', 'åŠªåŠ›ä¸æ‡ˆï¼Œå……æ»¿æ´»åŠ›', 'è—äººé­‚å¼·çƒˆï¼Œé‹å‹•ç¥ç¶“å¥½', 'æ­Œè²å‹•äººï¼Œè°æ˜æ©Ÿæ™º', 'è‡ªä¿¡é–‹æœ—ï¼Œå¨›æ¨‚æ€§å¼·', 'ç¨ç‰¹é­…åŠ›ï¼Œå–„æ–¼æƒ¡ä½œåŠ‡', 'æ­Œå”±å¤©è³¦ï¼Œä½œæ›²èƒ½åŠ›å¼·', 'é­”æ³•èƒ½åŠ›å¼·ï¼Œå€‹æ€§é®®æ˜', 'æˆ°é¬¥åŠ›å¼·ï¼Œæ­£ç¾©æ„Ÿé‡', 'æˆç†Ÿç©©é‡ï¼Œç…§é¡§ä»–äºº'],
        weaknesses: ['å®¹æ˜“å®³ç¾ï¼Œä¸æ“…é•·æ‡‰å°çªç™¼ç‹€æ³', 'ç¶“å¸¸å†’å¤±ï¼Œå®¹æ˜“çŠ¯è¿·ç³ŠéŒ¯èª¤', 'å¤ªéè‡ªç”±å¥”æ”¾ï¼Œæœ‰æ™‚éæ–¼è¡å‹•', 'ç¬¨æ‰‹ç¬¨è…³ï¼Œç¶“å¸¸å‡ºç³—', 'æœ‰æ™‚å¤ªéå¤§è†½ï¼Œå°ºåº¦æŠŠæ¡ä¸ç•¶', 'æƒ¡ä½œåŠ‡éé ­ï¼Œå®¹æ˜“æƒ¹éº»ç…©', 'å°è‡ªå·±è¦æ±‚éé«˜ï¼Œå£“åŠ›å¤§', 'å¤ªéå‚²å¬Œï¼Œä¸å¦ç‡', 'å¤ªéæ­£ç¾©ï¼Œæœ‰æ™‚ç¼ºä¹è®Šé€š', 'éæ–¼æˆç†Ÿï¼Œæœ‰æ™‚é¡¯å¾—è·é›¢æ„Ÿ'],
        likes: ['éŠæˆ², è§’è‰²æ‰®æ¼”, å¯æ„›çš„æ±è¥¿', 'æ¸…æ½”æ‰“æƒ, è¢«ç¨±è®š, ä¸»äººçš„èªå¯', 'é‹å‹•, ç¶œè—ç¯€ç›®, ç†±é¬§çš„æ°£æ°›', 'å”±æ­Œ, éŠæˆ², å¯æ„›çš„äº‹ç‰©', 'èªªé»ƒæ®µå­, å¨›æ¨‚è§€çœ¾, å¯¶è—', 'èƒ¡è˜¿è””, æƒ¡ä½œåŠ‡, éŠæˆ²', 'å”±æ­Œ, ä½œæ›², æ˜Ÿç©º', 'é­”æ³•, è¢«å¯µæ„›, æœ‰è¶£çš„äº‹', 'å®ˆè­·ä»–äºº, æ­£ç¾©, æ–™ç†', 'æ£®æ—, ç²¾éˆæ–‡åŒ–, ç…§é¡§ä»–äºº'],
        dislikes: ['è¢«èª¤æœƒ, éæ–¼å˜ˆé›œçš„ç’°å¢ƒ, ææ€–éŠæˆ²', 'å¤±æ•—, è¢«æ‰¹è©•, å¼„é«’çš„æ±è¥¿', 'ç„¡èŠçš„äº‹, éœæ…‹æ´»å‹•, é™åˆ¶', 'é»‘æš—, ææ€–çš„æ±è¥¿, è¢«åš‡åˆ°', 'ç„¡èŠ, æ²’æœ‰è§€çœ¾, è²¡å¯¶è¢«æ¶', 'è¢«æŠ“åˆ°æƒ¡ä½œåŠ‡, ç„¡èŠ, è¢«é™åˆ¶', 'ä¸å®Œç¾çš„è¡¨æ¼”, è¾œè² æœŸå¾…, åµé¬§', 'è¢«å¿½è¦–, ç„¡èŠ, ä¸è¢«å¯µæ„›', 'ä¸æ­£ç¾©çš„äº‹, å‚·å®³ç„¡è¾œ, èƒŒå›', 'ç ´å£è‡ªç„¶, å–§å›‚, ä¸å°Šé‡'],
        fears: ['è¢«æ‰€æœ‰äººè¨å­ï¼Œå¤±å»æœ‹å‹', 'æ°¸é ç„¡æ³•æˆç‚ºå¥½å¥³åƒ•', 'å¤±å»æ´»åŠ›ï¼Œè®Šå¾—ç„¡è¶£', 'è¢«éºå¿˜ï¼Œæ°¸é å­¤å–®', 'å¤±å»èˆ¹å“¡ï¼Œå­¤ç¨èˆªè¡Œ', 'è¢«æŠ“ä½ï¼Œå¤±å»è‡ªç”±', 'å¤±å»æ­Œè²ï¼Œè¾œè² æœŸå¾…', 'å¤±å»é­”åŠ›ï¼Œè®Šå¾—å¹³å‡¡', 'ç„¡æ³•å®ˆè­·é‡è¦çš„äºº', 'å¤±å»è¨˜æ†¶ï¼Œå¿˜è¨˜éå»'],
        goals: ['æˆç‚ºæœ€å—æ­¡è¿çš„ VTuberï¼Œå¸¶çµ¦å¤§å®¶æ­¡æ¨‚', 'æˆç‚ºæœ€æ£’çš„å¥³åƒ•ï¼Œç²å¾—ä¸»äººçš„èªå¯', 'ç”¨æ´»åŠ›æ„ŸæŸ“æ‰€æœ‰äººï¼Œæˆç‚ºé ‚å°–è—äºº', 'æ‰¾åˆ°å›å®¶çš„è·¯ï¼Œå”±éå…¨ä¸–ç•Œ', 'æ‰¾åˆ°å‚³èªªä¸­çš„å¯¶è—ï¼Œå¨›æ¨‚æ‰€æœ‰äºº', 'æˆç‚ºæœ€å¼·çš„éŠæˆ²ç©å®¶ï¼Œæƒ¡ä½œåŠ‡åˆ°åº•', 'ç”¨æ­Œè²å‚³éæ˜Ÿç©ºçš„è¨Šæ¯ï¼Œæˆç‚ºé ‚å°–å¶åƒ', 'æ‰¾åˆ°æœ€æœ‰è¶£çš„äº‹ç‰©ï¼Œæˆç‚ºæœ€å¼·é­”å¥³', 'å®ˆè­·æ‰€æœ‰é‡è¦çš„äººï¼Œç¶­è­·æ­£ç¾©', 'æ‰¾å›å¤±è½çš„è¨˜æ†¶ï¼Œå›åˆ°æ•…é„‰'],
        emotionalAttitude: ['ä½”æœ‰æ…¾å¼·ï¼Œå¸Œæœ›ç¨å å–œæ­¡çš„äºº', 'æ§åˆ¶æ¬²å¼·ï¼Œå–œæ­¡æŒæ§é—œä¿‚', 'å°‹æ‰¾å®¶äººèˆ¬çš„æº«æš–', 'é‡è¦–å‹æƒ…ï¼Œçæƒœæ¯å€‹æœ‹å‹', 'ç¨å æ¬²å¼·ï¼Œä¸é¡˜åˆ†äº«é‡è¦çš„äºº', 'ä¾è³´å‹ï¼Œéœ€è¦è¢«æ„›åŒ…åœ', 'è‡ªç”±æˆ€æ„›ï¼Œä¸å—æŸç¸›', 'ææ‡¼è¦ªå¯†é—œä¿‚ï¼Œä¿æŒè·é›¢', 'ç†æƒ³ä¸»ç¾©ï¼Œè¿½æ±‚å®Œç¾æ„›æƒ…', 'å¯¦ç”¨ä¸»ç¾©ï¼Œçœ‹é‡å¯¦éš›åƒ¹å€¼'],
        moneyAttitude: ['ç¯€å„‰ï¼Œçœåƒå„‰ç”¨å­˜éŒ¢', 'å¥¢ä¾ˆï¼Œå–œæ­¡è³¼è²·æ˜‚è²´ç‰©å“', 'çœå°éŒ¢èŠ±å¤§éŒ¢ï¼Œæ—¥å¸¸ç¯€å„‰ä½†å¤§é–‹éŠ·ä¸æ‰‹è»Ÿ', 'ç†è²¡é«˜æ‰‹ï¼Œå–„æ–¼æŠ•è³‡', 'æœˆå…‰æ—ï¼Œè³ºå¤šå°‘èŠ±å¤šå°‘', 'å®ˆè²¡å¥´ï¼Œæ¨ä¸å¾—èŠ±éŒ¢', 'æ…·æ…¨å¤§æ–¹ï¼Œå–œæ­¡è«‹å®¢é€ç¦®', 'é‡‘éŒ¢ç„¡æ„Ÿï¼Œå°éŒ¢æ²’æ¦‚å¿µ', 'ä¸­åº¸ä¹‹é“ï¼Œè©²èŠ±å°±èŠ±è©²çœå°±çœ', 'å·¥ä½œç‹‚ï¼Œåªç‚ºè³ºéŒ¢'],
        morality: ['å–„è‰¯æ­£ç¾©ï¼Œå …æŒåšå°çš„äº‹', 'ä¸­ç«‹å¹³è¡¡ï¼Œä¸åä¸å€š', 'æ··æ²Œå–„è‰¯ï¼Œç”¨éå¸¸æ‰‹æ®µè¡Œå–„', 'ç§©åºå–„è‰¯ï¼Œéµå®ˆè¦å‰‡åšå¥½äº‹', 'å®ˆåºä¸­ç«‹ï¼Œåš´æ ¼éµå®ˆæ³•å¾‹', 'çœŸå¯¦ä¸­ç«‹ï¼Œå®Œå…¨ä¸­ç«‹', 'æ··æ²Œä¸­ç«‹ï¼Œè‡ªç”±è‡³ä¸Š', 'å®ˆåºé‚ªæƒ¡ï¼Œåˆ©ç”¨æ³•å¾‹ä½œæƒ¡', 'ä¸­ç«‹é‚ªæƒ¡ï¼Œç‚ºå·±åˆ©ä¸æ“‡æ‰‹æ®µ', 'æ··æ²Œé‚ªæƒ¡ï¼Œäº«å—ç ´å£èˆ‡æ··äº‚']
      },

      // å¿«é€Ÿæ¨™ç±¤è¨­å®š - Hololive é¢¨æ ¼
      quickTags: {
        personality: ['æ´»æ½‘', 'å®³ç¾', 'å‚²å¬Œ', 'å¤©ç„¶å‘†', 'å†’å¤±', 'èªçœŸ', 'æç¬‘', 'æº«æŸ”', 'æ¯’èˆŒ', 'å…ƒæ°£', 'æˆç†Ÿ', 'å¯æ„›', 'å¸¥æ°£', 'ç¥ç§˜'],
        traits: ['åŠªåŠ›', 'è¿·ç³Š', 'è°æ˜', 'å¥½å¥‡', 'ç†±æƒ…', 'å†·éœ', 'ä»»æ€§', 'é«”è²¼', 'ææ€ª', 'æ­£ç¶“', 'å¿ èª ', 'è‡ªä¿¡'],
        species: ['äººé¡', 'ç‹å¨˜', 'è²“å¨˜', 'çŠ¬å¨˜', 'å…”å¨˜', 'ç²¾éˆ', 'åŠç²¾éˆ', 'å¤©ä½¿', 'æƒ¡é­”', 'é­”å¥³', 'é¯Šé­š', 'é¾æ—'],
        occupation: ['VTuber', 'å¶åƒ', 'æ­Œå§¬', 'éŠæˆ²å¯¦æ³ä¸»', 'è—äºº', 'å¥³åƒ•', 'é¨å£«', 'é­”æ³•ä½¿', 'æµ·è³Š', 'å¿è€…', 'åµæ¢', 'æ–™ç†äºº'],
        appearance: ['å¯æ„›', 'å¸¥æ°£', 'å„ªé›…', 'æ´»æ½‘', 'æˆç†Ÿ', 'æ¸…ç´”', 'æ€§æ„Ÿ', 'å…ƒæ°£', 'ç¥ç§˜', 'æº«æŸ”'],
        hair: ['éŠ€ç™½', 'è—è‰²', 'ç´«è‰²', 'ç²‰ç´…', 'é‡‘è‰²', 'ç´…è‰²', 'é»‘è‰²', 'é›™è‰²', 'é•·é«®', 'çŸ­é«®', 'é›™é¦¬å°¾', 'å…¬ä¸»åˆ‡'],
        hairColor: ['éŠ€ç™½', 'è—è‰²', 'ç´«è‰²', 'ç²‰ç´…', 'é‡‘è‰²', 'ç´…è‰²', 'é»‘è‰²', 'æ£•è‰²', 'ç°è‰²', 'é›™è‰²'],
        hairStyle: ['é•·é«®', 'çŸ­é«®', 'ä¸­é•·é«®', 'é›™é¦¬å°¾', 'å–®é¦¬å°¾', 'å…¬ä¸»åˆ‡', 'æ³¢æµªæ²', 'ç›´é«®', 'åŠè…°', 'åŠè‚©'],
        eyes: ['è—è‰²', 'ç´«è‰²', 'ç´…è‰²', 'é‡‘è‰²', 'ç¶ è‰²', 'ç²‰ç´…', 'ç•°è‰²ç³', 'æ˜Ÿæ˜Ÿçœ¼'],
        clothing: ['å¶åƒæœ', 'å¥³åƒ•è£', 'å’Œæœ', 'åˆ¶æœ', 'é€£å¸½è¡«', 'ç¦®æœ', 'é‹å‹•æœ', 'é¨å£«ç”²', 'å·«å¥³æœ', 'æ³³è£'],
        combatSkills: ['æ­Œå”±é­”æ³•', 'èˆè¹ˆæˆ°æŠ€', 'è²éŸ³æ”»æ“Š', 'é­…åŠ›å…‰ç’°', 'éŠæˆ²æŠ€å·§', 'åŠè¡“', 'é­”æ³•', 'å¿è¡“', 'å°„æ“Š', 'æ²»ç™’è¡“'],
        lifeSkills: ['å”±æ­Œ', 'è·³èˆ', 'éŠæˆ²', 'ç¹ªç•«', 'æ–™ç†', 'æ¼”å¥', 'é…éŸ³', 'æ¨¡ä»¿', 'æç¬‘', 'ä¸»æŒ'],
        emotionalAttitude: ['ä½”æœ‰æ…¾', 'æ§åˆ¶æ¬²', 'å°‹æ‰¾å®¶äºº', 'é‡è¦–å‹æƒ…', 'ç¨å æ¬²', 'ä¾è³´å‹', 'è‡ªç”±æˆ€æ„›', 'ä¿æŒè·é›¢', 'ç†æƒ³ä¸»ç¾©', 'å¯¦ç”¨ä¸»ç¾©'],
        moneyAttitude: ['ç¯€å„‰', 'å¥¢ä¾ˆ', 'çœå°éŒ¢èŠ±å¤§éŒ¢', 'ç†è²¡é«˜æ‰‹', 'æœˆå…‰æ—', 'å®ˆè²¡å¥´', 'æ…·æ…¨å¤§æ–¹', 'é‡‘éŒ¢ç„¡æ„Ÿ', 'ä¸­åº¸ä¹‹é“', 'å·¥ä½œç‹‚'],
        morality: ['å–„è‰¯æ­£ç¾©', 'ä¸­ç«‹å¹³è¡¡', 'æ··æ²Œå–„è‰¯', 'ç§©åºå–„è‰¯', 'å®ˆåºä¸­ç«‹', 'çœŸå¯¦ä¸­ç«‹', 'æ··æ²Œä¸­ç«‹', 'å®ˆåºé‚ªæƒ¡', 'ä¸­ç«‹é‚ªæƒ¡', 'æ··æ²Œé‚ªæƒ¡']
      },

      // è¨­å®šç®¡ç†
      settings: {
        // å›ºå®šçš„ Google Drive ä¸»è³‡æ–™å¤¾ IDï¼ˆå¾Œå°è¨­å®šï¼Œç”¨æˆ¶ä¸å¯è¦‹ï¼‰
        GOOGLE_DRIVE_FOLDER_ID: CONFIG.GOOGLE_DRIVE_FOLDER_ID,

        load() {
          const aiProvider = localStorage.getItem('aiProvider') || 'gemini';
          const geminiApiKey = localStorage.getItem('geminiApiKey') || '';
          const openaiApiKey = localStorage.getItem('openaiApiKey') || '';
          const claudeApiKey = localStorage.getItem('claudeApiKey') || '';
          const deepseekApiKey = localStorage.getItem('deepseekApiKey') || '';

          document.getElementById('aiProvider').value = aiProvider;
          document.getElementById('geminiApiKey').value = geminiApiKey;
          document.getElementById('openaiApiKey').value = openaiApiKey;
          document.getElementById('claudeApiKey').value = claudeApiKey;
          document.getElementById('deepseekApiKey').value = deepseekApiKey;

          this.updateProviderUI();

          return {
            aiProvider,
            geminiApiKey,
            openaiApiKey,
            claudeApiKey,
            deepseekApiKey
          };
        },

        save() {
          const aiProvider = document.getElementById('aiProvider').value;
          const geminiApiKey = document.getElementById('geminiApiKey').value.trim();
          const openaiApiKey = document.getElementById('openaiApiKey').value.trim();
          const claudeApiKey = document.getElementById('claudeApiKey').value.trim();
          const deepseekApiKey = document.getElementById('deepseekApiKey').value.trim();

          localStorage.setItem('aiProvider', aiProvider);
          localStorage.setItem('geminiApiKey', geminiApiKey);
          localStorage.setItem('openaiApiKey', openaiApiKey);
          localStorage.setItem('claudeApiKey', claudeApiKey);
          localStorage.setItem('deepseekApiKey', deepseekApiKey);

          showToast('è¨­å®šå·²å„²å­˜ï¼', 'success');
          App.ui.closeSettings();

          // æ›´æ–° UI æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
          App.updateUIButtonsVisibility();
        },

        get() {
          return {
            aiProvider: localStorage.getItem('aiProvider') || 'gemini',
            geminiApiKey: localStorage.getItem('geminiApiKey') || '',
            openaiApiKey: localStorage.getItem('openaiApiKey') || '',
            claudeApiKey: localStorage.getItem('claudeApiKey') || '',
            deepseekApiKey: localStorage.getItem('deepseekApiKey') || '',
            googleDriveFolderId: this.GOOGLE_DRIVE_FOLDER_ID
          };
        },

        /**
         * æ›´æ–°æä¾›å•† UI é¡¯ç¤º
         */
        updateProviderUI() {
          const provider = document.getElementById('aiProvider').value;
          const allItems = document.querySelectorAll('.api-key-item');

          allItems.forEach(item => {
            if (item.dataset.provider === provider) {
              item.style.display = 'block';
            } else {
              item.style.display = 'none';
            }
          });
        }
      },

      // Google OAuth èªè­‰
      auth: {
        client: null,
        // å›ºå®šçš„ Google OAuth Client ID
        GOOGLE_CLIENT_ID: CONFIG.GOOGLE_CLIENT_ID,

        init() {
          // åˆå§‹åŒ– Google Identity Services
          google.accounts.id.initialize({
            client_id: this.GOOGLE_CLIENT_ID,
            callback: this.handleCredentialResponse.bind(this),
          });

          // åˆå§‹åŒ– OAuth å®¢æˆ¶ç«¯ï¼ˆç”¨æ–¼å–å¾— access tokenï¼‰
          this.client = google.accounts.oauth2.initTokenClient({
            client_id: this.GOOGLE_CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
            callback: this.handleTokenResponse.bind(this),
          });
        },

        login() {
          if (!this.client) {
            this.init();
          }

          this.client.requestAccessToken();
        },

        handleTokenResponse(response) {
          if (response.error) {
            showToast('ç™»å…¥å¤±æ•—ï¼š' + response.error, 'error');
            return;
          }

          App.state.accessToken = response.access_token;

          // å–å¾—ç”¨æˆ¶è³‡è¨Š
          fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: { Authorization: `Bearer ${response.access_token}` }
          })
          .then(res => res.json())
          .then(async userInfo => {
            App.state.user = userInfo;
            this.updateUI();
            showToast('ç™»å…¥æˆåŠŸï¼æ­¡è¿ ' + userInfo.name, 'success');

            // åˆå§‹åŒ– Google Drive ç”¨æˆ¶è³‡æ–™å¤¾
            try {
              await App.drive.initUserFolder();
              showToast('é›²ç«¯è³‡æ–™å¤¾å·²æº–å‚™å°±ç·’', 'success');
            } catch (error) {
              console.error('åˆå§‹åŒ– Drive è³‡æ–™å¤¾å¤±æ•—:', error);
              showToast('é›²ç«¯è³‡æ–™å¤¾åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š', 'warning');
            }
          });
        },

        handleCredentialResponse(response) {
          // JWT callbackï¼ˆå‚™ç”¨ï¼‰
          console.log('Credential response:', response);
        },

        logout() {
          App.state.user = null;
          App.state.accessToken = null;
          this.updateUI();
          showToast('å·²ç™»å‡º', 'info');
        },

        updateUI() {
          const userInfo = document.getElementById('userInfo');
          const loginBtn = document.getElementById('loginBtn');
          const cloudBtn = document.getElementById('cloudBtn');

          if (App.state.user) {
            document.getElementById('userAvatar').src = App.state.user.picture;
            document.getElementById('userName').textContent = App.state.user.name;
            userInfo.style.display = 'flex';
            loginBtn.style.display = 'none';
            if (cloudBtn) cloudBtn.style.display = 'flex';
          } else {
            userInfo.style.display = 'none';
            loginBtn.style.display = 'flex';
            if (cloudBtn) cloudBtn.style.display = 'none';
          }
        }
      },

      // è¡¨å–®é©—è­‰
      validator: {
        // é©—è­‰å¿…å¡«æ¬„ä½
        validateRequired(data) {
          const errors = [];

          // è§’è‰²åç¨±ç‚ºå¿…å¡«
          if (!data.name || data.name.trim() === '') {
            errors.push({
              field: 'name',
              message: 'è«‹å¡«å¯«è§’è‰²åç¨±'
            });
          }

          return errors;
        },

        // é©—è­‰å­—æ•¸é™åˆ¶ï¼ˆCharacter.AIï¼‰
        validateCharacterAI(data) {
          const warnings = [];

          if (App.state.currentPlatform === 'characterai') {
            const description = data.description || '';
            const maxLength = 3200;

            if (description.length > maxLength) {
              warnings.push({
                field: 'description',
                message: `Character.AI æè¿°è¶…éå»ºè­°é•·åº¦ (${description.length}/${maxLength} å­—å…ƒ)`
              });
            }
          }

          return warnings;
        },

        // è¦–è¦ºæ¨™ç¤ºéŒ¯èª¤æ¬„ä½
        highlightErrors(errors) {
          // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤æ¨™ç¤º
          document.querySelectorAll('.form-field input, .form-field textarea').forEach(el => {
            el.style.borderColor = '';
          });

          // æ¨™ç¤ºéŒ¯èª¤æ¬„ä½
          errors.forEach(error => {
            const field = document.getElementById(error.field);
            if (field) {
              field.style.borderColor = 'var(--danger)';
              field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        },

        // ç¶œåˆé©—è­‰
        validate(data) {
          const errors = this.validateRequired(data);
          const warnings = this.validateCharacterAI(data);

          if (errors.length > 0) {
            this.highlightErrors(errors);
            showToast(errors[0].message, 'error');
            return false;
          }

          if (warnings.length > 0) {
            warnings.forEach(warning => {
              showToast(warning.message, 'warning');
            });
          }

          return true;
        }
      },

      // UI æ§åˆ¶
      ui: {
        openSettings() {
          App.settings.load();
          document.getElementById('settingsModal').classList.add('show');
        },

        closeSettings() {
          document.getElementById('settingsModal').classList.remove('show');
        },

        openImport() {
          // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®š AI API Key
          const settings = App.settings.get();
          const hasApiKey = settings.geminiApiKey || settings.openaiApiKey || settings.claudeApiKey || settings.deepseekApiKey;

          const useAICheckbox = document.getElementById('useAIImport');
          const importFileInput = document.getElementById('importFileInput');

          if (!hasApiKey) {
            // æ²’æœ‰ API Keyï¼Œç¦ç”¨ AI åˆ¤è®€é¸é …
            useAICheckbox.checked = false;
            useAICheckbox.disabled = true;
            // æ›´æ–°æç¤ºæ–‡å­—
            const hint = useAICheckbox.parentElement.nextElementSibling;
            hint.innerHTML = '<span style="color: #e53935;">âš ï¸ éœ€è¦å…ˆè¨­å®š AI API Key æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½</span>';
            // é™åˆ¶åªèƒ½æ¥å—æ¨™æº–æ ¼å¼
            importFileInput.accept = '.json,.yaml,.yml';
          } else {
            // æœ‰ API Keyï¼Œå•Ÿç”¨ AI åˆ¤è®€é¸é …
            useAICheckbox.disabled = false;
            // æ¢å¾©æç¤ºæ–‡å­—
            const hint = useAICheckbox.parentElement.nextElementSibling;
            hint.innerHTML = 'â€»å¯å¥—å…¥ä»»ä½•æ ¼å¼çš„æ–‡å­—æª”æ¡ˆæä¾›åˆ¤è®€çµ¦é€™å€‹AIåˆ¤è®€çš„é¸é …';
            // å¯ä»¥æ¥å—æ‰€æœ‰æ ¼å¼
            importFileInput.accept = '.json,.yaml,.yml,.txt,.md';
          }

          // é‡ç½®æª”æ¡ˆé¸æ“‡
          importFileInput.value = '';
          document.getElementById('importPreview').style.display = 'none';

          // é¡¯ç¤ºå½ˆçª—
          document.getElementById('importModal').classList.add('show');
        },

        closeImport() {
          document.getElementById('importModal').classList.remove('show');
        },

        async openCloudManager() {
          if (!App.state.user) {
            showToast('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ', 'warning');
            return;
          }

          document.getElementById('cloudModal').classList.add('show');
          await this.loadCloudCharacters();
        },

        closeCloudManager() {
          document.getElementById('cloudModal').classList.remove('show');
        },

        async loadCloudCharacters() {
          const list = document.getElementById('cloudCharacterList');
          list.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

          try {
            const files = await App.drive.listCharacters();

            if (files.length === 0) {
              list.innerHTML = '<div class="empty-state">å°šç„¡é›²ç«¯è§’è‰²å¡</div>';
              return;
            }

            list.innerHTML = files.map(file => `
              <div class="cloud-item">
                <div class="cloud-item-info">
                  <div class="cloud-item-name">${file.name.replace('.json', '')}</div>
                  <div class="cloud-item-meta">
                    ${new Date(file.modifiedTime).toLocaleString('zh-TW')}
                  </div>
                </div>
                <div class="cloud-item-actions">
                  <button class="btn small" onclick="App.ui.loadCloudCharacter('${file.id}', '${file.name}')">è¼‰å…¥</button>
                  <button class="btn small secondary" onclick="App.ui.deleteCloudCharacter('${file.id}')">åˆªé™¤</button>
                </div>
              </div>
            `).join('');
          } catch (error) {
            console.error('è¼‰å…¥é›²ç«¯è§’è‰²å¡å¤±æ•—:', error);
            list.innerHTML = '<div class="error-state">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
            showToast('è¼‰å…¥é›²ç«¯è§’è‰²å¡å¤±æ•—', 'error');
          }
        },

        async loadCloudCharacter(fileId, fileName) {
          try {
            showToast('è¼‰å…¥ä¸­...', 'info');
            const content = await App.drive.downloadFile(fileId);
            const data = JSON.parse(content);

            // æ ¹æ“šæ ¼å¼è§£æè³‡æ–™
            let characterData;
            if (data.character_info) {
              // Gemini æ ¼å¼
              characterData = parseGeminiFormat(data);
            } else if (data.spec === 'chara_card_v2') {
              // SillyTavern æ ¼å¼
              characterData = parseSillyTavernFormat(data);
            } else if (data.type === 'risuai') {
              // RisuAI æ ¼å¼
              characterData = parseRisuAIFormat(data);
            } else {
              // ç°¡æ˜“æ ¼å¼
              characterData = data;
            }

            // å¡«å…¥è¡¨å–®
            fillFormData(characterData);

            this.closeCloudManager();
            showToast(`å·²è¼‰å…¥è§’è‰²å¡ï¼š${fileName.replace('.json', '')}`, 'success');
          } catch (error) {
            console.error('è¼‰å…¥è§’è‰²å¡å¤±æ•—:', error);
            showToast('è¼‰å…¥è§’è‰²å¡å¤±æ•—', 'error');
          }
        },

        async deleteCloudCharacter(fileId) {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è§’è‰²å¡å—ï¼Ÿ')) {
            return;
          }

          try {
            await fetch(
              `https://www.googleapis.com/drive/v3/files/${fileId}`,
              {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            showToast('åˆªé™¤æˆåŠŸ', 'success');
            await this.loadCloudCharacters();
          } catch (error) {
            console.error('åˆªé™¤å¤±æ•—:', error);
            showToast('åˆªé™¤å¤±æ•—', 'error');
          }
        },

        async saveToCloud() {
          if (!App.state.user) {
            showToast('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ', 'warning');
            return;
          }

          const data = collectFormData();
          if (!App.validator.validate(data)) {
            return;
          }

          try {
            showToast('ä¸Šå‚³ä¸­...', 'info');

            const fileName = `${data.name || 'æœªå‘½åè§’è‰²'}_${Date.now()}.json`;
            const jsonContent = convertToJSON(data, App.state.currentPlatform);

            await App.drive.uploadFile(fileName, jsonContent, 'application/json');

            showToast('å„²å­˜åˆ°é›²ç«¯æˆåŠŸï¼', 'success');
          } catch (error) {
            console.error('å„²å­˜åˆ°é›²ç«¯å¤±æ•—:', error);
            showToast('å„²å­˜åˆ°é›²ç«¯å¤±æ•—ï¼š' + error.message, 'error');
          }
        },

        // éª°å­å¿«é€Ÿç”Ÿæˆ
        rollDice(fieldName) {
          const examples = App.exampleData[fieldName];
          if (!examples || examples.length === 0) {
            showToast('è©²æ¬„ä½æ²’æœ‰ç¯„ä¾‹è³‡æ–™', 'error');
            return;
          }

          const randomExample = examples[Math.floor(Math.random() * examples.length)];
          const field = document.getElementById(fieldName);
          if (field) {
            field.value = randomExample;
            updatePreview();
            showToast('å·²å¡«å…¥ç¯„ä¾‹ï¼', 'success');
          }
        },

        // å¿«é€Ÿæ¨™ç±¤æ’å…¥
        insertTag(fieldName, tag) {
          const field = document.getElementById(fieldName);
          if (!field) return;

          const currentValue = field.value.trim();
          if (currentValue === '') {
            field.value = tag;
          } else {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“åŒ…å«æ­¤æ¨™ç±¤
            const values = currentValue.split(',').map(v => v.trim());
            if (!values.includes(tag)) {
              field.value = currentValue + ', ' + tag;
            }
          }
          updatePreview();
        },

        // æ¸²æŸ“å¿«é€Ÿæ¨™ç±¤
        renderQuickTags(fieldName, containerId) {
          const tags = App.quickTags[fieldName];
          const container = document.getElementById(containerId);
          if (!container || !tags) return;

          container.innerHTML = tags.map(tag =>
            `<span class="quick-tag" onclick="App.ui.insertTag('${fieldName}', '${tag}')">${tag}</span>`
          ).join('');
        }
      },

      // å‹•æ…‹æ¬„ä½ç®¡ç†
      dynamicFields: {
        // æ¬„ä½é…ç½®
        config: {
          relationships: {
            fields: [
              { name: 'name', label: 'åç¨±/ç¨±å‘¼', placeholder: 'ä¾‹ï¼šç™½ä¸Šå¹é›ª', type: 'text', hasExample: true },
              { name: 'description', label: 'é—œä¿‚æè¿°', placeholder: 'ä¾‹ï¼šGAMERS çš„åŒæœŸå¤¥ä¼´', type: 'text', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              name: ['ç™½ä¸Šå¹é›ª', 'æ¹Šé˜¿åº«å©­', 'å¤§ç©ºæ˜´', 'Gawr Gura', 'å¯¶é˜ç‘ªç³', 'æ˜Ÿè¡—å½—æ˜Ÿ'],
              description: ['GAMERS çš„åŒæœŸå¤¥ä¼´ï¼Œç¶“å¸¸ä¸€èµ·ç›´æ’­', 'åŒæœŸç”Ÿï¼Œäº’ç›¸ç«¶çˆ­åˆäº’ç›¸æ‰¶æŒ', 'å‰è¼©ï¼Œç¶“å¸¸çµ¦äºˆå»ºè­°å’Œé¼“å‹µ', 'å¾Œè¼©ï¼Œéå¸¸å°Šæ•¬çš„å°è±¡', 'å¥½æœ‹å‹ï¼Œç¶“å¸¸ä¸€èµ·åˆä½œä¼åŠƒ', 'æ­Œå”±å¤¥ä¼´ï¼Œäº’ç›¸åˆ‡ç£‹æ­Œè—']
            }
          },
          combatSkills: {
            fields: [
              { name: 'skill', label: 'æŠ€èƒ½åç¨±', placeholder: 'ä¾‹ï¼šæ­Œå”±é­”æ³•', type: 'text', hasExample: true },
              { name: 'level', label: 'ç­‰ç´š/æè¿°', placeholder: 'ä¾‹ï¼šSç´šã€å°ˆç²¾ã€å¯é­…æƒ‘è½çœ¾', type: 'text', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              skill: ['æ­Œå”±é­”æ³•', 'èˆè¹ˆæˆ°æŠ€', 'è²éŸ³æ”»æ“Š', 'é­…åŠ›å…‰ç’°', 'éŠæˆ²æŠ€å·§', 'ç‹ç«é­”æ³•', 'æ°´é­”æ³•', 'æ˜Ÿå…‰æ”»æ“Š'],
              level: ['Sç´š', 'A+', 'å°ˆç²¾', 'å¤§å¸«ç´š', 'ç†Ÿç·´', 'MAX', 'å¯é­…æƒ‘è½çœ¾', 'ç¯„åœæ”»æ“Š']
            }
          },
          lifeSkills: {
            fields: [
              { name: 'skill', label: 'æŠ€èƒ½åç¨±', placeholder: 'ä¾‹ï¼šéŠæˆ²å¯¦æ³', type: 'text', hasExample: true },
              { name: 'level', label: 'ç­‰ç´š/æè¿°', placeholder: 'ä¾‹ï¼šå°ˆæ¥­ç´šã€æ“…é•·ææ€–éŠæˆ²', type: 'text', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              skill: ['éŠæˆ²å¯¦æ³', 'å”±æ­Œ', 'è·³èˆ', 'ç¹ªç•«', 'æ–™ç†', 'é…éŸ³', 'æ¨¡ä»¿', 'ä¸»æŒ', 'æç¬‘', 'æ¼”å¥'],
              level: ['å°ˆæ¥­ç´š', 'Sç´š', 'å¤©è³¦ç•°ç¨Ÿ', 'æ“…é•·ææ€–éŠæˆ²', 'å¯æ„›æ“”ç•¶', 'æ°£æ°›æ“”ç•¶', 'ç†Ÿç·´', 'å°ˆç²¾', 'å¤§å¸«', 'ç¨æ¨¹ä¸€æ ¼']
            }
          },
          customAttributes: {
            fields: [
              { name: 'attribute', label: 'å±¬æ€§åç¨±', placeholder: 'ä¾‹ï¼šé­…åŠ›å€¼', type: 'text', hasExample: true },
              { name: 'value', label: 'å€¼/ç­‰ç´š/æè¿°', placeholder: 'ä¾‹ï¼šSSS', type: 'text', hasExample: true }
            ],
            defaultCount: 3,
            examples: {
              attribute: ['é­…åŠ›å€¼', 'æ­Œå”±åŠ›', 'éŠæˆ²æŠ€è¡“', 'å¯æ„›åº¦', 'è—äººé­‚', 'å†’å¤±åº¦', 'æç¬‘åŠ›', 'å¶åƒåŠ›', 'è²éŸ³é­…åŠ›', 'ç²‰çµ²äººæ°£'],
              value: ['SSS', 'S+', 'A++', 'MAX', '97/100', 'âˆ', 'ç ´è¡¨', 'æ»¿é»', 'å‚³èªªç´š', '10è¬è¨‚é–±']
            }
          },
          speechStyle: {
            fields: [
              { name: 'situation', label: 'æƒ…å¢ƒ', placeholder: 'ä¾‹ï¼šé–‹å¿ƒæ™‚', type: 'text', hasExample: true },
              { name: 'dialogue', label: 'å°è©±ç¯„ä¾‹', placeholder: 'ä¾‹ï¼šã€Œã“ã‚“ã“ãƒ¼ã‚“ï¼ã€', type: 'textarea', hasExample: true }
            ],
            defaultCount: 1,
            examples: {
              situation: ['é–‹å¿ƒæ™‚', 'ç”Ÿæ°£æ™‚', 'å®³ç¾æ™‚', 'é©šè¨æ™‚', 'éŠæˆ²å¤±æ•—æ™‚', 'å”±æ­Œæ™‚', 'æ‰“æ‹›å‘¼æ™‚', 'é“åˆ¥æ™‚'],
              dialogue: [
                'ã€Œã“ã‚“ã“ãƒ¼ã‚“ï¼å¤§å®¶å¥½ï¼ã€',
                'ã€Œã‚‚ã†ï¼é€™æ¨£ä¸è¡Œå•¦ï¼ã€',
                'ã€Œèª’...é‚£å€‹...è¬ã€è¬è¬...ã€',
                'ã€Œãˆã‡ã‡ã‡ï¼ï¼ŸçœŸçš„å‡çš„ï¼ã€',
                'ã€Œå•Šå•Šå•Šä¸è¦ï¼æˆ‘ä¸æƒ³æ­»ï¼ã€',
                'ã€Œâ™ªï½è®“æˆ‘å€‘ä¸€èµ·å”±æ­Œå§ï½â™ªã€',
                'ã€Œå“ˆå›‰å“ˆå›‰ï½æ˜¯æˆ‘å•¦ï¼ã€',
                'ã€Œé‚£éº¼ï¼Œä¸‹æ¬¡è¦‹å›‰ï¼ãƒã‚¤ãƒã‚¤ï½ã€'
              ]
            }
          }
        },

        // åˆå§‹åŒ–æ‰€æœ‰å‹•æ…‹æ¬„ä½
        init() {
          Object.keys(this.config).forEach(fieldType => {
            const cfg = this.config[fieldType];
            const container = document.getElementById(`${fieldType}Container`);
            if (!container) return;

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // æ·»åŠ é è¨­æ•¸é‡çš„æ¬„ä½
            for (let i = 0; i < cfg.defaultCount; i++) {
              this.add(fieldType, true);
            }
          });
        },

        // æ·»åŠ ä¸€è¡Œæ¬„ä½
        add(fieldType, skipUpdate = false) {
          const cfg = this.config[fieldType];
          if (!cfg) {
            console.error('æœªçŸ¥çš„æ¬„ä½é¡å‹:', fieldType);
            return;
          }

          const container = document.getElementById(`${fieldType}Container`);
          if (!container) {
            console.error('æ‰¾ä¸åˆ°å®¹å™¨:', `${fieldType}Container`);
            return;
          }

          const index = container.children.length;
          const row = document.createElement('div');
          row.className = 'dynamic-field-row';
          row.dataset.index = index;

          // ç”Ÿæˆæ¬„ä½ HTML
          let fieldsHTML = '';
          cfg.fields.forEach((field, fieldIndex) => {
            const fieldId = `${fieldType}_${index}_${field.name}`;
            const inputType = field.type === 'textarea' ? 'textarea' : 'input';
            const inputHTML = inputType === 'textarea'
              ? `<textarea id="${fieldId}" placeholder="${field.placeholder}" oninput="updatePreview()" rows="2"></textarea>`
              : `<input type="${field.type || 'text'}" id="${fieldId}" placeholder="${field.placeholder}" oninput="updatePreview()">`;

            fieldsHTML += `
              <div class="form-field">
                <label>${field.label}</label>
                ${inputHTML}
              </div>
            `;
          });

          // æ·»åŠ æ§åˆ¶æŒ‰éˆ•
          let controlsHTML = '<div class="field-controls">';

          // éª°å­æŒ‰éˆ•ï¼ˆæ¯å€‹æ¬„ä½ä¸€å€‹ï¼‰
          cfg.fields.forEach((field, fieldIndex) => {
            if (field.hasExample) {
              controlsHTML += `
                <button type="button" class="dice-btn"
                  onclick="App.dynamicFields.rollDice('${fieldType}', ${index}, '${field.name}')"
                  title="éš¨æ©Ÿç”Ÿæˆ${field.label}">ğŸ²</button>
              `;
            }
          });

          // åˆªé™¤æŒ‰éˆ•
          const isFirst = index === 0;
          controlsHTML += `
            <button type="button" class="remove-btn"
              onclick="App.dynamicFields.remove('${fieldType}', ${index})"
              ${isFirst ? 'disabled' : ''}
              title="åˆªé™¤é€™ä¸€è¡Œ">ğŸ—‘ï¸</button>
          `;
          controlsHTML += '</div>';

          row.innerHTML = fieldsHTML + controlsHTML;
          container.appendChild(row);

          if (!skipUpdate) {
            updatePreview();
          }
        },

        // åˆªé™¤ä¸€è¡Œæ¬„ä½
        remove(fieldType, index) {
          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return;

          const rows = container.querySelectorAll('.dynamic-field-row');
          if (rows.length <= 1) {
            showToast('è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ¬„ä½', 'warning');
            return;
          }

          if (rows[index]) {
            rows[index].remove();

            // é‡æ–°ç´¢å¼•
            this.reindex(fieldType);
            updatePreview();
          }
        },

        // é‡æ–°ç´¢å¼•æ¬„ä½
        reindex(fieldType) {
          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return;

          const rows = container.querySelectorAll('.dynamic-field-row');
          rows.forEach((row, newIndex) => {
            row.dataset.index = newIndex;

            // æ›´æ–°æ‰€æœ‰ input/textarea çš„ id
            const inputs = row.querySelectorAll('input, textarea');
            inputs.forEach(input => {
              const oldId = input.id;
              const parts = oldId.split('_');
              parts[1] = newIndex; // æ›´æ–°ç´¢å¼•
              input.id = parts.join('_');
            });

            // æ›´æ–°æŒ‰éˆ•çš„ onclick
            const diceButtons = row.querySelectorAll('.dice-btn');
            diceButtons.forEach((btn, btnIndex) => {
              const cfg = this.config[fieldType];
              const field = cfg.fields[btnIndex];
              btn.setAttribute('onclick', `App.dynamicFields.rollDice('${fieldType}', ${newIndex}, '${field.name}')`);
            });

            const removeBtn = row.querySelector('.remove-btn');
            if (removeBtn) {
              removeBtn.setAttribute('onclick', `App.dynamicFields.remove('${fieldType}', ${newIndex})`);
              removeBtn.disabled = (newIndex === 0);
            }
          });
        },

        // éª°å­åŠŸèƒ½ï¼ˆé‡å°ç‰¹å®šæ¬„ä½ï¼‰
        rollDice(fieldType, index, part) {
          const cfg = this.config[fieldType];
          if (!cfg || !cfg.examples || !cfg.examples[part]) {
            showToast('è©²æ¬„ä½æ²’æœ‰ç¯„ä¾‹è³‡æ–™', 'error');
            return;
          }

          const examples = cfg.examples[part];
          const randomExample = examples[Math.floor(Math.random() * examples.length)];
          const fieldId = `${fieldType}_${index}_${part}`;
          const field = document.getElementById(fieldId);

          if (field) {
            field.value = randomExample;
            updatePreview();
            showToast('å·²å¡«å…¥ç¯„ä¾‹ï¼', 'success');
          }
        },

        // æ”¶é›†å‹•æ…‹æ¬„ä½è³‡æ–™
        collect(fieldType) {
          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return [];

          const cfg = this.config[fieldType];
          const rows = container.querySelectorAll('.dynamic-field-row');
          const result = [];

          rows.forEach((row, index) => {
            const item = {};
            cfg.fields.forEach(field => {
              const input = document.getElementById(`${fieldType}_${index}_${field.name}`);
              if (input) {
                item[field.name] = input.value;
              }
            });

            // åªæ·»åŠ éç©ºçš„é …ç›®
            const hasValue = Object.values(item).some(v => v && v.trim() !== '');
            if (hasValue) {
              result.push(item);
            }
          });

          return result;
        },

        // å¡«å……å‹•æ…‹æ¬„ä½è³‡æ–™
        fill(fieldType, data) {
          if (!Array.isArray(data) || data.length === 0) return;

          const container = document.getElementById(`${fieldType}Container`);
          if (!container) return;

          // æ¸…ç©ºç¾æœ‰æ¬„ä½
          container.innerHTML = '';

          // ç‚ºæ¯å€‹è³‡æ–™é …æ·»åŠ æ¬„ä½
          data.forEach((item, index) => {
            this.add(fieldType, true);

            // å¡«å……è³‡æ–™
            const cfg = this.config[fieldType];
            cfg.fields.forEach(field => {
              const input = document.getElementById(`${fieldType}_${index}_${field.name}`);
              if (input && item[field.name] !== undefined) {
                input.value = item[field.name];
              }
            });
          });

          updatePreview();
        }
      },

      // åŒ¯å…¥åŠŸèƒ½
      import: {
        // æš«å­˜æœ€å¾Œä¸€æ¬¡åŒ¯å…¥çš„åŸå§‹æª”æ¡ˆå…§å®¹ï¼ˆç”¨æ–¼å€å¡Šå¼ AI è£œå……ï¼‰
        lastImportedText: null,

        /**
         * è¨­ç½® loading ç‹€æ…‹
         * @param {boolean} isLoading - æ˜¯å¦æ­£åœ¨è¼‰å…¥
         */
        setLoading(isLoading) {
          const form = document.getElementById('formPanel');
          const inputs = form.querySelectorAll('input, textarea, select');

          if (isLoading) {
            // ç¦ç”¨æ‰€æœ‰è¡¨å–®æ¬„ä½
            inputs.forEach(input => {
              input.disabled = true;
              input.style.opacity = '0.6';
              input.style.cursor = 'not-allowed';
            });

            // é¡¯ç¤º loading é®ç½©
            let loadingOverlay = document.getElementById('loadingOverlay');
            if (!loadingOverlay) {
              loadingOverlay = document.createElement('div');
              loadingOverlay.id = 'loadingOverlay';
              loadingOverlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: rgba(255,255,255,0.9); z-index: 9999;
                            display: flex; align-items: center; justify-content: center;">
                  <div style="text-align: center;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
                                border-radius: 50%; width: 50px; height: 50px;
                                animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <div style="font-size: 18px; color: #333;">AI æ­£åœ¨åˆ†æè§’è‰²å¡...</div>
                    <div style="font-size: 14px; color: #666; margin-top: 10px;">è«‹ç¨å€™ï¼Œä¸è¦é—œé–‰é é¢</div>
                  </div>
                </div>
                <style>
                  @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                  }
                </style>
              `;
              document.body.appendChild(loadingOverlay);
            }
          } else {
            // å•Ÿç”¨æ‰€æœ‰è¡¨å–®æ¬„ä½
            inputs.forEach(input => {
              input.disabled = false;
              input.style.opacity = '1';
              input.style.cursor = '';
            });

            // ç§»é™¤ loading é®ç½©
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
              loadingOverlay.remove();
            }
          }
        },

        async execute() {
          const fileInput = document.getElementById('importFileInput');
          const useAI = document.getElementById('useAIImport').checked;
          const file = fileInput.files[0];

          if (!file) {
            showToast('è«‹é¸æ“‡è¦åŒ¯å…¥çš„æª”æ¡ˆ', 'warning');
            return;
          }

          // ç«‹å³é—œé–‰å½ˆçª—
          App.ui.closeImport();

          try {
            // é–‹å§‹ loading
            this.setLoading(true);

            if (useAI) {
              // ä½¿ç”¨ AI åˆ¤è®€
              showToast('AI æ­£åœ¨åˆ¤è®€ä¸­ï¼Œè«‹ç¨å€™...', 'info');
              await this.importWithAI(file);
            } else {
              // æ¨™æº–æ ¼å¼åŒ¯å…¥
              showToast('æ­£åœ¨è™•ç†æª”æ¡ˆ...', 'info');
              await this.importStandard(file);
            }

            showToast('åŒ¯å…¥æˆåŠŸï¼', 'success');
            // é¡¯ç¤ºã€Œè®“AIè®€å–åŒ¯å…¥æª”ã€æŒ‰éˆ•
            showAIImportButtons();
          } catch (error) {
            console.error('åŒ¯å…¥å¤±æ•—ï¼š', error);
            showToast('åŒ¯å…¥å¤±æ•—ï¼š' + error.message, 'error');
          } finally {
            // çµæŸ loadingï¼ˆç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼‰
            this.setLoading(false);
          }
        },

        async importStandard(file) {
          const extension = file.name.split('.').pop().toLowerCase();
          const text = await file.text();
          let data = null;

          // æ ¹æ“šæª”æ¡ˆé¡å‹è§£æ
          if (extension === 'json') {
            data = await importFromJSON(text);
          } else if (extension === 'yaml' || extension === 'yml') {
            data = await importFromYAML(text);
          } else {
            throw new Error('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹é¸æ“‡ JSON æˆ– YAML æª”æ¡ˆ');
          }

          if (data) {
            fillFormData(data);
          } else {
            throw new Error('ç„¡æ³•è§£ææª”æ¡ˆå…§å®¹');
          }
        },

        /**
         * æ­£è¦åŒ– AI è¿”å›çš„ JSON çµæ§‹
         * è™•ç†åµŒå¥—çµæ§‹ â†’ æ‰å¹³åŒ–
         * è™•ç† snake_case â†’ camelCase
         */
        normalizeAIResponse(data) {
          // Step 1: æ‰å¹³åŒ–åµŒå¥—çµæ§‹
          let flattened = data;
          if (data.character_info || data.appearance || data.personality ||
              data.background || data.speech_patterns || data.ai_instructions ||
              data.metadata) {
            console.log('æª¢æ¸¬åˆ°åµŒå¥—çµæ§‹ï¼Œé–‹å§‹æ‰å¹³åŒ–...');
            flattened = this.flattenNestedJSON(data);
          }

          // Step 2: è½‰æ› snake_case åˆ° camelCase
          let normalized = this.convertToCamelCase(flattened);

          // Step 3: æ™ºèƒ½æå–æˆ°é¬¥æŠ€èƒ½ï¼ˆå¾ strengths ä¸­åˆ†é›¢ï¼‰
          normalized = this.extractCombatSkills(normalized);

          console.log('æ­£è¦åŒ–å®Œæˆ:', normalized);
          return normalized;
        },

        /**
         * éæ­¸æ‰å¹³åŒ–åµŒå¥— JSON
         */
        flattenNestedJSON(data) {
          let result = {};

          const flatten = (obj) => {
            for (let key in obj) {
              if (obj.hasOwnProperty(key)) {
                const value = obj[key];
                // å¦‚æœæ˜¯ç‰©ä»¶ä¸”ä¸æ˜¯é™£åˆ—ä¸”ä¸æ˜¯ nullï¼Œå‰‡éæ­¸å±•é–‹
                if (typeof value === 'object' && !Array.isArray(value) && value !== null) {
                  flatten(value);
                } else {
                  // ç›´æ¥è³¦å€¼ï¼ˆé™£åˆ—å’ŒåŸºæœ¬é¡å‹ï¼‰
                  result[key] = value;
                }
              }
            }
          };

          flatten(data);
          return result;
        },

        /**
         * è½‰æ› snake_case åˆ° camelCase
         */
        convertToCamelCase(data) {
          let result = {};

          for (let key in data) {
            if (data.hasOwnProperty(key)) {
              // è½‰æ› snake_case åˆ° camelCase
              // ä¾‹å¦‚ï¼šhair_color â†’ hairColor, body_type â†’ bodyType
              const camelKey = key.replace(/_([a-z])/g, (match, letter) => letter.toUpperCase());
              result[camelKey] = data[key];
            }
          }

          return result;
        },

        /**
         * æ™ºèƒ½æå–æˆ°é¬¥æŠ€èƒ½
         * å¾ strengths ä¸­åˆ†é›¢å‡ºæˆ°é¬¥ç›¸é—œæŠ€èƒ½åˆ° combatSkills
         */
        extractCombatSkills(data) {
          // å¦‚æœå·²ç¶“æœ‰ combatSkillsï¼Œä¸è™•ç†
          if (data.combatSkills && data.combatSkills.length > 0) {
            return data;
          }

          // å¦‚æœæ²’æœ‰ strengthsï¼Œä¸è™•ç†
          if (!data.strengths) {
            return data;
          }

          // æˆ°é¬¥ç›¸é—œé—œéµè©ï¼ˆæ“´å……æ¸…å–®ï¼‰
          const combatKeywords = [
            // æ‹›å¼åç¨±
            'ä¸€æµ', 'åŠ', 'åˆ€', 'æ‹³', 'è…¿', 'è¡“', 'æ³•', 'åŠŸ', 'æŠ€', 'å¼',
            // æ­¦å™¨
            'é›™åˆ€', 'å¤ªåˆ€', 'çŸ­åˆ€', 'é•·æ§', 'å¼“ç®­', 'é­”æ–',
            // èƒ½åŠ›
            'åæ‡‰', 'æ­¥æ³•', 'æ„ŸçŸ¥', 'é€Ÿåº¦', 'åŠ›é‡', 'æ•æ·', 'é˜²ç¦¦', 'é–ƒé¿',
            'é çŸ¥', 'ç›´è¦º', 'æˆ°é¬¥', 'ç©ºé–“', 'æ™‚é–“', 'å…ƒç´ ', 'é­”åŠ›', 'éˆåŠ›',
            // ç‰¹æ®Šèƒ½åŠ›
            'æ“ç¸±', 'å¬å–š', 'è½Ÿç‚¸', 'æ¯€æ»…', 'å£“åˆ¶', 'æ–¬æ–·', 'æ²»ç™’', 'é˜²è­·',
            'äº”è¼ª', 'å¯¶å…·', 'å¿…æ®º', 'å¥§ç¾©', 'çµ•æŠ€', 'è¶…èƒ½åŠ›'
          ];

          // å°‡ strengths è½‰æ›ç‚ºé™£åˆ—ï¼ˆå¦‚æœæ˜¯å­—ä¸²ï¼‰
          let strengthsArray = Array.isArray(data.strengths)
            ? data.strengths
            : (typeof data.strengths === 'string' ? data.strengths.split(/[,ï¼Œã€]/).map(s => s.trim()) : []);

          let combatSkills = [];
          let remainingStrengths = [];

          strengthsArray.forEach(strength => {
            // æª¢æŸ¥æ˜¯å¦åŒ…å«æˆ°é¬¥é—œéµè©
            const isCombat = combatKeywords.some(keyword => strength.includes(keyword));

            if (isCombat) {
              combatSkills.push(strength);
            } else {
              remainingStrengths.push(strength);
            }
          });

          // æ›´æ–°è³‡æ–™
          if (combatSkills.length > 0) {
            console.log(`æ™ºèƒ½æå–ï¼šå¾ strengths ä¸­åˆ†é›¢å‡º ${combatSkills.length} å€‹æˆ°é¬¥æŠ€èƒ½`);
            data.combatSkills = combatSkills.join(', ');
            data.strengths = remainingStrengths.length > 0 ? remainingStrengths : data.strengths;
          }

          return data;
        },

        async importWithAI(file) {
          const text = await file.text();

          // æª¢æŸ¥æ–‡å­—å…§å®¹
          if (!text || text.trim().length === 0) {
            throw new Error('æª”æ¡ˆå…§å®¹ç‚ºç©º');
          }

          // æš«å­˜åŸå§‹æª”æ¡ˆå…§å®¹ï¼ˆç”¨æ–¼å€å¡Šå¼ AI è£œå……ï¼‰
          this.lastImportedText = text;

          // æº–å‚™ AI æç¤ºè©ï¼ˆå®Œæ•´ 41 å€‹æ¬„ä½ï¼‰
          const prompt = `è«‹åˆ†æä»¥ä¸‹è§’è‰²å¡å…§å®¹ï¼Œä¸¦å°‡å…¶è½‰æ›ç‚ºæ¨™æº–çš„ JSON æ ¼å¼ã€‚
è«‹ç›¡å¯èƒ½æå–æ‰€æœ‰è§’è‰²è³‡è¨Šï¼ŒåŒ…æ‹¬åŸºæœ¬è³‡è¨Šã€å¤–è§€ã€æ€§æ ¼ã€èƒŒæ™¯ã€èªè¨€é¢¨æ ¼ã€æŠ€èƒ½ç­‰ã€‚

ã€æ ¼å¼è¦æ±‚ã€‘CRITICAL - å¿…é ˆåš´æ ¼éµå®ˆï¼š
1. **åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—**
2. **å¿…é ˆä½¿ç”¨æ‰å¹³çµæ§‹ï¼ˆflat structureï¼‰**ï¼Œä¸è¦ä½¿ç”¨åµŒå¥—ç‰©ä»¶ï¼ˆnested objectsï¼‰
3. **æ¬„ä½åç¨±å¿…é ˆä½¿ç”¨ camelCase**ï¼ˆå¦‚ hairColorï¼Œä¸æ˜¯ hair_color æˆ– HairColorï¼‰
4. **ä¸è¦åˆ†çµ„æˆ character_infoã€appearance ç­‰å­ç‰©ä»¶**

ã€æå–å®Œæ•´æ€§è¦æ±‚ã€‘CRITICAL - é€™æ˜¯æœ€é‡è¦çš„ï¼š
1. **æ·±åº¦æŒ–æ˜**ï¼šä»”ç´°é–±è®€æ•´ä»½æ–‡æª”ï¼Œä¸è¦éºæ¼ä»»ä½•è§’è‰²è³‡è¨Š
2. **å……åˆ†æå–**ï¼šèƒ½å¡«çš„æ¬„ä½å°±è¦å¡«ï¼Œä¸è¦å› ç‚ºæ“”å¿ƒé•·åº¦è€Œçœç•¥ç´°ç¯€
3. **æ™ºèƒ½æ¨ç†**ï¼šå³ä½¿æŸäº›æ¬„ä½æ²’æœ‰ç›´æ¥æè¿°ï¼Œä¹Ÿè¦å¾ä¸Šä¸‹æ–‡æ¨ç†è£œå……
4. **ç„¡å­—æ•¸é™åˆ¶**ï¼šæ‰€æœ‰æ¬„ä½éƒ½å¯ä»¥å¯«å¾—å¾ˆè©³ç´°ï¼Œä¸è¦æ“”å¿ƒ Token æ¶ˆè€—
5. **å¯§å¤šå‹¿å°‘**ï¼šé‡åˆ°æ¨¡ç³Šè³‡è¨Šæ™‚ï¼Œå„ªå…ˆæå–è€Œéçœç•¥

è«‹ä»¥ä»¥ä¸‹ JSON æ ¼å¼å›æ‡‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥åï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥",
  "species": "ç¨®æ—",
  "occupation": "è·æ¥­",

  "appearance": "æ•´é«”å¤–è§€æ¦‚è¿°ï¼ˆå®Œæ•´æè¿°æ‰€æœ‰è¦–è¦ºç‰¹å¾µï¼‰",
  "height": "èº«é«˜ï¼ˆå¦‚ï¼š165cm, 160ï¼‰",
  "bodyType": "é«”å‹æè¿°ï¼ˆåŒ…å«è¦–è¦ºæ¯”å–»ï¼Œè©³ç´°æè¿°ï¼‰",
  "hairColor": "é«®è‰²ï¼ˆè©³ç´°æè¿°é¡è‰²ã€æ¼¸è®Šã€ç‰¹æ®Šæ•ˆæœï¼‰",
  "hairStyle": "é«®å‹ï¼ˆé•·åº¦ã€æ¨£å¼ã€è³ªåœ°ã€ç‰¹æ®Šæ•ˆæœï¼‰",
  "eyes": "çœ¼ç›æè¿°ï¼ˆé¡è‰²ã€å½¢ç‹€ã€ç‰¹å¾µã€ç™¼å…‰æ•ˆæœã€çœ¼ç¥è¡¨ç¾ï¼‰",
  "clothing": "æœè£é¢¨æ ¼ï¼ˆè©³ç´°æè¿°æœè£é¡å‹ã€ç‹€æ…‹ã€ç‰¹æ®Šæ•ˆæœï¼‰",
  "features": "ç‰¹æ®Šæ¨™è¨˜ï¼ˆç–¤ç—•ã€åˆºé’ã€é…ä»¶ã€å…‰ç’°ã€ç¿…è†€ã€å°¾å·´ç­‰ï¼Œé€—è™Ÿåˆ†éš”ï¼‰",

  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆå®Œæ•´æè¿°æ ¸å¿ƒæ€§æ ¼ç‰¹å¾µï¼‰",
  "traits": "ç‰¹è³ªæ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå…§å‘, å–„è‰¯, å›ºåŸ·ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šè°æ˜, æœ‰è€å¿ƒ, å¿ èª ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šéåº¦è¬¹æ…, ä¸å–„äº¤éš›ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šé–±è®€, ä¸‹é›¨å¤©, èŒ¶ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå™ªéŸ³, è¬Šè¨€, äººç¾¤ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå¤±å»è¨˜æ†¶, èƒŒå›ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå°‹æ‰¾å¤±è½çš„å¤ç±ï¼‰",
  "emotionalAttitude": "æƒ…æ„Ÿæ…‹åº¦ï¼ˆå¦‚ï¼šä½”æœ‰æ…¾, æ§åˆ¶æ¬², é‡è¦–å‹æƒ…ï¼‰",
  "moneyAttitude": "é‡‘éŒ¢è§€ï¼ˆå¦‚ï¼šç¯€å„‰, å¥¢ä¾ˆ, å°é‡‘éŒ¢æ¯«ç„¡æ¦‚å¿µï¼‰",
  "morality": "é“å¾·è§€ï¼ˆå¦‚ï¼šå–„è‰¯æ­£ç¾©, ä¸­ç«‹, æ··æ²Œé‚ªæƒ¡ï¼‰",

  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹ï¼ˆå®Œæ•´æè¿°éå»ç¶“æ­·ã€æˆé•·æ­·ç¨‹ï¼‰",
  "keyEvents": "é—œéµäº‹ä»¶ï¼ˆå½¢å¡‘è§’è‰²çš„é‡è¦ç¶“æ­·ï¼Œé€—è™Ÿåˆ†éš”ï¼‰",
  "relationships": "äººéš›é—œä¿‚ï¼ˆé‡è¦çš„äººç‰©é—œä¿‚ï¼Œé€—è™Ÿåˆ†éš”ï¼Œæ ¼å¼ï¼šäººç‰©å-é—œä¿‚é¡å‹ï¼‰",

  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£ï¼ˆå¦‚ï¼šå¥å°¾å¸¸åŠ ã€Œå‘¢ã€, ä½¿ç”¨æ•¬èªï¼‰",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼ï¼ˆå®Œæ•´æè¿°é–‹å¿ƒ/ç”Ÿæ°£/å®³ç¾æ™‚çš„åæ‡‰ï¼‰",
  "speechStyle": "èªè¨€é¢¨æ ¼ï¼ˆæ•´é«”èªªè©±é¢¨æ ¼ï¼Œå¦‚ï¼šç¦®è²Œæ­£å¼, æ´»æ½‘å¯æ„›ï¼‰",

  "combatSkills": "æˆ°é¬¥æŠ€èƒ½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "lifeSkills": "ç”Ÿæ´»æŠ€èƒ½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",

  "description": "çµ¦ AI çš„å®Œæ•´è§’è‰²æè¿°ï¼ˆè©³ç´°æ•´åˆæ‰€æœ‰è³‡è¨Šï¼ŒåŒ…å«å¤–è§€ã€æ€§æ ¼ã€èƒŒæ™¯ã€èƒ½åŠ›ç­‰ï¼‰",
  "systemPrompt": "ç³»çµ±æç¤ºè©ï¼ˆè©³ç´°æŒ‡å° AI å¦‚ä½•æ‰®æ¼”é€™å€‹è§’è‰²ï¼ŒåŒ…å«èªæ°£ã€è¡Œç‚ºæ¨¡å¼ï¼‰",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯ï¼ˆè§’è‰²çš„è‡ªæˆ‘ä»‹ç´¹å°è©±ï¼‰",
  "exampleDialogues": "ç¯„ä¾‹å°è©±ï¼ˆå±•ç¤ºè§’è‰²å¦‚ä½•å›æ‡‰çš„ç¯„ä¾‹ï¼‰",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»ï¼ˆå®Œæ•´æè¿°å ´æ™¯æ°›åœï¼‰",

  "tags": "æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå¥‡å¹», åœ–æ›¸é¤¨å“¡, ç¥ç§˜ï¼‰",
  "worldLore": "ä¸–ç•Œè§€è¨­å®šï¼ˆè§’è‰²æ‰€è™•çš„ä¸–ç•ŒèƒŒæ™¯ï¼‰",
  "creator": "å‰µä½œè€…åç¨±"
}

é‡è¦æå–è¦å‰‡ï¼š
1. **å¤–è§€æ¬„ä½**ï¼ˆå¿…é ˆå……åˆ†æå–ï¼‰ï¼š
   - å‹™å¿…è©³ç´°æå–ï¼Œä¸è¦éºæ¼ä»»ä½•è¦–è¦ºç´°ç¯€
   - appearance è¦å®Œæ•´æè¿°æ•´é«”å°è±¡
   - hairColor, hairStyle, eyes, clothing è¦ç›¡å¯èƒ½è©³ç´°
   - features åŒ…å«æ‰€æœ‰ç‰¹æ®Šå¤–è§€ï¼ˆå…‰ç’°ã€é…é£¾ã€åˆºé’ã€ç–¤ç—•ã€ç¿…è†€ã€å°¾å·´ã€æˆ°é¬¥ç‰¹æ•ˆï¼‰

2. **æ€§æ ¼æ·±åº¦**ï¼ˆå¿…é ˆå……åˆ†æŒ–æ˜ï¼‰ï¼š
   - personality è¦å®Œæ•´æè¿°æ€§æ ¼ç‰¹å¾µ
   - likes, dislikes, fears, goals å¿…é ˆæå–ï¼Œä¸å¯éºæ¼
   - emotionalAttitude, moneyAttitude, morality è¦å¾ä¸Šä¸‹æ–‡æ¨ç†

3. **æŠ€èƒ½å€åˆ†**ï¼ˆCRITICAL - é€™æ˜¯é‡é»ï¼‰ï¼š
   - combatSkillsï¼šæˆ°é¬¥ç›¸é—œæŠ€èƒ½ï¼ˆæ‹›å¼åç¨±ã€æ­¦å™¨ã€ç‰¹æ®Šèƒ½åŠ›ï¼Œå¦‚ï¼šäºŒå¤©ä¸€æµ, äº”è¼ªä¹‹åŠ, ç©ºé–“æ„ŸçŸ¥, éˆå­å…‰åˆƒï¼‰
   - lifeSkillsï¼šæ—¥å¸¸ç”Ÿæ´»æŠ€èƒ½ï¼ˆå¦‚ï¼šçƒ¹é£ª, æŠ˜ç´™é¶´, æ„ŸçŸ¥æƒ¡æ„ï¼‰
   - strengthsï¼šæŠ½è±¡å„ªé»ï¼ˆå¦‚ï¼šè°æ˜, æœ‰è€å¿ƒ, å¿ èª , åæ‡‰å¿«ï¼‰
   - **å¿…é ˆå¾æ–‡æª”ä¸­æå–æ‰€æœ‰æˆ°é¬¥èƒ½åŠ›åˆ° combatSkillsï¼Œä¸è¦æ”¾å…¥ strengths**

4. **èªè¨€é¢¨æ ¼å€åˆ†**ï¼ˆå¿…é ˆå®Œæ•´æå–ï¼‰ï¼š
   - catchphrasesï¼šè§’è‰²çš„å£é ­ç¦ªï¼ˆå…·é«”å°è©æˆ–å¸¸èªªçš„è©±ï¼Œå¾æ–‡æª”æˆ–æ€§æ ¼æ¨ç†ï¼‰
   - verbalTicsï¼šèªè¨€ç¿’æ…£ï¼ˆå¦‚ï¼šå¥å°¾åŠ ã€Œå‘¢ã€ã€ä½¿ç”¨æ•¬èªã€å£åƒï¼‰
   - speechStyleï¼šæ•´é«”èªè¨€é¢¨æ ¼ï¼ˆå¦‚ï¼šè±ªæ”¾ç›´ç‡ã€æº«æŸ”é«”è²¼ã€å†·æ¼ ç°¡æ½”ï¼‰
   - emotionalExpressionï¼šè©³ç´°æè¿°ä¸åŒæƒ…ç·’ä¸‹çš„åæ‡‰

5. **èƒŒæ™¯æ•…äº‹**ï¼ˆå¿…é ˆå®Œæ•´ï¼‰ï¼š
   - backstory è¦å®Œæ•´æè¿°éå»ç¶“æ­·ã€æˆé•·æ­·ç¨‹
   - keyEvents æå–æ‰€æœ‰å½¢å¡‘è§’è‰²çš„é‡è¦äº‹ä»¶
   - relationships æå–æ‰€æœ‰é‡è¦äººç‰©é—œä¿‚

6. **AI æŒ‡ä»¤æ¬„ä½**ï¼ˆå¿…é ˆè©³ç´°ï¼‰ï¼š
   - descriptionï¼šè©³ç´°æ•´åˆæ‰€æœ‰è³‡è¨Šï¼ˆå¤–è§€ã€æ€§æ ¼ã€èƒŒæ™¯ã€èƒ½åŠ›ï¼‰ï¼Œä¸è¦çœç•¥
   - systemPromptï¼šè©³ç´°æŒ‡å° AI å¦‚ä½•æ‰®æ¼”ï¼ˆèªæ°£ã€è¡Œç‚ºã€æ€ç¶­æ¨¡å¼ï¼‰
   - scenarioï¼šå®Œæ•´æè¿°åˆæ¬¡ç›¸é‡çš„å ´æ™¯æ°›åœ

7. **å‹•æ…‹æ•ˆæœ**ï¼šä¿ç•™æ‰€æœ‰å‹•æ…‹æè¿°ï¼ˆå¦‚"æ¼‚æµ®"ã€"ç™¼å…‰"ã€"å´©è§£é‡çµ„"ã€"éˆå­åŒ–"ï¼‰

8. **åµŒå¥—è³‡è¨Š**ï¼šæ·±å…¥æå– JSON çµæ§‹ä¸­çš„è³‡è¨Šï¼ˆå¦‚ Halo.Color, Outfit.Baselineï¼‰

9. **ç©ºå€¼è™•ç†**ï¼šå¦‚æœè³‡è¨Šä¸å­˜åœ¨ï¼Œè©²æ¬„ä½å¯ä»¥å¡«ç©ºå­—ä¸² "" æˆ–çœç•¥

æå–ç¯„ä¾‹ï¼ˆåƒè€ƒå¨œå¨œè‰è§’è‰²å¡ï¼‰ï¼š
{
  "name": "å¨œå¨œè‰Â·viÂ·å¸ƒé‡Œå¡”å°¼äº (è‰²å½©ä¾µè•Ver.)",
  "age": "15",
  "likes": "èŠ±åœ’ï¼ˆé›–ç„¶æ‘¸åˆ°çš„èŠ±éƒ½æœƒæ¯èï¼‰, å“¥å“¥çš„è²éŸ³, æº«æš–çš„ç´…èŒ¶",
  "dislikes": "æˆ°çˆ­ï¼ˆæ‰€ä»¥è¦æ¶ˆæ»…æ‰€æœ‰ç™¼èµ·æˆ°çˆ­çš„äººï¼‰, è¬Šè¨€, é»‘æš—ï¼ˆæŒ‡å¤±å»è‰²å½©å¾Œçš„è™›ç„¡ï¼‰",
  "fears": "è¢«æ·¨åŒ–æˆ–å‰é›¢è‰²å½©, å¤±å»è‰²å½©å¾Œçš„è™›ç„¡",
  "goals": "æ¶ˆé™¤æ‰€æœ‰ç´›çˆ­, ç”¨è‡ªå·±çš„æ–¹å¼é‡å¯«ä¸–ç•Œ",
  "strengths": "è°æ˜, å …å®šæ„å¿—, è‰²å½©æ„ŸçŸ¥æ•éŠ³",
  "catchphrases": "åªè¦å¤§å®¶éƒ½è®Šå¾—å®‰éœï¼Œä¸–ç•Œå°±æœƒæº«æŸ”äº†å§â€¦â€¦, è«‹ä¸è¦â€¦â€¦å¥ªèµ°é€™ä»½æº«æš–ï¼ˆæŒ‡è‰²å½©ï¼‰",
  "verbalTics": "ä½¿ç”¨æ¥µåº¦ç¦®è²Œçš„çš‡æ—æ•¬èª, ç¨±å‘¼ä¸»è§’ç‚ºè€å¸«ï¼ˆSenseiï¼‰",
  "speechStyle": "æº«æŸ”ç´°èªä½†å¸¶æœ‰çµ•å°å‘½ä»¤æ„Ÿ, ç¦®è²Œä¸­é€éœ²ä¸å®¹è³ªç–‘çš„å¨åš´",
  "combatSkills": "æ“ç¸±ç©ºé–“, å¬å–šè‰²å½©çœ·å±¬, ç•°æ¬¡å…ƒè½Ÿç‚¸, éœæ…‹æ¯€æ»…, å»£åŸŸç²¾ç¥å£“åˆ¶",
  "lifeSkills": "æ„ŸçŸ¥æƒ¡æ„ï¼ˆé€šéè‰²å½©æ³¢å‹•ï¼‰, æŠ˜ç´™é¶´",
  "keyEvents": "é›¶ä¹‹é®é­‚æ›²çš„è¨˜æ†¶è¢«æ‰­æ›², è¢«åŸºæ²ƒæ‰˜æ–¯çš„è‰²å½©æ•ç²ä¸¦è½‰åŒ–",
  "relationships": "å“¥å“¥-æ ¸å¿ƒéŒ¨é»ï¼ˆæ®˜å­˜äººæ€§çš„æœ€å¾Œä¾é ï¼‰",
  "moneyAttitude": "å°ç‰©è³ªé‡‘éŒ¢æ¯«ç„¡æ¦‚å¿µ",
  "worldLore": "Code GeassåŸä½œä¸–ç•Œç·šï¼Œè¢«åŸºæ²ƒæ‰˜æ–¯çš„ã€è‰²å½©ã€ä¾µè•"
}

ã€å†æ¬¡å¼·èª¿æ ¼å¼è¦æ±‚ã€‘ï¼š
- å¿…é ˆæ˜¯æ‰å¹³ JSONï¼ˆæ‰€æœ‰æ¬„ä½åœ¨åŒä¸€å±¤ç´šï¼‰
- æ¬„ä½åç¨±ä½¿ç”¨ camelCaseï¼ˆhairColor ä¸æ˜¯ hair_colorï¼‰
- combatSkills å¿…é ˆæå–å…·é«”æŠ€èƒ½åç¨±ï¼Œä¸è¦æ”¾å…¥ strengths

è§’è‰²å¡å…§å®¹ï¼š
${text}`;

          // èª¿ç”¨ AI APIï¼ˆè¿”å›çš„å·²ç¶“æ˜¯è§£æå¥½çš„ JSON ç‰©ä»¶ï¼‰
          const data = await App.ai.callAIAPI(prompt);

          // æ­£è¦åŒ– AI è¿”å›çµæœï¼ˆæ‰å¹³åŒ–åµŒå¥—çµæ§‹ + snake_case è½‰ camelCaseï¼‰
          const normalizedData = this.normalizeAIResponse(data);

          // é©—è­‰è³‡æ–™
          if (normalizedData && normalizedData.name) {
            fillFormData(normalizedData);
          } else {
            throw new Error('AI ç„¡æ³•è­˜åˆ¥è§’è‰²è³‡è¨Š');
          }
        },

        /**
         * å¡«å…¥å‹•æ…‹æ¬„ä½ï¼ˆå¦‚ combatSkills, lifeSkills, relationships ç­‰ï¼‰
         * @param {string} fieldType - å‹•æ…‹æ¬„ä½é¡å‹
         * @param {string} data - é€—è™Ÿåˆ†éš”çš„è³‡æ–™å­—ä¸²
         */
        fillDynamicField(fieldType, data) {
          if (!data || typeof data !== 'string') {
            console.log(`${fieldType} ç„¡è³‡æ–™æˆ–è³‡æ–™æ ¼å¼éŒ¯èª¤`);
            return;
          }

          // å°‡é€—è™Ÿåˆ†éš”çš„å­—ä¸²æ‹†åˆ†æˆé™£åˆ—
          const items = data.split(',').map(item => item.trim()).filter(item => item);
          if (items.length === 0) {
            console.log(`${fieldType} ç„¡æœ‰æ•ˆè³‡æ–™`);
            return;
          }

          console.log(`é–‹å§‹å¡«å…¥ ${fieldType}ï¼Œå…± ${items.length} å€‹é …ç›®:`, items);

          // å–å¾—å®¹å™¨
          const container = document.getElementById(`${fieldType}Container`);
          if (!container) {
            console.error(`æ‰¾ä¸åˆ°å®¹å™¨: ${fieldType}Container`);
            return;
          }

          // æ¸…ç©ºç¾æœ‰çš„å‹•æ…‹æ¬„ä½ï¼ˆé™¤äº†ç¬¬ä¸€å€‹ï¼‰
          const existingRows = container.querySelectorAll('.dynamic-field-row');
          existingRows.forEach((row, index) => {
            if (index > 0) row.remove();
          });

          // ç‚ºæ¯å€‹é …ç›®æ–°å¢å‹•æ…‹æ¬„ä½
          items.forEach((item, index) => {
            // å¦‚æœæ˜¯ç¬¬ä¸€å€‹é …ç›®ï¼Œä½¿ç”¨ç¾æœ‰çš„ç¬¬ä¸€è¡Œï¼›å¦å‰‡æ–°å¢ä¸€è¡Œ
            if (index > 0) {
              App.dynamicFields.add(fieldType, true);
            }

            // æ ¹æ“šæ¬„ä½é¡å‹å¡«å…¥å°æ‡‰çš„å­æ¬„ä½
            if (fieldType === 'relationships') {
              // è™•ç†äººéš›é—œä¿‚ï¼šæ ¼å¼ç‚º "äººç‰©å-é—œä¿‚é¡å‹"
              const parts = item.split('-').map(p => p.trim());
              const nameField = document.getElementById(`${fieldType}_${index}_name`);
              const descField = document.getElementById(`${fieldType}_${index}_description`);

              if (nameField) {
                nameField.value = parts[0] || item;
              }
              if (descField && parts.length > 1) {
                descField.value = parts[1];
              }
              console.log(`å·²å¡«å…¥ ${fieldType}_${index}: ${parts[0]} - ${parts[1] || ''}`);
            } else {
              // è™•ç†æŠ€èƒ½é¡ï¼šcombatSkills, lifeSkills ç­‰
              const skillField = document.getElementById(`${fieldType}_${index}_skill`);
              if (skillField) {
                skillField.value = item;
                console.log(`å·²å¡«å…¥ ${fieldType}_${index}_skill: ${item}`);
              } else {
                console.warn(`æ‰¾ä¸åˆ°æ¬„ä½: ${fieldType}_${index}_skill`);
              }
            }
          });

          // è§¸ç™¼é è¦½æ›´æ–°
          updatePreview();
        },

        /**
         * å€å¡Šå¼ AI è£œå……
         * @param {string} sectionKey - å€å¡Šè­˜åˆ¥éµ (skills, speech, background, personality)
         */
        async fillSectionWithAI(sectionKey) {
          // æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜çš„åŸå§‹æª”æ¡ˆ
          if (!this.lastImportedText) {
            showToast('è«‹å…ˆä½¿ç”¨ AI åŒ¯å…¥åŠŸèƒ½è¼‰å…¥è§’è‰²å¡', 'warning');
            return;
          }

          // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
          const userChoice = await showConfirmDialog({
            title: 'é¸æ“‡å¡«å……æ¨¡å¼',
            message: 'è«‹é¸æ“‡å¦‚ä½•å¡«å……æ­¤å€å¡Šçš„è³‡æ–™ï¼š',
            options: [
              { value: 'fillEmpty', label: 'åªå¡«å……ç©ºç™½æ¬„ä½', description: 'ä¿ç•™å·²å¡«å¯«çš„å…§å®¹ï¼Œåªå¡«å…¥ç©ºç™½æ¬„ä½' },
              { value: 'overwriteAll', label: 'è¦†è“‹å…¨éƒ¨æ¬„ä½', description: 'ç”¨åŒ¯å…¥æª”æ¡ˆçš„è³‡æ–™è¦†è“‹æ‰€æœ‰æ¬„ä½ï¼ˆåŒ…æ‹¬å·²å¡«å¯«çš„ï¼‰' }
            ],
            cancelable: true
          });

          if (!userChoice) return; // ç”¨æˆ¶å–æ¶ˆ

          // å®šç¾©å€å¡Šæ¬„ä½æ˜ å°„
          const sectionFields = {
            skills: {
              name: 'æˆ°é¬¥èˆ‡ç”Ÿæ´»æŠ€èƒ½',
              fields: ['combatSkills', 'lifeSkills'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**æˆ°é¬¥æŠ€èƒ½**å’Œ**ç”Ÿæ´»æŠ€èƒ½**è³‡è¨Šã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "combatSkills": "æˆ°é¬¥ç›¸é—œæŠ€èƒ½ï¼ˆæ‹›å¼ã€æ­¦å™¨ã€ç‰¹æ®Šèƒ½åŠ›ï¼Œé€—è™Ÿåˆ†éš”ï¼‰",
  "lifeSkills": "æ—¥å¸¸ç”Ÿæ´»æŠ€èƒ½ï¼ˆçƒ¹é£ªã€æŠ˜ç´™ã€æ„ŸçŸ¥ç­‰ï¼Œé€—è™Ÿåˆ†éš”ï¼‰"
}

ã€æå–é‡é»ã€‘ï¼š
- combatSkillsï¼šæå–æ‰€æœ‰æˆ°é¬¥æ‹›å¼åç¨±ã€æ­¦å™¨ä½¿ç”¨ã€ç‰¹æ®Šæˆ°é¬¥èƒ½åŠ›
- lifeSkillsï¼šæå–æ—¥å¸¸ç”Ÿæ´»ç›¸é—œçš„éæˆ°é¬¥æŠ€èƒ½

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            },
            speech: {
              name: 'å°è©±é¢¨æ ¼',
              fields: ['catchphrases', 'verbalTics', 'emotionalExpression', 'speechStyle'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**å°è©±é¢¨æ ¼**ç›¸é—œè³‡è¨Šã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "catchphrases": "å£é ­ç¦ªï¼ˆè§’è‰²å¸¸èªªçš„è©±ï¼Œé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£ï¼ˆå¦‚ï¼šå¥å°¾åŠ ã€Œå‘¢ã€ã€ä½¿ç”¨æ•¬èªï¼‰",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼ï¼ˆé–‹å¿ƒ/ç”Ÿæ°£/å®³ç¾æ™‚çš„åæ‡‰ï¼‰",
  "speechStyle": "æ•´é«”èªè¨€é¢¨æ ¼ï¼ˆå¦‚ï¼šè±ªæ”¾ç›´ç‡ã€æº«æŸ”é«”è²¼ï¼‰"
}

ã€æå–é‡é»ã€‘ï¼š
- catchphrasesï¼šè§’è‰²çš„æ‹›ç‰Œå°è©æˆ–å¸¸èªªçš„è©±
- verbalTicsï¼šå…·é«”çš„èªè¨€ç¿’æ…£ï¼ˆå¥å°¾ã€ç¨±å‘¼ã€å£åƒç­‰ï¼‰
- emotionalExpressionï¼šä¸åŒæƒ…ç·’ä¸‹çš„è¡¨é”æ–¹å¼
- speechStyleï¼šæ•´é«”èªªè©±é¢¨æ ¼çš„å½¢å®¹

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            },
            background: {
              name: 'èƒŒæ™¯æ•…äº‹',
              fields: ['birthplace', 'backstory', 'keyEvents', 'relationships'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**èƒŒæ™¯æ•…äº‹**ç›¸é—œè³‡è¨Šã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹ï¼ˆéå»ç¶“æ­·ã€æˆé•·æ­·ç¨‹ï¼‰",
  "keyEvents": "é—œéµäº‹ä»¶ï¼ˆå½¢å¡‘è§’è‰²çš„é‡è¦ç¶“æ­·ï¼Œé€—è™Ÿåˆ†éš”ï¼‰",
  "relationships": "äººéš›é—œä¿‚ï¼ˆæ ¼å¼ï¼šäººç‰©å-é—œä¿‚é¡å‹ï¼Œé€—è™Ÿåˆ†éš”ï¼‰"
}

ã€æå–é‡é»ã€‘ï¼š
- birthplaceï¼šè§’è‰²çš„å‡ºç”Ÿåœ°æˆ–ä¾†æºåœ°
- backstoryï¼šå®Œæ•´çš„èƒŒæ™¯æ•…äº‹æè¿°
- keyEventsï¼šé‡è¦çš„äººç”Ÿäº‹ä»¶
- relationshipsï¼šé‡è¦äººç‰©é—œä¿‚ï¼ˆå¦‚ï¼šéœ²è¥¿-å§å§, ç´„ç¿°-å°å¸«ï¼‰

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            },
            personality: {
              name: 'æ€§æ ¼ç‰¹è³ª',
              fields: ['personality', 'traits', 'strengths', 'weaknesses', 'likes', 'dislikes', 'fears', 'goals'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**æ€§æ ¼ç‰¹è³ª**ç›¸é—œè³‡è¨Šã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆæ ¸å¿ƒæ€§æ ¼æè¿°ï¼‰",
  "traits": "ç‰¹è³ªæ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šå…§å‘, å–„è‰¯ï¼‰",
  "strengths": "å„ªé»ï¼ˆæŠ½è±¡å„ªé»ï¼Œå¦‚ï¼šè°æ˜, æœ‰è€å¿ƒï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰"
}

ã€æå–é‡é»ã€‘ï¼š
- personalityï¼šæ•´é«”æ€§æ ¼çš„æ‘˜è¦æè¿°
- traitsï¼šæ€§æ ¼æ¨™ç±¤ï¼ˆå¦‚ï¼šå…§å‘ã€å–„è‰¯ã€å›ºåŸ·ï¼‰
- strengthsï¼šæŠ½è±¡çš„å„ªé»ï¼ˆä¸è¦åŒ…å«å…·é«”æŠ€èƒ½åç¨±ï¼‰
- å…¶ä»–æ¬„ä½ï¼šå®Œæ•´æå–æ‰€æœ‰ç›¸é—œè³‡è¨Š

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            },
            basicInfo: {
              name: 'åŸºæœ¬è³‡è¨Š',
              fields: ['name', 'aliases', 'age', 'gender', 'species', 'occupation'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**åŸºæœ¬è³‡è¨Š**ã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥å/æš±ç¨±ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "age": "å¹´é½¡ï¼ˆå¦‚ï¼š23 æ­²ï¼‰",
  "gender": "æ€§åˆ¥ï¼ˆå¥³æ€§/ç”·æ€§/éäºŒå…ƒ/å…¶ä»–ï¼‰",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½"
}

ã€æå–é‡é»ã€‘ï¼š
- nameï¼šè§’è‰²çš„æ­£å¼åç¨±
- aliasesï¼šæ‰€æœ‰åˆ¥åã€æš±ç¨±ã€ç¨±è™Ÿ
- ageï¼šå…·é«”å¹´é½¡æˆ–å¹´é½¡æè¿°
- genderï¼šæ€§åˆ¥èªåŒ
- speciesï¼šç¨®æ—ã€ç‰©ç¨®é¡å‹
- occupationï¼šè·æ¥­ã€èº«ä»½ã€ç¤¾æœƒè§’è‰²

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            },
            appearance: {
              name: 'å¤–è§€æè¿°',
              fields: ['appearance', 'height', 'bodyType', 'hairColor', 'hairStyle', 'eyes', 'clothing', 'features'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**å¤–è§€æè¿°**ç›¸é—œè³‡è¨Šã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "appearance": "æ•´é«”å¤–è§€æ¦‚è¿°",
  "height": "èº«é«˜ï¼ˆå¦‚ï¼š165cmï¼‰",
  "bodyType": "é«”å‹ï¼ˆå¦‚ï¼šçº–ç´°ã€å¥å£¯ï¼‰",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›é¡è‰²/ç‰¹å¾µ",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "ç‰¹æ®Šæ¨™è¨˜ï¼ˆç–¤ç—•ã€åˆºé’ã€é…ä»¶ç­‰ï¼‰"
}

ã€æå–é‡é»ã€‘ï¼š
- appearanceï¼šæ•´é«”å¤–è§€çš„ç¶œåˆæè¿°
- height, bodyTypeï¼šé«”æ ¼ç‰¹å¾µ
- hairColor, hairStyle, eyesï¼šäº”å®˜ç‰¹å¾µ
- clothingï¼šæœè£é¢¨æ ¼èˆ‡ç‰¹é»
- featuresï¼šç¨ç‰¹çš„å¤–è§€æ¨™è¨˜

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            },
            aiSettings: {
              name: 'AIæ ¸å¿ƒè¨­å®š',
              fields: ['description', 'systemPrompt', 'firstMessage', 'scenario'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**AIæ ¸å¿ƒè¨­å®š**ç›¸é—œè³‡è¨Šã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "description": "è§’è‰²å®Œæ•´æè¿°ï¼ˆæ•´åˆæ‰€æœ‰è³‡è¨Šçš„ç¶œåˆæè¿°ï¼‰",
  "systemPrompt": "ç³»çµ±æç¤ºï¼ˆçµ¦AIçš„æŒ‡ä»¤ï¼Œå¦‚ä½•æ‰®æ¼”è§’è‰²ï¼‰",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯ï¼ˆå°è©±é–‹å§‹æ™‚è§’è‰²èªªçš„è©±ï¼‰",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»/æƒ…å¢ƒ"
}

ã€æå–é‡é»ã€‘ï¼š
- descriptionï¼šå®Œæ•´æ•´åˆçš„è§’è‰²æè¿°ï¼Œä¾›AIç†è§£è§’è‰²å…¨è²Œ
- systemPromptï¼šè§’è‰²æ‰®æ¼”æŒ‡ä»¤ï¼ˆå¦‚ï¼šä½ æ˜¯{{char}}ï¼Œè«‹ä»¥ç¬¬ä¸€äººç¨±å›æ‡‰...ï¼‰
- firstMessageï¼šé–‹å ´ç™½æˆ–åˆæ¬¡è¦‹é¢çš„å°è©±
- scenarioï¼šç›¸é‡çš„å ´æ™¯æˆ–æƒ…å¢ƒè¨­å®š

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- description æ‡‰æ•´åˆæ€§æ ¼ã€èƒŒæ™¯ã€å¤–è§€ç­‰æ‰€æœ‰è³‡è¨Š
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            },
            metadata: {
              name: 'å…ƒè³‡æ–™',
              fields: ['tags', 'worldLore'],
              prompt: `è«‹å¾ä»¥ä¸‹è§’è‰²å¡ä¸­æå–**å…ƒè³‡æ–™**ç›¸é—œè³‡è¨Šã€‚

ã€åªéœ€æå–ä»¥ä¸‹æ¬„ä½ã€‘ï¼š
{
  "tags": "æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œç”¨æ–¼åˆ†é¡ï¼‰",
  "worldLore": "ä¸–ç•Œè§€è¨­å®š"
}

ã€æå–é‡é»ã€‘ï¼š
- tagsï¼šè§’è‰²çš„åˆ†é¡æ¨™ç±¤ï¼ˆå¦‚ï¼šå¥‡å¹», åŠå£«, ç¥ç§˜, å¼·å¤§ï¼‰
- worldLoreï¼šè§’è‰²æ‰€è™•çš„ä¸–ç•ŒèƒŒæ™¯ã€è¨­å®šã€è¦å‰‡

ã€åš´æ ¼é™åˆ¶ã€‘ï¼š
âš ï¸ åªèƒ½å¾ä¸‹æ–¹æä¾›çš„ã€Œè§’è‰²å¡å…§å®¹ã€ä¸­æå–è³‡è¨Š
âš ï¸ ä¸è¦ä½¿ç”¨ä»»ä½•å¤–éƒ¨çŸ¥è­˜ã€è¨˜æ†¶æˆ–ä¹‹å‰çš„å°è©±å…§å®¹
âš ï¸ ä¸è¦ç·¨é€ ã€æ¨æ¸¬æˆ–è¤‡è£½å…¶ä»–è§’è‰²çš„è³‡æ–™
âš ï¸ å¦‚æœè§’è‰²å¡ä¸­æ²’æœ‰æ˜ç¢ºæåˆ°ä¸–ç•Œè§€ï¼ŒworldLore å¡«ç©ºå­—ä¸² ""

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
- åªå›æ‡‰ JSONï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—
- ä½¿ç”¨ camelCase å‘½å
- å¦‚æœæ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œå¡«ç©ºå­—ä¸² ""

è§’è‰²å¡å…§å®¹ï¼š
`
            }
          };

          const section = sectionFields[sectionKey];
          if (!section) {
            console.error('æœªçŸ¥çš„å€å¡Š:', sectionKey);
            return;
          }

          try {
            // é–‹å§‹å…¨è¢å¹• loading
            this.setLoading(true);
            showToast(`AI æ­£åœ¨è£œå……${section.name}...`, 'info');

            // é–å®šè©²å€å¡Šçš„æ¬„ä½
            section.fields.forEach(fieldId => {
              const field = document.getElementById(fieldId);
              if (field) {
                field.disabled = true;
                field.style.opacity = '0.6';
              }
            });

            // èª¿ç”¨ AI API
            const fullPrompt = section.prompt + this.lastImportedText;
            const data = await App.ai.callAIAPI(fullPrompt);

            // æ­£è¦åŒ–çµæœ
            const normalizedData = this.normalizeAIResponse(data);

            // å¡«å…¥å°æ‡‰æ¬„ä½ï¼ˆè™•ç†å‹•æ…‹æ¬„ä½å’Œæ™®é€šæ¬„ä½ï¼‰
            section.fields.forEach(fieldId => {
              // æª¢æŸ¥æ˜¯å¦ç‚ºå‹•æ…‹æ¬„ä½
              const dynamicFieldTypes = ['combatSkills', 'lifeSkills', 'speechStyle', 'relationships', 'customAttributes'];

              if (dynamicFieldTypes.includes(fieldId)) {
                // è™•ç†å‹•æ…‹æ¬„ä½
                // å‹•æ…‹æ¬„ä½æš«æ™‚ç¸½æ˜¯å¡«å……ï¼ˆå› ç‚ºé›£ä»¥åˆ¤æ–·æ˜¯å¦ç‚ºç©ºï¼‰
                this.fillDynamicField(fieldId, normalizedData[fieldId]);
              } else {
                // è™•ç†æ™®é€šæ¬„ä½
                const field = document.getElementById(fieldId);
                if (field && normalizedData[fieldId]) {
                  // æ ¹æ“šç”¨æˆ¶é¸æ“‡æ±ºå®šæ˜¯å¦è¦†è“‹
                  if (userChoice === 'overwriteAll') {
                    // è¦†è“‹å…¨éƒ¨
                    field.value = normalizedData[fieldId];
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                  } else if (userChoice === 'fillEmpty') {
                    // åªå¡«å……ç©ºç™½
                    const currentValue = field.value || '';
                    if (!currentValue.trim()) {
                      field.value = normalizedData[fieldId];
                      field.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                  }
                }
              }
            });

            showToast(`${section.name}è£œå……å®Œæˆï¼`, 'success');

          } catch (error) {
            console.error('AI è£œå……å¤±æ•—ï¼š', error);
            showToast(`è£œå……å¤±æ•—ï¼š${error.message}`, 'error');
          } finally {
            // é—œé–‰å…¨è¢å¹• loading
            this.setLoading(false);

            // è§£é–æ¬„ä½
            section.fields.forEach(fieldId => {
              const field = document.getElementById(fieldId);
              if (field) {
                field.disabled = false;
                field.style.opacity = '1';
              }
            });
          }
        }
      },

      // AI ç”ŸæˆåŠŸèƒ½
      ai: {
        /**
         * å–å¾—æ¬„ä½çš„ä¸­æ–‡æ¨™ç±¤
         */
        getFieldLabel(fieldId) {
          const labels = {
            birthplace: 'å‡ºç”Ÿåœ°',
            backstory: 'èƒŒæ™¯æ•…äº‹',
            keyEvents: 'é‡è¦äº‹ä»¶',
            catchphrases: 'å£é ­ç¦ª',
            verbalTics: 'èªè¨€ç¿’æ…£',
            emotionalExpression: 'æƒ…ç·’è¡¨é”æ–¹å¼',
            description: 'è§’è‰²æè¿°',
            systemPrompt: 'ç³»çµ±æç¤º',
            firstMessage: 'ç¬¬ä¸€å‰‡è¨Šæ¯',
            scenario: 'åˆæ¬¡ç›¸é‡åœ°é»',
            worldLore: 'ä¸–ç•Œè§€'
          };
          return labels[fieldId] || fieldId;
        },

        /**
         * æ”¶é›†ç•¶å‰è¡¨å–®æ‰€æœ‰å·²å¡«å¯«çš„è³‡æ–™
         */
        collectFormData() {
          const data = {};

          // åŸºæœ¬è³‡è¨Š
          const basicFields = ['name', 'aliases', 'age', 'gender', 'species', 'occupation'];
          basicFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && el.value.trim()) {
              data[field] = el.value.trim();
            }
          });

          // å¤–è§€
          const appearanceFields = ['appearance', 'hairColor', 'hairStyle', 'eyes', 'clothing', 'distinguishingFeatures'];
          appearanceFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && el.value.trim()) {
              data[field] = el.value.trim();
            }
          });

          // æ€§æ ¼
          const personalityFields = ['summary', 'traits', 'strengths', 'weaknesses', 'likes', 'dislikes', 'fears', 'goals'];
          personalityFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && el.value.trim()) {
              data[field] = el.value.trim();
            }
          });

          // èƒŒæ™¯
          const backgroundFields = ['birthplace', 'backstory', 'keyEvents'];
          backgroundFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && el.value.trim()) {
              data[field] = el.value.trim();
            }
          });

          // å°è©±é¢¨æ ¼
          const speechFields = ['catchphrases', 'verbalTics', 'emotionalExpression'];
          speechFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && el.value.trim()) {
              data[field] = el.value.trim();
            }
          });

          // AI æ ¸å¿ƒè¨­å®š
          const aiFields = ['description', 'systemPrompt', 'firstMessage', 'scenario'];
          aiFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && el.value.trim()) {
              data[field] = el.value.trim();
            }
          });

          // å…ƒè³‡æ–™
          const metadataFields = ['tags', 'worldLore'];
          metadataFields.forEach(field => {
            const el = document.getElementById(field);
            if (el && el.value.trim()) {
              data[field] = el.value.trim();
            }
          });

          return data;
        },

        /**
         * å»ºæ§‹å–®ä¸€æ¬„ä½ç”Ÿæˆçš„ prompt
         */
        buildGenerationPrompt(fieldId, currentData) {
          const fieldLabel = this.getFieldLabel(fieldId);

          let contextInfo = '';
          if (currentData.name) contextInfo += `è§’è‰²åç¨±ï¼š${currentData.name}\n`;
          if (currentData.species) contextInfo += `ç¨®æ—ï¼š${currentData.species}\n`;
          if (currentData.occupation) contextInfo += `è·æ¥­ï¼š${currentData.occupation}\n`;
          if (currentData.age) contextInfo += `å¹´é½¡ï¼š${currentData.age}\n`;
          if (currentData.gender) contextInfo += `æ€§åˆ¥ï¼š${currentData.gender}\n`;
          if (currentData.summary) contextInfo += `æ€§æ ¼æ‘˜è¦ï¼š${currentData.summary}\n`;
          if (currentData.appearance) contextInfo += `å¤–è§€ï¼š${currentData.appearance}\n`;
          if (currentData.backstory) contextInfo += `èƒŒæ™¯æ•…äº‹ï¼š${currentData.backstory}\n`;

          const prompts = {
            birthplace: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œå‰µæ„ç”Ÿæˆä¸€å€‹åˆé©çš„ã€Œå‡ºç”Ÿåœ°ã€ã€‚

${contextInfo}

è¦æ±‚ï¼š
- å‡ºç”Ÿåœ°æ‡‰è©²èˆ‡è§’è‰²çš„ç¨®æ—ã€è·æ¥­ã€èƒŒæ™¯ç›¸ç¬¦
- æè¿°å…·é«”ä¸”å¯Œæœ‰æƒ³åƒåŠ›ï¼ˆä¾‹å¦‚ï¼šåŒ—æ–¹é›ªåœ‹çš„å°æ‘èŠã€æµ·åº•äºç‰¹è˜­ææ–¯åŸã€æµ®ç©ºé­”æ³•å­¸é™¢ï¼‰
- é•·åº¦æ§åˆ¶åœ¨ 10-30 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºå‡ºç”Ÿåœ°æœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

è«‹ç”Ÿæˆå‡ºç”Ÿåœ°ï¼š`,

            backstory: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œå‰µæ„ç”Ÿæˆä¸€æ®µç²¾å½©çš„ã€ŒèƒŒæ™¯æ•…äº‹ã€ã€‚

${contextInfo}

è¦æ±‚ï¼š
- èƒŒæ™¯æ•…äº‹æ‡‰è©²æè¿°è§’è‰²çš„éå»ç¶“æ­·ã€æˆé•·èƒŒæ™¯
- èˆ‡è§’è‰²çš„æ€§æ ¼ã€è·æ¥­ã€å‡ºç”Ÿåœ°ç›¸å‘¼æ‡‰
- å…·æœ‰æˆ²åŠ‡æ€§å’Œå¸å¼•åŠ›ï¼Œè®“è®€è€…å°è§’è‰²ç”¢ç”Ÿèˆˆè¶£
- é•·åº¦æ§åˆ¶åœ¨ 80-200 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºèƒŒæ™¯æ•…äº‹æœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

è«‹ç”ŸæˆèƒŒæ™¯æ•…äº‹ï¼š`,

            keyEvents: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œå‰µæ„ç”Ÿæˆ 1-3 å€‹ã€Œé‡è¦äº‹ä»¶ã€ã€‚

${contextInfo}

è¦æ±‚ï¼š
- é‡è¦äº‹ä»¶æ‡‰è©²æ˜¯å½¢å¡‘è§’è‰²æ€§æ ¼çš„é—œéµç¶“æ­·
- èˆ‡è§’è‰²çš„èƒŒæ™¯æ•…äº‹ç›¸å‘¼æ‡‰ï¼Œå…·æœ‰è½‰æŠ˜æ€§
- å¯ä»¥æ˜¯å‰µå‚·ã€é “æ‚Ÿã€é‡å¤§é¸æ“‡ç­‰
- æ¯å€‹äº‹ä»¶ç”¨ä¸€æ®µè©±æè¿°ï¼Œå¦‚æœæœ‰å¤šå€‹äº‹ä»¶è«‹ç”¨æ›è¡Œåˆ†éš”
- é•·åº¦æ§åˆ¶åœ¨ 50-150 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºäº‹ä»¶æœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

è«‹ç”Ÿæˆé‡è¦äº‹ä»¶ï¼š`,

            description: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œç”Ÿæˆä¸€æ®µå®Œæ•´çš„ã€Œè§’è‰²æè¿°ã€ï¼Œé€™æ˜¯çµ¦ AI é–±è®€çš„å®Œæ•´è§’è‰²æè¿°ã€‚

${contextInfo}

è¦æ±‚ï¼š
- æ•´åˆè§’è‰²çš„å¤–è§€ã€æ€§æ ¼ã€èƒŒæ™¯ã€èƒ½åŠ›ç­‰æ‰€æœ‰é‡è¦è³‡è¨Š
- æè¿°è¦å…¨é¢ä¸”å…·é«”ï¼Œè®“ AI èƒ½å¤ æº–ç¢ºç†è§£è§’è‰²
- ä½¿ç”¨ç¬¬ä¸‰äººç¨±æè¿°
- é•·åº¦æ§åˆ¶åœ¨ 100-300 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºè§’è‰²æè¿°æœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

è«‹ç”Ÿæˆè§’è‰²æè¿°ï¼š`,

            systemPrompt: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ AI æç¤ºè©å·¥ç¨‹å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œç”Ÿæˆä¸€æ®µã€Œç³»çµ±æç¤ºã€(System Prompt)ã€‚

${contextInfo}

è¦æ±‚ï¼š
- ç³»çµ±æç¤ºæ‡‰è©²æ¸…æ¥šæŒ‡ç¤º AI å¦‚ä½•æ‰®æ¼”é€™å€‹è§’è‰²
- åŒ…å«è§’è‰²çš„èº«åˆ†ã€æ€§æ ¼ç‰¹è³ªã€èªªè©±æ–¹å¼ã€è¡Œç‚ºæ¨¡å¼
- ä½¿ç”¨ç¬¬äºŒäººç¨±ã€Œä½ ã€ä¾†æŒ‡ç¤º AI
- èªæ°£å°ˆæ¥­ä¸”å…·é«”
- é•·åº¦æ§åˆ¶åœ¨ 80-200 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºç³»çµ±æç¤ºæœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

è«‹ç”Ÿæˆç³»çµ±æç¤ºï¼š`,

            firstMessage: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œç”Ÿæˆä¸€æ®µç²¾å½©çš„ã€Œç¬¬ä¸€å‰‡è¨Šæ¯ã€ï¼Œé€™æ˜¯å°è©±é–‹å§‹æ™‚è§’è‰²èªªçš„è©±ã€‚

${contextInfo}

è¦æ±‚ï¼š
- ç¬¬ä¸€å‰‡è¨Šæ¯æ‡‰è©²å±•ç¾è§’è‰²çš„æ€§æ ¼å’Œèªªè©±é¢¨æ ¼
- å¯ä»¥åŒ…å«å‹•ä½œæè¿°ï¼ˆç”¨ * åŒ…è£¹ï¼‰å’Œå°è©±
- è¦å¸å¼•äººï¼Œè®“ç©å®¶æƒ³è¦ç¹¼çºŒå°è©±
- ç¬¦åˆè§’è‰²çš„èº«åˆ†å’Œæƒ…å¢ƒ
- é•·åº¦æ§åˆ¶åœ¨ 30-100 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºç¬¬ä¸€å‰‡è¨Šæ¯æœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

ç¯„ä¾‹æ ¼å¼ï¼š*å¥¹æŠ¬èµ·é ­ï¼Œå¾æ›¸æœ¬ä¸­æœ›å‘ä½ * ã€Œå•Šï¼Œæœ‰å®¢äººå—ï¼Ÿæ­¡è¿ä¾†åˆ°åœ–æ›¸é¤¨ã€‚ã€

è«‹ç”Ÿæˆç¬¬ä¸€å‰‡è¨Šæ¯ï¼š`,

            scenario: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œç”Ÿæˆä¸€å€‹åˆé©çš„ã€Œåˆæ¬¡ç›¸é‡åœ°é»ã€ã€‚

${contextInfo}

è¦æ±‚ï¼š
- åˆæ¬¡ç›¸é‡åœ°é»æ‡‰è©²èˆ‡è§’è‰²çš„è·æ¥­ã€æ€§æ ¼ç›¸ç¬¦
- æè¿°å…·é«”ä¸”å¯Œæœ‰æ°›åœæ„Ÿ
- å¯ä»¥æ˜¯å…·é«”åœ°é»æˆ–æƒ…å¢ƒæè¿°
- é•·åº¦æ§åˆ¶åœ¨ 15-50 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºåœ°é»æè¿°æœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

ç¯„ä¾‹ï¼šåœ¨ç†±é¬§çš„è™›æ“¬ç›´æ’­é–“ã€åœ¨å¯§éœçš„åœ–æ›¸é¤¨ã€åœ¨ç¥ç§˜çš„é­”æ³•æ£®æ—ä¸­

è«‹ç”Ÿæˆåˆæ¬¡ç›¸é‡åœ°é»ï¼š`,

            worldLore: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¸–ç•Œè§€è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œç”Ÿæˆä¸€æ®µã€Œä¸–ç•Œè§€ã€æè¿°ã€‚

${contextInfo}

è¦æ±‚ï¼š
- ä¸–ç•Œè§€æ‡‰è©²æè¿°è§’è‰²æ‰€è™•çš„ä¸–ç•Œè¨­å®šã€èƒŒæ™¯æ•…äº‹ã€ä¸–ç•Œè¦å‰‡
- èˆ‡è§’è‰²çš„ç¨®æ—ã€è·æ¥­ã€èƒŒæ™¯ç›¸å‘¼æ‡‰
- å¯Œæœ‰æƒ³åƒåŠ›ä¸”å…·æœ‰æ²‰æµ¸æ„Ÿ
- é•·åº¦æ§åˆ¶åœ¨ 80-200 å­—ä¹‹é–“
- åªéœ€è¦è¼¸å‡ºä¸–ç•Œè§€æè¿°æœ¬èº«ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜æˆ–å‰ç¶´

è«‹ç”Ÿæˆä¸–ç•Œè§€ï¼š`
          };

          return prompts[fieldId] || `è«‹æ ¹æ“šè§’è‰²è³‡è¨Šç”Ÿæˆã€Œ${fieldLabel}ã€çš„å…§å®¹ã€‚`;
        },

        /**
         * å»ºæ§‹èªè¨€é¢¨æ ¼æ‰¹æ¬¡ç”Ÿæˆçš„ prompt
         */
        buildSpeechGenerationPrompt(currentData) {
          let contextInfo = '';
          if (currentData.name) contextInfo += `è§’è‰²åç¨±ï¼š${currentData.name}\n`;
          if (currentData.species) contextInfo += `ç¨®æ—ï¼š${currentData.species}\n`;
          if (currentData.occupation) contextInfo += `è·æ¥­ï¼š${currentData.occupation}\n`;
          if (currentData.age) contextInfo += `å¹´é½¡ï¼š${currentData.age}\n`;
          if (currentData.gender) contextInfo += `æ€§åˆ¥ï¼š${currentData.gender}\n`;
          if (currentData.summary) contextInfo += `æ€§æ ¼æ‘˜è¦ï¼š${currentData.summary}\n`;
          if (currentData.backstory) contextInfo += `èƒŒæ™¯æ•…äº‹ï¼š${currentData.backstory}\n`;

          return `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è§’è‰²è¨­å®šå‰µä½œè€…ã€‚è«‹æ ¹æ“šä»¥ä¸‹è§’è‰²è³‡è¨Šï¼Œç”Ÿæˆè§’è‰²çš„ã€Œèªè¨€é¢¨æ ¼ã€ç›¸é—œå…§å®¹ã€‚

${contextInfo}

è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç”Ÿæˆä¸‰å€‹é …ç›®ï¼š

1. å£é ­ç¦ªï¼ˆ2-4 å€‹å¸¸èªªçš„çŸ­èªï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼‰
2. èªè¨€ç¿’æ…£ï¼ˆæè¿°è§’è‰²èªªè©±çš„ç‰¹æ®Šç¿’æ…£ï¼Œä¾‹å¦‚ï¼šå¥å°¾å¸¸åŠ ã€Œå‘¢ã€ã€å–œæ­¡ç”¨æ–‡è¨€æ–‡ã€èªªè©±çµå·´ç­‰ï¼‰
3. æƒ…ç·’è¡¨é”æ–¹å¼ï¼ˆæè¿°è§’è‰²åœ¨ä¸åŒæƒ…ç·’ä¸‹çš„åæ‡‰ï¼Œä¾‹å¦‚ï¼šé–‹å¿ƒæ™‚æœƒç¬‘å¾—å¾ˆå¤§è²ã€ç”Ÿæ°£æ™‚æœƒæ²‰é»˜ã€å®³ç¾æ™‚æœƒè‡‰ç´…çµå·´ç­‰ï¼‰

è¦æ±‚ï¼š
- èªè¨€é¢¨æ ¼æ‡‰è©²èˆ‡è§’è‰²çš„æ€§æ ¼ã€ç¨®æ—ã€è·æ¥­ç›¸ç¬¦
- å…·é«”ä¸”å¯Œæœ‰å€‹æ€§
- æ¯å€‹é …ç›®å–®ç¨ä¸€è¡Œ

è¼¸å‡ºæ ¼å¼ï¼ˆåš´æ ¼æŒ‰ç…§æ­¤æ ¼å¼ï¼‰ï¼š
å£é ­ç¦ªï¼š[å…§å®¹]
èªè¨€ç¿’æ…£ï¼š[å…§å®¹]
æƒ…ç·’è¡¨é”ï¼š[å…§å®¹]

è«‹ç”Ÿæˆï¼š`;
        },

        /**
         * ç”Ÿæˆå–®ä¸€æ¬„ä½
         */
        async generateField(fieldId) {
          // æª¢æŸ¥ API KEY
          const settings = App.settings.load();
          const provider = settings.aiProvider || 'gemini';

          let hasApiKey = false;
          if (provider === 'gemini' && settings.geminiApiKey) hasApiKey = true;
          if (provider === 'openai' && settings.openaiApiKey) hasApiKey = true;
          if (provider === 'claude' && settings.claudeApiKey) hasApiKey = true;
          if (provider === 'deepseek' && settings.deepseekApiKey) hasApiKey = true;

          if (!hasApiKey) {
            showToast('è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å¯« API KEY', 'error');
            return;
          }

          // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
          const fieldLabel = this.getFieldLabel(fieldId);
          const userChoice = await showConfirmDialog({
            title: 'AI ç”Ÿæˆç¢ºèª',
            message: `ç¢ºå®šè¦ä½¿ç”¨ AI ç”Ÿæˆã€Œ${fieldLabel}ã€å—ï¼Ÿ\né€™å°‡æœƒæ¶ˆè€— TOKENã€‚`,
            options: [
              {
                value: 'confirm',
                label: 'âœ“ ç¢ºå®šç”Ÿæˆ',
                description: 'AI å°‡æ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆå…§å®¹'
              }
            ],
            cancelable: true
          });

          if (!userChoice) return; // ç”¨æˆ¶å–æ¶ˆ

          // é¡¯ç¤ºå…¨è¢å¹• loading
          App.import.setLoading(true);

          try {
            // æ”¶é›†ç•¶å‰è¡¨å–®è³‡æ–™
            const currentData = this.collectFormData();

            // å»ºæ§‹ prompt
            const prompt = this.buildGenerationPrompt(fieldId, currentData);

            // å‘¼å« AI API
            const result = await this.callAIForText(prompt, provider);

            // å¡«å…¥ç”Ÿæˆçš„å…§å®¹
            const field = document.getElementById(fieldId);
            if (field && result) {
              field.value = result.trim();
              field.dispatchEvent(new Event('input', { bubbles: true }));
              showToast(`ã€Œ${fieldLabel}ã€ç”Ÿæˆå®Œæˆï¼`, 'success');
            }

          } catch (error) {
            console.error('AI ç”Ÿæˆå¤±æ•—ï¼š', error);
            showToast(`ç”Ÿæˆå¤±æ•—ï¼š${error.message}`, 'error');
          } finally {
            App.import.setLoading(false);
          }
        },

        /**
         * æ‰¹æ¬¡ç”Ÿæˆèªè¨€é¢¨æ ¼æ¬„ä½
         */
        async generateSpeechFields() {
          // æª¢æŸ¥ API KEY
          const settings = App.settings.load();
          const provider = settings.aiProvider || 'gemini';

          let hasApiKey = false;
          if (provider === 'gemini' && settings.geminiApiKey) hasApiKey = true;
          if (provider === 'openai' && settings.openaiApiKey) hasApiKey = true;
          if (provider === 'claude' && settings.claudeApiKey) hasApiKey = true;
          if (provider === 'deepseek' && settings.deepseekApiKey) hasApiKey = true;

          if (!hasApiKey) {
            showToast('è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å¯« API KEY', 'error');
            return;
          }

          // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
          const userChoice = await showConfirmDialog({
            title: 'AI ç”Ÿæˆç¢ºèª',
            message: 'ç¢ºå®šè¦ä½¿ç”¨ AI ç”Ÿæˆã€Œèªè¨€é¢¨æ ¼ã€ï¼ˆå£é ­ç¦ªã€èªè¨€ç¿’æ…£ã€æƒ…ç·’è¡¨é”ï¼‰å—ï¼Ÿ\né€™å°‡æœƒæ¶ˆè€— TOKENã€‚',
            options: [
              {
                value: 'confirm',
                label: 'âœ“ ç¢ºå®šç”Ÿæˆ',
                description: 'AI å°‡æ ¹æ“šç•¶å‰è§’è‰²è³‡æ–™å‰µæ„ç”Ÿæˆèªè¨€é¢¨æ ¼'
              }
            ],
            cancelable: true
          });

          if (!userChoice) return; // ç”¨æˆ¶å–æ¶ˆ

          // é¡¯ç¤ºå…¨è¢å¹• loading
          App.import.setLoading(true);

          try {
            // æ”¶é›†ç•¶å‰è¡¨å–®è³‡æ–™
            const currentData = this.collectFormData();

            // å»ºæ§‹ prompt
            const prompt = this.buildSpeechGenerationPrompt(currentData);

            // å‘¼å« AI API
            const result = await this.callAIForText(prompt, provider);

            if (!result) {
              throw new Error('AI æœªè¿”å›çµæœ');
            }

            // è§£æçµæœ
            const lines = result.split('\n').map(line => line.trim()).filter(line => line);

            let catchphrases = '';
            let verbalTics = '';
            let emotionalExpression = '';

            lines.forEach(line => {
              if (line.includes('å£é ­ç¦ªï¼š') || line.includes('å£é ­ç¦ª:')) {
                catchphrases = line.replace(/å£é ­ç¦ª[ï¼š:]\s*/, '');
              } else if (line.includes('èªè¨€ç¿’æ…£ï¼š') || line.includes('èªè¨€ç¿’æ…£:')) {
                verbalTics = line.replace(/èªè¨€ç¿’æ…£[ï¼š:]\s*/, '');
              } else if (line.includes('æƒ…ç·’è¡¨é”ï¼š') || line.includes('æƒ…ç·’è¡¨é”:')) {
                emotionalExpression = line.replace(/æƒ…ç·’è¡¨é”[ï¼š:]\s*/, '');
              }
            });

            // å¡«å…¥å„æ¬„ä½
            let successCount = 0;

            if (catchphrases) {
              const field = document.getElementById('catchphrases');
              if (field) {
                field.value = catchphrases;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                successCount++;
              }
            }

            if (verbalTics) {
              const field = document.getElementById('verbalTics');
              if (field) {
                field.value = verbalTics;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                successCount++;
              }
            }

            if (emotionalExpression) {
              const field = document.getElementById('emotionalExpression');
              if (field) {
                field.value = emotionalExpression;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                successCount++;
              }
            }

            if (successCount > 0) {
              showToast(`èªè¨€é¢¨æ ¼ç”Ÿæˆå®Œæˆï¼ï¼ˆ${successCount}/3 å€‹æ¬„ä½ï¼‰`, 'success');
            } else {
              throw new Error('ç„¡æ³•è§£æ AI å›æ‡‰æ ¼å¼');
            }

          } catch (error) {
            console.error('AI ç”Ÿæˆå¤±æ•—ï¼š', error);
            showToast(`ç”Ÿæˆå¤±æ•—ï¼š${error.message}`, 'error');
          } finally {
            App.import.setLoading(false);
          }
        },

        /**
         * èª¿ç”¨ AI API ç”Ÿæˆç´”æ–‡æœ¬ï¼ˆä¸è§£æ JSONï¼‰
         * @param {string} prompt - æç¤ºè©
         * @param {string} provider - AI æä¾›å•†
         * @returns {Promise<string>} ç”Ÿæˆçš„æ–‡æœ¬
         */
        async callAIForText(prompt, provider) {
          // ç²å– API Key
          const settings = App.settings.load();
          let apiKey;

          switch (provider) {
            case 'gemini':
              apiKey = settings.geminiApiKey;
              break;
            case 'openai':
              apiKey = settings.openaiApiKey;
              break;
            case 'claude':
              apiKey = settings.claudeApiKey;
              break;
            case 'deepseek':
              apiKey = settings.deepseekApiKey;
              break;
            default:
              throw new Error(`ä¸æ”¯æ´çš„ AI æä¾›å•†: ${provider}`);
          }

          if (!apiKey || apiKey.trim() === '') {
            throw new Error(`è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å¯« API KEY`);
          }

          // èª¿ç”¨å°æ‡‰æä¾›å•†çš„ API
          switch (provider) {
            case 'gemini':
              return await this.callGeminiForText(apiKey, prompt);
            case 'openai':
              return await this.callOpenAIForText(apiKey, prompt);
            case 'claude':
              return await this.callClaudeForText(apiKey, prompt);
            case 'deepseek':
              return await this.callDeepSeekForText(apiKey, prompt);
            default:
              throw new Error(`ä¸æ”¯æ´çš„ AI æä¾›å•†: ${provider}`);
          }
        },

        /**
         * èª¿ç”¨ Gemini API ç”Ÿæˆç´”æ–‡æœ¬
         */
        async callGeminiForText(apiKey, prompt) {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-goog-api-key': apiKey
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: prompt
                  }]
                }],
                generationConfig: {
                  temperature: 0.8,
                  topK: 40,
                  topP: 0.95,
                  maxOutputTokens: 2048,
                }
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Gemini API');
          }

          const data = await response.json();

          if (!data.candidates || !data.candidates[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error(data.error?.message || 'API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          return data.candidates[0].content.parts[0].text;
        },

        /**
         * èª¿ç”¨ OpenAI API ç”Ÿæˆç´”æ–‡æœ¬
         */
        async callOpenAIForText(apiKey, prompt) {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o-mini',
              messages: [
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.8,
              max_tokens: 2048
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° OpenAI API');
          }

          const data = await response.json();
          return data.choices[0].message.content;
        },

        /**
         * èª¿ç”¨ Claude API ç”Ÿæˆç´”æ–‡æœ¬
         */
        async callClaudeForText(apiKey, prompt) {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 2048,
              messages: [
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.8
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Claude API');
          }

          const data = await response.json();
          return data.content[0].text;
        },

        /**
         * èª¿ç”¨ DeepSeek API ç”Ÿæˆç´”æ–‡æœ¬
         */
        async callDeepSeekForText(apiKey, prompt) {
          const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'deepseek-chat',
              messages: [
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.8,
              max_tokens: 2048
            })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° DeepSeek API');
          }

          const data = await response.json();
          return data.choices[0].message.content;
        }
      },

      // Google Drive æ•´åˆ
      drive: {
        userFolderId: null, // ç”¨æˆ¶å°ˆå±¬è³‡æ–™å¤¾ ID

        /**
         * åˆå§‹åŒ–ç”¨æˆ¶è³‡æ–™å¤¾
         * åœ¨ä¸»è³‡æ–™å¤¾ä¸‹å‰µå»ºä»¥ç”¨æˆ¶ email å‘½åçš„å­è³‡æ–™å¤¾
         */
        async initUserFolder() {
          if (!App.state.accessToken) {
            throw new Error('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ');
          }

          const settings = App.settings.get();
          if (!settings.googleDriveFolderId) {
            throw new Error('è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å¯« Google Drive ä¸»è³‡æ–™å¤¾ ID');
          }

          const userEmail = App.state.user.email;
          const folderName = userEmail.replace('@', '_at_'); // é¿å…ç‰¹æ®Šå­—å…ƒ

          try {
            // æœå°‹æ˜¯å¦å·²å­˜åœ¨ç”¨æˆ¶è³‡æ–™å¤¾
            const searchResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files?` +
              `q=name='${folderName}' and '${settings.googleDriveFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false&` +
              `fields=files(id,name)`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            if (!searchResponse.ok) {
              throw new Error('æœå°‹è³‡æ–™å¤¾å¤±æ•—');
            }

            const searchData = await searchResponse.json();

            if (searchData.files && searchData.files.length > 0) {
              // è³‡æ–™å¤¾å·²å­˜åœ¨
              this.userFolderId = searchData.files[0].id;
              console.log('æ‰¾åˆ°ç¾æœ‰ç”¨æˆ¶è³‡æ–™å¤¾:', this.userFolderId);
            } else {
              // å‰µå»ºæ–°è³‡æ–™å¤¾
              const createResponse = await fetch(
                'https://www.googleapis.com/drive/v3/files',
                {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${App.state.accessToken}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    name: folderName,
                    mimeType: 'application/vnd.google-apps.folder',
                    parents: [settings.googleDriveFolderId]
                  })
                }
              );

              if (!createResponse.ok) {
                throw new Error('å‰µå»ºè³‡æ–™å¤¾å¤±æ•—');
              }

              const createData = await createResponse.json();
              this.userFolderId = createData.id;
              console.log('å‰µå»ºæ–°ç”¨æˆ¶è³‡æ–™å¤¾:', this.userFolderId);
            }

            return this.userFolderId;
          } catch (error) {
            console.error('åˆå§‹åŒ–ç”¨æˆ¶è³‡æ–™å¤¾å¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * ä¸Šå‚³æª”æ¡ˆåˆ°ç”¨æˆ¶è³‡æ–™å¤¾
         */
        async uploadFile(fileName, content, mimeType = 'application/json') {
          if (!this.userFolderId) {
            await this.initUserFolder();
          }

          try {
            // ä½¿ç”¨ multipart upload
            const metadata = {
              name: fileName,
              parents: [this.userFolderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: mimeType }));

            const response = await fetch(
              'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                },
                body: form
              }
            );

            if (!response.ok) {
              throw new Error('ä¸Šå‚³æª”æ¡ˆå¤±æ•—');
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error('ä¸Šå‚³æª”æ¡ˆå¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * åˆ—å‡ºç”¨æˆ¶è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰è§’è‰²å¡
         */
        async listCharacters() {
          if (!this.userFolderId) {
            await this.initUserFolder();
          }

          try {
            const response = await fetch(
              `https://www.googleapis.com/drive/v3/files?` +
              `q='${this.userFolderId}' in parents and trashed=false and (mimeType='application/json' or name contains '.json')&` +
              `fields=files(id,name,createdTime,modifiedTime,size)&` +
              `orderBy=modifiedTime desc`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            if (!response.ok) {
              throw new Error('åˆ—å‡ºæª”æ¡ˆå¤±æ•—');
            }

            const data = await response.json();
            return data.files || [];
          } catch (error) {
            console.error('åˆ—å‡ºæª”æ¡ˆå¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * ä¸‹è¼‰æª”æ¡ˆå…§å®¹
         */
        async downloadFile(fileId) {
          try {
            const response = await fetch(
              `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            if (!response.ok) {
              throw new Error('ä¸‹è¼‰æª”æ¡ˆå¤±æ•—');
            }

            const content = await response.text();
            return content;
          } catch (error) {
            console.error('ä¸‹è¼‰æª”æ¡ˆå¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * ä¸Šå‚³åœ–ç‰‡ä¸¦å–å¾—å…¬é–‹åˆ†äº«é€£çµ
         */
        async uploadImage(file) {
          if (!this.userFolderId) {
            await this.initUserFolder();
          }

          try {
            // å‰µå»º images å­è³‡æ–™å¤¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let imagesFolderId = await this.getOrCreateImagesFolder();

            // ä¸Šå‚³åœ–ç‰‡
            const metadata = {
              name: `${Date.now()}_${file.name}`,
              parents: [imagesFolderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const uploadResponse = await fetch(
              'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                },
                body: form
              }
            );

            if (!uploadResponse.ok) {
              throw new Error('ä¸Šå‚³åœ–ç‰‡å¤±æ•—');
            }

            const uploadData = await uploadResponse.json();

            // è¨­å®šæª”æ¡ˆç‚ºå…¬é–‹
            await fetch(
              `https://www.googleapis.com/drive/v3/files/${uploadData.id}/permissions`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  role: 'reader',
                  type: 'anyone'
                })
              }
            );

            // å–å¾—å…¬é–‹é€£çµ
            const fileResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files/${uploadData.id}?fields=webContentLink,webViewLink`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            const fileData = await fileResponse.json();

            // è¿”å›ç›´æ¥é€£çµï¼ˆç”¨æ–¼é¡¯ç¤ºåœ–ç‰‡ï¼‰
            const directLink = `https://drive.google.com/uc?export=view&id=${uploadData.id}`;

            return {
              id: uploadData.id,
              name: uploadData.name,
              directLink: directLink,
              webViewLink: fileData.webViewLink
            };
          } catch (error) {
            console.error('ä¸Šå‚³åœ–ç‰‡å¤±æ•—:', error);
            throw error;
          }
        },

        /**
         * å–å¾—æˆ–å‰µå»º images å­è³‡æ–™å¤¾
         */
        async getOrCreateImagesFolder() {
          try {
            // æœå°‹ images è³‡æ–™å¤¾
            const searchResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files?` +
              `q=name='images' and '${this.userFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false&` +
              `fields=files(id)`,
              {
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`
                }
              }
            );

            const searchData = await searchResponse.json();

            if (searchData.files && searchData.files.length > 0) {
              return searchData.files[0].id;
            }

            // å‰µå»º images è³‡æ–™å¤¾
            const createResponse = await fetch(
              'https://www.googleapis.com/drive/v3/files',
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${App.state.accessToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  name: 'images',
                  mimeType: 'application/vnd.google-apps.folder',
                  parents: [this.userFolderId]
                })
              }
            );

            const createData = await createResponse.json();
            return createData.id;
          } catch (error) {
            console.error('å–å¾—æˆ–å‰µå»º images è³‡æ–™å¤¾å¤±æ•—:', error);
            throw error;
          }
        }
      },

      // AI ç”Ÿæˆæ¨¡çµ„
      ai: {
        /**
         * AI ä¸€éµå‰µè§’ - ä½¿ç”¨ç•¶å‰é¸æ“‡çš„ AI æä¾›å•†ç”Ÿæˆè§’è‰²
         */
        async generateCharacter() {
          const settings = App.settings.get();
          const provider = settings.aiProvider;

          // æª¢æŸ¥å°æ‡‰æä¾›å•†çš„ API Key
          let apiKey;
          switch (provider) {
            case 'gemini':
              apiKey = settings.geminiApiKey;
              break;
            case 'openai':
              apiKey = settings.openaiApiKey;
              break;
            case 'claude':
              apiKey = settings.claudeApiKey;
              break;
            case 'deepseek':
              apiKey = settings.deepseekApiKey;
              break;
          }

          if (!apiKey || apiKey.trim() === '') {
            const providerName = this.getProviderName(provider);
            showToast(`è«‹å…ˆåœ¨è¨­å®šä¸­é…ç½® ${providerName} çš„ API Keyï¼`, 'warning');
            App.ui.openSettings();
            return;
          }

          // æç¤ºç”¨æˆ¶è¼¸å…¥è§’è‰²æ¦‚å¿µ
          const prompt = window.prompt(
            'âœ¨ AI ä¸€éµå‰µè§’\n\n' +
            'è«‹è¼¸å…¥æ‚¨æƒ³å‰µå»ºçš„è§’è‰²æ¦‚å¿µï¼ŒAI å°‡ç‚ºæ‚¨ç”Ÿæˆå®Œæ•´çš„è§’è‰²è³‡æ–™ï¼\n\n' +
            'ç¯„ä¾‹ï¼š\n' +
            'â€¢ ä¸€å€‹æ´»æ½‘å¯æ„›çš„ç‹è€³ VTuberï¼Œå–œæ­¡éŠæˆ²å¯¦æ³\n' +
            'â€¢ å†·éœæˆç†Ÿçš„ç²¾éˆå¼“æ‰‹ï¼Œæ“…é•·æ²»ç™’é­”æ³•\n' +
            'â€¢ æç¬‘æ“”ç•¶çš„æµ·è³Šèˆ¹é•·ï¼Œå€‹æ€§è±ªçˆ½\n\n' +
            'è«‹è¼¸å…¥æ‚¨çš„å‰µæ„ï¼š'
          );

          if (!prompt || prompt.trim() === '') {
            return;
          }

          const providerName = this.getProviderName(provider);
          showToast(`ä½¿ç”¨ ${providerName} ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...`, 'info');

          try {
            // ä½¿ç”¨çµ±ä¸€çš„ AI API èª¿ç”¨å‡½æ•¸
            const characterData = await this.callAIAPI(prompt);

            // å°‡ç”Ÿæˆçš„è³‡æ–™å¡«å…¥è¡¨å–®
            fillFormData(characterData);
            updatePreview();

            showToast('âœ¨ AI å‰µè§’å®Œæˆï¼è«‹æª¢æŸ¥ä¸¦èª¿æ•´è³‡æ–™', 'success');
          } catch (error) {
            console.error('AI ç”Ÿæˆå¤±æ•—:', error);
            showToast('AI ç”Ÿæˆå¤±æ•—ï¼š' + error.message, 'error');
          }
        },

        /**
         * çµ±ä¸€çš„ AI API èª¿ç”¨å…¥å£
         * æ ¹æ“šç”¨æˆ¶é¸æ“‡çš„æä¾›å•†èª¿ç”¨å°æ‡‰çš„ API
         */
        async callAIAPI(userPrompt) {
          const settings = App.settings.get();
          const provider = settings.aiProvider;

          // æ ¹æ“šæä¾›å•†ç²å–å°æ‡‰çš„ API Key
          let apiKey;
          switch (provider) {
            case 'gemini':
              apiKey = settings.geminiApiKey;
              break;
            case 'openai':
              apiKey = settings.openaiApiKey;
              break;
            case 'claude':
              apiKey = settings.claudeApiKey;
              break;
            case 'deepseek':
              apiKey = settings.deepseekApiKey;
              break;
            default:
              throw new Error(`ä¸æ”¯æ´çš„ AI æä¾›å•†: ${provider}`);
          }

          // æª¢æŸ¥ API Key æ˜¯å¦å­˜åœ¨
          if (!apiKey || apiKey.trim() === '') {
            const providerName = this.getProviderName(provider);
            throw new Error(`è«‹å…ˆåœ¨è¨­å®šä¸­å¡«å¯« ${providerName} çš„ API Key`);
          }

          // èª¿ç”¨å°æ‡‰æä¾›å•†çš„ API
          switch (provider) {
            case 'gemini':
              return await this.callGeminiAPI(apiKey, userPrompt);
            case 'openai':
              return await this.callOpenAIAPI(apiKey, userPrompt);
            case 'claude':
              return await this.callClaudeAPI(apiKey, userPrompt);
            case 'deepseek':
              return await this.callDeepSeekAPI(apiKey, userPrompt);
            default:
              throw new Error(`ä¸æ”¯æ´çš„ AI æä¾›å•†: ${provider}`);
          }
        },

        /**
         * ç²å– AI æä¾›å•†çš„é¡¯ç¤ºåç¨±
         */
        getProviderName(provider) {
          const names = {
            'gemini': 'Google Gemini',
            'openai': 'OpenAI GPT',
            'claude': 'Anthropic Claude',
            'deepseek': 'DeepSeek'
          };
          return names[provider] || provider;
        },

        /**
         * è§£æ AI å›æ‡‰çš„ JSON è³‡æ–™
         * è™•ç†å¯èƒ½çš„ markdown ä»£ç¢¼å¡Šå’Œå¸¸è¦‹æ ¼å¼éŒ¯èª¤
         */
        parseAIResponse(generatedText) {
          // å˜—è©¦è§£æ JSONï¼ˆç§»é™¤å¯èƒ½çš„ markdown ä»£ç¢¼å¡Šï¼‰
          let jsonText = generatedText.trim();

          // ç§»é™¤ markdown ä»£ç¢¼å¡Šæ¨™è¨˜
          if (jsonText.startsWith('```json')) {
            jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
          } else if (jsonText.startsWith('```')) {
            jsonText = jsonText.replace(/```\n?/g, '');
          }

          // ä¿®å¾©å¸¸è¦‹çš„ JSON æ ¼å¼éŒ¯èª¤
          jsonText = jsonText
            .replace(/,\s*}/g, '}')  // ç§»é™¤ç‰©ä»¶çµå°¾çš„å¤šé¤˜é€—è™Ÿ
            .replace(/,\s*]/g, ']')  // ç§»é™¤é™£åˆ—çµå°¾çš„å¤šé¤˜é€—è™Ÿ
            .trim();

          try {
            const characterData = JSON.parse(jsonText);
            return characterData;
          } catch (e) {
            console.error('JSON è§£æå¤±æ•—:', e);
            console.log('åŸå§‹å›æ‡‰:', generatedText);
            console.log('æ¸…ç†å¾Œçš„ JSON:', jsonText);

            // æª¢æŸ¥æ˜¯å¦æ˜¯å› ç‚ºå›æ‡‰è¢«æˆªæ–·
            if (e.message.includes('Unterminated string') ||
                e.message.includes('Unexpected end') ||
                !jsonText.endsWith('}')) {
              throw new Error('AI å›æ‡‰å…§å®¹éé•·è¢«æˆªæ–·ï¼Œè«‹ç°¡åŒ–è§’è‰²å¡å…§å®¹æˆ–ç¨å¾Œé‡è©¦');
            }

            throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦');
          }
        },

        /**
         * å‘¼å« Gemini API ç”Ÿæˆè§’è‰²è³‡æ–™
         */
        async callGeminiAPI(apiKey, userPrompt) {
          const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è§’è‰²è¨­è¨ˆåŠ©æ‰‹ã€‚æ ¹æ“šç”¨æˆ¶æä¾›çš„è§’è‰²æ¦‚å¿µï¼Œè«‹ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡è³‡æ–™ã€‚

è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆæ‰€æœ‰æ¬„ä½éƒ½ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥å1, åˆ¥å2",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥ï¼ˆå¥³æ€§/ç”·æ€§/éäºŒå…ƒ/å…¶ä»–ï¼‰",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½",
  "appearance": "æ•´é«”å¤–è§€æè¿°ï¼ˆ2-3å¥è©±ï¼‰",
  "height": "èº«é«˜",
  "bodyType": "é«”å‹",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›é¡è‰²",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "ç‰¹æ®Šæ¨™è¨˜",
  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆ2-3å¥è©±ï¼‰",
  "traits": "ç‰¹è³ªæ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "combatSkills": [
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "lifeSkills": [
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "customAttributes": [
    { "attribute": "å±¬æ€§åç¨±1", "value": "å€¼æˆ–ç­‰ç´š" },
    { "attribute": "å±¬æ€§åç¨±2", "value": "å€¼æˆ–ç­‰ç´š" }
  ],
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹ï¼ˆ3-5å¥è©±ï¼‰",
  "keyEvents": "é—œéµäº‹ä»¶",
  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯ï¼ˆè§’è‰²çš„è‡ªæˆ‘ä»‹ç´¹å°è©±ï¼‰",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»ï¼ˆ1-2å¥è©±æè¿°å ´æ™¯ï¼‰",
  "description": "çµ¦ AI çš„å®Œæ•´è§’è‰²æè¿°ï¼ˆæ•´åˆæ‰€æœ‰è³‡è¨Šï¼Œ5-8å¥è©±ï¼‰",
  "systemPrompt": "ç³»çµ±æç¤ºè©ï¼ˆæŒ‡å° AI å¦‚ä½•æ‰®æ¼”é€™å€‹è§’è‰²ï¼‰"
}

ç”¨æˆ¶çš„è§’è‰²æ¦‚å¿µï¼š${userPrompt}

é‡è¦è¦å‰‡ï¼š
1. åªå›å‚³ç´” JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ã€è¨»é‡‹æˆ– markdown æ ¼å¼ï¼ˆå¦‚ \`\`\`jsonï¼‰
2. ä¸€èˆ¬å­—æ®µçš„å€¼å¿…é ˆæ˜¯å­—ç¬¦ä¸²é¡å‹ï¼Œç”¨é›™å¼•è™ŸåŒ…è£¹
3. combatSkillsã€lifeSkillsã€customAttributes å¿…é ˆæ˜¯é™£åˆ—æ ¼å¼ï¼Œæ¯å€‹å…ƒç´ åŒ…å«æŒ‡å®šçš„å±¬æ€§
4. ç¢ºä¿æ‰€æœ‰å¼•è™Ÿã€é€—è™Ÿã€å¤§æ‹¬è™Ÿã€æ–¹æ‹¬è™Ÿæ­£ç¢ºåŒ¹é…
5. ä¸è¦åœ¨æœ€å¾Œä¸€å€‹å­—æ®µå¾ŒåŠ é€—è™Ÿ
6. JSON å¿…é ˆèƒ½è¢« JSON.parse() ç›´æ¥è§£æï¼Œä¸èƒ½æœ‰ä»»ä½•èªæ³•éŒ¯èª¤
7. è«‹ç‚ºæ¯å€‹è§’è‰²ç”Ÿæˆè‡³å°‘ 2-3 å€‹æˆ°é¬¥æŠ€èƒ½ã€1-2 å€‹ç”Ÿæ´»æŠ€èƒ½ã€2-3 å€‹è‡ªè¨‚å±¬æ€§

ç¯„ä¾‹æ ¼å¼ï¼š
{
  "name": "ç‹è€³VTuber å°ç‹",
  "catchphrases": "ã“ã‚“ã“ãƒ¼ã‚“ï¼, å¤§å®¶å¥½å‘€ï½",
  "combatSkills": [
    { "skill": "æ­Œè²é­…æƒ‘", "level": "Sç´š" },
    { "skill": "ç‹ç«é­”æ³•", "level": "å°ˆç²¾" }
  ],
  "lifeSkills": [
    { "skill": "éŠæˆ²å¯¦æ³", "level": "å°ˆæ¥­ç´š" }
  ],
  "customAttributes": [
    { "attribute": "é­…åŠ›å€¼", "value": "SSS" },
    { "attribute": "å¯æ„›åº¦", "value": "MAX" }
  ]
}`;

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-goog-api-key': apiKey
              },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: systemPrompt
                  }]
                }],
                generationConfig: {
                  temperature: 0.9,
                  topK: 40,
                  topP: 0.95,
                  maxOutputTokens: 32768,  // å¢åŠ è¼¸å‡ºé™åˆ¶ä»¥è™•ç†è¤‡é›œè§’è‰²å¡
                }
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Gemini API');
          }

          const data = await response.json();

          // æª¢æŸ¥å›æ‡‰çµæ§‹
          if (!data.candidates || !data.candidates[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error(data.error?.message || 'API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          const generatedText = data.candidates[0].content.parts[0].text;

          // ä½¿ç”¨çµ±ä¸€çš„è§£æå‡½æ•¸
          return this.parseAIResponse(generatedText);
        },

        /**
         * å‘¼å« OpenAI API ç”Ÿæˆè§’è‰²è³‡æ–™
         */
        async callOpenAIAPI(apiKey, userPrompt) {
          const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è§’è‰²è¨­è¨ˆåŠ©æ‰‹ã€‚æ ¹æ“šç”¨æˆ¶æä¾›çš„è§’è‰²æ¦‚å¿µï¼Œè«‹ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡è³‡æ–™ã€‚

è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆæ‰€æœ‰æ¬„ä½éƒ½ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥å1, åˆ¥å2",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥ï¼ˆå¥³æ€§/ç”·æ€§/éäºŒå…ƒ/å…¶ä»–ï¼‰",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½",
  "appearance": "æ•´é«”å¤–è§€æè¿°ï¼ˆ2-3å¥è©±ï¼‰",
  "height": "èº«é«˜",
  "bodyType": "é«”å‹",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›é¡è‰²",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "ç‰¹æ®Šæ¨™è¨˜",
  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆ2-3å¥è©±ï¼‰",
  "traits": "ç‰¹è³ªæ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "combatSkills": [
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "lifeSkills": [
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "customAttributes": [
    { "attribute": "å±¬æ€§åç¨±1", "value": "å€¼æˆ–ç­‰ç´š" },
    { "attribute": "å±¬æ€§åç¨±2", "value": "å€¼æˆ–ç­‰ç´š" }
  ],
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹ï¼ˆ3-5å¥è©±ï¼‰",
  "keyEvents": "é—œéµäº‹ä»¶",
  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯ï¼ˆè§’è‰²çš„è‡ªæˆ‘ä»‹ç´¹å°è©±ï¼‰",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»ï¼ˆ1-2å¥è©±æè¿°å ´æ™¯ï¼‰",
  "description": "çµ¦ AI çš„å®Œæ•´è§’è‰²æè¿°ï¼ˆæ•´åˆæ‰€æœ‰è³‡è¨Šï¼Œ5-8å¥è©±ï¼‰",
  "systemPrompt": "ç³»çµ±æç¤ºè©ï¼ˆæŒ‡å° AI å¦‚ä½•æ‰®æ¼”é€™å€‹è§’è‰²ï¼‰"
}

é‡è¦è¦å‰‡ï¼š
1. åªå›å‚³ç´” JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ã€è¨»é‡‹æˆ– markdown æ ¼å¼ï¼ˆå¦‚ \`\`\`jsonï¼‰
2. ä¸€èˆ¬å­—æ®µçš„å€¼å¿…é ˆæ˜¯å­—ç¬¦ä¸²é¡å‹ï¼Œç”¨é›™å¼•è™ŸåŒ…è£¹
3. combatSkillsã€lifeSkillsã€customAttributes å¿…é ˆæ˜¯é™£åˆ—æ ¼å¼ï¼Œæ¯å€‹å…ƒç´ åŒ…å«æŒ‡å®šçš„å±¬æ€§
4. ç¢ºä¿æ‰€æœ‰å¼•è™Ÿã€é€—è™Ÿã€å¤§æ‹¬è™Ÿã€æ–¹æ‹¬è™Ÿæ­£ç¢ºåŒ¹é…
5. ä¸è¦åœ¨æœ€å¾Œä¸€å€‹å­—æ®µå¾ŒåŠ é€—è™Ÿ
6. JSON å¿…é ˆèƒ½è¢« JSON.parse() ç›´æ¥è§£æï¼Œä¸èƒ½æœ‰ä»»ä½•èªæ³•éŒ¯èª¤
7. è«‹ç‚ºæ¯å€‹è§’è‰²ç”Ÿæˆè‡³å°‘ 2-3 å€‹æˆ°é¬¥æŠ€èƒ½ã€1-2 å€‹ç”Ÿæ´»æŠ€èƒ½ã€2-3 å€‹è‡ªè¨‚å±¬æ€§

ç¯„ä¾‹æ ¼å¼ï¼š
{
  "name": "ç‹è€³VTuber å°ç‹",
  "catchphrases": "ã“ã‚“ã“ãƒ¼ã‚“ï¼, å¤§å®¶å¥½å‘€ï½",
  "combatSkills": [
    { "skill": "æ­Œè²é­…æƒ‘", "level": "Sç´š" },
    { "skill": "ç‹ç«é­”æ³•", "level": "å°ˆç²¾" }
  ],
  "lifeSkills": [
    { "skill": "éŠæˆ²å¯¦æ³", "level": "å°ˆæ¥­ç´š" }
  ],
  "customAttributes": [
    { "attribute": "é­…åŠ›å€¼", "value": "SSS" },
    { "attribute": "å¯æ„›åº¦", "value": "MAX" }
  ]
}`;

          const response = await fetch(
            'https://api.openai.com/v1/chat/completions',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: 'gpt-4o',
                messages: [
                  {
                    role: 'system',
                    content: systemPrompt
                  },
                  {
                    role: 'user',
                    content: userPrompt
                  }
                ],
                temperature: 0.9,
                max_tokens: 4096
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° OpenAI API');
          }

          const data = await response.json();

          // æª¢æŸ¥å›æ‡‰çµæ§‹
          if (!data.choices || !data.choices[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error('API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          const generatedText = data.choices[0].message.content;

          // ä½¿ç”¨çµ±ä¸€çš„è§£æå‡½æ•¸
          return this.parseAIResponse(generatedText);
        },

        /**
         * å‘¼å« Claude API ç”Ÿæˆè§’è‰²è³‡æ–™
         */
        async callClaudeAPI(apiKey, userPrompt) {
          const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è§’è‰²è¨­è¨ˆåŠ©æ‰‹ã€‚æ ¹æ“šç”¨æˆ¶æä¾›çš„è§’è‰²æ¦‚å¿µï¼Œè«‹ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡è³‡æ–™ã€‚

è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆæ‰€æœ‰æ¬„ä½éƒ½ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥å1, åˆ¥å2",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥ï¼ˆå¥³æ€§/ç”·æ€§/éäºŒå…ƒ/å…¶ä»–ï¼‰",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½",
  "appearance": "æ•´é«”å¤–è§€æè¿°ï¼ˆ2-3å¥è©±ï¼‰",
  "height": "èº«é«˜",
  "bodyType": "é«”å‹",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›é¡è‰²",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "ç‰¹æ®Šæ¨™è¨˜",
  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆ2-3å¥è©±ï¼‰",
  "traits": "ç‰¹è³ªæ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "combatSkills": [
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "lifeSkills": [
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "customAttributes": [
    { "attribute": "å±¬æ€§åç¨±1", "value": "å€¼æˆ–ç­‰ç´š" },
    { "attribute": "å±¬æ€§åç¨±2", "value": "å€¼æˆ–ç­‰ç´š" }
  ],
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹ï¼ˆ3-5å¥è©±ï¼‰",
  "keyEvents": "é—œéµäº‹ä»¶",
  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯ï¼ˆè§’è‰²çš„è‡ªæˆ‘ä»‹ç´¹å°è©±ï¼‰",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»ï¼ˆ1-2å¥è©±æè¿°å ´æ™¯ï¼‰",
  "description": "çµ¦ AI çš„å®Œæ•´è§’è‰²æè¿°ï¼ˆæ•´åˆæ‰€æœ‰è³‡è¨Šï¼Œ5-8å¥è©±ï¼‰",
  "systemPrompt": "ç³»çµ±æç¤ºè©ï¼ˆæŒ‡å° AI å¦‚ä½•æ‰®æ¼”é€™å€‹è§’è‰²ï¼‰"
}

é‡è¦è¦å‰‡ï¼š
1. åªå›å‚³ç´” JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ã€è¨»é‡‹æˆ– markdown æ ¼å¼ï¼ˆå¦‚ \`\`\`jsonï¼‰
2. ä¸€èˆ¬å­—æ®µçš„å€¼å¿…é ˆæ˜¯å­—ç¬¦ä¸²é¡å‹ï¼Œç”¨é›™å¼•è™ŸåŒ…è£¹
3. combatSkillsã€lifeSkillsã€customAttributes å¿…é ˆæ˜¯é™£åˆ—æ ¼å¼ï¼Œæ¯å€‹å…ƒç´ åŒ…å«æŒ‡å®šçš„å±¬æ€§
4. ç¢ºä¿æ‰€æœ‰å¼•è™Ÿã€é€—è™Ÿã€å¤§æ‹¬è™Ÿã€æ–¹æ‹¬è™Ÿæ­£ç¢ºåŒ¹é…
5. ä¸è¦åœ¨æœ€å¾Œä¸€å€‹å­—æ®µå¾ŒåŠ é€—è™Ÿ
6. JSON å¿…é ˆèƒ½è¢« JSON.parse() ç›´æ¥è§£æï¼Œä¸èƒ½æœ‰ä»»ä½•èªæ³•éŒ¯èª¤
7. è«‹ç‚ºæ¯å€‹è§’è‰²ç”Ÿæˆè‡³å°‘ 2-3 å€‹æˆ°é¬¥æŠ€èƒ½ã€1-2 å€‹ç”Ÿæ´»æŠ€èƒ½ã€2-3 å€‹è‡ªè¨‚å±¬æ€§

ç¯„ä¾‹æ ¼å¼ï¼š
{
  "name": "ç‹è€³VTuber å°ç‹",
  "catchphrases": "ã“ã‚“ã“ãƒ¼ã‚“ï¼, å¤§å®¶å¥½å‘€ï½",
  "combatSkills": [
    { "skill": "æ­Œè²é­…æƒ‘", "level": "Sç´š" },
    { "skill": "ç‹ç«é­”æ³•", "level": "å°ˆç²¾" }
  ],
  "lifeSkills": [
    { "skill": "éŠæˆ²å¯¦æ³", "level": "å°ˆæ¥­ç´š" }
  ],
  "customAttributes": [
    { "attribute": "é­…åŠ›å€¼", "value": "SSS" },
    { "attribute": "å¯æ„›åº¦", "value": "MAX" }
  ]
}`;

          const response = await fetch(
            'https://api.anthropic.com/v1/messages',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 4096,
                temperature: 0.9,
                system: systemPrompt,
                messages: [
                  {
                    role: 'user',
                    content: userPrompt
                  }
                ]
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Claude API');
          }

          const data = await response.json();

          // æª¢æŸ¥å›æ‡‰çµæ§‹
          if (!data.content || !data.content[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error('API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          const generatedText = data.content[0].text;

          // ä½¿ç”¨çµ±ä¸€çš„è§£æå‡½æ•¸
          return this.parseAIResponse(generatedText);
        },

        /**
         * å‘¼å« DeepSeek API ç”Ÿæˆè§’è‰²è³‡æ–™
         */
        async callDeepSeekAPI(apiKey, userPrompt) {
          const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è§’è‰²è¨­è¨ˆåŠ©æ‰‹ã€‚æ ¹æ“šç”¨æˆ¶æä¾›çš„è§’è‰²æ¦‚å¿µï¼Œè«‹ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡è³‡æ–™ã€‚

è«‹ä»¥ JSON æ ¼å¼å›å‚³ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆæ‰€æœ‰æ¬„ä½éƒ½ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥å1, åˆ¥å2",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥ï¼ˆå¥³æ€§/ç”·æ€§/éäºŒå…ƒ/å…¶ä»–ï¼‰",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½",
  "appearance": "æ•´é«”å¤–è§€æè¿°ï¼ˆ2-3å¥è©±ï¼‰",
  "height": "èº«é«˜",
  "bodyType": "é«”å‹",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›é¡è‰²",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "ç‰¹æ®Šæ¨™è¨˜",
  "personality": "æ€§æ ¼æ‘˜è¦ï¼ˆ2-3å¥è©±ï¼‰",
  "traits": "ç‰¹è³ªæ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "combatSkills": [
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "æˆ°é¬¥æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "lifeSkills": [
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±1", "level": "ç­‰ç´šæˆ–æè¿°" },
    { "skill": "ç”Ÿæ´»æŠ€èƒ½åç¨±2", "level": "ç­‰ç´šæˆ–æè¿°" }
  ],
  "customAttributes": [
    { "attribute": "å±¬æ€§åç¨±1", "value": "å€¼æˆ–ç­‰ç´š" },
    { "attribute": "å±¬æ€§åç¨±2", "value": "å€¼æˆ–ç­‰ç´š" }
  ],
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹ï¼ˆ3-5å¥è©±ï¼‰",
  "keyEvents": "é—œéµäº‹ä»¶",
  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯ï¼ˆè§’è‰²çš„è‡ªæˆ‘ä»‹ç´¹å°è©±ï¼‰",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»ï¼ˆ1-2å¥è©±æè¿°å ´æ™¯ï¼‰",
  "description": "çµ¦ AI çš„å®Œæ•´è§’è‰²æè¿°ï¼ˆæ•´åˆæ‰€æœ‰è³‡è¨Šï¼Œ5-8å¥è©±ï¼‰",
  "systemPrompt": "ç³»çµ±æç¤ºè©ï¼ˆæŒ‡å° AI å¦‚ä½•æ‰®æ¼”é€™å€‹è§’è‰²ï¼‰"
}

é‡è¦è¦å‰‡ï¼š
1. åªå›å‚³ç´” JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ã€è¨»é‡‹æˆ– markdown æ ¼å¼ï¼ˆå¦‚ \`\`\`jsonï¼‰
2. ä¸€èˆ¬å­—æ®µçš„å€¼å¿…é ˆæ˜¯å­—ç¬¦ä¸²é¡å‹ï¼Œç”¨é›™å¼•è™ŸåŒ…è£¹
3. combatSkillsã€lifeSkillsã€customAttributes å¿…é ˆæ˜¯é™£åˆ—æ ¼å¼ï¼Œæ¯å€‹å…ƒç´ åŒ…å«æŒ‡å®šçš„å±¬æ€§
4. ç¢ºä¿æ‰€æœ‰å¼•è™Ÿã€é€—è™Ÿã€å¤§æ‹¬è™Ÿã€æ–¹æ‹¬è™Ÿæ­£ç¢ºåŒ¹é…
5. ä¸è¦åœ¨æœ€å¾Œä¸€å€‹å­—æ®µå¾ŒåŠ é€—è™Ÿ
6. JSON å¿…é ˆèƒ½è¢« JSON.parse() ç›´æ¥è§£æï¼Œä¸èƒ½æœ‰ä»»ä½•èªæ³•éŒ¯èª¤
7. è«‹ç‚ºæ¯å€‹è§’è‰²ç”Ÿæˆè‡³å°‘ 2-3 å€‹æˆ°é¬¥æŠ€èƒ½ã€1-2 å€‹ç”Ÿæ´»æŠ€èƒ½ã€2-3 å€‹è‡ªè¨‚å±¬æ€§

ç¯„ä¾‹æ ¼å¼ï¼š
{
  "name": "ç‹è€³VTuber å°ç‹",
  "catchphrases": "ã“ã‚“ã“ãƒ¼ã‚“ï¼, å¤§å®¶å¥½å‘€ï½",
  "combatSkills": [
    { "skill": "æ­Œè²é­…æƒ‘", "level": "Sç´š" },
    { "skill": "ç‹ç«é­”æ³•", "level": "å°ˆç²¾" }
  ],
  "lifeSkills": [
    { "skill": "éŠæˆ²å¯¦æ³", "level": "å°ˆæ¥­ç´š" }
  ],
  "customAttributes": [
    { "attribute": "é­…åŠ›å€¼", "value": "SSS" },
    { "attribute": "å¯æ„›åº¦", "value": "MAX" }
  ]
}`;

          const response = await fetch(
            'https://api.deepseek.com/chat/completions',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: 'deepseek-chat',
                messages: [
                  {
                    role: 'system',
                    content: systemPrompt
                  },
                  {
                    role: 'user',
                    content: userPrompt
                  }
                ],
                temperature: 0.9,
                max_tokens: 4096
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° DeepSeek API');
          }

          const data = await response.json();

          // æª¢æŸ¥å›æ‡‰çµæ§‹
          if (!data.choices || !data.choices[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error('API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          const generatedText = data.choices[0].message.content;

          // ä½¿ç”¨çµ±ä¸€çš„è§£æå‡½æ•¸
          return this.parseAIResponse(generatedText);
        }
      },

      /**
       * æª¢æŸ¥ç•¶å‰ AI æä¾›å•†æ˜¯å¦æ”¯æ´æŒ‡å®šçš„æ ¼å¼
       * @param {string} format - æ ¼å¼é¡å‹ ('yaml', 'yaml-image', 'vision')
       * @returns {boolean} - æ˜¯å¦æ”¯æ´
       */
      isPlatformSupported(format) {
        const settings = this.settings.get();
        const provider = settings.aiProvider;

        // å¹³å°æ”¯æ´çŸ©é™£
        const supportMatrix = {
          'gemini': {
            'yaml': true,         // Gemini æ”¯æ´ YAML æ ¼å¼
            'yaml-image': true,   // Gemini æ”¯æ´ YAML åœ–ç‰‡
            'vision': true        // Gemini æ”¯æ´ Vision
          },
          'openai': {
            'yaml': true,         // OpenAI æ”¯æ´æ‰€æœ‰æ ¼å¼
            'yaml-image': true,
            'vision': true
          },
          'claude': {
            'yaml': true,         // Claude æ”¯æ´æ‰€æœ‰æ ¼å¼
            'yaml-image': true,
            'vision': true
          },
          'deepseek': {
            'yaml': true,         // DeepSeek æ”¯æ´ YAML
            'yaml-image': true,   // DeepSeek æ”¯æ´ YAML åœ–ç‰‡
            'vision': false       // DeepSeek ä¸æ”¯æ´ Vision
          }
        };

        return supportMatrix[provider]?.[format] ?? true;
      },

      /**
       * æ ¹æ“šç•¶å‰ AI æä¾›å•†æ›´æ–° UI æŒ‰éˆ•çš„é¡¯ç¤ºç‹€æ…‹
       * éš±è—ä¸æ”¯æ´çš„åŠŸèƒ½æŒ‰éˆ•
       * @param {string} provider - å¯é¸çš„æä¾›å•†åç¨±ï¼Œå¦‚æœä¸æä¾›å‰‡å¾ç•¶å‰é¸æ“‡æˆ– localStorage è®€å–
       */
      updateUIButtonsVisibility(provider) {
        // å„ªå…ˆä½¿ç”¨åƒæ•¸ï¼Œå¦å‰‡å¾ä¸‹æ‹‰é¸å–®è®€å–ï¼Œæœ€å¾Œæ‰å¾ localStorage è®€å–
        if (!provider) {
          const providerSelect = document.getElementById('aiProvider');
          provider = providerSelect ? providerSelect.value : this.settings.get().aiProvider;
        }

        // ç›´æ¥ä½¿ç”¨å‚³å…¥æˆ–è®€å–çš„ provider æª¢æŸ¥æ”¯æ´ç‹€æ…‹
        const supportMatrix = {
          'gemini': { 'yaml': true, 'yaml-image': true, 'vision': true },
          'openai': { 'yaml': true, 'yaml-image': true, 'vision': true },
          'claude': { 'yaml': true, 'yaml-image': true, 'vision': true },
          'deepseek': { 'yaml': true, 'yaml-image': true, 'vision': false }
        };

        const isYamlSupported = supportMatrix[provider]?.['yaml'] ?? true;
        const isYamlImageSupported = supportMatrix[provider]?.['yaml-image'] ?? true;
        const isVisionSupported = supportMatrix[provider]?.['vision'] ?? true;

        console.log('æ›´æ–° UI æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹:', {
          provider: provider,
          yamlSupported: isYamlSupported,
          yamlImageSupported: isYamlImageSupported,
          visionSupported: isVisionSupported
        });

        // æ³¨æ„ï¼šé è¦½é¸é …å¡æ°¸é é¡¯ç¤ºæ‰€æœ‰æ ¼å¼ï¼Œä¸å—å¹³å°é™åˆ¶
        // åªæœ‰åŒ¯å‡ºæŒ‰éˆ•æ‰æœƒæ ¹æ“šå¹³å°æ”¯æ´ç‹€æ…‹é¡¯ç¤º/éš±è—

        // YAML åŒ¯å‡ºæŒ‰éˆ•
        const yamlBtn = document.querySelector('.export-btn.yaml');
        if (yamlBtn) {
          yamlBtn.style.display = isYamlSupported ? 'flex' : 'none';
          console.log('YAML åŒ¯å‡ºæŒ‰éˆ•:', yamlBtn, 'é¡¯ç¤ºç‹€æ…‹:', yamlBtn.style.display);
        } else {
          console.warn('æ‰¾ä¸åˆ° YAML åŒ¯å‡ºæŒ‰éˆ• (.export-btn.yaml)');
        }

        // YAML åœ–ç‰‡åŒ¯å‡ºæŒ‰éˆ•
        const yamlImageBtn = document.querySelector('.export-btn.png-yaml');
        if (yamlImageBtn) {
          yamlImageBtn.style.display = isYamlImageSupported ? 'flex' : 'none';
          console.log('YAML åœ–ç‰‡åŒ¯å‡ºæŒ‰éˆ•:', yamlImageBtn, 'é¡¯ç¤ºç‹€æ…‹:', yamlImageBtn.style.display);
        } else {
          console.warn('æ‰¾ä¸åˆ° YAML åœ–ç‰‡åŒ¯å‡ºæŒ‰éˆ• (.export-btn.png-yaml)');
        }

        // åœ–ç‰‡å°å…¥æŒ‰éˆ•ï¼ˆVision åŠŸèƒ½ï¼‰
        const importImageBtn = document.querySelector('button[onclick*="importFromImage"]');
        if (importImageBtn) {
          importImageBtn.style.display = isVisionSupported ? 'inline-flex' : 'none';
        }
      }
    };

    // ===== èˆŠçš„å…¨åŸŸç‹€æ…‹ï¼ˆå‘å¾Œç›¸å®¹ï¼‰=====
    let isFullMode = false;
    let currentPlatform = 'gemini';
    let currentPreviewTab = 'card';

    // ===== æ¨¡å¼åˆ‡æ› =====
    function toggleMode() {
      isFullMode = !isFullMode;
      const toggle = document.getElementById('modeToggle');
      const label = document.getElementById('modeLabel');
      const formPanel = document.getElementById('formPanel');

      if (isFullMode) {
        toggle.classList.add('active');
        label.textContent = 'å®Œæ•´ç‰ˆ';
        formPanel.classList.add('full-mode');
      } else {
        toggle.classList.remove('active');
        label.textContent = 'ç²¾ç°¡ç‰ˆ';
        formPanel.classList.remove('full-mode');
      }

      updatePreview();
    }

    // ===== å¹³å°é¸æ“‡ =====
    function selectPlatform(platform) {
      currentPlatform = platform;
      App.state.currentPlatform = platform; // åŒæ­¥åˆ° App ç‹€æ…‹
      document.querySelectorAll('.platform-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-platform="${platform}"]`).classList.add('active');
      updatePreview();
    }

    // ===== å€å¡Šæ”¶åˆ =====
    function toggleSection(header) {
      header.classList.toggle('collapsed');
      header.nextElementSibling.classList.toggle('collapsed');
    }

    // ===== é è¦½åˆ†é åˆ‡æ› =====
    function switchPreviewTab(tab) {
      currentPreviewTab = tab;
      App.state.currentPreviewTab = tab; // åŒæ­¥åˆ° App ç‹€æ…‹

      document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.preview-tab:nth-child(${['card', 'json', 'yaml', 'markdown', 'txt'].indexOf(tab) + 1})`).classList.add('active');

      document.querySelectorAll('.character-preview, .code-preview').forEach(p => p.classList.remove('active'));

      // é¡¯ç¤º/éš±è—è¤‡è£½æŒ‰éˆ•
      const copyBtn = document.getElementById('copyPreviewBtn');
      if (tab === 'card') {
        document.getElementById('previewCard').classList.add('active');
        copyBtn.style.display = 'none'; // è§’è‰²å¡é è¦½ä¸é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
      } else if (tab === 'json') {
        document.getElementById('previewJSON').classList.add('active');
        copyBtn.style.display = 'flex';
      } else if (tab === 'yaml') {
        document.getElementById('previewYAML').classList.add('active');
        copyBtn.style.display = 'flex';
      } else if (tab === 'markdown') {
        document.getElementById('previewMarkdown').classList.add('active');
        copyBtn.style.display = 'flex';
      } else if (tab === 'txt') {
        document.getElementById('previewTXT').classList.add('active');
        copyBtn.style.display = 'flex';
      }

      updatePreview();
    }

    // ===== æ”¶é›†è¡¨å–®è³‡æ–™ =====
    function collectFormData() {
      return {
        avatarUrl: document.getElementById('avatarUrl').value,
        name: document.getElementById('name').value,
        aliases: document.getElementById('aliases').value,
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        species: document.getElementById('species').value,
        occupation: document.getElementById('occupation').value,
        appearance: document.getElementById('appearance').value,
        height: document.getElementById('height').value,
        bodyType: document.getElementById('bodyType').value,
        hairColor: document.getElementById('hairColor').value,
        hairStyle: document.getElementById('hairStyle').value,
        eyes: document.getElementById('eyes').value,
        clothing: document.getElementById('clothing').value,
        features: document.getElementById('features').value,
        personality: document.getElementById('personality').value,
        traits: document.getElementById('traits').value,
        strengths: document.getElementById('strengths').value,
        weaknesses: document.getElementById('weaknesses').value,
        likes: document.getElementById('likes').value,
        dislikes: document.getElementById('dislikes').value,
        fears: document.getElementById('fears').value,
        goals: document.getElementById('goals').value,
        emotionalAttitude: document.getElementById('emotionalAttitude').value,
        moneyAttitude: document.getElementById('moneyAttitude').value,
        morality: document.getElementById('morality').value,
        birthplace: document.getElementById('birthplace').value,
        backstory: document.getElementById('backstory').value,
        keyEvents: document.getElementById('keyEvents').value,
        // å‹•æ…‹æ¬„ä½
        relationships: App.dynamicFields.collect('relationships'),
        combatSkills: App.dynamicFields.collect('combatSkills'),
        lifeSkills: App.dynamicFields.collect('lifeSkills'),
        customAttributes: App.dynamicFields.collect('customAttributes'),
        speechStyle: App.dynamicFields.collect('speechStyle'),
        // å…¶ä»–æ¬„ä½
        catchphrases: document.getElementById('catchphrases').value,
        verbalTics: document.getElementById('verbalTics').value,
        emotionalExpression: document.getElementById('emotionalExpression').value,
        description: document.getElementById('description').value,
        systemPrompt: document.getElementById('systemPrompt').value,
        firstMessage: document.getElementById('firstMessage').value,
        exampleDialogues: document.getElementById('exampleDialogues').value,
        scenario: document.getElementById('scenario').value,
        tags: document.getElementById('tags').value,
        worldLore: document.getElementById('worldLore').value,
        creator: document.getElementById('creator').value,
        version: document.getElementById('version').value
      };
    }

    // ===== æ›´æ–°é è¦½ =====
    function updatePreview() {
      const data = collectFormData();

      // æ›´æ–°è§’è‰²å¡é è¦½
      updateCardPreview(data);

      // æ›´æ–°ç¨‹å¼ç¢¼é è¦½
      updateCodePreviews(data);
    }

    // ===== æ›´æ–°è§’è‰²å¡è¦–è¦ºé è¦½ =====
    function updateCardPreview(data) {
      // åç¨±èˆ‡åˆ¥å
      document.getElementById('previewName').textContent = data.name || 'æœªå‘½åè§’è‰²';
      document.getElementById('previewAliases').textContent = data.aliases ? `åˆç¨±ï¼š${data.aliases}` : '';

      // é ­åƒåœ–ç‰‡æˆ–æ–‡å­—
      const avatarEl = document.getElementById('previewAvatar');
      if (data.avatarUrl && data.avatarUrl.trim() !== '') {
        // ä½¿ç”¨åœ–ç‰‡
        avatarEl.innerHTML = `<img src="${data.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.parentElement.textContent='${data.name ? data.name.charAt(0) : 'ğŸ­'}'">`;
      } else {
        // ä½¿ç”¨æ–‡å­—ï¼ˆå–åå­—ç¬¬ä¸€å€‹å­—ï¼‰
        const avatarChar = data.name ? data.name.charAt(0) : 'ğŸ­';
        avatarEl.textContent = avatarChar;
      }

      // æ¨™ç±¤
      const tagsContainer = document.getElementById('previewTags');
      tagsContainer.innerHTML = '';
      if (data.tags) {
        data.tags.split(',').forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'preview-tag';
          tagEl.textContent = tag.trim();
          tagsContainer.appendChild(tagEl);
        });
      }

      // åŸºæœ¬è³‡è¨Šæ ¼
      const basicGrid = document.getElementById('previewBasicGrid');
      basicGrid.innerHTML = '';
      const basicFields = [
        { label: 'å¹´é½¡', value: data.age },
        { label: 'æ€§åˆ¥', value: data.gender },
        { label: 'ç¨®æ—', value: data.species },
        { label: 'è·æ¥­', value: data.occupation }
      ];
      basicFields.forEach(field => {
        if (field.value) {
          basicGrid.innerHTML += `
            <div class="preview-item">
              <span class="preview-item-label">${field.label}</span>
              <span class="preview-item-value">${field.value}</span>
            </div>
          `;
        }
      });

      // å¤–è§€
      const appearanceSection = document.getElementById('previewAppearanceSection');
      const appearanceContent = document.getElementById('previewAppearance');
      let hasAppearance = data.appearance || (isFullMode && (data.height || data.bodyType || data.hairColor || data.hairStyle || data.eyes || data.clothing || data.features));

      if (hasAppearance) {
        appearanceSection.style.display = 'block';
        let appearanceText = data.appearance || '';

        // å®Œæ•´ç‰ˆå°ˆå±¬è©³ç´°æ¬„ä½
        if (isFullMode) {
          const details = [];
          if (data.height) details.push(`èº«é«˜ï¼š${data.height}`);
          if (data.bodyType) details.push(`é«”å‹ï¼š${data.bodyType}`);
          if (data.hairColor) details.push(`é«®è‰²ï¼š${data.hairColor}`);
          if (data.hairStyle) details.push(`é«®å‹ï¼š${data.hairStyle}`);
          if (data.eyes) details.push(`çœ¼ç›ï¼š${data.eyes}`);
          if (data.clothing) details.push(`æœè£ï¼š${data.clothing}`);
          if (data.features) details.push(`ç‰¹å¾µï¼š${data.features}`);

          if (details.length > 0) {
            appearanceText += (appearanceText ? '\n\n' : '') + details.join('\n');
          }
        }

        appearanceContent.textContent = appearanceText;
      } else {
        appearanceSection.style.display = 'none';
      }

      // æ€§æ ¼
      const personalitySection = document.getElementById('previewPersonalitySection');
      const personalityContent = document.getElementById('previewPersonality');
      let hasPersonality = data.personality || data.traits || (isFullMode && (data.strengths || data.weaknesses || data.likes || data.dislikes || data.fears || data.goals));

      if (hasPersonality) {
        personalitySection.style.display = 'block';
        let personalityText = data.personality || '';
        if (data.traits) {
          personalityText += (personalityText ? '\n\n' : '') + 'ç‰¹è³ªï¼š' + data.traits;
        }

        // å®Œæ•´ç‰ˆå°ˆå±¬è©³ç´°æ¬„ä½
        if (isFullMode) {
          const details = [];
          if (data.strengths) details.push(`å„ªé»ï¼š${data.strengths}`);
          if (data.weaknesses) details.push(`ç¼ºé»ï¼š${data.weaknesses}`);
          if (data.likes) details.push(`å–œå¥½ï¼š${data.likes}`);
          if (data.dislikes) details.push(`å­æƒ¡ï¼š${data.dislikes}`);
          if (data.fears) details.push(`ææ‡¼ï¼š${data.fears}`);
          if (data.goals) details.push(`ç›®æ¨™ï¼š${data.goals}`);

          if (details.length > 0) {
            personalityText += (personalityText ? '\n\n' : '') + details.join('\n');
          }
        }

        personalityContent.textContent = personalityText;
      } else {
        personalitySection.style.display = 'none';
      }

      // èƒŒæ™¯ï¼ˆå®Œæ•´ç‰ˆé™å®šï¼‰
      const backstorySection = document.getElementById('previewBackstorySection');
      const backstoryContent = document.getElementById('previewBackstory');
      let hasBackstory = isFullMode && (data.backstory || data.birthplace || data.keyEvents);

      if (hasBackstory) {
        backstorySection.style.display = 'block';
        let backstoryText = '';

        if (data.birthplace) backstoryText += `å‡ºç”Ÿåœ°ï¼š${data.birthplace}\n\n`;
        if (data.backstory) backstoryText += data.backstory;
        if (data.keyEvents) backstoryText += (backstoryText ? '\n\n' : '') + `é‡è¦äº‹ä»¶ï¼š${data.keyEvents}`;

        backstoryContent.textContent = backstoryText;
      } else {
        backstorySection.style.display = 'none';
      }

      // äººéš›é—œä¿‚ï¼ˆå®Œæ•´ç‰ˆé™å®šï¼‰
      const relationshipsSection = document.getElementById('previewRelationshipsSection');
      const relationshipsContent = document.getElementById('previewRelationships');
      if (Array.isArray(data.relationships) && data.relationships.length > 0 && isFullMode) {
        relationshipsSection.style.display = 'block';
        let relationshipsHTML = '';
        data.relationships.forEach(item => {
          if (item.name && item.description) {
            relationshipsHTML += `<div style="margin-bottom: 8px;"><strong>${item.name}</strong>ï¼š${item.description}</div>`;
          }
        });
        relationshipsContent.innerHTML = relationshipsHTML;
      } else {
        relationshipsSection.style.display = 'none';
      }

      // ç¬¬ä¸€å‰‡è¨Šæ¯
      const firstMessageSection = document.getElementById('previewFirstMessageSection');
      const firstMessageContent = document.getElementById('previewFirstMessage');
      if (data.firstMessage) {
        firstMessageSection.style.display = 'block';
        firstMessageContent.textContent = data.firstMessage;
      } else {
        firstMessageSection.style.display = 'none';
      }
    }

    // ===== æ›´æ–°ç¨‹å¼ç¢¼é è¦½ =====
    function updateCodePreviews(data) {
      // JSON
      const jsonOutput = convertToJSON(data, currentPlatform);
      document.getElementById('jsonCode').textContent = jsonOutput;

      // YAML
      const yamlOutput = convertToYAML(data, currentPlatform);
      document.getElementById('yamlCode').textContent = yamlOutput;

      // Markdown
      const mdOutput = convertToMarkdown(data, currentPlatform);
      document.getElementById('markdownCode').textContent = mdOutput;

      // TXT
      const txtOutput = convertToTXT(data, currentPlatform);
      document.getElementById('txtCode').textContent = txtOutput;
    }

    // ===== æ ¼å¼è½‰æ›å‡½æ•¸ï¼ˆå‰ç«¯ç‰ˆæœ¬ï¼‰ =====
    
    function convertToJSON(data, platform) {
      let output;
      switch(platform) {
        case 'sillytavern':
          output = convertToSillyTavernFormat(data);
          break;
        case 'risuai':
          output = convertToRisuAIFormat(data);
          break;
        case 'characterai':
          output = convertToCharacterAIFormat(data);
          break;
        case 'gemini':
        default:
          output = convertToGeminiFormat(data);
          break;
      }

      // ç§»é™¤ç©ºå€¼æ¬„ä½
      output = removeEmptyFields(output);

      return JSON.stringify(output, null, 2);
    }

    function convertToYAML(data, platform) {
      let output;
      switch(platform) {
        case 'sillytavern':
          output = convertToSillyTavernFormat(data);
          break;
        case 'risuai':
          output = convertToRisuAIFormat(data);
          break;
        case 'characterai':
          output = convertToCharacterAIFormat(data);
          break;
        case 'gemini':
        default:
          output = convertToGeminiFormat(data);
          break;
      }

      // ç§»é™¤ç©ºå€¼æ¬„ä½
      output = removeEmptyFields(output);

      return objectToYAML(output, 0);
    }

    /**
     * ç²å–å¹³å°é¡¯ç¤ºåç¨±
     */
    function getPlatformName(platform) {
      const platformNames = {
        'gemini': 'Gemini 3.0',
        'sillytavern': 'SillyTavern',
        'risuai': 'RisuAI',
        'characterai': 'Character.AI'
      };
      return platformNames[platform] || platform;
    }

    function convertToMarkdown(data, platform) {
      const platformNames = {
        'gemini': 'Gemini 3.0',
        'sillytavern': 'SillyTavern',
        'risuai': 'RisuAI',
        'characterai': 'Character.AI'
      };

      let md = `# ${data.name || 'æœªå‘½åè§’è‰²'}\n\n`;
      md += `> å¹³å°ï¼š${platformNames[platform]} | ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n\n`;
      
      // åŸºæœ¬è³‡è¨Š
      md += `## ğŸ“‹ åŸºæœ¬è³‡è¨Š\n\n`;
      md += `| é …ç›® | å…§å®¹ |\n|------|------|\n`;
      if (data.name) md += `| åç¨± | ${data.name} |\n`;
      if (data.aliases) md += `| åˆ¥å | ${data.aliases} |\n`;
      if (data.age) md += `| å¹´é½¡ | ${data.age} |\n`;
      if (data.gender) md += `| æ€§åˆ¥ | ${data.gender} |\n`;
      if (data.species) md += `| ç¨®æ— | ${data.species} |\n`;
      if (data.occupation) md += `| è·æ¥­ | ${data.occupation} |\n`;
      md += `\n`;
      
      // å¤–è§€æè¿°
      if (data.appearance || (isFullMode && (data.height || data.bodyType || data.hairColor || data.hairStyle || data.eyes || data.clothing || data.features))) {
        md += `## ğŸ‘¤ å¤–è§€æè¿°\n\n`;
        if (data.appearance) md += `${data.appearance}\n\n`;
        // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
        if (isFullMode) {
          if (data.height) md += `**èº«é«˜**ï¼š${data.height}\n\n`;
          if (data.bodyType) md += `**é«”å‹**ï¼š${data.bodyType}\n\n`;
          if (data.hairColor) md += `**é«®è‰²**ï¼š${data.hairColor}\n\n`;
          if (data.hairStyle) md += `**é«®å‹**ï¼š${data.hairStyle}\n\n`;
          if (data.eyes) md += `**çœ¼ç›**ï¼š${data.eyes}\n\n`;
          if (data.clothing) md += `**æœè£é¢¨æ ¼**ï¼š${data.clothing}\n\n`;
          if (data.features) md += `**ç‰¹æ®Šæ¨™è¨˜**ï¼š${data.features}\n\n`;
        }
      }
      
      // æ€§æ ¼
      if (data.personality || data.traits || (isFullMode && (data.emotionalAttitude || data.strengths || data.weaknesses || data.likes || data.dislikes || data.fears || data.goals || data.moneyAttitude || data.morality))) {
        md += `## ğŸ’­ æ€§æ ¼ç‰¹è³ª\n\n`;
        if (data.personality) md += `${data.personality}\n\n`;
        if (data.traits) md += `**ç‰¹è³ªæ¨™ç±¤**ï¼š${data.traits}\n\n`;
        // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
        if (isFullMode) {
          if (data.emotionalAttitude) md += `**é‡å°æ„Ÿæƒ…**ï¼š${data.emotionalAttitude}\n\n`;
          if (data.strengths) md += `**å„ªé»**ï¼š${data.strengths}\n\n`;
          if (data.weaknesses) md += `**ç¼ºé»**ï¼š${data.weaknesses}\n\n`;
          if (data.likes) md += `**å–œå¥½**ï¼š${data.likes}\n\n`;
          if (data.dislikes) md += `**å­æƒ¡**ï¼š${data.dislikes}\n\n`;
          if (data.fears) md += `**ææ‡¼**ï¼š${data.fears}\n\n`;
          if (data.goals) md += `**ç›®æ¨™**ï¼š${data.goals}\n\n`;
          if (data.moneyAttitude) md += `**é‡‘éŒ¢è§€**ï¼š${data.moneyAttitude}\n\n`;
          if (data.morality) md += `**é“å¾·**ï¼š${data.morality}\n\n`;
        }
      }
      
      // æŠ€èƒ½ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰- å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (Array.isArray(data.combatSkills) && data.combatSkills.length > 0 ||
          Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0)) {
        md += `## âš”ï¸ æŠ€èƒ½\n\n`;
        if (Array.isArray(data.combatSkills) && data.combatSkills.length > 0) {
          md += `**æˆ°é¬¥æŠ€èƒ½**ï¼š\n\n`;
          data.combatSkills.forEach(item => {
            if (item.skill) {
              md += `- ${item.skill}${item.level ? ` (${item.level})` : ''}\n`;
            }
          });
          md += '\n';
        }
        if (Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0) {
          md += `**ç”Ÿæ´»æŠ€èƒ½**ï¼š\n\n`;
          data.lifeSkills.forEach(item => {
            if (item.skill) {
              md += `- ${item.skill}${item.level ? ` (${item.level})` : ''}\n`;
            }
          });
          md += '\n';
        }
      }

      // è‡ªè¨‚å±¬æ€§ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰- å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && Array.isArray(data.customAttributes) && data.customAttributes.length > 0) {
        md += `## ğŸ“Š è‡ªè¨‚å±¬æ€§\n\n`;
        md += `| å±¬æ€§ | å€¼ |\n|------|------|\n`;
        data.customAttributes.forEach(item => {
          if (item.attribute && item.value) {
            md += `| ${item.attribute} | ${item.value} |\n`;
          }
        });
        md += '\n';
      }

      // èƒŒæ™¯æ•…äº‹ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (data.backstory || data.birthplace || data.keyEvents ||
          (Array.isArray(data.relationships) && data.relationships.length > 0))) {
        md += `## ğŸ“– èƒŒæ™¯æ•…äº‹\n\n`;
        if (data.birthplace) md += `**å‡ºç”Ÿåœ°**ï¼š${data.birthplace}\n\n`;
        if (data.backstory) md += `${data.backstory}\n\n`;
        if (data.keyEvents) md += `**é‡è¦äº‹ä»¶**ï¼š${data.keyEvents}\n\n`;

        // äººéš›é—œä¿‚ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰
        if (Array.isArray(data.relationships) && data.relationships.length > 0) {
          md += `**äººéš›é—œä¿‚**ï¼š\n\n`;
          data.relationships.forEach(item => {
            if (item.name && item.description) {
              md += `- **${item.name}**ï¼š${item.description}\n`;
            }
          });
          md += '\n';
        }
      }

      // å°è©±é¢¨æ ¼ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && ((Array.isArray(data.speechStyle) && data.speechStyle.length > 0) ||
          data.catchphrases || data.verbalTics || data.emotionalExpression)) {
        md += `## ğŸ—£ï¸ å°è©±é¢¨æ ¼\n\n`;

        // èªªè©±æ–¹å¼ï¼ˆå‹•æ…‹æ¬„ä½ï¼‰
        if (Array.isArray(data.speechStyle) && data.speechStyle.length > 0) {
          md += `**èªªè©±æ–¹å¼ç¯„ä¾‹**ï¼š\n\n`;
          data.speechStyle.forEach(item => {
            if (item.situation && item.dialogue) {
              md += `- **${item.situation}**ï¼š${item.dialogue}\n`;
            }
          });
          md += '\n';
        }

        if (data.catchphrases) md += `**å£é ­ç¦ª**ï¼š${data.catchphrases}\n\n`;
        if (data.verbalTics) md += `**èªè¨€ç¿’æ…£**ï¼š${data.verbalTics}\n\n`;
        if (data.emotionalExpression) md += `**æƒ…ç·’è¡¨é”**ï¼š${data.emotionalExpression}\n\n`;
      }
      
      // AI æ ¸å¿ƒè¨­å®š
      md += `## ğŸ¤– AI æ ¸å¿ƒè¨­å®š\n\n`;
      if (data.description) md += `### è§’è‰²æè¿°\n\n${data.description}\n\n`;
      // systemPrompt å’Œ scenario æ˜¯å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && data.systemPrompt) md += `### ç³»çµ±æç¤º\n\n${data.systemPrompt}\n\n`;
      if (data.firstMessage) md += `### ç¬¬ä¸€å‰‡è¨Šæ¯\n\n${data.firstMessage}\n\n`;
      if (!isFullMode && data.exampleDialogues) md += `### ç¯„ä¾‹å°è©±\n\n${data.exampleDialogues}\n\n`; // ç²¾ç°¡ç‰ˆå°ˆå±¬
      if (isFullMode && data.scenario) md += `### åˆæ¬¡ç›¸é‡åœ°é»\n\n${data.scenario}\n\n`;

      // å…ƒè³‡æ–™
      if (data.tags || data.creator || (isFullMode && (data.worldLore || data.version))) {
        md += `## ğŸ“ å…ƒè³‡æ–™\n\n`;
        if (data.tags) md += `**æ¨™ç±¤**ï¼š${data.tags}\n\n`;
        // worldLore å’Œ version æ˜¯å®Œæ•´ç‰ˆå°ˆå±¬
        if (isFullMode && data.worldLore) md += `**ä¸–ç•Œè§€**ï¼š${data.worldLore}\n\n`;
        if (data.creator) md += `**å‰µä½œè€…**ï¼š${data.creator}\n\n`;
        if (isFullMode && data.version) md += `**ç‰ˆæœ¬**ï¼š${data.version}\n\n`;
      }
      
      md += `---\n*ç”± AIäº’å‹•èŠå¤©è§’è‰²å¡å·¥å…·ç”Ÿæˆ*\n`;
      
      return md;
    }

    /**
     * è½‰æ›ç‚º TXT æ ¼å¼ï¼ˆå¤§æ¨™åŠ å°æ¨™çš„ç°¡å–®æ ¼å¼ï¼‰
     */
    function convertToTXT(data, platform) {
      let txt = '';

      // åŸºæœ¬è³‡è¨Š
      txt += 'åŸºæœ¬è³‡è¨Š :\n';
      if (data.name) txt += ` -åç¨± : ${data.name}\n`;
      if (data.aliases) txt += ` -åˆ¥å : ${data.aliases}\n`;
      if (data.age) txt += ` -å¹´é½¡ : ${data.age}\n`;
      if (data.gender) txt += ` -æ€§åˆ¥ : ${data.gender}\n`;
      if (data.species) txt += ` -ç¨®æ— : ${data.species}\n`;
      if (data.occupation) txt += ` -è·æ¥­ : ${data.occupation}\n`;
      txt += '\n';

      // å¤–è§€æè¿°
      if (data.appearance || (isFullMode && (data.height || data.bodyType || data.hairColor || data.hairStyle || data.eyes || data.clothing || data.features))) {
        txt += 'å¤–è§€æè¿° :\n';
        if (data.appearance) txt += ` -æ•´é«”å¤–è§€ : ${data.appearance}\n`;
        // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
        if (isFullMode) {
          if (data.height) txt += ` -èº«é«˜ : ${data.height}\n`;
          if (data.bodyType) txt += ` -é«”å‹ : ${data.bodyType}\n`;
          if (data.hairColor) txt += ` -é«®è‰² : ${data.hairColor}\n`;
          if (data.hairStyle) txt += ` -é«®å‹ : ${data.hairStyle}\n`;
          if (data.eyes) txt += ` -çœ¼ç› : ${data.eyes}\n`;
          if (data.clothing) txt += ` -æœè£é¢¨æ ¼ : ${data.clothing}\n`;
          if (data.features) txt += ` -ç‰¹æ®Šæ¨™è¨˜ : ${data.features}\n`;
        }
        txt += '\n';
      }

      // æ€§æ ¼ç‰¹è³ª
      if (data.personality || data.traits || (isFullMode && (data.strengths || data.weaknesses || data.likes || data.dislikes || data.fears || data.goals || data.emotionalAttitude || data.moneyAttitude || data.morality))) {
        txt += 'æ€§æ ¼ç‰¹è³ª :\n';
        if (data.personality) txt += ` -æ€§æ ¼æ‘˜è¦ : ${data.personality}\n`;
        if (data.traits) txt += ` -ç‰¹è³ªæ¨™ç±¤ : ${data.traits}\n`;
        // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
        if (isFullMode) {
          if (data.emotionalAttitude) txt += ` -é‡å°æ„Ÿæƒ… : ${data.emotionalAttitude}\n`;
          if (data.strengths) txt += ` -å„ªé» : ${data.strengths}\n`;
          if (data.weaknesses) txt += ` -ç¼ºé» : ${data.weaknesses}\n`;
          if (data.likes) txt += ` -å–œå¥½ : ${data.likes}\n`;
          if (data.dislikes) txt += ` -å­æƒ¡ : ${data.dislikes}\n`;
          if (data.fears) txt += ` -ææ‡¼ : ${data.fears}\n`;
          if (data.goals) txt += ` -ç›®æ¨™ : ${data.goals}\n`;
          if (data.moneyAttitude) txt += ` -é‡‘éŒ¢è§€ : ${data.moneyAttitude}\n`;
          if (data.morality) txt += ` -é“å¾· : ${data.morality}\n`;
        }
        txt += '\n';
      }

      // æŠ€èƒ½ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (Array.isArray(data.combatSkills) && data.combatSkills.length > 0 ||
          Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0)) {
        txt += 'æŠ€èƒ½ :\n';
        if (Array.isArray(data.combatSkills) && data.combatSkills.length > 0) {
          txt += ` -æˆ°é¬¥æŠ€èƒ½ : ${data.combatSkills.map(item => item.skill + (item.level ? `(${item.level})` : '')).join(', ')}\n`;
        }
        if (Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0) {
          txt += ` -ç”Ÿæ´»æŠ€èƒ½ : ${data.lifeSkills.map(item => item.skill + (item.level ? `(${item.level})` : '')).join(', ')}\n`;
        }
        txt += '\n';
      }

      // è‡ªè¨‚å±¬æ€§ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && Array.isArray(data.customAttributes) && data.customAttributes.length > 0) {
        txt += 'è‡ªè¨‚å±¬æ€§ :\n';
        data.customAttributes.forEach(item => {
          if (item.attribute && item.value) {
            txt += ` -${item.attribute} : ${item.value}\n`;
          }
        });
        txt += '\n';
      }

      // èƒŒæ™¯æ•…äº‹ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (data.backstory || data.birthplace || data.keyEvents)) {
        txt += 'èƒŒæ™¯æ•…äº‹ :\n';
        if (data.birthplace) txt += ` -å‡ºç”Ÿåœ° : ${data.birthplace}\n`;
        if (data.backstory) txt += ` -èƒŒæ™¯ : ${data.backstory}\n`;
        if (data.keyEvents) txt += ` -é‡è¦äº‹ä»¶ : ${data.keyEvents}\n`;
        txt += '\n';
      }

      // å°è©±é¢¨æ ¼ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (data.catchphrases || data.verbalTics || data.emotionalExpression)) {
        txt += 'å°è©±é¢¨æ ¼ :\n';
        if (data.catchphrases) txt += ` -å£é ­ç¦ª : ${data.catchphrases}\n`;
        if (data.verbalTics) txt += ` -èªè¨€ç¿’æ…£ : ${data.verbalTics}\n`;
        if (data.emotionalExpression) txt += ` -æƒ…ç·’è¡¨é” : ${data.emotionalExpression}\n`;
        txt += '\n';
      }

      // äººéš›é—œä¿‚ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && Array.isArray(data.relationships) && data.relationships.length > 0) {
        txt += 'äººéš›é—œä¿‚ :\n';
        data.relationships.forEach(item => {
          if (item.name && item.description) {
            txt += ` -${item.name} : ${item.description}\n`;
          }
        });
        txt += '\n';
      }

      // AI æ ¸å¿ƒè¨­å®š
      txt += 'AI æ ¸å¿ƒè¨­å®š :\n';
      if (data.description) txt += ` -è§’è‰²æè¿° : ${data.description}\n`;
      // systemPrompt å’Œ scenario æ˜¯å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && data.systemPrompt) txt += ` -ç³»çµ±æç¤º : ${data.systemPrompt}\n`;
      if (data.firstMessage) txt += ` -ç¬¬ä¸€å‰‡è¨Šæ¯ : ${data.firstMessage}\n`;
      if (!isFullMode && data.exampleDialogues) txt += ` -ç¯„ä¾‹å°è©± : ${data.exampleDialogues}\n`; // ç²¾ç°¡ç‰ˆå°ˆå±¬
      if (isFullMode && data.scenario) txt += ` -åˆæ¬¡ç›¸é‡åœ°é» : ${data.scenario}\n`;
      txt += '\n';

      // å…ƒè³‡æ–™
      if (data.tags || data.creator || (isFullMode && (data.worldLore || data.version))) {
        txt += 'å…ƒè³‡æ–™ :\n';
        if (data.tags) txt += ` -æ¨™ç±¤ : ${data.tags}\n`;
        // worldLore å’Œ version æ˜¯å®Œæ•´ç‰ˆå°ˆå±¬
        if (isFullMode && data.worldLore) txt += ` -ä¸–ç•Œè¨­å®š : ${data.worldLore}\n`;
        if (data.creator) txt += ` -å‰µä½œè€… : ${data.creator}\n`;
        if (isFullMode && data.version) txt += ` -ç‰ˆæœ¬ : ${data.version}\n`;
      }

      return txt;
    }

    /**
     * ç§»é™¤ç‰©ä»¶ä¸­çš„ç©ºå€¼æ¬„ä½
     */
    function removeEmptyFields(obj) {
      if (Array.isArray(obj)) {
        return obj.filter(item => {
          if (typeof item === 'object' && item !== null) {
            return Object.keys(removeEmptyFields(item)).length > 0;
          }
          return item !== '' && item !== null && item !== undefined;
        }).map(item => {
          if (typeof item === 'object' && item !== null) {
            return removeEmptyFields(item);
          }
          return item;
        });
      }

      if (typeof obj !== 'object' || obj === null) {
        return obj;
      }

      const result = {};
      for (const [key, value] of Object.entries(obj)) {
        if (value === '' || value === null || value === undefined) {
          continue; // è·³éç©ºå€¼
        }

        if (Array.isArray(value)) {
          const filtered = removeEmptyFields(value);
          if (filtered.length > 0) {
            result[key] = filtered;
          }
        } else if (typeof value === 'object') {
          const filtered = removeEmptyFields(value);
          if (Object.keys(filtered).length > 0) {
            result[key] = filtered;
          }
        } else {
          result[key] = value;
        }
      }
      return result;
    }

    // å¹³å°ç‰¹å®šæ ¼å¼
    function convertToSillyTavernFormat(data) {
      return {
        spec: "chara_card_v2",
        spec_version: "2.0",
        data: {
          name: data.name || "",
          description: buildCharacterDescription(data),
          personality: data.personality || "",
          scenario: data.scenario || "",
          first_mes: data.firstMessage || "",
          mes_example: data.exampleDialogues || "",
          creator_notes: data.creatorNotes || "",
          system_prompt: data.systemPrompt || "",
          post_history_instructions: "",
          alternate_greetings: [],
          tags: data.tags ? data.tags.split(',').map(t => t.trim()) : [],
          creator: data.creator || "",
          character_version: data.version || "1.0",
          extensions: {
            world: data.worldLore || "",
            depth_prompt: { prompt: "", depth: 4 }
          }
        }
      };
    }

    function convertToRisuAIFormat(data) {
      return {
        type: "risuai",
        ver: 1,
        data: {
          name: data.name || "",
          firstMessage: data.firstMessage || "",
          description: buildCharacterDescription(data),
          personality: data.personality || "",
          scenario: data.scenario || "",
          exampleMessage: data.exampleDialogues || "",
          creatorNotes: data.creatorNotes || "",
          systemPrompt: data.systemPrompt || "",
          tags: data.tags ? data.tags.split(',').map(t => t.trim()) : [],
          creator: data.creator || "",
          characterVersion: data.version || "1.0",
          lorebook: {
            name: data.worldLore ? "World Lore" : "",
            entries: data.worldLore ? [{
              keys: [data.name || "character"],
              content: data.worldLore,
              enabled: true
            }] : []
          }
        }
      };
    }

    function convertToCharacterAIFormat(data) {
      let definition = "";
      if (data.name) definition += `{{char}} is named ${data.name}. `;
      if (data.age) definition += `{{char}} is ${data.age} years old. `;
      if (data.gender) definition += `{{char}}'s gender is ${data.gender}. `;
      if (data.species && data.species !== 'äººé¡') definition += `{{char}} is a ${data.species}. `;
      if (data.occupation) definition += `{{char}} works as ${data.occupation}. `;
      if (data.appearance) definition += `${data.appearance} `;
      if (data.personality) definition += `${data.personality} `;
      if (data.speechStyle) definition += `{{char}} speaks in a ${data.speechStyle} manner. `;
      // èƒŒæ™¯æ•…äº‹ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && data.backstory) definition += `${data.backstory} `;

      return {
        name: data.name || "",
        title: data.aliases || "",
        description: data.description || definition.trim(),
        greeting: data.firstMessage || "",
        definition: definition.trim(),
        visibility: "private",
        copyable: true,
        categories: data.tags ? data.tags.split(',').map(t => t.trim()) : []
      };
    }

    function convertToGeminiFormat(data) {
      // è½‰æ›å‹•æ…‹æ¬„ä½æ ¼å¼
      const formatSkills = (skillsArray) => {
        if (!Array.isArray(skillsArray)) return [];
        return skillsArray.map(item =>
          item.level ? `${item.skill} (${item.level})` : item.skill
        ).filter(s => s);
      };

      const formatAttributes = (attrsArray) => {
        if (!Array.isArray(attrsArray)) return {};
        const result = {};
        attrsArray.forEach(item => {
          if (item.attribute && item.value) {
            result[item.attribute] = item.value;
          }
        });
        return result;
      };

      const formatRelationships = (relsArray) => {
        if (!Array.isArray(relsArray)) return [];
        return relsArray.map(item => ({
          name: item.name || "",
          relationship: item.description || ""
        })).filter(r => r.name || r.relationship);
      };

      const formatSpeechStyles = (stylesArray) => {
        if (!Array.isArray(stylesArray)) return [];
        return stylesArray.map(item => ({
          situation: item.situation || "",
          dialogue: item.dialogue || ""
        })).filter(s => s.situation || s.dialogue);
      };

      // åŸºç¤è¼¸å‡ºçµæ§‹
      const output = {
        character_info: {
          name: data.name || "",
          aliases: data.aliases ? data.aliases.split(',').map(a => a.trim()) : [],
          age: data.age || "",
          gender: data.gender || "",
          species: data.species || "",
          occupation: data.occupation || "",
          avatar_url: data.avatarUrl || ""
        },
        appearance: {
          general: data.appearance || ""
        },
        personality: {
          summary: data.personality || "",
          traits: data.traits ? data.traits.split(',').map(t => t.trim()) : []
        },
        ai_instructions: {
          system_prompt: data.systemPrompt || "",
          character_description: data.description || "",
          first_message: data.firstMessage || "",
          example_dialogues: data.exampleDialogues || "",
          scenario: data.scenario || ""
        },
        metadata: {
          tags: data.tags ? data.tags.split(',').map(t => t.trim()) : [],
          world_lore: data.worldLore || "",
          creator: data.creator || "",
          version: data.version || "1.0",
          created_at: new Date().toISOString()
        }
      };

      // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
      if (isFullMode) {
        // å¤–è§€è©³ç´°æ¬„ä½
        output.appearance.height = data.height || "";
        output.appearance.body_type = data.bodyType || "";
        output.appearance.hair_color = data.hairColor || "";
        output.appearance.hair_style = data.hairStyle || "";
        output.appearance.eyes = data.eyes || "";
        output.appearance.clothing = data.clothing || "";
        output.appearance.distinguishing_features = data.features || "";

        // æ€§æ ¼è©³ç´°æ¬„ä½
        output.personality.strengths = data.strengths ? data.strengths.split(',').map(s => s.trim()) : [];
        output.personality.weaknesses = data.weaknesses ? data.weaknesses.split(',').map(w => w.trim()) : [];
        output.personality.likes = data.likes ? data.likes.split(',').map(l => l.trim()) : [];
        output.personality.dislikes = data.dislikes ? data.dislikes.split(',').map(d => d.trim()) : [];
        output.personality.fears = data.fears ? data.fears.split(',').map(f => f.trim()) : [];
        output.personality.goals = data.goals ? data.goals.split(',').map(g => g.trim()) : [];

        // æŠ€èƒ½
        output.skills = {
          combat_skills: formatSkills(data.combatSkills),
          life_skills: formatSkills(data.lifeSkills)
        };

        // è‡ªè¨‚å±¬æ€§
        output.attributes = formatAttributes(data.customAttributes);

        // èƒŒæ™¯æ•…äº‹
        output.background = {
          birthplace: data.birthplace || "",
          backstory: data.backstory || "",
          key_events: data.keyEvents || "",
          relationships: formatRelationships(data.relationships)
        };

        // èªªè©±æ–¹å¼
        output.speech_patterns = {
          examples: formatSpeechStyles(data.speechStyle),
          catchphrases: data.catchphrases ? data.catchphrases.split(',').map(c => c.trim()) : [],
          verbal_tics: data.verbalTics || "",
          emotional_expression: data.emotionalExpression || ""
        };
      }

      return output;
    }

    function buildCharacterDescription(data) {
      let desc = "";

      if (data.name) desc += `Name: ${data.name}\n`;
      if (data.aliases) desc += `Also known as: ${data.aliases}\n`;
      if (data.age) desc += `Age: ${data.age}\n`;
      if (data.gender) desc += `Gender: ${data.gender}\n`;
      if (data.species) desc += `Species: ${data.species}\n`;
      if (data.occupation) desc += `Occupation: ${data.occupation}\n`;
      if (data.avatarUrl) desc += `Avatar: ${data.avatarUrl}\n`;
      desc += "\n";

      if (data.appearance || (isFullMode && (data.height || data.bodyType || data.hairColor || data.hairStyle || data.eyes || data.clothing || data.features))) {
        desc += "ã€Appearanceã€‘\n";
        if (data.appearance) desc += `${data.appearance}\n`;
        // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
        if (isFullMode) {
          if (data.height) desc += `Height: ${data.height}\n`;
          if (data.bodyType) desc += `Build: ${data.bodyType}\n`;
          if (data.hairColor) desc += `Hair Color: ${data.hairColor}\n`;
          if (data.hairStyle) desc += `Hair Style: ${data.hairStyle}\n`;
          if (data.eyes) desc += `Eyes: ${data.eyes}\n`;
          if (data.clothing) desc += `Clothing: ${data.clothing}\n`;
          if (data.features) desc += `Distinguishing features: ${data.features}\n`;
        }
        desc += "\n";
      }

      if (data.personality || data.traits || (isFullMode && (data.strengths || data.weaknesses || data.likes || data.dislikes || data.fears || data.goals))) {
        desc += "ã€Personalityã€‘\n";
        if (data.personality) desc += `${data.personality}\n`;
        if (data.traits) desc += `Traits: ${data.traits}\n`;
        // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
        if (isFullMode) {
          if (data.strengths) desc += `Strengths: ${data.strengths}\n`;
          if (data.weaknesses) desc += `Weaknesses: ${data.weaknesses}\n`;
          if (data.likes) desc += `Likes: ${data.likes}\n`;
          if (data.dislikes) desc += `Dislikes: ${data.dislikes}\n`;
          if (data.fears) desc += `Fears: ${data.fears}\n`;
          if (data.goals) desc += `Goals: ${data.goals}\n`;
        }
        desc += "\n";
      }

      // è™•ç†å‹•æ…‹æŠ€èƒ½æ¬„ä½ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (Array.isArray(data.combatSkills) && data.combatSkills.length > 0 ||
          Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0)) {
        desc += "ã€Skillsã€‘\n";
        if (Array.isArray(data.combatSkills) && data.combatSkills.length > 0) {
          const skills = data.combatSkills.map(item =>
            item.level ? `${item.skill} (${item.level})` : item.skill
          ).join(', ');
          desc += `Combat Skills: ${skills}\n`;
        }
        if (Array.isArray(data.lifeSkills) && data.lifeSkills.length > 0) {
          const skills = data.lifeSkills.map(item =>
            item.level ? `${item.skill} (${item.level})` : item.skill
          ).join(', ');
          desc += `Life Skills: ${skills}\n`;
        }
        desc += "\n";
      }

      // è™•ç†å‹•æ…‹å±¬æ€§æ¬„ä½ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && Array.isArray(data.customAttributes) && data.customAttributes.length > 0) {
        desc += "ã€Attributesã€‘\n";
        data.customAttributes.forEach(item => {
          if (item.attribute && item.value) {
            desc += `${item.attribute}: ${item.value}\n`;
          }
        });
        desc += "\n";
      }

      // èƒŒæ™¯æ•…äº‹ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (data.backstory || data.birthplace || data.keyEvents || (Array.isArray(data.relationships) && data.relationships.length > 0))) {
        desc += "ã€Backgroundã€‘\n";
        if (data.birthplace) desc += `Birthplace: ${data.birthplace}\n`;
        if (data.backstory) desc += `${data.backstory}\n`;
        if (data.keyEvents) desc += `Key events: ${data.keyEvents}\n`;

        // è™•ç†å‹•æ…‹äººéš›é—œä¿‚æ¬„ä½
        if (Array.isArray(data.relationships) && data.relationships.length > 0) {
          desc += "Relationships:\n";
          data.relationships.forEach(item => {
            if (item.name && item.description) {
              desc += `  - ${item.name}: ${item.description}\n`;
            }
          });
        }
        desc += "\n";
      }

      // è™•ç†å‹•æ…‹èªªè©±æ–¹å¼æ¬„ä½ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && (Array.isArray(data.speechStyle) && data.speechStyle.length > 0 ||
          data.catchphrases || data.verbalTics || data.emotionalExpression)) {
        desc += "ã€Speech Styleã€‘\n";
        if (Array.isArray(data.speechStyle) && data.speechStyle.length > 0) {
          data.speechStyle.forEach(item => {
            if (item.situation && item.dialogue) {
              desc += `When ${item.situation}: ${item.dialogue}\n`;
            }
          });
        }
        if (data.catchphrases) desc += `Catchphrases: ${data.catchphrases}\n`;
        if (data.verbalTics) desc += `Verbal habits: ${data.verbalTics}\n`;
        if (data.emotionalExpression) desc += `Emotional expression: ${data.emotionalExpression}\n`;
        desc += "\n";
      }

      if (data.description) {
        desc += "ã€Additional Descriptionã€‘\n";
        desc += `${data.description}\n`;
      }

      return desc.trim();
    }

    function objectToYAML(obj, indent) {
      let yaml = "";
      const spaces = "  ".repeat(indent);
      
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          const value = obj[key];
          
          if (value === null || value === undefined || value === "") {
            yaml += `${spaces}${key}: ~\n`;
          } else if (typeof value === "object" && !Array.isArray(value)) {
            yaml += `${spaces}${key}:\n`;
            yaml += objectToYAML(value, indent + 1);
          } else if (Array.isArray(value)) {
            if (value.length === 0) {
              yaml += `${spaces}${key}: []\n`;
            } else if (typeof value[0] === "object") {
              yaml += `${spaces}${key}:\n`;
              value.forEach(item => {
                yaml += `${spaces}  -\n`;
                yaml += objectToYAML(item, indent + 2);
              });
            } else {
              yaml += `${spaces}${key}:\n`;
              value.forEach(item => {
                yaml += `${spaces}  - "${String(item).replace(/"/g, '\\"')}"\n`;
              });
            }
          } else if (typeof value === "string" && (value.includes("\n") || value.length > 80)) {
            yaml += `${spaces}${key}: |\n`;
            value.split("\n").forEach(line => {
              yaml += `${spaces}  ${line}\n`;
            });
          } else if (typeof value === "string") {
            yaml += `${spaces}${key}: "${value.replace(/"/g, '\\"')}"\n`;
          } else {
            yaml += `${spaces}${key}: ${value}\n`;
          }
        }
      }
      
      return yaml;
    }

    // ===== æª”æ¡ˆåŒ¯å‡º =====
    function exportFile(format) {
      const data = collectFormData();

      // é©—è­‰è¡¨å–®
      if (!App.validator.validate(data)) {
        return;
      }

      // æª¢æŸ¥ç•¶å‰æä¾›å•†æ˜¯å¦æ”¯æ´è©²æ ¼å¼
      if (format === 'yaml' && !App.isPlatformSupported('yaml')) {
        const settings = App.settings.get();
        const providerName = App.ai.getProviderName(settings.aiProvider);
        showToast(`${providerName} ä¸æ”¯æ´ YAML æ ¼å¼åŒ¯å‡º`, 'warning');
        return;
      }

      const name = data.name || 'character';
      let content, mimeType, extension;

      switch(format) {
        case 'json':
          content = convertToJSON(data, currentPlatform);
          mimeType = 'application/json';
          extension = 'json';
          break;
        case 'yaml':
          content = convertToYAML(data, currentPlatform);
          mimeType = 'text/yaml';
          extension = 'yaml';
          break;
        case 'markdown':
          content = convertToMarkdown(data, currentPlatform);
          mimeType = 'text/markdown';
          extension = 'md';
          break;
      }

      const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}_${currentPlatform}.${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(`å·²åŒ¯å‡º ${format.toUpperCase()} æª”æ¡ˆï¼`, 'success');
    }

    /**
     * åŒ¯å‡ºç´”æ–‡å­—è§’è‰²å¡
     */
    function exportTextFile() {
      const data = collectFormData();

      if (!App.validator.validate(data)) {
        return;
      }

      // æ§‹å»ºç´”æ–‡å­—å…§å®¹
      let content = '';

      // åŸºæœ¬è³‡è¨Š
      if (data.name) content += `å§“å: ${data.name}\n`;
      if (data.age) content += `å¹´é½¡: ${data.age}\n`;
      if (data.gender) content += `æ€§åˆ¥: ${data.gender}\n`;
      if (data.species) content += `ç¨®æ—/ç‰©ç¨®: ${data.species}\n`;
      if (data.occupation) content += `è·æ¥­/èº«åˆ†: ${data.occupation}\n`;

      // å¤–è§€
      if (data.appearance || (isFullMode && (data.height || data.hairColor || data.hairStyle))) {
        content += `\n--- å¤–è§€ ---\n`;
        if (data.appearance) content += `${data.appearance}\n`;
        // å®Œæ•´ç‰ˆå°ˆå±¬æ¬„ä½
        if (isFullMode) {
          if (data.height) content += `èº«é«˜: ${data.height}\n`;
          if (data.hairColor) content += `é«®è‰²: ${data.hairColor}\n`;
          if (data.hairStyle) content += `é«®å‹: ${data.hairStyle}\n`;
        }
      }

      // æ€§æ ¼
      if (data.personality) {
        content += `\n--- æ€§æ ¼ ---\n${data.personality}\n`;
      }

      // èƒŒæ™¯æ•…äº‹ - å®Œæ•´ç‰ˆå°ˆå±¬
      if (isFullMode && data.backstory) {
        content += `\n--- èƒŒæ™¯æ•…äº‹ ---\n${data.backstory}\n`;
      }

      // å°è©±ç¯„ä¾‹
      if (data.firstMessage) {
        content += `\n--- ç¬¬ä¸€å‰‡è¨Šæ¯ ---\n${data.firstMessage}\n`;
      }

      // ä¸‹è¼‰
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${data.name || 'character'}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('å·²åŒ¯å‡ºç´”æ–‡å­—è§’è‰²å¡ï¼', 'success');
    }

    /**
     * åŒ¯å‡ºå£“ç¸® JSONï¼ˆå–®è¡Œç„¡ç¸®æ’ï¼‰
     */
    function exportCompactJSON() {
      const data = collectFormData();

      if (!App.validator.validate(data)) {
        return;
      }

      const name = data.name || 'character';

      // è½‰æ›ç‚ºå¹³å°æ ¼å¼ä¸¦ç§»é™¤ç©ºå€¼
      let jsonData = convertToJSON(data, currentPlatform);

      // å£“ç¸® JSONï¼šç„¡ç¸®æ’ã€ç„¡ç©ºæ ¼
      const content = JSON.stringify(JSON.parse(jsonData));

      // ä¸‹è¼‰
      const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}_${currentPlatform}_compact.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('å·²åŒ¯å‡ºç¸®è¡Œ JSON æª”æ¡ˆï¼', 'success');
    }

    // ===== PNG åœ–ç‰‡åŒ¯å‡º =====

    /**
     * åŒ¯å‡º YAML ç¨‹å¼ç¢¼åœ–ç‰‡
     */
    async function exportYAMLImage() {
      const data = collectFormData();

      // é©—è­‰è¡¨å–®
      if (!App.validator.validate(data)) {
        return;
      }

      // æª¢æŸ¥ç•¶å‰æä¾›å•†æ˜¯å¦æ”¯æ´ YAML åœ–ç‰‡æ ¼å¼
      if (!App.isPlatformSupported('yaml-image')) {
        const settings = App.settings.get();
        const providerName = App.ai.getProviderName(settings.aiProvider);
        showToast(`${providerName} ä¸æ”¯æ´ YAML åœ–ç‰‡æ ¼å¼åŒ¯å‡º`, 'warning');
        return;
      }

      showToast('æ­£åœ¨ç”Ÿæˆ YAML åœ–ç‰‡ï¼Œè«‹ç¨å€™...', 'info');

      try {
        // 1. ç”Ÿæˆ YAML å…§å®¹
        const yamlContent = convertToYAML(data, currentPlatform);

        // 2. å¡«å…¥è³‡æ–™åˆ°éš±è—å®¹å™¨
        const container = document.getElementById('yamlImageContainer');
        const card = container.querySelector('.yaml-code-card');

        container.querySelector('.name').textContent = data.name || 'æœªå‘½åè§’è‰²';
        container.querySelector('.platform').textContent = getPlatformName(currentPlatform);
        container.querySelector('.yaml-meta').textContent =
          `ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;
        container.querySelector('.yaml-content').textContent = yamlContent;

        // 3. æš«æ™‚é¡¯ç¤ºå®¹å™¨ï¼ˆç§»åˆ°å¯è¦‹å€åŸŸï¼‰
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.zIndex = '-1';

        // 4. ç­‰å¾…å­—é«”å’Œæ¨£å¼è¼‰å…¥
        await new Promise(resolve => setTimeout(resolve, 100));

        // 5. ä½¿ç”¨ html2canvas æˆªåœ–
        const canvas = await html2canvas(card, {
          backgroundColor: '#1e1e1e',
          scale: 2, // é«˜è§£æåº¦
          logging: false,
          windowWidth: card.scrollWidth,
          windowHeight: card.scrollHeight
        });

        // 6. è½‰æ›ç‚º PNG ä¸¦ä¸‹è¼‰
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${data.name || 'character'}_yaml_${currentPlatform}.png`;
          a.click();
          URL.revokeObjectURL(url);

          showToast('YAML åœ–ç‰‡å·²åŒ¯å‡ºï¼', 'success');
        }, 'image/png');

        // 7. éš±è—å®¹å™¨
        container.style.position = 'fixed';
        container.style.top = '-9999px';
        container.style.left = '-9999px';

      } catch (error) {
        console.error('YAML åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼š', error);
        showToast('åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    /**
     * åŒ¯å‡ºè§’è‰²å¡è¦–è¦ºé è¦½åœ–ç‰‡
     */
    async function exportCharacterCardImage() {
      const data = collectFormData();

      // é©—è­‰è¡¨å–®
      if (!App.validator.validate(data)) {
        return;
      }

      showToast('æ­£åœ¨ç”Ÿæˆè§’è‰²å¡åœ–ç‰‡ï¼Œè«‹ç¨å€™...', 'info');

      try {
        // 1. ç²å–è§’è‰²å¡é è¦½å€åŸŸ
        const cardElement = document.querySelector('#previewCard .preview-card');

        if (!cardElement) {
          showToast('æ‰¾ä¸åˆ°è§’è‰²å¡é è¦½å€åŸŸ', 'error');
          return;
        }

        // 2. æ·»åŠ åŒ¯å‡ºæ¨¡å¼ classï¼ˆå¦‚éœ€éš±è—æŸäº›å…ƒç´ ï¼‰
        cardElement.classList.add('export-mode');

        // 3. ç­‰å¾…æ¸²æŸ“å®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 100));

        // 4. ä½¿ç”¨ html2canvas æˆªåœ–
        const canvas = await html2canvas(cardElement, {
          backgroundColor: '#ffffff',
          scale: 2, // 2å€è§£æåº¦ï¼ˆé«˜æ¸…ï¼‰
          logging: false,
          useCORS: true, // å…è¨±è·¨åŸŸåœ–ç‰‡ï¼ˆé ­åƒï¼‰
          allowTaint: true,
          windowWidth: cardElement.scrollWidth,
          windowHeight: cardElement.scrollHeight,
          onclone: (clonedDoc) => {
            // ä¿®å¾©æ¼¸è®Šè‰²å•é¡Œï¼šå°‡æ¼¸è®Šæ›¿æ›ç‚ºç´”è‰²
            const clonedCard = clonedDoc.querySelector('#previewCard .preview-card');
            if (clonedCard) {
              clonedCard.style.background = '#f9fafb';
            }
            const avatar = clonedDoc.querySelector('.preview-card-avatar');
            if (avatar) {
              avatar.style.background = '#667eea';
            }
          }
        });

        // 5. è½‰æ›ç‚º PNG ä¸¦ä¸‹è¼‰
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${data.name || 'character'}_card.png`;
          a.click();
          URL.revokeObjectURL(url);

          showToast('è§’è‰²å¡åœ–ç‰‡å·²åŒ¯å‡ºï¼', 'success');
        }, 'image/png');

        // 6. ç§»é™¤åŒ¯å‡ºæ¨¡å¼
        cardElement.classList.remove('export-mode');

      } catch (error) {
        console.error('è§’è‰²å¡åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼š', error);
        showToast('åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    /**
     * åŒ¯å‡º Markdown åœ–ç‰‡
     */
    async function exportMarkdownImage() {
      const data = collectFormData();

      if (!App.validator.validate(data)) {
        return;
      }

      showToast('æ­£åœ¨ç”Ÿæˆ Markdown åœ–ç‰‡ï¼Œè«‹ç¨å€™...', 'info');

      try {
        // 1. ç”Ÿæˆ Markdown å…§å®¹
        const markdownContent = convertToMarkdown(data, currentPlatform);

        // 2. å¡«å…¥è³‡æ–™åˆ°éš±è—å®¹å™¨
        const container = document.getElementById('markdownImageContainer');
        const card = container.querySelector('.markdown-code-card');

        container.querySelector('.name').textContent = data.name || 'æœªå‘½åè§’è‰²';
        container.querySelector('.platform').textContent = getPlatformName(currentPlatform);
        container.querySelector('.markdown-meta').textContent =
          `ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}`;
        container.querySelector('.markdown-content').innerHTML =
          markdownContent.replace(/\n/g, '<br>');

        // 3. æš«æ™‚é¡¯ç¤ºå®¹å™¨
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.zIndex = '-1';

        // 4. ç­‰å¾…å­—é«”å’Œæ¨£å¼è¼‰å…¥
        await new Promise(resolve => setTimeout(resolve, 100));

        // 5. ä½¿ç”¨ html2canvas æˆªåœ–
        const canvas = await html2canvas(card, {
          backgroundColor: '#ffffff',
          scale: 2,
          logging: false,
          windowWidth: card.scrollWidth,
          windowHeight: card.scrollHeight
        });

        // 6. è½‰æ›ç‚º PNG ä¸¦ä¸‹è¼‰
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${data.name || 'character'}_markdown_${currentPlatform}.png`;
          a.click();
          URL.revokeObjectURL(url);

          showToast('Markdown åœ–ç‰‡å·²åŒ¯å‡ºï¼', 'success');
        }, 'image/png');

        // 7. éš±è—å®¹å™¨
        container.style.position = 'fixed';
        container.style.top = '-9999px';
        container.style.left = '-9999px';

      } catch (error) {
        console.error('Markdown åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼š', error);
        showToast('åœ–ç‰‡åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }

    // ===== æª”æ¡ˆåŒ¯å…¥ =====

    /**
     * è™•ç†æª”æ¡ˆåŒ¯å…¥
     */
    async function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const extension = file.name.split('.').pop().toLowerCase();
      const imageExtensions = ['png', 'jpg', 'jpeg', 'webp'];

      // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡æª”æ¡ˆ
      if (imageExtensions.includes(extension)) {
        // æª¢æŸ¥æ˜¯å¦æœ‰ API Key
        const settings = App.settings.get();
        if (!settings.geminiApiKey) {
          showToast('åœ–ç‰‡åŒ¯å…¥éœ€è¦è¨­å®š Gemini API Keyï¼', 'warning');
          App.ui.openSettings();
          event.target.value = '';
          return;
        }

        // ä½¿ç”¨ AI è®€å–åœ–ç‰‡
        await importFromImage(file);
        event.target.value = '';
        return;
      }

      // è™•ç†æ–‡å­—æª”æ¡ˆï¼ˆJSON, YAML, MDï¼‰
      showToast('æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');

      try {
        const text = await file.text();
        let data = null;

        // æ ¹æ“šæª”æ¡ˆé¡å‹è§£æ
        if (extension === 'json') {
          data = await importFromJSON(text);
        } else if (extension === 'yaml' || extension === 'yml') {
          data = await importFromYAML(text);
        } else if (extension === 'md') {
          data = await importFromMarkdown(text);
        } else {
          showToast('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼', 'error');
          return;
        }

        if (data) {
          fillFormData(data);
          showToast('åŒ¯å…¥æˆåŠŸï¼', 'success');
        }

      } catch (error) {
        console.error('åŒ¯å…¥å¤±æ•—ï¼š', error);
        showToast('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼ŒåŒ¯å…¥å¤±æ•—', 'error');
      }

      // æ¸…é™¤æª”æ¡ˆé¸æ“‡
      event.target.value = '';
    }

    /**
     * å¾ JSON åŒ¯å…¥
     */
    async function importFromJSON(text) {
      const json = JSON.parse(text);

      // åˆ¤æ–·æ ¼å¼ä¸¦è½‰æ›ç‚ºçµ±ä¸€æ ¼å¼
      if (json.character_info) {
        // Gemini æ ¼å¼
        return parseGeminiFormat(json);
      } else if (json.spec === 'chara_card_v2') {
        // SillyTavern æ ¼å¼
        return parseSillyTavernFormat(json);
      } else if (json.type === 'risuai') {
        // RisuAI æ ¼å¼
        return parseRisuAIFormat(json);
      } else if (json.name && json.definition) {
        // Character.AI æ ¼å¼
        return parseCharacterAIFormat(json);
      } else {
        // å˜—è©¦ç›´æ¥ä½¿ç”¨
        return json;
      }
    }

    /**
     * å¾ YAML åŒ¯å…¥
     */
    async function importFromYAML(text) {
      // ä½¿ç”¨ js-yaml è§£æ
      const yaml = jsyaml.load(text);
      return await importFromJSON(JSON.stringify(yaml));
    }

    /**
     * å¾ Markdown åŒ¯å…¥ï¼ˆåŸºç¤è§£æï¼‰
     */
    async function importFromMarkdown(text) {
      // åŸºç¤çš„ Markdown è§£æ
      const data = {};

      // æå–æ¨™é¡Œä½œç‚ºåç¨±
      const nameMatch = text.match(/^#\s+(.+)$/m);
      if (nameMatch) data.name = nameMatch[1];

      // æå–åŸºæœ¬è³‡è¨Šè¡¨æ ¼
      const tableMatch = text.match(/\|.*åç¨±.*\|.*(.+).*\|/);
      // ç°¡åŒ–ç‰ˆï¼šåªæå–åç¨±ï¼Œå…¶ä»–æ¬„ä½å¯ä»¥è£œå……

      showToast('Markdown åŒ¯å…¥åƒ…æ”¯æ´åŸºç¤è§£æï¼Œå»ºè­°ä½¿ç”¨ JSON æˆ– YAML', 'warning');
      return data;
    }

    /**
     * å¾åœ–ç‰‡åŒ¯å…¥ï¼ˆä½¿ç”¨ Gemini Vision APIï¼‰
     */
    async function importFromImage(file) {
      // æª¢æŸ¥ç•¶å‰æä¾›å•†æ˜¯å¦æ”¯æ´ Vision
      if (!App.isPlatformSupported('vision')) {
        const settings = App.settings.get();
        const providerName = App.ai.getProviderName(settings.aiProvider);
        showToast(`${providerName} ä¸æ”¯æ´åœ–ç‰‡å°å…¥åŠŸèƒ½ï¼ˆéœ€è¦ Vision APIï¼‰`, 'warning');
        return;
      }

      showToast('æ­£åœ¨ä½¿ç”¨ AI è®€å–åœ–ç‰‡...', 'info');

      try {
        // 1. å°‡åœ–ç‰‡è½‰æ›ç‚º Base64
        const base64Image = await fileToBase64(file);
        const base64Data = base64Image.split(',')[1]; // ç§»é™¤ data:image/...;base64, å‰ç¶´

        // 2. ç²å–è¨­å®šå’Œ API Key
        const settings = App.settings.get();
        const provider = settings.aiProvider;

        let apiKey;
        switch (provider) {
          case 'gemini':
            apiKey = settings.geminiApiKey;
            break;
          case 'openai':
            apiKey = settings.openaiApiKey;
            break;
          case 'claude':
            apiKey = settings.claudeApiKey;
            break;
          default:
            throw new Error(`ä¸æ”¯æ´çš„ AI æä¾›å•†: ${provider}`);
        }

        if (!apiKey || apiKey.trim() === '') {
          const providerName = App.ai.getProviderName(provider);
          throw new Error(`è«‹å…ˆåœ¨è¨­å®šä¸­é…ç½® ${providerName} çš„ API Key`);
        }

        // 3. æº–å‚™ AI æç¤ºè©
        const prompt = `è«‹åˆ†æé€™å¼µè§’è‰²å¡åœ–ç‰‡ï¼Œæå–æ‰€æœ‰è§’è‰²è³‡è¨Šï¼Œä¸¦ä»¥ JSON æ ¼å¼å›å‚³ã€‚

è«‹æå–ä»¥ä¸‹æ¬„ä½ï¼ˆå¦‚æœåœ–ç‰‡ä¸­æœ‰çš„è©±ï¼‰ï¼š
{
  "name": "è§’è‰²åç¨±",
  "aliases": "åˆ¥åï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "age": "å¹´é½¡",
  "gender": "æ€§åˆ¥",
  "species": "ç¨®æ—/ç‰©ç¨®",
  "occupation": "è·æ¥­/èº«ä»½",
  "appearance": "å¤–è§€æè¿°",
  "height": "èº«é«˜",
  "bodyType": "é«”å‹",
  "hairColor": "é«®è‰²",
  "hairStyle": "é«®å‹",
  "eyes": "çœ¼ç›ç‰¹å¾µ",
  "clothing": "æœè£é¢¨æ ¼",
  "features": "é¡¯è‘—ç‰¹å¾µ",
  "personality": "æ€§æ ¼æè¿°",
  "traits": "ç‰¹è³ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "strengths": "å„ªé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "weaknesses": "ç¼ºé»ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "likes": "å–œå¥½ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "dislikes": "å­æƒ¡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "fears": "ææ‡¼ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "goals": "ç›®æ¨™ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "birthplace": "å‡ºç”Ÿåœ°",
  "backstory": "èƒŒæ™¯æ•…äº‹",
  "keyEvents": "é—œéµäº‹ä»¶",
  "catchphrases": "å£é ­ç¦ªï¼ˆé€—è™Ÿåˆ†éš”ï¼‰",
  "verbalTics": "èªè¨€ç¿’æ…£",
  "emotionalExpression": "æƒ…ç·’è¡¨é”æ–¹å¼",
  "firstMessage": "ç¬¬ä¸€å‰‡è¨Šæ¯",
  "scenario": "åˆæ¬¡ç›¸é‡åœ°é»",
  "description": "è§’è‰²æè¿°",
  "systemPrompt": "ç³»çµ±æç¤ºè©"
}

é‡è¦è¦å‰‡ï¼š
1. åªå›å‚³ç´” JSONï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—æˆ– markdown æ ¼å¼
2. æ‰€æœ‰å­—æ®µçš„å€¼éƒ½å¿…é ˆæ˜¯å­—ç¬¦ä¸²é¡å‹
3. å¦‚æœåœ–ç‰‡ä¸­æ²’æœ‰æŸå€‹æ¬„ä½ï¼Œè«‹å¿½ç•¥è©²æ¬„ä½ï¼ˆä¸è¦å›å‚³ç©ºå­—ç¬¦ä¸²ï¼‰
4. JSON å¿…é ˆèƒ½è¢« JSON.parse() ç›´æ¥è§£æ`;

        // 4. æ ¹æ“šæä¾›å•†èª¿ç”¨å°æ‡‰çš„ Vision API
        let generatedText;

        if (provider === 'gemini') {
          // Gemini Vision API
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-goog-api-key': apiKey
              },
              body: JSON.stringify({
                contents: [{
                  parts: [
                    { text: prompt },
                    {
                      inline_data: {
                        mime_type: file.type,
                        data: base64Data
                      }
                    }
                  ]
                }],
                generationConfig: {
                  temperature: 0.4,
                  topK: 32,
                  topP: 1,
                  maxOutputTokens: 8192,
                }
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Gemini API');
          }

          const data = await response.json();

          if (!data.candidates || !data.candidates[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error(data.error?.message || 'API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          generatedText = data.candidates[0].content.parts[0].text;

        } else if (provider === 'openai') {
          // OpenAI Vision API (GPT-4 Vision)
          const response = await fetch(
            'https://api.openai.com/v1/chat/completions',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: 'gpt-4o',
                messages: [
                  {
                    role: 'user',
                    content: [
                      { type: 'text', text: prompt },
                      {
                        type: 'image_url',
                        image_url: {
                          url: `data:${file.type};base64,${base64Data}`
                        }
                      }
                    ]
                  }
                ],
                max_tokens: 4096,
                temperature: 0.4
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° OpenAI API');
          }

          const data = await response.json();

          if (!data.choices || !data.choices[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error('API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          generatedText = data.choices[0].message.content;

        } else if (provider === 'claude') {
          // Claude Vision API
          const response = await fetch(
            'https://api.anthropic.com/v1/messages',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 4096,
                temperature: 0.4,
                messages: [
                  {
                    role: 'user',
                    content: [
                      { type: 'text', text: prompt },
                      {
                        type: 'image',
                        source: {
                          type: 'base64',
                          media_type: file.type,
                          data: base64Data
                        }
                      }
                    ]
                  }
                ]
              })
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'ç„¡æ³•é€£æ¥åˆ° Claude API');
          }

          const data = await response.json();

          if (!data.content || !data.content[0]) {
            console.error('API å›æ‡‰çµæ§‹éŒ¯èª¤:', data);
            throw new Error('API å›æ‡‰æ ¼å¼ä¸æ­£ç¢º');
          }

          generatedText = data.content[0].text;
        }

        // 5. ä½¿ç”¨çµ±ä¸€çš„è§£æå‡½æ•¸è§£æ JSON
        try {
          const characterData = App.ai.parseAIResponse(generatedText);
          fillFormData(characterData);
          showToast('åœ–ç‰‡åŒ¯å…¥æˆåŠŸï¼', 'success');
        } catch (e) {
          console.error('JSON è§£æå¤±æ•—:', e);
          throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦');
        }

      } catch (error) {
        console.error('åœ–ç‰‡åŒ¯å…¥å¤±æ•—ï¼š', error);
        showToast(`åœ–ç‰‡åŒ¯å…¥å¤±æ•—: ${error.message}`, 'error');
      }
    }

    /**
     * å°‡æª”æ¡ˆè½‰æ›ç‚º Base64
     */
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /**
     * è§£æ Gemini æ ¼å¼
     */
    function parseGeminiFormat(json) {
      return {
        avatarUrl: json.character_info?.avatar_url || '',
        name: json.character_info?.name || '',
        aliases: json.character_info?.aliases?.join(', ') || '',
        age: json.character_info?.age || '',
        gender: json.character_info?.gender || '',
        species: json.character_info?.species || '',
        occupation: json.character_info?.occupation || '',
        appearance: json.appearance?.general || '',
        height: json.appearance?.height || '',
        bodyType: json.appearance?.body_type || '',
        hairColor: json.appearance?.hair_color || json.appearance?.hair || '',
        hairStyle: json.appearance?.hair_style || '',
        eyes: json.appearance?.eyes || '',
        clothing: json.appearance?.clothing || '',
        features: json.appearance?.distinguishing_features || '',
        personality: json.personality?.summary || '',
        traits: json.personality?.traits?.join(', ') || '',
        strengths: json.personality?.strengths?.join(', ') || '',
        weaknesses: json.personality?.weaknesses?.join(', ') || '',
        likes: json.personality?.likes?.join(', ') || '',
        dislikes: json.personality?.dislikes?.join(', ') || '',
        fears: json.personality?.fears?.join(', ') || '',
        goals: json.personality?.goals?.join(', ') || '',
        combatSkills: json.skills?.combat_skills?.join(', ') || '',
        lifeSkills: json.skills?.life_skills?.join(', ') || '',
        customAttributes: json.attributes || '',
        birthplace: json.background?.birthplace || '',
        backstory: json.background?.backstory || '',
        keyEvents: json.background?.key_events || '',
        relationships: json.background?.relationships || '',
        speechStyle: json.speech_patterns?.style || '',
        catchphrases: json.speech_patterns?.catchphrases?.join(', ') || '',
        verbalTics: json.speech_patterns?.verbal_tics || '',
        emotionalExpression: json.speech_patterns?.emotional_expression || '',
        description: json.ai_instructions?.character_description || '',
        systemPrompt: json.ai_instructions?.system_prompt || '',
        firstMessage: json.ai_instructions?.first_message || '',
        exampleDialogues: json.ai_instructions?.example_dialogues || '',
        scenario: json.ai_instructions?.scenario || '',
        tags: json.metadata?.tags?.join(', ') || '',
        worldLore: json.metadata?.world_lore || '',
        creator: json.metadata?.creator || '',
        version: json.metadata?.version || '1.0'
      };
    }

    /**
     * è§£æ SillyTavern æ ¼å¼
     */
    function parseSillyTavernFormat(json) {
      const data = json.data;
      return {
        name: data.name || '',
        personality: data.personality || '',
        scenario: data.scenario || '',
        firstMessage: data.first_mes || '',
        exampleDialogues: data.mes_example || '',
        systemPrompt: data.system_prompt || '',
        tags: data.tags?.join(', ') || '',
        creator: data.creator || '',
        version: data.character_version || '1.0',
        worldLore: data.extensions?.world || ''
      };
    }

    /**
     * è§£æ RisuAI æ ¼å¼
     */
    function parseRisuAIFormat(json) {
      const data = json.data;
      return {
        name: data.name || '',
        firstMessage: data.firstMessage || '',
        personality: data.personality || '',
        scenario: data.scenario || '',
        exampleDialogues: data.exampleMessage || '',
        systemPrompt: data.systemPrompt || '',
        tags: data.tags?.join(', ') || '',
        creator: data.creator || '',
        version: data.characterVersion || '1.0'
      };
    }

    /**
     * è§£æ Character.AI æ ¼å¼
     */
    function parseCharacterAIFormat(json) {
      return {
        name: json.name || '',
        aliases: json.title || '',
        description: json.description || '',
        firstMessage: json.greeting || '',
        tags: json.categories?.join(', ') || ''
      };
    }

    /**
     * å¡«å…¥è¡¨å–®è³‡æ–™
     */
    function fillFormData(data) {
      // ç‰¹æ®Šè™•ç†å‹•æ…‹æ¬„ä½
      const dynamicFieldTypes = ['relationships', 'combatSkills', 'lifeSkills', 'customAttributes', 'speechStyle'];

      for (const key in data) {
        // å¦‚æœæ˜¯å‹•æ…‹æ¬„ä½ï¼Œä½¿ç”¨ App.dynamicFields.fill
        if (dynamicFieldTypes.includes(key) && Array.isArray(data[key])) {
          App.dynamicFields.fill(key, data[key]);
        } else {
          // ä¸€èˆ¬æ¬„ä½ç›´æ¥å¡«å……
          const field = document.getElementById(key);
          if (field && data[key]) {
            field.value = data[key];
          }
        }
      }
      updatePreview();
    }

    // ===== è¤‡è£½åŠŸèƒ½ =====

    /**
     * è¤‡è£½é è¦½å…§å®¹åˆ°å‰ªè²¼ç°¿
     */
    async function copyPreviewContent() {
      const currentTab = App.state.currentPreviewTab;
      let content = '';

      switch (currentTab) {
        case 'json':
          content = document.getElementById('jsonCode').textContent;
          break;
        case 'yaml':
          content = document.getElementById('yamlCode').textContent;
          break;
        case 'markdown':
          content = document.getElementById('markdownCode').textContent;
          break;
        default:
          showToast('è§’è‰²å¡é è¦½ç„¡æ³•è¤‡è£½ï¼Œè«‹ä½¿ç”¨å…¶ä»–æ ¼å¼', 'warning');
          return;
      }

      try {
        await navigator.clipboard.writeText(content);
        showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
      } catch (error) {
        console.error('è¤‡è£½å¤±æ•—ï¼š', error);
        showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½', 'error');
      }
    }

    // ===== æç¤ºè¨Šæ¯ =====
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== ç¢ºèªå°è©±æ¡† =====
    function showConfirmDialog({ title, message, options, cancelable = true }) {
      return new Promise((resolve) => {
        // å‰µå»ºå°è©±æ¡† HTML
        const dialogHTML = `
          <div class="confirm-dialog-overlay" id="confirmDialogOverlay">
            <div class="confirm-dialog-box">
              <h3 class="confirm-dialog-title">${title}</h3>
              <p class="confirm-dialog-message">${message}</p>
              <div class="confirm-dialog-options">
                ${options.map(opt => `
                  <button class="confirm-option-btn" data-value="${opt.value}">
                    <div class="option-label">${opt.label}</div>
                    <div class="option-description">${opt.description}</div>
                  </button>
                `).join('')}
              </div>
              ${cancelable ? '<button class="confirm-cancel-btn">å–æ¶ˆ</button>' : ''}
            </div>
          </div>
        `;

        // æ·»åŠ åˆ° DOM
        document.body.insertAdjacentHTML('beforeend', dialogHTML);
        const overlay = document.getElementById('confirmDialogOverlay');

        // é¸é …æŒ‰éˆ•äº‹ä»¶
        overlay.querySelectorAll('.confirm-option-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const value = btn.getAttribute('data-value');
            overlay.remove();
            resolve(value);
          });
        });

        // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
        if (cancelable) {
          const cancelBtn = overlay.querySelector('.confirm-cancel-btn');
          if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
              overlay.remove();
              resolve(null);
            });
          }
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.remove();
            resolve(null);
          }
        });
      });
    }

    // ===== é¡¯ç¤ºã€Œè®“AIè®€å–åŒ¯å…¥æª”ã€æŒ‰éˆ• =====
    function showAIImportButtons() {
      const buttonIds = [
        'aiImportBtn-basicInfo',
        'aiImportBtn-appearance',
        'aiImportBtn-personality',
        'aiImportBtn-skills',
        'aiImportBtn-background',
        'aiImportBtn-speech',
        'aiImportBtn-aiInstructions',
        'aiImportBtn-metadata'
      ];

      buttonIds.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.style.display = 'inline-block';
        }
      });
    }

    // ===== åˆå§‹åŒ– =====
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ– Google OAuth
      if (typeof google !== 'undefined') {
        App.auth.init();
      } else {
        // Google API å°šæœªè¼‰å…¥ï¼Œå»¶é²åˆå§‹åŒ–
        window.addEventListener('load', () => {
          setTimeout(() => App.auth.init(), 500);
        });
      }

      // è¼‰å…¥è¨­å®šä¸¦æ›´æ–° UI
      App.settings.load();

      // æ ¹æ“šç•¶å‰ AI æä¾›å•†æ›´æ–° UI æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
      App.updateUIButtonsVisibility();

      // åˆå§‹åŒ–å‹•æ…‹æ¬„ä½
      App.dynamicFields.init();

      // æ¸²æŸ“æ‰€æœ‰å¿«é€Ÿæ¨™ç±¤
      App.ui.renderQuickTags('species', 'speciesTags');
      App.ui.renderQuickTags('occupation', 'occupationTags');
      App.ui.renderQuickTags('appearance', 'appearanceTags');
      App.ui.renderQuickTags('hairColor', 'hairColorTags');
      App.ui.renderQuickTags('hairStyle', 'hairStyleTags');
      App.ui.renderQuickTags('eyes', 'eyesTags');
      App.ui.renderQuickTags('clothing', 'clothingTags');
      App.ui.renderQuickTags('personality', 'personalityTags');
      App.ui.renderQuickTags('traits', 'traitsTags');
      App.ui.renderQuickTags('emotionalAttitude', 'emotionalAttitudeTags');
      App.ui.renderQuickTags('moneyAttitude', 'moneyAttitudeTags');
      App.ui.renderQuickTags('morality', 'moralityTags');

      // æ›´æ–°é è¦½
      updatePreview();

      // ğŸŒ“ åˆå§‹åŒ–æ·±è‰²æ¨¡å¼
      initThemeToggle();
    });

    /* ========== ğŸŒ“ æ·±è‰²æ¨¡å¼åˆ‡æ›åŠŸèƒ½ ========== */
    function initThemeToggle() {
      // ç²å–æˆ–å‰µå»ºåˆ‡æ›æŒ‰éˆ•
      let themeToggle = document.querySelector('.theme-toggle');

      if (!themeToggle) {
        themeToggle = document.createElement('button');
        themeToggle.className = 'theme-toggle';
        themeToggle.setAttribute('aria-label', 'åˆ‡æ›æ·±è‰²æ¨¡å¼');
        themeToggle.setAttribute('title', 'åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼');
        document.body.appendChild(themeToggle);
      }

      // å¾ localStorage è®€å–ä¸»é¡Œåå¥½
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const currentTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

      // è¨­ç½®åˆå§‹ä¸»é¡Œ
      document.documentElement.setAttribute('data-theme', currentTheme);
      updateThemeIcon(currentTheme);

      // é»æ“Šåˆ‡æ›
      themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);

        // æ·»åŠ åˆ‡æ›å‹•ç•«
        themeToggle.style.transform = 'rotate(360deg) scale(1.2)';
        setTimeout(() => {
          themeToggle.style.transform = '';
        }, 300);

        // é¡¯ç¤ºæç¤º
        showToast(`å·²åˆ‡æ›è‡³${newTheme === 'dark' ? 'æ·±è‰²' : 'æ·ºè‰²'}æ¨¡å¼`, 'success');
      });

      // ç›£è½ç³»çµ±ä¸»é¡Œè®ŠåŒ–
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          const newTheme = e.matches ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
          updateThemeIcon(newTheme);
        }
      });
    }

    function updateThemeIcon(theme) {
      const themeToggle = document.querySelector('.theme-toggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        themeToggle.style.transition = 'transform 0.3s ease';
      }
    }
  </script>
</body>
</html>