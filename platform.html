<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§’è‰²å¡å…±äº«å¹³å°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- é…ç½®æ–‡ä»¶ -->
  <script src="config.js"></script>

  <!-- å¤šèªè¨€ç³»çµ± -->
  <script src="lang/zh-TW.js"></script>
  <script src="lang/en.js"></script>
  <script src="lang/ja.js"></script>
  <script src="lang/ko.js"></script>
  <script src="lang/i18n.js"></script>

  <style>
    /* ===== CSS è®Šæ•¸å®šç¾© ===== */
    :root {
      /* ğŸ¨ ä¸»é¡Œè‰²å½© */
      --primary: #5B7BFF;
      --primary-dark: #4A6AEE;
      --primary-light: #8FA9FF;
      --primary-glow: rgba(91, 123, 255, 0.3);

      --secondary: #FF6B9D;
      --success: #06D6A0;
      --warning: #FFB800;
      --danger: #FF6B6B;
      --info: #4FC3F7;

      /* ğŸŒˆ æ¼¸è®Šè‰²å½© */
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --gradient-ocean: linear-gradient(135deg, #4fc3f7 0%, #5b7bff 100%);
      --gradient-sunset: linear-gradient(135deg, #ff6b9d 0%, #ffa06b 100%);

      /* ğŸŒ‘ æ·ºè‰²æ¨¡å¼é¡è‰² */
      --bg-primary: #F8F9FA;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F1F3F5;

      --text-primary: #1A1A1A;
      --text-secondary: #4A5568;
      --text-tertiary: #718096;

      --border-color: #E2E8F0;
      --border-light: #F1F3F5;

      /* ğŸ“ åœ“è§’ç³»çµ± */
      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 20px;
      --radius-xl: 24px;

      /* ğŸ’« é™°å½±ç³»çµ± */
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* ===== é ‚éƒ¨å°èˆªåˆ— ===== */
    .header {
      background: var(--bg-secondary);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 20px 0;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* ===== ç”¨æˆ¶è³‡è¨Šæ¨£å¼ ===== */
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .login-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: white;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .login-btn:hover {
      border-color: var(--primary);
      background: var(--bg-tertiary);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    /* ===== æœå°‹èˆ‡ç¯©é¸å€ ===== */
    .search-section {
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 24px;
    }

    .search-box {
      position: relative;
      margin-bottom: 24px;
    }

    .search-input {
      width: 100%;
      padding: 16px 50px 16px 20px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      font-size: 16px;
      transition: all 0.3s ease;
      background: var(--bg-secondary);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-glow);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: var(--text-tertiary);
    }

    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .filter-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    /* ===== çµ±è¨ˆè³‡è¨Š ===== */
    .stats {
      max-width: 1400px;
      margin: 0 auto 32px;
      padding: 0 24px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ===== è§’è‰²å¡ç¶²æ ¼ ===== */
    .cards-grid {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px 48px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
    }

    .character-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .character-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .card-thumbnail {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, var(--primary-light), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      color: white;
    }

    .card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-content {
      padding: 20px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .card-meta {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .card-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tag {
      padding: 4px 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
      flex: 1;
    }

    /* ===== è¼‰å…¥ä¸­å‹•ç•« ===== */
    .loading {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== ç©ºç‹€æ…‹ ===== */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* ===== Toast æç¤º ===== */
    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: var(--bg-secondary);
      padding: 16px 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: flex;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
      }
      to {
        transform: translateX(0);
      }
    }

    /* ===== è©³æƒ…å½ˆçª— ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg-tertiary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .modal-section-content {
      color: var(--text-primary);
    }

    .modal-actions {
      padding: 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
    }

    /* ===== å¯†ç¢¼é©—è­‰å½ˆçª— ===== */
    .password-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 2000;
    }

    .password-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .password-modal-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      max-width: 400px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      animation: modalPop 0.3s ease;
    }

    @keyframes modalPop {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .password-modal-header {
      padding: 24px 24px 0;
      text-align: center;
    }

    .password-modal-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .password-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .password-modal-desc {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .password-modal-body {
      padding: 24px;
    }

    .password-input-group {
      position: relative;
    }

    .password-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .password-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-glow);
    }

    .password-error {
      color: var(--danger);
      font-size: 13px;
      margin-top: 8px;
      display: none;
    }

    .password-error.show {
      display: block;
    }

    .password-modal-actions {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
    }

    .password-modal-actions .btn {
      flex: 1;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #e55858;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- èªè¨€é¸æ“‡å™¨å®¹å™¨ -->
  <div id="languageSelectorContainer"></div>

  <!-- é ‚éƒ¨å°èˆªåˆ— -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <span>ğŸŒ</span>
        <span data-i18n="platform.title">è§’è‰²å¡å…±äº«å¹³å°</span>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn btn-secondary">
          <span>âœï¸</span> <span data-i18n="platform.backToEditor">è¿”å›ç·¨è¼¯å™¨</span>
        </a>
        <button class="btn btn-primary" onclick="refreshList()">
          <span>ğŸ”„</span> <span data-i18n="common.refresh">é‡æ–°æ•´ç†</span>
        </button>
      </div>
    </div>
  </header>

  <!-- æœå°‹èˆ‡ç¯©é¸å€ -->
  <div class="search-section">
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" data-i18n-placeholder="platform.searchPlaceholder" placeholder="æœå°‹è§’è‰²åç¨±ã€ä½œè€…æˆ–æ¨™ç±¤...">
      <span class="search-icon">ğŸ”</span>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-filter="all" data-i18n="common.all">å…¨éƒ¨</button>
      <button class="filter-btn" data-filter="å®Œæ•´ç‰ˆ" data-i18n="platform.fullVersion">å®Œæ•´ç‰ˆ</button>
      <button class="filter-btn" data-filter="ç²¾ç°¡ç‰ˆ" data-i18n="platform.simpleVersion">ç²¾ç°¡ç‰ˆ</button>
    </div>
  </div>

  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="stats">
    <div class="stat-item">
      <span>ğŸ“Š</span>
      <span><span data-i18n="platform.totalCards">ç¸½å…±</span> <strong id="totalCount">0</strong> <span data-i18n="platform.cards">å¼µè§’è‰²å¡</span></span>
    </div>
    <div class="stat-item">
      <span>ğŸ‘¥</span>
      <span><span data-i18n="platform.createdBy">ç”±</span> <strong id="authorCount">0</strong> <span data-i18n="platform.authors">ä½ä½œè€…å‰µå»º</span></span>
    </div>
  </div>

  <!-- è§’è‰²å¡ç¶²æ ¼ -->
  <div class="cards-grid" id="cardsGrid">
    <!-- è¼‰å…¥ä¸­ -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div data-i18n="common.loading">æ­£åœ¨è¼‰å…¥è§’è‰²å¡...</div>
    </div>
  </div>

  <!-- Toast æç¤º -->
  <div class="toast" id="toast">
    <span id="toastIcon"></span>
    <span id="toastMessage"></span>
  </div>

  <!-- è©³æƒ…å½ˆçª— -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle"></div>
        <button class="modal-close" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions" id="modalActions">
        <button class="btn btn-secondary" onclick="closeModal()" data-i18n="common.close">é—œé–‰</button>
        <button class="btn btn-primary" onclick="downloadCharacter()">
          <span>ğŸ“¥</span> <span data-i18n="platform.downloadAndImport">ä¸‹è¼‰ä¸¦åŒ¯å…¥</span>
        </button>
      </div>
    </div>
  </div>

  <!-- å¯†ç¢¼é©—è­‰å½ˆçª— -->
  <div class="password-modal" id="passwordModal">
    <div class="password-modal-content">
      <div class="password-modal-header">
        <div class="password-modal-icon" id="passwordModalIcon">ğŸ”</div>
        <div class="password-modal-title" id="passwordModalTitle" data-i18n="platform.verifyPassword">é©—è­‰å¯†ç¢¼</div>
        <div class="password-modal-desc" id="passwordModalDesc" data-i18n="platform.enterPassword">è«‹è¼¸å…¥æ­¤è§’è‰²å¡çš„ç·¨è¼¯å¯†ç¢¼</div>
      </div>
      <div class="password-modal-body">
        <div class="password-input-group">
          <input type="password" class="password-input" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" maxlength="32">
          <div class="password-error" id="passwordError" data-i18n="platform.passwordError">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</div>
        </div>
      </div>
      <div class="password-modal-actions">
        <button class="btn btn-secondary" onclick="closePasswordModal()" data-i18n="common.cancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="passwordConfirmBtn" onclick="confirmPassword()" data-i18n="common.confirm">ç¢ºèª</button>
      </div>
    </div>
  </div>

  <script>
    // API URLï¼ˆå¾é…ç½®æ–‡ä»¶è®€å–ï¼‰
    const API_URL = CONFIG.PLATFORM_API_URL;

    // å…¨å±€è®Šæ•¸
    let allCharacters = [];
    let currentFilter = 'all';
    let currentSearch = '';
    let selectedCharacter = null;

    // å¯†ç¢¼é©—è­‰ç›¸é—œ
    let pendingPasswordAction = null; // { action: 'edit'|'delete', characterId: string }

    // ===== SHA-256 é›œæ¹Šå‡½æ•¸ =====
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function generatePasswordHash(characterId, password) {
      return await sha256(characterId + password);
    }

    // ===== å¯†ç¢¼é©—è­‰å½ˆçª— =====
    function openPasswordModal(action, characterId, title, desc, icon = 'ğŸ”') {
      pendingPasswordAction = { action, characterId };

      document.getElementById('passwordModalIcon').textContent = icon;
      document.getElementById('passwordModalTitle').textContent = title;
      document.getElementById('passwordModalDesc').textContent = desc;
      document.getElementById('passwordInput').value = '';
      document.getElementById('passwordError').classList.remove('show');

      // è¨­å®šç¢ºèªæŒ‰éˆ•æ¨£å¼
      const confirmBtn = document.getElementById('passwordConfirmBtn');
      if (action === 'delete') {
        confirmBtn.className = 'btn btn-danger';
        confirmBtn.innerHTML = '<span>ğŸ—‘ï¸</span> ç¢ºèªåˆªé™¤';
      } else {
        confirmBtn.className = 'btn btn-primary';
        confirmBtn.innerHTML = 'ç¢ºèª';
      }

      document.getElementById('passwordModal').classList.add('show');
      setTimeout(() => document.getElementById('passwordInput').focus(), 100);
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.remove('show');
      pendingPasswordAction = null;
    }

    async function confirmPassword() {
      if (!pendingPasswordAction) return;

      const password = document.getElementById('passwordInput').value;
      if (!password) {
        document.getElementById('passwordError').textContent = 'è«‹è¼¸å…¥å¯†ç¢¼';
        document.getElementById('passwordError').classList.add('show');
        return;
      }

      const { action, characterId } = pendingPasswordAction;
      const passwordHash = await generatePasswordHash(characterId, password);

      try {
        // é©—è­‰å¯†ç¢¼
        const verifyResponse = await fetch(`${API_URL}?action=verifyPassword&id=${characterId}&passwordHash=${encodeURIComponent(passwordHash)}`);
        const verifyResult = await verifyResponse.json();

        if (!verifyResult.success) {
          document.getElementById('passwordError').textContent = verifyResult.message || 'é©—è­‰å¤±æ•—';
          document.getElementById('passwordError').classList.add('show');
          return;
        }

        if (verifyResult.data.noPassword) {
          document.getElementById('passwordError').textContent = 'æ­¤è§’è‰²å¡æ²’æœ‰è¨­å®šç·¨è¼¯å¯†ç¢¼ï¼Œç„¡æ³•ç·¨è¼¯æˆ–åˆªé™¤';
          document.getElementById('passwordError').classList.add('show');
          return;
        }

        if (!verifyResult.data.verified) {
          document.getElementById('passwordError').textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';
          document.getElementById('passwordError').classList.add('show');
          return;
        }

        // å¯†ç¢¼æ­£ç¢ºï¼ŒåŸ·è¡Œæ“ä½œ
        closePasswordModal();

        if (action === 'edit') {
          executeEdit(characterId, passwordHash);
        } else if (action === 'delete') {
          executeDelete(characterId, passwordHash);
        }
      } catch (error) {
        console.error('é©—è­‰éŒ¯èª¤ï¼š', error);
        document.getElementById('passwordError').textContent = 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
        document.getElementById('passwordError').classList.add('show');
      }
    }

    // åŸ·è¡Œç·¨è¼¯
    async function executeEdit(characterId, passwordHash) {
      try {
        showToast('æ­£åœ¨è¼‰å…¥è§’è‰²è³‡æ–™...', 'info');

        const response = await fetch(`${API_URL}?action=get&id=${characterId}`);
        const result = await response.json();

        if (result.success) {
          const char = result.data;
          const data = typeof char.data === 'string' ? JSON.parse(char.data) : char.data;

          // å°‡è³‡æ–™å„²å­˜åˆ° sessionStorageï¼Œè®“ç·¨è¼¯å™¨è®€å–
          sessionStorage.setItem('editCharacterData', JSON.stringify(data));
          sessionStorage.setItem('editCharacterId', characterId);
          sessionStorage.setItem('editPasswordHash', passwordHash);

          // è·³è½‰å›ç·¨è¼¯å™¨
          showToast('âœ… æ­£åœ¨è·³è½‰åˆ°ç·¨è¼¯å™¨...', 'success');
          setTimeout(() => {
            window.location.href = 'index.html?edit=true';
          }, 500);
        } else {
          showToast('âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.message, 'error');
        }
      } catch (error) {
        console.error('è¼‰å…¥éŒ¯èª¤ï¼š', error);
        showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
      }
    }

    // åŸ·è¡Œåˆªé™¤
    async function executeDelete(characterId, passwordHash) {
      try {
        showToast('æ­£åœ¨åˆªé™¤è§’è‰²å¡...', 'info');

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'delete',
            id: characterId,
            passwordHash: passwordHash
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('âœ… è§’è‰²å¡å·²åˆªé™¤', 'success');
          closeModal();
          refreshList();
        } else {
          showToast('âŒ åˆªé™¤å¤±æ•—ï¼š' + result.message, 'error');
        }
      } catch (error) {
        console.error('åˆªé™¤éŒ¯èª¤ï¼š', error);
        showToast('âŒ åˆªé™¤å¤±æ•—', 'error');
      }
    }

    // è«‹æ±‚ç·¨è¼¯è§’è‰²ï¼ˆé–‹å•Ÿå¯†ç¢¼å½ˆçª—ï¼‰
    function requestEdit(characterId) {
      const char = allCharacters.find(c => c.id === characterId);
      if (!char) return;

      if (!char.hasPassword) {
        showToast('âš ï¸ æ­¤è§’è‰²å¡æ²’æœ‰è¨­å®šç·¨è¼¯å¯†ç¢¼ï¼Œç„¡æ³•ç·¨è¼¯', 'warning');
        return;
      }

      openPasswordModal('edit', characterId, 'ç·¨è¼¯è§’è‰²å¡', 'è«‹è¼¸å…¥æ­¤è§’è‰²å¡çš„ç·¨è¼¯å¯†ç¢¼', 'âœï¸');
    }

    // è«‹æ±‚åˆªé™¤è§’è‰²ï¼ˆé–‹å•Ÿå¯†ç¢¼å½ˆçª—ï¼‰
    function requestDelete(characterId) {
      const char = allCharacters.find(c => c.id === characterId) || selectedCharacter;
      if (!char) return;

      if (!char.hasPassword) {
        showToast('âš ï¸ æ­¤è§’è‰²å¡æ²’æœ‰è¨­å®šç·¨è¼¯å¯†ç¢¼ï¼Œç„¡æ³•åˆªé™¤', 'warning');
        return;
      }

      openPasswordModal('delete', characterId, 'åˆªé™¤è§’è‰²å¡', 'æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼è«‹è¼¸å…¥å¯†ç¢¼ç¢ºèªåˆªé™¤', 'ğŸ—‘ï¸');
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–å¤šèªè¨€ç³»çµ±
      I18n.init();
      I18n.insertSelector('languageSelectorContainer', 'top-right');
      I18n.onLanguageChange = function(lang) {
        document.title = I18n.t('platform.title');
        I18n.updatePageTexts();
      };
      I18n.updatePageTexts();

      loadCharacters();
      setupEventListeners();

      // æª¢æŸ¥ URL åƒæ•¸ï¼Œå¦‚æœæœ‰ id å‰‡ç›´æ¥é¡¯ç¤ºè©²è§’è‰²
      const urlParams = new URLSearchParams(window.location.search);
      const characterId = urlParams.get('id');
      if (characterId) {
        setTimeout(() => showDetail(characterId), 500);
      }
    });

    // è¨­å®šäº‹ä»¶ç›£è½
    function setupEventListeners() {
      // æœå°‹
      document.getElementById('searchInput').addEventListener('input', (e) => {
        currentSearch = e.target.value.toLowerCase();
        filterAndDisplayCharacters();
      });

      // ç¯©é¸æŒ‰éˆ•
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentFilter = e.target.dataset.filter;
          filterAndDisplayCharacters();
        });
      });

      // å½ˆçª—èƒŒæ™¯é»æ“Šé—œé–‰
      document.getElementById('detailModal').addEventListener('click', (e) => {
        if (e.target.id === 'detailModal') {
          closeModal();
        }
      });

      // å¯†ç¢¼å½ˆçª—èƒŒæ™¯é»æ“Šé—œé–‰
      document.getElementById('passwordModal').addEventListener('click', (e) => {
        if (e.target.id === 'passwordModal') {
          closePasswordModal();
        }
      });

      // å¯†ç¢¼è¼¸å…¥æ¡† Enter éµæäº¤
      document.getElementById('passwordInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          confirmPassword();
        }
      });
    }

    // è¼‰å…¥è§’è‰²å¡åˆ—è¡¨
    async function loadCharacters() {
      try {
        const response = await fetch(`${API_URL}?action=list&limit=1000`);
        const result = await response.json();

        if (result.success) {
          allCharacters = result.data.characters;
          filterAndDisplayCharacters();
          updateStats();
        } else {
          showToast('âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.message, 'error');
        }
      } catch (error) {
        console.error('è¼‰å…¥éŒ¯èª¤ï¼š', error);
        showToast('âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
        displayEmpty();
      }
    }

    // ç¯©é¸ä¸¦é¡¯ç¤ºè§’è‰²å¡
    function filterAndDisplayCharacters() {
      let filtered = allCharacters;

      // å¥—ç”¨ç¯©é¸å™¨
      if (currentFilter !== 'all') {
        filtered = filtered.filter(c => c.type === currentFilter);
      }

      // å¥—ç”¨æœå°‹
      if (currentSearch) {
        filtered = filtered.filter(c => {
          const searchText = `${c.name} ${c.author} ${c.tags}`.toLowerCase();
          return searchText.includes(currentSearch);
        });
      }

      displayCharacters(filtered);
    }

    // é¡¯ç¤ºè§’è‰²å¡
    function displayCharacters(characters) {
      const grid = document.getElementById('cardsGrid');
      const loading = document.getElementById('loading');

      if (loading) {
        loading.style.display = 'none';
      }

      if (characters.length === 0) {
        displayEmpty();
        return;
      }

      grid.innerHTML = characters.map(char => `
        <div class="character-card" onclick="showDetail('${char.id}')">
          <div class="card-thumbnail">
            ${char.thumbnail ? `<img src="${char.thumbnail}" alt="${char.name}">` : 'ğŸ­'}
          </div>
          <div class="card-content">
            <div class="card-title">${char.name || 'æœªå‘½åè§’è‰²'}</div>
            <div class="card-meta">
              <div class="card-meta-item">
                <span>ğŸ‘¤</span>
                <span>${char.author || 'åŒ¿å'}</span>
              </div>
            </div>
            ${char.tags ? `
              <div class="card-tags">
                ${char.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // é¡¯ç¤ºç©ºç‹€æ…‹
    function displayEmpty() {
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
          <div class="empty-icon">ğŸ”</div>
          <div style="font-size: 18px; margin-bottom: 8px;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è§’è‰²å¡</div>
          <div>è©¦è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æœå°‹é—œéµå­—</div>
        </div>
      `;
    }

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    function updateStats() {
      document.getElementById('totalCount').textContent = allCharacters.length;
      const authors = new Set(allCharacters.map(c => c.author));
      document.getElementById('authorCount').textContent = authors.size;
    }

    // é¡¯ç¤ºè§’è‰²è©³æƒ…
    async function showDetail(id) {
      try {
        const response = await fetch(`${API_URL}?action=get&id=${id}`);
        const result = await response.json();

        if (result.success) {
          selectedCharacter = result.data;
          const char = result.data;
          const data = typeof char.data === 'string' ? JSON.parse(char.data) : char.data;

          document.getElementById('modalTitle').textContent = char.name;
          document.getElementById('modalBody').innerHTML = `
            <div class="modal-section">
              <div class="modal-section-title">åŸºæœ¬è³‡è¨Š</div>
              <div class="modal-section-content">
                <p><strong>ä½œè€…ï¼š</strong>${char.author}</p>
                <p><strong>é¡å‹ï¼š</strong>${char.type}</p>
                <p><strong>ç‰ˆæœ¬ï¼š</strong>${char.version}</p>
                <p><strong>ä¸Šå‚³æ™‚é–“ï¼š</strong>${new Date(char.uploadDate).toLocaleString('zh-TW')}</p>
              </div>
            </div>
            ${data.description ? `
              <div class="modal-section">
                <div class="modal-section-title">è§’è‰²æè¿°</div>
                <div class="modal-section-content">${data.description}</div>
              </div>
            ` : ''}
            ${data.personality ? `
              <div class="modal-section">
                <div class="modal-section-title">æ€§æ ¼</div>
                <div class="modal-section-content">${data.personality}</div>
              </div>
            ` : ''}
            ${char.tags ? `
              <div class="modal-section">
                <div class="modal-section-title">æ¨™ç±¤</div>
                <div class="modal-section-content">
                  <div class="card-tags">
                    ${char.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
                  </div>
                </div>
              </div>
            ` : ''}
          `;

          // æ›´æ–°æŒ‰éˆ•å€åŸŸï¼ˆå¦‚æœæœ‰å¯†ç¢¼å‰‡é¡¯ç¤ºç·¨è¼¯/åˆªé™¤æŒ‰éˆ•ï¼‰
          document.getElementById('modalActions').innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal()">é—œé–‰</button>
            <button class="btn btn-primary" onclick="downloadCharacter()">
              <span>ğŸ“¥</span> ä¸‹è¼‰ä¸¦åŒ¯å…¥
            </button>
            ${char.hasPassword ? `
              <button class="btn" onclick="requestEdit('${char.id}')" style="background: var(--gradient-sunset); color: white;">
                <span>âœï¸</span> ç·¨è¼¯
              </button>
              <button class="btn btn-danger" onclick="requestDelete('${char.id}')">
                <span>ğŸ—‘ï¸</span> åˆªé™¤
              </button>
            ` : ''}
          `;

          document.getElementById('detailModal').classList.add('show');
        }
      } catch (error) {
        console.error('è¼‰å…¥è©³æƒ…éŒ¯èª¤ï¼š', error);
        showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
      }
    }

    // é—œé–‰å½ˆçª—
    function closeModal() {
      document.getElementById('detailModal').classList.remove('show');
      selectedCharacter = null;
    }

    // å¿«é€Ÿä¸‹è¼‰
    function quickDownload(id) {
      const char = allCharacters.find(c => c.id === id);
      if (char) {
        downloadCharacterData(char);
      }
    }

    // ä¸‹è¼‰è§’è‰²ï¼ˆå¾è©³æƒ…é ï¼‰
    function downloadCharacter() {
      if (selectedCharacter) {
        downloadCharacterData(selectedCharacter);
        closeModal();
      }
    }

    // ä¸‹è¼‰è§’è‰²è³‡æ–™
    function downloadCharacterData(char) {
      try {
        const data = typeof char.data === 'string' ? JSON.parse(char.data) : char.data;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${char.name || 'character'}.json`;
        a.click();
        URL.revokeObjectURL(url);

        showToast('âœ… ä¸‹è¼‰æˆåŠŸï¼è«‹åœ¨ç·¨è¼¯å™¨ä¸­åŒ¯å…¥æ­¤æª”æ¡ˆ', 'success');
      } catch (error) {
        console.error('ä¸‹è¼‰éŒ¯èª¤ï¼š', error);
        showToast('âŒ ä¸‹è¼‰å¤±æ•—', 'error');
      }
    }

    // é‡æ–°æ•´ç†
    function refreshList() {
      allCharacters = [];
      document.getElementById('cardsGrid').innerHTML = '<div class="loading" id="loading"><div class="loading-spinner"></div><div>æ­£åœ¨è¼‰å…¥è§’è‰²å¡...</div></div>';
      loadCharacters();
      showToast('ğŸ”„ æ­£åœ¨é‡æ–°æ•´ç†...', 'info');
    }

    // é¡¯ç¤º Toast
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');

      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };

      icon.textContent = icons[type] || icons.info;
      msg.textContent = message;

      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
