<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§’è‰²å¡å…±äº«å¹³å°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- é…ç½®æ–‡ä»¶ -->
  <script src="config.js"></script>

  <style>
    /* ===== CSS è®Šæ•¸å®šç¾© ===== */
    :root {
      /* ğŸ¨ ä¸»é¡Œè‰²å½© */
      --primary: #5B7BFF;
      --primary-dark: #4A6AEE;
      --primary-light: #8FA9FF;
      --primary-glow: rgba(91, 123, 255, 0.3);

      --secondary: #FF6B9D;
      --success: #06D6A0;
      --warning: #FFB800;
      --danger: #FF6B6B;
      --info: #4FC3F7;

      /* ğŸŒˆ æ¼¸è®Šè‰²å½© */
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      --gradient-ocean: linear-gradient(135deg, #4fc3f7 0%, #5b7bff 100%);
      --gradient-sunset: linear-gradient(135deg, #ff6b9d 0%, #ffa06b 100%);

      /* ğŸŒ‘ æ·ºè‰²æ¨¡å¼é¡è‰² */
      --bg-primary: #F8F9FA;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: #F1F3F5;

      --text-primary: #1A1A1A;
      --text-secondary: #4A5568;
      --text-tertiary: #718096;

      --border-color: #E2E8F0;
      --border-light: #F1F3F5;

      /* ğŸ“ åœ“è§’ç³»çµ± */
      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 20px;
      --radius-xl: 24px;

      /* ğŸ’« é™°å½±ç³»çµ± */
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* ===== é ‚éƒ¨å°èˆªåˆ— ===== */
    .header {
      background: var(--bg-secondary);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 20px 0;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    /* ===== æœå°‹èˆ‡ç¯©é¸å€ ===== */
    .search-section {
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 24px;
    }

    .search-box {
      position: relative;
      margin-bottom: 24px;
    }

    .search-input {
      width: 100%;
      padding: 16px 50px 16px 20px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      font-size: 16px;
      transition: all 0.3s ease;
      background: var(--bg-secondary);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-glow);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: var(--text-tertiary);
    }

    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .filter-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    /* ===== çµ±è¨ˆè³‡è¨Š ===== */
    .stats {
      max-width: 1400px;
      margin: 0 auto 32px;
      padding: 0 24px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ===== è§’è‰²å¡ç¶²æ ¼ ===== */
    .cards-grid {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px 48px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
    }

    .character-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .character-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .card-thumbnail {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, var(--primary-light), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      color: white;
    }

    .card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-content {
      padding: 20px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .card-meta {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .card-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tag {
      padding: 4px 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
      flex: 1;
    }

    /* ===== è¼‰å…¥ä¸­å‹•ç•« ===== */
    .loading {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== ç©ºç‹€æ…‹ ===== */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* ===== Toast æç¤º ===== */
    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: var(--bg-secondary);
      padding: 16px 24px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: flex;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
      }
      to {
        transform: translateX(0);
      }
    }

    /* ===== è©³æƒ…å½ˆçª— ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg-tertiary);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .modal-section-content {
      color: var(--text-primary);
    }

    .modal-actions {
      padding: 24px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 12px;
    }
  </style>
</head>
<body>
  <!-- é ‚éƒ¨å°èˆªåˆ— -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <span>ğŸŒ</span>
        <span>è§’è‰²å¡å…±äº«å¹³å°</span>
      </div>
      <div class="header-actions">
        <a href="index.html" class="btn btn-secondary">
          <span>âœï¸</span> è¿”å›ç·¨è¼¯å™¨
        </a>
        <button class="btn btn-primary" onclick="refreshList()">
          <span>ğŸ”„</span> é‡æ–°æ•´ç†
        </button>
      </div>
    </div>
  </header>

  <!-- æœå°‹èˆ‡ç¯©é¸å€ -->
  <div class="search-section">
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹è§’è‰²åç¨±ã€ä½œè€…æˆ–æ¨™ç±¤...">
      <span class="search-icon">ğŸ”</span>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
      <button class="filter-btn" data-filter="å®Œæ•´ç‰ˆ">å®Œæ•´ç‰ˆ</button>
      <button class="filter-btn" data-filter="ç²¾ç°¡ç‰ˆ">ç²¾ç°¡ç‰ˆ</button>
      <button class="filter-btn" data-filter="åŸå‰µ">åŸå‰µ</button>
      <button class="filter-btn" data-filter="fanwork">åŒäºº</button>
    </div>
  </div>

  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="stats">
    <div class="stat-item">
      <span>ğŸ“Š</span>
      <span>ç¸½å…± <strong id="totalCount">0</strong> å¼µè§’è‰²å¡</span>
    </div>
    <div class="stat-item">
      <span>ğŸ‘¥</span>
      <span>ç”± <strong id="authorCount">0</strong> ä½ä½œè€…å‰µå»º</span>
    </div>
  </div>

  <!-- è§’è‰²å¡ç¶²æ ¼ -->
  <div class="cards-grid" id="cardsGrid">
    <!-- è¼‰å…¥ä¸­ -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div>æ­£åœ¨è¼‰å…¥è§’è‰²å¡...</div>
    </div>
  </div>

  <!-- Toast æç¤º -->
  <div class="toast" id="toast">
    <span id="toastIcon"></span>
    <span id="toastMessage"></span>
  </div>

  <!-- è©³æƒ…å½ˆçª— -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle"></div>
        <button class="modal-close" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">é—œé–‰</button>
        <button class="btn btn-primary" onclick="downloadCharacter()">
          <span>ğŸ“¥</span> ä¸‹è¼‰ä¸¦åŒ¯å…¥
        </button>
      </div>
    </div>
  </div>

  <script>
    // API URLï¼ˆå¾é…ç½®æ–‡ä»¶è®€å–ï¼‰
    const API_URL = CONFIG.PLATFORM_API_URL;

    // å…¨å±€è®Šæ•¸
    let allCharacters = [];
    let currentFilter = 'all';
    let currentSearch = '';
    let selectedCharacter = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadCharacters();
      setupEventListeners();
    });

    // è¨­å®šäº‹ä»¶ç›£è½
    function setupEventListeners() {
      // æœå°‹
      document.getElementById('searchInput').addEventListener('input', (e) => {
        currentSearch = e.target.value.toLowerCase();
        filterAndDisplayCharacters();
      });

      // ç¯©é¸æŒ‰éˆ•
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentFilter = e.target.dataset.filter;
          filterAndDisplayCharacters();
        });
      });

      // å½ˆçª—èƒŒæ™¯é»æ“Šé—œé–‰
      document.getElementById('detailModal').addEventListener('click', (e) => {
        if (e.target.id === 'detailModal') {
          closeModal();
        }
      });
    }

    // è¼‰å…¥è§’è‰²å¡åˆ—è¡¨
    async function loadCharacters() {
      try {
        const response = await fetch(`${API_URL}?action=list&limit=1000`);
        const result = await response.json();

        if (result.success) {
          allCharacters = result.data.characters;
          filterAndDisplayCharacters();
          updateStats();
        } else {
          showToast('âŒ è¼‰å…¥å¤±æ•—ï¼š' + result.message, 'error');
        }
      } catch (error) {
        console.error('è¼‰å…¥éŒ¯èª¤ï¼š', error);
        showToast('âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
        displayEmpty();
      }
    }

    // ç¯©é¸ä¸¦é¡¯ç¤ºè§’è‰²å¡
    function filterAndDisplayCharacters() {
      let filtered = allCharacters;

      // å¥—ç”¨ç¯©é¸å™¨
      if (currentFilter !== 'all') {
        if (currentFilter === 'fanwork') {
          filtered = filtered.filter(c => c.source && c.source !== 'åŸå‰µ');
        } else {
          filtered = filtered.filter(c => c.type === currentFilter || c.source === currentFilter);
        }
      }

      // å¥—ç”¨æœå°‹
      if (currentSearch) {
        filtered = filtered.filter(c => {
          const searchText = `${c.name} ${c.author} ${c.source} ${c.tags}`.toLowerCase();
          return searchText.includes(currentSearch);
        });
      }

      displayCharacters(filtered);
    }

    // é¡¯ç¤ºè§’è‰²å¡
    function displayCharacters(characters) {
      const grid = document.getElementById('cardsGrid');
      const loading = document.getElementById('loading');

      if (loading) {
        loading.style.display = 'none';
      }

      if (characters.length === 0) {
        displayEmpty();
        return;
      }

      grid.innerHTML = characters.map(char => `
        <div class="character-card" onclick="showDetail('${char.id}')">
          <div class="card-thumbnail">
            ${char.thumbnail ? `<img src="${char.thumbnail}" alt="${char.name}">` : 'ğŸ­'}
          </div>
          <div class="card-content">
            <div class="card-title">${char.name || 'æœªå‘½åè§’è‰²'}</div>
            <div class="card-meta">
              <div class="card-meta-item">
                <span>ğŸ‘¤</span>
                <span>${char.author || 'åŒ¿å'}</span>
              </div>
              <div class="card-meta-item">
                <span>ğŸ“š</span>
                <span>${char.source || 'åŸå‰µ'}</span>
              </div>
            </div>
            ${char.tags ? `
              <div class="card-tags">
                ${char.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
              </div>
            ` : ''}
            <div class="card-actions">
              <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); showDetail('${char.id}')">
                <span>ğŸ‘ï¸</span> æŸ¥çœ‹
              </button>
              <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); quickDownload('${char.id}')">
                <span>ğŸ“¥</span> ä¸‹è¼‰
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // é¡¯ç¤ºç©ºç‹€æ…‹
    function displayEmpty() {
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML = `
        <div class="empty-state" style="grid-column: 1 / -1;">
          <div class="empty-icon">ğŸ”</div>
          <div style="font-size: 18px; margin-bottom: 8px;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è§’è‰²å¡</div>
          <div>è©¦è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æœå°‹é—œéµå­—</div>
        </div>
      `;
    }

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    function updateStats() {
      document.getElementById('totalCount').textContent = allCharacters.length;
      const authors = new Set(allCharacters.map(c => c.author));
      document.getElementById('authorCount').textContent = authors.size;
    }

    // é¡¯ç¤ºè§’è‰²è©³æƒ…
    async function showDetail(id) {
      try {
        const response = await fetch(`${API_URL}?action=get&id=${id}`);
        const result = await response.json();

        if (result.success) {
          selectedCharacter = result.data;
          const char = result.data;
          const data = typeof char.data === 'string' ? JSON.parse(char.data) : char.data;

          document.getElementById('modalTitle').textContent = char.name;
          document.getElementById('modalBody').innerHTML = `
            <div class="modal-section">
              <div class="modal-section-title">åŸºæœ¬è³‡è¨Š</div>
              <div class="modal-section-content">
                <p><strong>ä½œè€…ï¼š</strong>${char.author}</p>
                <p><strong>åŸä½œå“ï¼š</strong>${char.source}</p>
                <p><strong>é¡å‹ï¼š</strong>${char.type}</p>
                <p><strong>ç‰ˆæœ¬ï¼š</strong>${char.version}</p>
                <p><strong>ä¸Šå‚³æ™‚é–“ï¼š</strong>${new Date(char.uploadDate).toLocaleString('zh-TW')}</p>
              </div>
            </div>
            ${data.description ? `
              <div class="modal-section">
                <div class="modal-section-title">è§’è‰²æè¿°</div>
                <div class="modal-section-content">${data.description}</div>
              </div>
            ` : ''}
            ${data.personality ? `
              <div class="modal-section">
                <div class="modal-section-title">æ€§æ ¼</div>
                <div class="modal-section-content">${data.personality}</div>
              </div>
            ` : ''}
            ${char.tags ? `
              <div class="modal-section">
                <div class="modal-section-title">æ¨™ç±¤</div>
                <div class="modal-section-content">
                  <div class="card-tags">
                    ${char.tags.split(',').map(tag => `<span class="tag">${tag.trim()}</span>`).join('')}
                  </div>
                </div>
              </div>
            ` : ''}
          `;

          document.getElementById('detailModal').classList.add('show');
        }
      } catch (error) {
        console.error('è¼‰å…¥è©³æƒ…éŒ¯èª¤ï¼š', error);
        showToast('âŒ è¼‰å…¥å¤±æ•—', 'error');
      }
    }

    // é—œé–‰å½ˆçª—
    function closeModal() {
      document.getElementById('detailModal').classList.remove('show');
      selectedCharacter = null;
    }

    // å¿«é€Ÿä¸‹è¼‰
    function quickDownload(id) {
      const char = allCharacters.find(c => c.id === id);
      if (char) {
        downloadCharacterData(char);
      }
    }

    // ä¸‹è¼‰è§’è‰²ï¼ˆå¾è©³æƒ…é ï¼‰
    function downloadCharacter() {
      if (selectedCharacter) {
        downloadCharacterData(selectedCharacter);
        closeModal();
      }
    }

    // ä¸‹è¼‰è§’è‰²è³‡æ–™
    function downloadCharacterData(char) {
      try {
        const data = typeof char.data === 'string' ? JSON.parse(char.data) : char.data;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${char.name || 'character'}.json`;
        a.click();
        URL.revokeObjectURL(url);

        showToast('âœ… ä¸‹è¼‰æˆåŠŸï¼è«‹åœ¨ç·¨è¼¯å™¨ä¸­åŒ¯å…¥æ­¤æª”æ¡ˆ', 'success');
      } catch (error) {
        console.error('ä¸‹è¼‰éŒ¯èª¤ï¼š', error);
        showToast('âŒ ä¸‹è¼‰å¤±æ•—', 'error');
      }
    }

    // é‡æ–°æ•´ç†
    function refreshList() {
      allCharacters = [];
      document.getElementById('cardsGrid').innerHTML = '<div class="loading" id="loading"><div class="loading-spinner"></div><div>æ­£åœ¨è¼‰å…¥è§’è‰²å¡...</div></div>';
      loadCharacters();
      showToast('ğŸ”„ æ­£åœ¨é‡æ–°æ•´ç†...', 'info');
    }

    // é¡¯ç¤º Toast
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');

      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };

      icon.textContent = icons[type] || icons.info;
      msg.textContent = message;

      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
