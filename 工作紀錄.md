# AI 角色卡創作工具 - 工作紀錄

## 狀態說明
- 🔴 還沒做
- 🟡 做到一半
- 🟢 完成
- ⏸️ 需要延後

---

## 2025-01-29 工作紀錄

### 已完成的需求

#### 1. 匯出功能重新組織 🟢
**需求描述：**
- 將匯出按鈕分成兩行
- 第一行：文字格式（TXT、JSON、YAML、Markdown）
- 第二行：特殊格式（角色卡圖片、縮行 JSON、YAML 圖片、Markdown 圖片）

**完成時間：** 2025-01-29（之前的會話）
**狀態：** 🟢 完成

---

#### 2. 多 AI 提供商支援 🟢
**需求描述：**
- 新增 GPT API、CLAUDE API、DEEPSEEK API 支援
- 實現 AI 提供商選擇器
- 為每個提供商添加獨立的 API Key 配置
- 實現統一的 AI API 調用架構
- 新增平台格式支援檢查機制
- 動態顯示/隱藏不支援的功能按鈕

**完成內容：**
- ✅ 設置界面 HTML 修改
- ✅ CSS 樣式新增
- ✅ 設置管理邏輯修改
- ✅ 統一的 AI API 調用函數
- ✅ OpenAI API 實現
- ✅ Claude API 實現
- ✅ DeepSeek API 實現
- ✅ 平台格式支援檢查函數
- ✅ 現有 AI 生成調用修改
- ✅ 圖片導入功能修改
- ✅ 匯出函數修改
- ✅ 初始化時更新 UI

**完成時間：** 2025-01-29
**Commit:** 78092f5
**狀態：** 🟢 完成

---

#### 3. 配置管理系統重構 🟢
**需求描述：**
- 創建 .env 文件存放敏感資料
- 創建 config.js 供前端使用
- 提供範本文件
- 新增 .gitignore 保護敏感資料

**完成內容：**
- ✅ 創建 .env 文件
- ✅ 創建 .env.example 範本
- ✅ 創建 config.js 配置文件
- ✅ 創建 config.example.js 範本
- ✅ 新增 .gitignore
- ✅ 移除硬編碼的 Google OAuth 配置
- ✅ 配置 GitHub Personal Access Token

**完成時間：** 2025-01-29
**Commit:** 43420a0
**狀態：** 🟢 完成

---

#### 4. 簡潔版畫面改進 🟢
**需求描述：**
- 簡潔版模式下，背景故事、技能、屬性、對話風格區塊要連標題都隱藏
- 不是隱藏裡面的設定，是整個區塊標題都不顯示

**完成內容：**
- ✅ 為背景故事 section-header 添加 full-mode-only 類別
- ✅ 為戰鬥與生活技能 section-header 添加 full-mode-only 類別
- ✅ 為自訂屬性 section-header 添加 full-mode-only 類別
- ✅ 為對話風格 section-header 添加 full-mode-only 類別

**完成時間：** 2025-01-29
**狀態：** 🟢 完成

---

#### 5. 預覽和匯出功能改進 🟢
**需求描述：**
- 預覽區新增 [txt] 選項卡
- 匯出按鈕分成兩行：
  - 第一行：[匯出txt] [匯出JSON] [匯出YAML] [匯出Markdown]
  - 第二行：[匯出角色卡圖片] [匯出縮行JSON] [匯出YAML圖片] [匯出Markdown圖片]
- txt 格式：大標加小標的簡單格式
  ```
  性格特質 :
   -性格摘要 : 活潑,害羞
   -特質標籤 : 努力,迷糊
  ```
- 縮行JSON：將 JSON 全部縮成一行不換行

**完成內容：**
- ✅ 預覽區新增 TXT 選項卡
- ✅ 添加 TXT 預覽內容區 (previewTXT)
- ✅ 修改 switchPreviewTab 函數支援 txt
- ✅ 創建 convertToTXT 函數實現大標加小標格式
- ✅ 在 updateCodePreviews 中添加 TXT 預覽更新
- ✅ 修改匯出按鈕文字為「匯出 TXT」
- ✅ 確認 exportCompactJSON 已實現單行壓縮

**完成時間：** 2025-01-29
**狀態：** 🟢 完成

---

#### 6. YAML 格式顯示問題修復 🟢
**需求描述：**
- 修復 YAML 預覽選項卡不會根據平台支援狀態顯示/隱藏的問題
- 修復更改 AI 提供商時未即時更新 UI 的問題
- 當選擇 Gemini 時，YAML 相關功能應自動隱藏

**完成內容：**
- ✅ 在 `updateUIButtonsVisibility()` 中添加 YAML 預覽選項卡處理
- ✅ 修改 AI 提供商下拉選單的 `onchange` 事件，同時更新按鈕顯示狀態
- ✅ 添加自動切換邏輯：當切換到不支援 YAML 的平台時，自動切換到 JSON 預覽
- ✅ 優化程式碼結構，避免重複檢查平台支援狀態

**完成時間：** 2025-01-29
**Commit:** 562f38f
**狀態：** 🟢 完成

---

#### 7. 配置文件部署問題修復 🟢
**需求描述：**
- 修復 GitHub Pages 上因缺少 config.js 導致所有功能失效的問題

**完成內容：**
- ✅ 將 config.js 從 .gitignore 中移除
- ✅ 將 config.js 加入版本控制
- ✅ 推送到 GitHub Pages

**完成時間：** 2025-01-29
**Commit:** 4e89d71
**狀態：** 🟢 完成

---

#### 8. AI 平台切換即時更新修復 🟢
**需求描述：**
- 修復切換 AI 提供商時，YAML 匯出按鈕需要點擊「儲存」才會更新的問題
- 實現即時更新 UI 顯示狀態

**完成內容：**
- ✅ 修改 `updateUIButtonsVisibility()` 函數，優先從下拉選單讀取當前選擇
- ✅ 修改 AI 提供商下拉選單的 `onchange` 事件，傳入當前選擇值
- ✅ 修復按鈕顯示屬性從空字串改為明確的 `'flex'`

**完成時間：** 2025-01-29
**Commit:** cc7f6f2
**狀態：** 🟢 完成

---

#### 9. 對話風格與範例對話模式衝突修復 🟢
**需求描述：**
- 修復「對話風格」與「範例對話」的模式顯示衝突
- 完整版應顯示「對話風格」（口頭禪、語言習慣、情緒表達）
- 簡潔版應顯示「範例對話」

**完成內容：**
- ✅ 新增 `.simple-mode-only` CSS 類別
- ✅ 將「範例對話」欄位從 `full-mode-only` 改為 `simple-mode-only`

**完成時間：** 2025-01-29
**Commit:** 8c5fbab
**狀態：** 🟢 完成

---

#### 10. 人際關係顯示功能修復 🟢
**需求描述：**
- 修復人際關係在角色卡預覽中不顯示的問題
- 修復人際關係在 TXT 匯出中不顯示的問題

**完成內容：**
- ✅ 在角色卡預覽 HTML 中添加人際關係區塊（完整版限定）
- ✅ 在 `updateCardPreview()` 函數中添加人際關係顯示邏輯
- ✅ 在 `convertToTXT()` 函數中添加人際關係文字輸出
- ✅ 人際關係顯示在背景與第一則訊息之間

**完成時間：** 2025-01-29
**Commit:** a858cc2
**狀態：** 🟢 完成

---

#### 11. YAML 匯出功能完全修復 🟢
**需求描述：**
- 修復 YAML 匯出功能完全無法使用的問題
- 所有 AI 平台都無法看到或使用 YAML 匯出按鈕
- 根本原因：初始化時序錯誤 + 平台支援配置不當

**診斷過程：**
- ✅ 啟動診斷團隊進行全面檢查
- ✅ 發現核心問題：`App.settings.get()` 不更新 UI
- ✅ 發現次要問題：Gemini 被設為不支援 YAML
- ✅ 審核團隊批准修復方案
- ✅ 測試團隊驗證修復（32/32 項目通過）

**完成內容：**
- ✅ 修復 1：將初始化的 `App.settings.get()` 改為 `App.settings.load()`（index.html:5619）
- ✅ 修復 2：啟用 Gemini 的 YAML 支援（index.html:3649-3650）
- ✅ 修復 3：同步更新第二處支援矩陣（index.html:3687）
- ✅ 確認所有 YAML 相關函數完整（convertToYAML, objectToYAML, exportFile, exportYAMLImage）
- ✅ 確認所有 HTML 元素正確（按鈕、預覽區、選項卡）
- ✅ 測試通過率：100%（32/32）

**技術細節：**
- `settings.load()` 會載入設定並更新 UI（包括 aiProvider dropdown）
- `settings.get()` 只讀取設定不更新 UI
- 修復後確保 `updateUIButtonsVisibility()` 能讀取到正確的 provider 值
- 所有 AI 平台（Gemini、OpenAI、Claude、DeepSeek）現在都支援 YAML 匯出

**完成時間：** 2025-01-29
**Commit:** 1c96f18
**狀態：** 🟢 完成

---

#### 12. 性格特質欄位擴充和骰子功能強化 🟢
**需求描述：**
- 在「詳細」設定中新增更多性格特質相關欄位
- 為所有性格特質欄位添加骰子按鈕功能
- 提供完整的範例資料和快速標籤支援

**新增欄位（完整版限定）：**
- ✅ **針對感情**（特質標籤下方）：佔有慾、控制欲、尋找家人、重視友情、獨占欲、依賴型、自由戀愛、保持距離、理想主義、實用主義
- ✅ **金錢觀**（目標/動機下方）：節儉、奢侈、省小錢花大錢、理財高手、月光族、守財奴、慷慨大方、金錢無感、中庸之道、工作狂
- ✅ **道德**（金錢觀旁）：善良正義、中立平衡、混沌善良、秩序善良、守序中立、真實中立、混沌中立、守序邪惡、中立邪惡、混沌邪惡

**骰子按鈕強化：**
- ✅ 優點 (strengths) - 新增骰子按鈕
- ✅ 缺點/弱點 (weaknesses) - 新增骰子按鈕
- ✅ 喜好 (likes) - 新增骰子按鈕
- ✅ 厭惡 (dislikes) - 新增骰子按鈕
- ✅ 恐懼 (fears) - 新增骰子按鈕
- ✅ 目標/動機 (goals) - 新增骰子按鈕

**完成內容：**
- ✅ HTML 結構：添加三個新欄位（emotionalAttitude, moneyAttitude, morality）
- ✅ HTML 結構：為六個欄位添加骰子按鈕
- ✅ 範例資料：為三個新欄位各添加 10 個 Hololive 風格範例
- ✅ 快速標籤：為三個新欄位添加快速標籤支援
- ✅ 初始化：添加快速標籤渲染調用
- ✅ 資料收集：更新 collectFormData 函數
- ✅ TXT 匯出：添加新欄位輸出支援
- ✅ Markdown 匯出：添加新欄位輸出支援
- ✅ JSON/YAML 匯出：自動包含新欄位

**技術細節：**
- 所有新欄位都設定為 `full-mode-only`，僅在完整版顯示
- 針對感情欄位與特質標籤等寬（full-width）
- 金錢觀和道德欄位並排顯示（form-row）
- 每個新欄位都有骰子按鈕和快速標籤容器
- 範例資料基於 Hololive 成員特色設計
- 匯出功能完整支援所有格式

**完成時間：** 2025-01-29
**Commit:** 0fed20e
**狀態：** 🟢 完成

---

#### 13. 匯入功能重構與 AI 判讀功能 🟢
**需求描述：**
- 將匯入功能改為彈出視窗（類似設定視窗）
- 新增 AI 判讀選項，支援任意格式文字檔案匯入
- 添加 API Key 檢查機制

**新增功能：**
- ✅ **匯入彈出視窗**：獨立的匯入功能彈窗
- ✅ **標準格式匯入**：JSON、YAML 格式（本網站建立的角色卡）
- ✅ **AI 判讀匯入**：任意文字格式（TXT、MD 等），使用 AI 自動識別
- ✅ **API Key 檢查**：未設定 API Key 時禁用 AI 判讀選項

**完成內容：**

**彈出視窗 UI：**
- ✅ 標題：📥 匯入角色卡
- ✅ 檔案選擇器（支援 .json, .yaml, .yml, .txt, .md）
- ✅ 說明文字：※僅接受符合本網站所建立之角色卡格式
- ✅ AI 判讀勾選框：🤖 使用 AI 判讀
- ✅ 說明文字：※可套入任何格式的文字檔案提供判讀給這個AI判讀的選項
- ✅ 確定/取消按鈕

**API Key 檢查機制：**
- ✅ 開啟彈窗時自動檢查所有 AI 提供商的 API Key
- ✅ 若**未設定** API Key：
  - 自動取消勾選「使用 AI 判讀」
  - 禁用該選項（disabled）
  - 顯示警告：⚠️ 需要先設定 AI API Key 才能使用此功能
  - 檔案選擇器僅接受 .json, .yaml, .yml
- ✅ 若**已設定** API Key：
  - 啟用「使用 AI 判讀」選項
  - 恢復原始說明文字
  - 檔案選擇器接受所有格式

**匯入邏輯：**
- ✅ **App.import.execute()**: 主執行函數
  - 檢查檔案是否選擇
  - 根據勾選狀態選擇匯入方式
  - 顯示處理進度提示
  - 統一的錯誤處理
- ✅ **App.import.importStandard()**: 標準格式匯入
  - 支援 JSON 和 YAML
  - 使用現有的 importFromJSON 和 importFromYAML 函數
  - 格式驗證和錯誤提示
- ✅ **App.import.importWithAI()**: AI 判讀匯入
  - 讀取任意文字檔案
  - 使用 AI API 分析內容
  - 提取角色資訊並轉換為標準格式
  - 自動填入表單

**UI 函數：**
- ✅ **App.ui.openImport()**: 開啟匯入彈窗
  - 檢查 API Key 狀態
  - 動態調整 UI 元素狀態
  - 重置檔案選擇
- ✅ **App.ui.closeImport()**: 關閉匯入彈窗

**技術細節：**
- AI 判讀使用統一的 `App.ai.callAIAPI()` 函數
- 提示詞設計：要求 AI 提取所有角色資訊並轉為 JSON
- 自動移除 markdown 程式碼塊標記（```json```）
- 完善的錯誤處理和用戶提示
- 匯入成功後自動關閉彈窗

**完成時間：** 2025-01-29
**Commit:** 892b0f4
**狀態：** 🟢 完成

---

#### 14. AI 匯入功能調用錯誤修復 🟢
**問題描述：**
- AI 判讀匯入功能出現錯誤：`App.callAIAPI is not a function`
- 錯誤位置：index.html:3000
- 錯誤原因：函數路徑錯誤

**錯誤分析：**
- `callAIAPI` 函數定義在 `App.ai` 對象中（index.html:3399）
- 匯入模組中誤用 `App.callAIAPI(prompt)`
- 正確調用應為 `App.ai.callAIAPI(prompt)`

**修復內容：**
- ✅ 診斷錯誤：使用專業團隊查錯方式定位問題
- ✅ 修正函數調用：將 `App.callAIAPI` 改為 `App.ai.callAIAPI`
- ✅ 驗證修復：確認函數路徑正確

**修改位置：**
```javascript
// index.html:3000
// 修改前：
const response = await App.callAIAPI(prompt);

// 修改後：
const response = await App.ai.callAIAPI(prompt);
```

**完成時間：** 2025-01-29
**狀態：** 🟢 完成

---

## 進行中的需求

<!-- 目前沒有進行中的需求 -->

---

## 待處理需求

<!-- 請在此處添加新的需求 -->

---

## 備註

- 所有 AI API 調用已統一使用 `callAIAPI()` 函數
- 平台支援矩陣：
  - Gemini: ❌ YAML, ❌ YAML 圖片, ✅ Vision
  - OpenAI: ✅ 全部支援
  - Claude: ✅ 全部支援
  - DeepSeek: ✅ YAML, ✅ YAML 圖片, ❌ Vision
